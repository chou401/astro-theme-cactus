<!DOCTYPE html><html lang="en-EN"> <head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>ReentrantLock &amp; synchronized &amp; ReentrantReadWriteLock • 知道的越多,才知知道的越少</title><link href="/astro-theme-cactus/favicon.ico" rel="icon" sizes="any"><link href="/astro-theme-cactus/icon.svg" rel="icon" type="image/svg+xml"><link href="/astro-theme-cactus/apple-touch-icon.png" rel="apple-touch-icon"><link href="/astro-theme-cactus/manifest.webmanifest" rel="manifest"><link href="https://chou401.github.io/astro-theme-cactus/posts/java-lock-definition/" rel="canonical"><meta content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock • 知道的越多,才知知道的越少" name="title"><meta content="Java 常用锁的介绍 &#38; 底层代码" name="description"><meta content="chou401" name="author"><meta content="" name="theme-color"><meta content="article" property="og:type"><meta content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock" property="og:title"><meta content="Java 常用锁的介绍 &#38; 底层代码" property="og:description"><meta content="https://chou401.github.io/astro-theme-cactus/posts/java-lock-definition/" property="og:url"><meta content="知道的越多,才知知道的越少" property="og:site_name"><meta content="en-EN" property="og:locale"><meta content="https://chou401.github.io/og-image/java-lock-definition.png" property="og:image"><meta content="1200" property="og:image:width"><meta content="630" property="og:image:height"><meta content="chou401" property="article:author"><meta content="2024-05-16T14:00:40.000Z" property="article:published_time"><meta content="summary_large_image" property="twitter:card"><meta content="https://chou401.github.io/astro-theme-cactus/posts/java-lock-definition/" property="twitter:url"><meta content="ReentrantLock &#38; synchronized &#38; ReentrantReadWriteLock" property="twitter:title"><meta content="Java 常用锁的介绍 &#38; 底层代码" property="twitter:description"><meta content="https://chou401.github.io/og-image/java-lock-definition.png" property="twitter:image"><link href="/sitemap-index.xml" rel="sitemap"><link href="/rss.xml" rel="alternate" title="知道的越多,才知知道的越少" type="application/rss+xml"><link href="http://localhost:4321/astro-theme-cactus/" rel="webmention"><meta content="Astro v4.5.16" name="generator"><link rel="stylesheet" href="/astro-theme-cactus/_astro/_slug_.vObVOHgF.css"><script type="module" src="/astro-theme-cactus/_astro/hoisted.BjpvhLSh.js"></script>
<script type="module" src="/astro-theme-cactus/_astro/page.BG5lM7_G.js"></script></head> <body> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "light" : "dark");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
		const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
		colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "light" : "dark"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-8 flex items-center sm:ps-[3.5rem]" id="main-header"> <div class="flex sm:flex-col"> <a class="inline-flex items-center grayscale hover:filter-none sm:relative sm:inline-block" href="/astro-theme-cactus/"> <svg aria-hidden="true" class="me-3 h-10 w-6 sm:absolute sm:start-[-3.5rem] sm:me-0 sm:h-20 sm:w-12" fill="none" focusable="false" viewBox="0 0 272 480" xmlns="http://www.w3.org/2000/svg"> <g stroke="null"> <title>Layer 1</title> <g transform="translate(0,800) scale(0.10000000149011612,-0.10000000149011612) " fill="#000000" id="svg_1" stroke="null"> <path d="m1330.461549,8010.447731c-9.667991,-6.119317 -19.647851,-12.578595 -21.830946,-14.618368c-2.494965,-2.039772 -11.851085,-7.819127 -20.583464,-12.238633c-9.044249,-4.759469 -15.593533,-9.518937 -14.346051,-10.538823c0.935612,-1.359848 0,-2.379734 -2.806836,-2.379734c-2.494965,0 -9.979861,-4.419507 -16.841016,-10.198861c-6.549283,-5.439393 -14.657921,-10.198861 -17.464757,-10.198861c-3.118707,0 -5.613672,-1.019886 -5.613672,-2.379734c0,-1.69981 -6.549283,-7.139203 -14.969791,-12.918557c-17.464757,-11.898671 -18.088498,-12.578595 -30.251454,-24.137304c-9.044249,-8.499051 -9.35612,-9.518937 -9.35612,-39.435596c0,-23.117419 1.247483,-31.61647 4.67806,-34.336166c2.494965,-2.379734 6.549283,-10.198861 9.044249,-17.678026c2.494965,-7.479165 5.301801,-14.278406 6.237413,-15.298292c3.742448,-3.399621 9.667991,-16.998102 9.667991,-22.437495c0,-3.059659 2.806836,-9.518937 5.925543,-14.618368c3.430577,-5.099431 6.549283,-11.558709 7.173025,-13.938444c0.623741,-2.719696 2.806836,-7.139203 4.98993,-9.518937c1.871224,-2.379734 3.742448,-6.799241 3.742448,-9.518937c0,-2.719696 1.559353,-4.759469 3.118707,-4.759469c1.871224,0 3.118707,-2.039772 3.118707,-4.419507c0,-2.379734 2.806836,-7.819127 6.237413,-11.898671c3.430577,-4.079545 6.237413,-8.499051 6.237413,-9.858899c0,-4.759469 13.722309,-32.636356 19.335981,-39.775558c3.118707,-3.739583 6.237413,-9.518937 7.484896,-12.918557c0.935612,-3.399621 3.118707,-5.439393 4.67806,-4.419507c1.559353,1.359848 2.806836,-1.019886 2.806836,-4.759469c0,-4.079545 0.935612,-7.139203 2.494965,-7.139203c2.806836,0 9.979861,-16.65814 9.979861,-23.457381c0,-4.079545 0.623741,-4.419507 2.494965,-1.019886c1.871224,2.719696 4.054318,0.339962 6.861155,-7.819127c2.494965,-6.459279 5.925543,-11.898671 7.484896,-11.898671c1.871224,0 -0.623741,-2.379734 -5.613672,-5.099431c-4.67806,-2.719696 -11.227344,-5.099431 -14.03418,-5.099431c-4.36619,0 -4.36619,-0.679924 -0.31187,-3.399621c3.118707,-2.379734 3.430577,-3.399621 0.623741,-3.399621c-5.613672,0 -27.756489,-16.65814 -42.10254,-30.936546c-13.410438,-13.938444 -18.088498,-15.298292 -69.235287,-20.057761c-31.498937,-2.719696 -61.750391,-6.799241 -102.917319,-13.258519c-8.420508,-1.019886 -17.776628,-3.739583 -20.271593,-5.439393c-2.494965,-1.69981 -11.539215,-4.419507 -20.271593,-5.779355c-26.509006,-4.079545 -35.865127,-6.799241 -35.865127,-9.858899c0,-1.69981 -2.494965,-3.059659 -5.301801,-3.059659c-6.861155,0 -39.607574,-14.278406 -40.855057,-17.678026c-0.623741,-1.69981 -3.742448,-2.719696 -6.861155,-2.719696c-3.118707,0 -6.861155,-1.359848 -7.796766,-3.399621c-0.935612,-1.69981 -6.861155,-3.399621 -12.786697,-3.399621c-5.925543,0 -10.291732,-1.359848 -9.044249,-3.059659c1.559353,-2.719696 -7.796766,-8.159089 -41.166927,-24.477266c-5.613672,-2.379734 -10.291732,-5.779355 -10.291732,-7.139203c0,-1.69981 -2.494965,-2.719696 -5.925543,-2.719696c-3.118707,0 -9.979861,-4.419507 -15.281663,-10.198861c-5.613672,-5.439393 -11.227344,-10.198861 -13.098568,-10.198861c-1.559353,0 -6.237413,6.119317 -9.979861,13.598481c-4.054318,7.479165 -9.35612,13.598481 -11.851085,13.938444c-3.118707,0 -3.430577,0.679924 -0.935612,2.039772c2.806836,1.019886 2.183095,3.739583 -2.183095,8.839013c-3.430577,3.739583 -6.237413,9.858899 -6.237413,13.258519c0,3.739583 -1.247483,5.439393 -3.118707,4.419507c-1.559353,-1.019886 -3.118707,0.339962 -3.118707,3.059659c0,3.059659 -1.247483,5.439393 -3.118707,5.439393c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -2.806836,6.799241c-1.247483,0 -9.044249,8.839013 -16.841016,19.717799c-14.657921,20.057761 -24.014041,31.956432 -39.607574,50.994306c-5.301801,6.119317 -9.35612,12.578595 -9.35612,14.618368c0,2.039772 -1.247483,2.719696 -2.806836,1.69981c-1.559353,-1.019886 -5.925543,3.399621 -9.979861,9.858899c-4.054318,6.459279 -8.420508,11.898671 -9.667991,11.898671c-1.559353,0 -2.494965,2.719696 -2.494965,5.779355c0,3.059659 -0.935612,4.759469 -1.871224,3.399621c-2.183095,-2.039772 -8.420508,3.739583 -41.166927,37.735786c-13.410438,13.258519 -24.949653,24.477266 -26.197136,24.477266c-1.559353,0 -4.98993,2.719696 -8.108638,6.119317c-3.118707,3.059659 -11.227344,10.538823 -17.776628,15.978216c-6.549283,5.779355 -14.969791,12.918557 -18.400369,15.978216c-14.969791,13.258519 -25.885265,21.757571 -34.305773,26.517039c-4.98993,2.719696 -13.098568,9.178975 -17.776628,14.618368c-4.67806,5.099431 -10.915473,9.178975 -13.410438,9.178975c-2.806836,0 -4.98993,1.359848 -4.98993,2.719696c0,1.69981 -4.98993,4.759469 -10.915473,7.479165c-5.925543,2.719696 -10.915473,6.119317 -10.915473,7.479165c0,3.399621 -28.068359,18.017988 -31.810807,16.998102c-1.559353,-0.339962 -2.494965,1.69981 -2.494965,4.419507c0,2.719696 -2.806836,5.099431 -6.237413,5.099431c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.359848 -4.67806,3.059659c0,1.69981 -4.67806,4.759469 -9.979861,7.139203c-25.261524,10.198861 -56.136719,28.556811 -53.641754,31.61647c1.247483,1.359848 -0.623741,2.379734 -4.36619,2.379734c-3.742448,0 -11.227344,3.059659 -16.841016,6.799241c-5.613672,3.739583 -12.786697,6.799241 -15.593533,6.799241c-3.118707,0 -5.613672,1.359848 -5.613672,3.059659c0,1.69981 -3.118707,4.419507 -6.861155,5.439393c-13.098568,4.419507 -36.800738,16.998102 -36.800738,19.377837c0,1.69981 -2.806836,2.719696 -6.237413,2.719696c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -4.054318,3.399621 -9.044249,3.399621c-5.301801,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -9.044249,3.399621 -20.583464,3.399621c-25.261524,0 -37.42448,-7.819127 -40.543186,-25.497153c-0.935612,-6.459279 -3.430577,-11.898671 -4.98993,-11.898671c-1.871224,0 -2.494965,-10.878785 -1.559353,-26.177077c0.935612,-20.057761 4.054318,-35.01609 12.786697,-60.513243c6.549283,-18.697912 12.474826,-39.095634 13.410438,-44.874989c0.935612,-6.119317 2.494965,-11.218747 3.742448,-11.218747c0.935612,0 3.742448,-5.099431 5.925543,-10.878785c2.494965,-6.119317 6.861155,-16.998102 10.291732,-24.137304c3.118707,-7.479165 5.925543,-15.298292 5.925543,-17.678026c0,-5.099431 16.217274,-40.455482 19.024111,-41.815331c1.247483,-0.679924 4.054318,-7.819127 6.237413,-16.318178c2.183095,-8.159089 5.301801,-14.95833 6.549283,-14.95833c1.247483,0 2.494965,-3.059659 2.494965,-6.799241c0,-3.739583 0.935612,-6.799241 2.494965,-6.799241c2.494965,0 9.979861,-16.65814 9.979861,-22.777457c0,-2.379734 1.559353,-4.419507 3.118707,-4.419507c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-4.759469 8.108638,-21.417609 12.474826,-25.497153c1.871224,-1.69981 9.35612,-19.037874 19.024111,-43.175179c2.494965,-6.119317 5.301801,-11.218747 6.549283,-11.218747c1.559353,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 2.806836,-8.159089 6.237413,-11.898671c3.430577,-3.739583 6.237413,-9.178975 6.237413,-11.898671c0,-2.719696 4.98993,-13.258519 10.915473,-23.457381c5.925543,-10.198861 10.915473,-20.397723 10.915473,-22.437495c0,-1.69981 1.559353,-3.399621 3.118707,-3.399621c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-3.739583 3.118707,-8.499051c0,-4.759469 1.247483,-8.499051 2.806836,-8.499051c1.559353,0 9.667991,-14.618368 17.776628,-32.296394c8.420508,-17.678026 15.593533,-31.276508 16.529145,-30.256622c1.247483,1.359848 14.346051,-26.177077 13.410438,-28.216849c-0.31187,-0.679924 3.118707,-4.759469 7.173025,-9.858899c4.054318,-4.759469 8.420508,-11.898671 9.35612,-15.298292c1.247483,-3.739583 3.430577,-6.459279 4.98993,-6.459279c1.559353,0 2.806836,-2.039772 2.806836,-4.419507c0,-3.739583 17.152886,-31.61647 28.068359,-45.554913c1.559353,-2.379734 3.118707,-5.099431 3.118707,-6.119317c0,-1.359848 1.871224,-4.079545 4.054318,-6.459279c1.871224,-2.379734 7.173025,-9.178975 11.539215,-15.638254c4.36619,-6.119317 11.539215,-15.638254 16.529145,-20.737685c4.67806,-5.439393 8.420508,-10.538823 8.420508,-11.558709c0,-1.019886 2.806836,-5.099431 6.237413,-9.178975c3.430577,-4.079545 6.237413,-9.518937 6.237413,-12.238633c0,-6.459279 -6.237413,-18.35795 -13.098568,-24.817229c-3.118707,-3.059659 -5.613672,-6.459279 -5.613672,-7.819127c0,-1.019886 -2.806836,-5.099431 -6.237413,-8.839013c-3.430577,-3.739583 -6.237413,-9.178975 -6.237413,-11.898671c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-2.039772 -3.118707,-4.759469c0,-2.379734 -3.430577,-7.479165 -7.796766,-10.878785c-4.36619,-3.399621 -7.796766,-8.159089 -7.796766,-10.538823c0,-2.379734 -1.247483,-4.419507 -3.118707,-4.419507c-1.559353,0 -3.118707,-2.039772 -3.118707,-4.079545c0,-3.739583 -4.98993,-11.558709 -19.335981,-29.916659c-2.183095,-2.719696 -3.742448,-5.099431 -3.118707,-5.099431c2.494965,0 -5.925543,-18.697912 -8.420508,-18.697912c-1.559353,0 -3.742448,-3.739583 -4.67806,-8.159089c-0.935612,-4.759469 -3.742448,-10.538823 -5.925543,-12.918557c-5.925543,-7.139203 -11.539215,-19.037874 -11.539215,-24.817229c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-3.059659 -3.118707,-6.459279c0,-3.399621 -2.183095,-7.479165 -4.98993,-8.499051c-2.494965,-1.019886 -3.742448,-3.399621 -2.806836,-5.439393c0.935612,-1.69981 0.31187,-3.399621 -1.247483,-3.399621c-1.871224,0 -3.430577,-2.039772 -3.430577,-4.759469c0,-2.719696 -1.247483,-5.439393 -2.806836,-6.119317c-1.559353,-0.339962 -6.237413,-9.858899 -10.915473,-20.397723c-4.36619,-10.878785 -9.35612,-19.717799 -11.227344,-19.717799c-1.559353,0 -3.118707,-3.059659 -3.118707,-6.459279c0,-3.739583 -1.559353,-7.819127 -3.118707,-8.839013c-1.871224,-1.019886 -3.118707,-5.779355 -3.118707,-10.538823c0,-4.419507 -1.247483,-8.159089 -2.494965,-8.159089c-3.430577,0 -9.979861,-15.638254 -9.979861,-23.457381c0,-3.739583 -2.183095,-7.139203 -4.67806,-8.499051c-2.494965,-1.019886 -4.67806,-5.099431 -4.67806,-8.839013c0,-3.739583 -1.247483,-9.518937 -2.806836,-12.918557c-1.559353,-3.059659 -4.67806,-12.918557 -7.173025,-21.757571c-2.183095,-9.178975 -4.98993,-16.318178 -6.237413,-16.318178c-1.247483,0 -2.494965,-4.419507 -2.494965,-10.198861c0,-5.439393 -1.247483,-10.198861 -2.494965,-10.198861c-3.430577,0 -13.410438,-38.075748 -15.281663,-59.833319c-0.935612,-10.198861 -3.118707,-19.377837 -4.36619,-20.397723c-1.559353,-1.019886 -2.806836,-9.178975 -2.806836,-18.35795c0,-8.839013 -1.559353,-16.998102 -3.430577,-17.678026c-3.430577,-1.359848 -7.173025,-29.236735 -10.915473,-79.89108c-1.247483,-15.638254 -3.430577,-28.216849 -4.67806,-28.216849c-1.559353,0 -2.806836,-25.837115 -2.806836,-57.793547c0,-32.296394 1.247483,-57.793547 2.806836,-57.793547c1.559353,0 3.430577,-8.159089 4.36619,-17.678026c2.183095,-25.837115 7.173025,-48.27461 11.227344,-49.634458c1.871224,-0.679924 3.430577,-6.459279 3.430577,-12.578595c0,-6.459279 1.247483,-12.238633 2.806836,-13.258519c1.559353,-1.019886 3.430577,-6.799241 4.36619,-12.918557c0.935612,-6.119317 3.118707,-17.338064 5.301801,-24.817229c2.183095,-7.479165 4.36619,-18.697912 5.301801,-24.477266c0.935612,-6.119317 2.806836,-11.218747 4.36619,-11.218747c1.559353,0 2.806836,-6.799241 2.806836,-15.298292c0,-8.499051 1.559353,-15.298292 3.118707,-15.298292c1.871224,0 3.118707,-1.69981 3.118707,-3.739583c0,-12.578595 13.410438,-50.314382 21.519076,-59.833319c4.98993,-5.779355 9.35612,-10.198861 9.979861,-9.518937c0.623741,0.339962 4.36619,-5.779355 7.796766,-13.938444l6.861155,-14.95833l-41.166927,0c-43.973763,0 -65.180969,-2.379734 -62.374133,-7.139203c0.935612,-1.69981 -4.67806,-3.059659 -12.162956,-3.059659c-8.420508,0 -15.281663,-2.039772 -17.776628,-5.099431c-2.183095,-3.059659 -9.044249,-5.099431 -15.905404,-5.099431c-6.861155,0 -12.162956,-1.359848 -12.162956,-3.399621c0,-1.69981 -2.494965,-3.399621 -5.613672,-3.399621c-2.806836,0 -10.603603,-3.059659 -16.841016,-6.459279c-5.925543,-3.739583 -12.162956,-5.779355 -13.098568,-4.759469c-0.935612,1.359848 -1.871224,-0.339962 -1.871224,-3.399621c0,-4.079545 -2.494965,-5.779355 -8.108638,-5.779355c-7.484896,0 -17.152886,-6.459279 -33.682032,-22.437495c-3.118707,-3.059659 -9.35612,-6.799241 -14.03418,-7.819127l-8.108638,-2.379734l-0.623741,-44.195065c-0.623741,-39.095634 0,-42.835217 3.742448,-33.656242c2.183095,5.439393 3.742448,15.298292 3.118707,21.757571c-0.623741,8.839013 0.623741,11.898671 4.98993,12.918557c6.549283,2.039772 8.108638,7.819127 2.183095,7.819127c-2.806836,0 -2.806836,1.019886 0,4.079545c2.183095,2.379734 3.742448,6.799241 3.742448,9.858899c0,3.059659 4.054318,7.479165 9.044249,9.858899c4.98993,2.039772 9.979861,6.459279 10.915473,9.178975c1.247483,3.399621 4.36619,4.419507 9.044249,3.059659c3.742448,-1.019886 9.044249,-0.339962 11.539215,1.359848c4.054318,2.719696 3.742448,3.399621 -0.623741,3.399621c-3.118707,0 -5.613672,1.69981 -5.613672,3.399621c0,2.039772 4.98993,3.399621 10.915473,3.399621c7.484896,0 10.915473,1.69981 10.915473,5.099431c0,2.719696 2.806836,5.099431 5.925543,5.099431c3.430577,0 7.173025,1.69981 8.108638,3.399621c0.935612,2.039772 5.301801,3.399621 9.667991,3.399621c4.36619,0 8.420508,2.379734 9.35612,5.099431c1.559353,3.739583 7.484896,5.099431 24.325912,5.439393c12.162956,0.339962 19.024111,1.359848 14.969791,2.039772c-9.667991,2.039772 -5.613672,7.819127 5.613672,7.819127c4.67806,0 9.35612,2.039772 9.979861,4.419507c1.247483,3.059659 15.281663,4.419507 53.329883,5.099431c43.973763,1.019886 52.082401,2.039772 52.082401,6.459279c0,2.719696 1.871224,4.419507 4.054318,3.399621c1.871224,-0.679924 3.430577,-3.399621 3.118707,-5.439393c-0.623741,-2.039772 1.871224,-3.739583 4.98993,-3.739583c7.484896,0 11.227344,-5.439393 5.925543,-7.819127c-3.118707,-1.359848 -2.806836,-2.039772 0.31187,-2.039772c5.613672,-0.339962 16.217274,-13.938444 14.03418,-17.678026c-0.935612,-1.69981 0.935612,-3.059659 4.054318,-3.399621c4.98993,0 4.98993,-0.339962 -0.623741,-3.059659c-3.430577,-1.359848 -9.044249,-2.039772 -12.786697,-1.019886c-3.742448,0.679924 -8.732378,-1.019886 -11.539215,-3.739583c-2.494965,-3.059659 -6.549283,-5.439393 -8.420508,-5.439393c-1.871224,0 -4.054318,-2.379734 -4.98993,-5.099431c-1.247483,-2.719696 -3.742448,-5.099431 -5.925543,-5.099431c-6.861155,0 -23.390299,-10.538823 -21.830946,-13.938444c1.247483,-1.69981 -1.559353,-3.059659 -6.237413,-3.059659c-4.36619,0 -8.732378,-2.379734 -9.667991,-5.099431c-1.247483,-2.719696 -4.67806,-5.099431 -8.108638,-5.099431c-3.430577,0 -9.979861,-4.079545 -14.657921,-9.178975c-19.959722,-22.777457 -38.360092,-36.7159 -42.10254,-32.296394c-1.247483,1.019886 -1.247483,-0.339962 -0.31187,-3.399621c1.247483,-3.739583 -0.31187,-6.799241 -5.301801,-9.858899c-4.054318,-2.039772 -8.420508,-6.119317 -9.667991,-8.499051c-1.247483,-2.719696 -4.67806,-4.759469 -6.861155,-4.759469c-2.494965,0 -4.67806,-3.059659 -4.67806,-6.799241c0,-6.119317 -11.227344,-15.978216 -16.217274,-14.278406c-1.247483,0.339962 -3.742448,-4.759469 -5.613672,-11.558709c-2.183095,-6.459279 -4.36619,-11.218747 -5.301801,-10.198861c-1.871224,2.039772 -22.142817,-24.817229 -24.637782,-32.636356c-1.247483,-3.399621 -3.118707,-6.119317 -4.67806,-6.119317c-1.559353,0 -2.806836,-2.379734 -2.806836,-5.099431c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-2.719696 -3.118707,-6.459279c0,-3.399621 -2.183095,-8.159089 -4.67806,-10.538823c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.719696 -1.559353,-3.739583 -3.742448,-2.379734c-2.183095,1.69981 -2.806836,0.679924 -1.559353,-3.059659c1.247483,-3.399621 -0.935612,-8.499051 -5.613672,-13.258519c-4.36619,-4.419507 -7.796766,-11.898671 -7.796766,-16.65814c0,-7.819127 -1.247483,-8.839013 -7.796766,-7.139203c-4.36619,0.679924 -7.796766,3.739583 -7.796766,6.119317c0,2.719696 -1.247483,4.759469 -3.118707,4.759469c-1.559353,0 -3.118707,3.059659 -3.118707,7.139203c0,5.099431 -1.559353,6.459279 -4.67806,5.099431c-3.742448,-1.359848 -4.67806,1.019886 -4.67806,12.578595c0,7.819127 -1.559353,16.65814 -3.118707,19.377837c-4.98993,8.499051 -4.054318,-78.871193 0.935612,-89.749978c2.494965,-4.759469 5.301801,-7.819127 6.237413,-6.459279c1.247483,1.019886 2.183095,-2.719696 2.183095,-8.839013c0,-6.119317 -1.247483,-10.198861 -2.806836,-9.178975c-6.237413,4.419507 -7.484896,-27.876887 -8.732378,-192.418514l-0.935612,-172.700716l12.474826,0c10.915473,0 12.474826,1.019886 12.474826,7.819127c-0.31187,4.079545 -2.183095,11.218747 -4.67806,15.978216c-2.494965,4.759469 -4.67806,14.618368 -4.67806,22.097533c0,19.037874 -3.118707,30.596584 -6.549283,25.157191c-1.247483,-2.719696 -2.494965,20.737685 -2.183095,51.334268c0,30.936546 -0.623741,58.133509 -1.247483,60.853205c-0.31187,2.379734 0.935612,5.439393 3.118707,6.119317c1.871224,1.019886 3.742448,-0.679924 3.742448,-3.739583c0,-3.059659 3.430577,-6.119317 7.484896,-7.479165c4.36619,-1.019886 8.420508,-4.079545 9.35612,-7.139203c0.935612,-2.719696 3.118707,-3.739583 4.98993,-2.719696c1.871224,1.019886 3.118707,-1.359848 3.118707,-5.779355c0,-4.419507 3.742448,-11.558709 7.796766,-15.978216c4.36619,-4.419507 8.732378,-11.558709 9.667991,-15.978216c0.935612,-4.419507 3.742448,-8.159089 6.237413,-8.159089c2.494965,0 4.36619,-2.719696 4.36619,-5.779355c0,-3.059659 2.494965,-8.499051 5.301801,-11.898671c4.67806,-5.779355 4.67806,-7.139203 0.935612,-10.198861c-4.054318,-2.719696 -3.742448,-3.059659 0.623741,-1.69981c4.67806,1.69981 10.603603,-5.779355 9.35612,-11.898671c-0.31187,-1.69981 0.935612,-2.719696 2.806836,-2.719696c1.871224,0 2.806836,-2.379734 1.559353,-5.099431c-0.935612,-2.719696 -0.31187,-5.099431 1.247483,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 2.806836,-6.459279 6.237413,-8.499051c3.430577,-2.039772 5.925543,-4.759469 5.613672,-6.119317c-0.623741,-1.359848 3.118707,-6.799241 7.796766,-12.238633c9.044249,-10.538823 10.915473,-21.077647 4.67806,-23.117419c-2.183095,-1.019886 9.35612,-1.69981 25.573394,-1.69981c16.217274,-0.339962 27.132747,0.339962 24.014041,1.359848c-2.806836,0.679924 -5.301801,3.059659 -5.301801,4.759469c0,1.69981 -2.183095,3.059659 -4.98993,3.059659c-2.494965,0 -3.742448,1.69981 -2.494965,3.739583c0.935612,2.039772 0.935612,4.759469 -0.623741,6.119317c-1.559353,1.019886 -9.35612,11.218747 -17.152886,22.437495c-15.281663,21.757571 -24.637782,40.455482 -24.637782,48.614572c0,3.059659 -0.935612,4.079545 -1.871224,3.059659c-2.494965,-2.379734 -13.722309,12.238633 -13.722309,17.678026c0,2.039772 -1.559353,3.739583 -3.118707,3.739583c-1.871224,0 -3.118707,2.039772 -2.806836,4.419507c0.935612,7.479165 -0.31187,13.598481 -2.183095,11.558709c-2.494965,-2.719696 -16.841016,20.057761 -16.841016,26.517039c0,2.719696 -1.871224,5.099431 -3.742448,5.099431c-2.806836,0 -2.494965,1.359848 0.623741,3.399621c4.054318,2.719696 3.742448,3.399621 -1.247483,3.399621c-4.054318,0 -4.98993,1.69981 -3.742448,5.779355c1.247483,3.399621 1.247483,4.759469 0,3.739583c-0.935612,-1.359848 -5.613672,1.359848 -9.979861,5.779355c-7.173025,7.139203 -7.484896,8.839013 -3.430577,13.938444c3.742448,5.439393 3.742448,5.779355 -0.935612,3.739583c-5.925543,-2.379734 -15.905404,6.119317 -19.335981,16.318178c-1.559353,4.759469 -2.806836,5.439393 -4.67806,2.379734c-1.871224,-3.399621 -3.742448,-1.359848 -6.549283,5.779355c-2.183095,5.779355 -4.67806,10.538823 -5.925543,10.538823c-1.247483,0 -1.871224,6.459279 -1.871224,14.278406c0,12.238633 1.247483,14.95833 6.549283,15.638254c3.430577,0.679924 9.979861,-2.719696 14.969791,-7.819127c4.67806,-4.759469 9.044249,-8.499051 9.979861,-8.499051c0.935612,0 9.044249,-6.119317 18.400369,-13.598481c9.35612,-7.479165 18.088498,-13.598481 19.647851,-13.598481c1.559353,0 5.925543,-3.739583 9.979861,-8.159089c3.742448,-4.759469 10.603603,-9.518937 15.281663,-10.538823c4.67806,-1.019886 12.474826,-5.779355 17.152886,-10.198861c4.98993,-4.759469 11.539215,-8.499051 14.657921,-8.499051c4.054318,0 4.98993,-1.69981 3.742448,-5.779355c-1.559353,-4.079545 -0.623741,-5.099431 2.806836,-3.739583c2.806836,1.359848 8.732378,0 13.722309,-3.059659c4.98993,-2.719696 12.162956,-5.779355 16.217274,-6.459279c3.742448,-1.019886 9.667991,-4.419507 12.786697,-7.819127c3.430577,-3.739583 10.603603,-7.479165 16.217274,-8.839013c11.539215,-2.379734 31.187066,-11.898671 34.305773,-16.318178c0.935612,-1.359848 7.173025,-3.399621 14.03418,-4.419507c6.549283,-1.019886 12.786697,-2.719696 13.722309,-4.419507c0.935612,-1.69981 8.108638,-3.739583 16.217274,-5.099431c9.044249,-1.359848 15.281663,-4.419507 16.529145,-8.159089c1.559353,-4.419507 2.494965,-4.759469 4.36619,-1.019886c1.871224,3.059659 3.430577,3.399621 4.67806,0.679924c1.247483,-2.039772 4.98993,-3.739583 8.420508,-3.739583c3.118707,0 5.925543,-1.359848 5.925543,-3.399621c0,-1.69981 7.173025,-3.399621 15.593533,-3.399621c8.732378,0 15.593533,-1.359848 15.593533,-3.399621c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-1.559353,0 -2.183095,-4.419507 -0.935612,-10.198861c1.247483,-7.819127 0.623741,-10.198861 -2.806836,-10.198861c-3.118707,0 -5.301801,-4.419507 -6.549283,-11.218747c-0.935612,-6.119317 -5.925543,-21.077647 -11.227344,-33.31628c-5.301801,-12.238633 -9.667991,-24.137304 -9.667991,-26.177077c0,-3.059659 75.4727,-4.079545 299.707707,-4.079545l299.707707,0l-1.559353,46.914762c-2.806836,71.73199 -4.98993,91.109827 -13.410438,115.927055c-4.054318,12.238633 -10.603603,31.61647 -14.03418,42.495255c-3.430577,11.218747 -10.603603,30.256622 -15.593533,42.155293c-4.98993,12.238633 -9.044249,23.797342 -9.044249,25.837115c-0.31187,2.039772 -2.806836,9.858899 -6.237413,17.338064c-3.430577,7.479165 -5.925543,14.618368 -6.237413,16.318178c0,1.359848 -4.98993,10.198861 -10.915473,19.377837c-5.925543,9.178975 -10.915473,18.017988 -10.915473,19.377837c0,3.059659 -14.03418,18.017988 -16.529145,18.017988c-0.935612,0 -6.237413,4.419507 -11.539215,9.518937c-11.851085,11.898671 -35.553255,26.177077 -48.963694,29.236735c-5.301801,1.359848 -14.657921,7.819127 -20.583464,13.938444c-10.915473,11.558709 -11.227344,11.898671 -7.173025,26.177077c4.67806,18.697912 13.722309,23.797342 34.617644,21.077647c8.732378,-1.019886 18.71224,-4.079545 22.454688,-6.799241c3.742448,-2.719696 9.044249,-4.759469 11.539215,-4.759469c3.742448,0 15.281663,-8.499051 48.339953,-35.356052c2.494965,-2.039772 12.162956,-12.238633 21.207205,-22.437495c22.142817,-24.477266 36.176997,-50.994306 53.018013,-100.288801c2.494965,-7.479165 7.173025,-19.717799 10.291732,-27.196963c9.35612,-21.757571 18.71224,-48.614572 18.71224,-52.354154c0,-2.039772 2.494965,-10.198861 5.925543,-18.35795c11.539215,-28.556811 15.905404,-45.214951 16.217274,-65.272712c0.31187,-11.218747 2.494965,-23.797342 4.98993,-27.876887c2.183095,-4.079545 4.054318,-13.258519 4.054318,-19.717799c0,-6.799241 1.559353,-15.298292 3.118707,-19.037874c2.183095,-4.419507 2.183095,-6.459279 0,-6.459279c-1.871224,0 -3.118707,-10.538823 -3.118707,-26.857001c0,-18.35795 -1.247483,-27.536925 -3.742448,-28.556811c-2.183095,-1.019886 175.583183,-2.039772 395.452,-2.039772l399.506318,-0.339962l2.183095,26.177077c0.935612,14.278406 1.871224,49.294496 1.871224,77.851307c0,28.556811 1.247483,55.753774 3.118707,60.513243c1.559353,5.099431 4.054318,21.077647 4.98993,36.375938c1.247483,15.638254 4.67806,32.636356 8.108638,39.775558c3.118707,6.799241 5.613672,15.298292 5.613672,19.377837c0,3.739583 5.613672,19.037874 12.474826,33.996204c6.861155,14.95833 12.474826,29.236735 12.474826,31.61647c0,2.039772 1.247483,4.079545 2.806836,4.079545c1.559353,0 3.742448,4.079545 4.67806,8.839013c3.742448,15.978216 18.088498,36.7159 49.587435,71.73199c35.553255,39.775558 44.909375,44.535027 61.12665,31.61647c10.915473,-8.159089 14.657921,-19.377837 11.227344,-32.976318c-0.935612,-5.099431 -14.969791,-23.457381 -31.810807,-41.475369c-19.647851,-21.417609 -32.434549,-38.41571 -38.04822,-50.994306c-4.67806,-10.538823 -9.979861,-22.097533 -11.851085,-25.837115c-13.410438,-26.177077 -28.068359,-76.151497 -30.563325,-104.028384c-1.247483,-11.898671 -3.118707,-25.497153 -4.67806,-30.256622c-1.559353,-4.759469 -3.118707,-41.815331 -3.742448,-82.610776l-0.935612,-73.771763l159.98965,0c155.935331,0 159.677779,0 159.677779,6.459279c0,3.739583 -1.247483,7.819127 -3.118707,8.839013c-1.559353,1.019886 -3.118707,6.459279 -3.118707,11.898671c0,5.439393 -1.247483,10.878785 -3.118707,11.898671c-1.559353,1.019886 -3.118707,6.459279 -3.118707,12.238633c0,5.439393 -0.935612,9.858899 -2.183095,9.858899c-3.430577,0 -10.291732,16.998102 -10.291732,25.837115c0,4.079545 -2.183095,9.178975 -4.67806,11.558709c-2.494965,2.379734 -4.67806,7.479165 -4.67806,11.558709c0,8.839013 -12.786697,42.835217 -16.217274,42.835217c-1.247483,0 -2.494965,2.379734 -2.494965,5.099431c0,8.159089 -7.484896,32.296394 -9.979861,32.296394c-1.559353,0 -2.494965,4.079545 -2.494965,8.839013c0,4.759469 -1.247483,7.819127 -3.118707,6.459279c-1.559353,-1.019886 -3.118707,1.019886 -3.118707,4.759469c0,4.079545 -1.247483,7.139203 -3.118707,7.139203c-1.559353,0 -3.118707,2.719696 -3.118707,6.119317c0,3.399621 -1.871224,8.839013 -4.36619,12.578595c-2.183095,3.739583 -5.925543,12.578595 -7.796766,19.717799c-2.183095,6.799241 -4.98993,11.898671 -6.237413,10.878785c-1.559353,-0.679924 -4.36619,4.759469 -6.549283,11.898671c-2.183095,7.479165 -5.925543,15.298292 -8.420508,17.338064c-2.183095,2.039772 -4.054318,5.779355 -4.054318,8.159089c0,2.379734 -2.183095,6.119317 -4.67806,8.499051c-2.494965,2.379734 -4.67806,6.799241 -4.67806,10.198861c0,3.399621 -1.871224,6.799241 -4.36619,7.819127c-2.494965,1.019886 -5.925543,7.479165 -8.108638,13.938444c-1.871224,6.799241 -4.98993,11.558709 -6.549283,10.538823c-1.559353,-1.359848 -2.806836,1.69981 -2.806836,6.119317c0,4.759469 -1.871224,9.178975 -4.36619,10.198861c-4.054318,1.69981 -7.173025,6.799241 -18.088498,29.576697c-2.183095,4.419507 -8.108638,13.258519 -13.410438,19.377837c-15.593533,18.35795 -17.152886,20.737685 -17.152886,28.216849c0,4.759469 2.183095,6.799241 6.549283,6.799241c3.430577,0 5.301801,1.69981 4.36619,3.399621c-0.935612,2.039772 1.559353,3.399621 5.925543,3.399621c5.925543,0 7.484896,1.359848 5.925543,5.099431c-0.935612,3.059659 -0.623741,5.099431 0.935612,4.419507c5.613672,-1.359848 16.841016,4.759469 16.841016,9.518937c0,2.719696 1.871224,4.759469 4.054318,4.759469c2.183095,0 8.108638,4.759469 13.098568,10.198861c4.98993,5.779355 10.915473,10.198861 13.098568,10.198861c2.183095,0 4.054318,1.69981 4.054318,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,2.039772 4.67806,4.419507c0,2.719696 3.430577,6.799241 7.796766,9.178975c4.36619,2.379734 7.796766,5.779355 7.796766,7.479165c0,1.359848 2.183095,2.719696 4.67806,2.719696c2.494965,0 4.67806,1.69981 4.67806,3.739583c0,1.69981 4.36619,5.099431 9.667991,7.139203c7.173025,2.719696 8.420508,4.419507 5.301801,6.459279c-3.118707,2.379734 -2.806836,3.059659 0.935612,3.059659c2.806836,0 8.420508,3.739583 12.474826,8.499051c4.054318,4.419507 9.044249,8.499051 10.915473,8.499051c4.36619,0 44.909375,42.495255 44.909375,47.254724c0,2.039772 1.871224,3.739583 4.054318,3.739583c1.871224,0 8.732378,7.819127 14.657921,17.338064c5.925543,9.518937 13.722309,20.737685 17.152886,25.157191c13.722309,17.338064 17.152886,22.097533 17.152886,23.797342c0,1.69981 8.420508,13.258519 16.529145,22.777457c2.806836,3.399621 5.301801,7.479165 5.301801,9.178975c0,2.039772 2.806836,8.839013 6.549283,15.298292c3.742448,6.799241 5.301801,12.238633 3.742448,12.238633c-1.247483,0 0,1.69981 3.118707,3.739583c2.806836,1.69981 5.301801,6.459279 5.301801,9.858899c0,3.739583 1.559353,6.799241 3.118707,6.799241c1.871224,0 3.118707,3.059659 3.118707,7.139203c0,3.739583 1.247483,6.119317 2.806836,5.099431c3.118707,-2.039772 9.667991,12.578595 9.667991,21.757571c0,3.739583 1.247483,6.799241 3.118707,6.799241c1.559353,0 4.054318,4.079545 4.98993,9.178975c1.247483,5.439393 3.118707,11.218747 4.054318,12.918557c1.247483,2.039772 5.301801,12.578595 9.35612,23.797342c3.742448,11.218747 8.420508,23.117419 9.979861,26.177077c1.559353,3.399621 2.806836,10.878785 2.806836,16.318178c0,5.779355 1.247483,9.858899 2.494965,8.839013c2.806836,-2.039772 9.979861,27.196963 9.979861,40.455482c0,4.419507 1.559353,9.178975 3.118707,10.198861c1.871224,1.019886 3.118707,11.898671 3.118707,24.137304c0,11.898671 1.247483,21.757571 2.494965,21.757571c1.559353,0 5.301801,16.318178 8.420508,36.7159c3.118707,20.057761 6.861155,37.735786 8.108638,39.775558c3.430577,3.739583 3.742448,142.444095 0.623741,145.843715c-3.430577,3.739583 -9.979861,38.755672 -9.979861,54.733888c-0.31187,7.479165 -1.247483,17.338064 -2.494965,21.757571c-1.871224,7.819127 -2.183095,7.819127 -4.36619,1.69981c-1.247483,-3.739583 -2.494965,6.459279 -2.494965,24.477266c-0.31187,16.998102 -1.559353,35.356052 -3.118707,40.795444c-1.559353,5.439393 -4.67806,25.497153 -6.861155,44.874989c-2.183095,20.737685 -4.98993,33.31628 -6.549283,30.596584c-1.247483,-2.719696 -2.494965,2.039772 -2.494965,11.558709c0,8.839013 -1.247483,16.998102 -3.118707,18.017988c-1.559353,1.019886 -3.118707,7.139203 -3.118707,13.258519c0,6.459279 -2.183095,15.978216 -4.67806,21.077647c-2.494965,5.439393 -5.613672,15.298292 -6.549283,21.757571c-1.247483,6.459279 -5.301801,16.65814 -9.044249,22.097533c-4.054318,5.779355 -8.732378,19.037874 -10.915473,29.916659c-1.871224,10.538823 -4.67806,19.377837 -5.925543,19.377837c-0.935612,0 -4.054318,7.139203 -6.237413,16.318178c-2.494965,8.839013 -5.925543,16.998102 -7.484896,18.35795c-1.871224,1.019886 -3.742448,5.099431 -4.054318,8.499051c-0.623741,3.739583 -3.118707,11.218747 -5.925543,16.65814c-2.494965,5.439393 -4.67806,12.578595 -4.67806,15.638254c0,3.059659 -1.559353,6.799241 -3.118707,7.819127c-1.871224,1.359848 -5.613672,8.159089 -8.420508,15.638254c-2.494965,7.139203 -5.925543,13.258519 -7.484896,13.258519c-1.559353,0 -2.806836,2.379734 -2.806836,5.099431c0,6.119317 -10.603603,27.196963 -18.71224,36.375938c-3.430577,4.079545 -5.301801,8.499051 -4.36619,9.858899c0.623741,1.359848 -1.247483,4.759469 -4.36619,7.139203c-3.430577,2.379734 -5.925543,5.439393 -5.613672,6.799241c0,1.019886 -4.36619,7.819127 -9.667991,14.618368c-5.613672,6.799241 -10.291732,13.258519 -10.291732,13.938444c0,1.019886 -3.118707,5.439393 -6.861155,10.198861c-4.054318,4.759469 -9.979861,11.898671 -13.410438,16.318178c-3.430577,4.079545 -9.667991,13.258519 -14.03418,20.057761c-4.36619,6.799241 -8.732378,12.578595 -9.979861,12.578595c-1.559353,0 -2.494965,2.379734 -2.494965,5.439393c0,2.719696 -1.247483,4.079545 -3.118707,3.059659c-1.559353,-1.019886 -3.118707,-0.339962 -3.118707,1.359848c0,2.039772 1.559353,3.739583 3.118707,3.739583c1.871224,0 3.118707,2.039772 3.118707,4.759469c0,2.719696 0.935612,5.439393 2.494965,6.119317c1.247483,0.679924 5.925543,7.139203 10.915473,14.95833c4.67806,7.479165 11.227344,16.998102 14.657921,21.077647c3.430577,4.079545 6.237413,8.839013 6.237413,10.878785c0,1.69981 1.247483,3.399621 2.494965,3.399621c1.559353,0 4.67806,4.079545 7.173025,9.518937c2.494965,5.099431 6.861155,11.898671 10.291732,15.298292c3.118707,3.059659 4.98993,5.779355 3.742448,5.779355c-1.247483,0 0,2.379734 2.494965,5.439393c2.806836,2.719696 4.98993,7.139203 4.98993,9.178975c0,2.379734 3.430577,8.499051 7.796766,13.598481c4.36619,5.099431 7.484896,9.178975 6.549283,9.178975c-0.935612,0 1.871224,5.439393 5.925543,12.238633c4.36619,6.799241 7.796766,14.95833 7.796766,18.017988c0,4.759469 0.623741,4.759469 3.118707,0.339962c2.183095,-3.739583 3.118707,-2.379734 3.118707,6.459279c0,6.459279 0.935612,10.538823 2.183095,9.518937c0.935612,-1.359848 4.36619,3.739583 7.484896,11.218747c3.118707,7.479165 7.173025,13.598481 9.044249,13.598481c1.559353,0 3.118707,3.059659 3.118707,6.799241c0,3.739583 1.247483,6.799241 2.806836,6.799241c1.559353,0 3.430577,4.419507 4.36619,9.858899c0.935612,5.439393 3.742448,11.898671 5.925543,14.278406c2.183095,2.719696 5.925543,8.839013 8.420508,14.278406c2.494965,5.099431 5.613672,9.178975 7.173025,9.178975c1.247483,0 2.494965,3.059659 2.494965,7.139203c0,3.739583 2.183095,9.178975 4.67806,12.238633c2.494965,2.719696 4.054318,6.459279 3.118707,8.159089c-1.247483,1.69981 0.31187,3.059659 2.806836,3.059659c2.806836,0 4.98993,3.059659 4.98993,6.799241c0,3.739583 1.559353,6.799241 3.118707,6.799241c1.871224,0 3.118707,2.719696 3.118707,6.119317c0,3.399621 2.806836,9.518937 6.237413,13.598481c3.430577,4.079545 6.237413,9.178975 6.237413,11.218747c0,2.379734 3.430577,9.178975 7.796766,15.298292c4.36619,6.119317 7.796766,12.918557 7.796766,14.95833c0,3.739583 5.301801,16.318178 12.786697,30.596584c1.559353,2.719696 5.301801,10.538823 8.420508,16.998102c2.806836,6.459279 6.237413,12.578595 7.796766,12.918557c1.247483,0.679924 2.183095,3.399621 2.183095,6.119317c0,2.719696 1.247483,7.479165 2.806836,10.878785c1.559353,3.059659 4.67806,10.538823 6.861155,16.65814c2.183095,5.779355 5.301801,9.858899 6.549283,9.178975c1.247483,-1.019886 2.494965,2.039772 2.494965,6.799241c0,4.759469 1.559353,9.518937 3.118707,10.538823c1.871224,1.019886 3.118707,4.759469 3.118707,8.499051c0,3.399621 2.183095,6.799241 4.67806,8.159089c2.494965,1.019886 4.67806,4.079545 4.67806,6.799241c0,8.159089 6.861155,22.437495 9.667991,20.397723c1.559353,-1.019886 2.806836,2.039772 2.806836,7.139203c0,4.759469 1.247483,11.558709 3.118707,15.298292c1.871224,3.739583 4.67806,9.858899 6.237413,13.598481c1.871224,3.739583 3.118707,9.178975 3.118707,11.898671c0,2.719696 1.247483,5.099431 2.494965,5.099431c1.247483,0 4.36619,7.139203 6.549283,16.318178c2.494965,8.839013 5.613672,17.678026 7.173025,20.057761c1.559353,2.039772 5.613672,16.65814 9.044249,32.296394c9.979861,43.175179 4.67806,101.308688 -9.044249,101.308688c-2.494965,0 -3.742448,2.039772 -2.494965,5.099431c1.247483,4.419507 -2.494965,5.099431 -23.078429,5.099431c-13.410438,0 -25.261524,-1.359848 -26.197136,-3.059659c-0.935612,-1.359848 -12.162956,-6.799241 -25.261524,-12.238633c-12.786697,-5.099431 -24.325912,-10.538823 -25.261524,-12.238633c-0.935612,-1.69981 -4.36619,-3.059659 -7.796766,-3.059659c-3.118707,0 -5.925543,-1.359848 -5.925543,-3.399621c0,-1.69981 -3.430577,-3.399621 -7.796766,-3.399621c-4.36619,0 -7.796766,-1.019886 -7.796766,-2.719696c0,-1.359848 -4.67806,-4.419507 -9.979861,-6.799241c-5.613672,-2.379734 -12.786697,-6.119317 -15.593533,-7.819127c-3.118707,-1.69981 -8.732378,-3.059659 -12.474826,-3.059659c-3.742448,0 -5.613672,-1.019886 -4.67806,-2.379734c2.494965,-2.379734 -11.851085,-11.218747 -18.400369,-11.218747c-2.494965,0 -4.36619,-2.379734 -4.36619,-5.099431c0,-2.719696 -2.806836,-5.099431 -5.925543,-5.099431c-3.430577,0 -7.173025,-1.359848 -8.108638,-3.399621c-0.935612,-1.69981 -6.549283,-3.399621 -11.851085,-3.739583c-8.420508,0 -9.044249,-0.679924 -3.742448,-3.059659c5.301801,-2.379734 5.301801,-3.059659 0.935612,-3.059659c-3.118707,-0.339962 -12.162956,-4.419507 -20.271593,-9.518937c-8.108638,-4.759469 -19.959722,-11.898671 -25.885265,-15.638254c-5.925543,-3.739583 -11.539215,-7.479165 -12.474826,-8.839013c-3.118707,-4.079545 -15.593533,-10.538823 -20.271593,-10.538823c-2.806836,0 -4.054318,-1.359848 -3.118707,-3.399621c0.935612,-1.69981 -0.31187,-3.399621 -2.806836,-3.399621c-4.36619,0 -11.539215,-5.099431 -22.142817,-15.978216c-2.183095,-2.039772 -9.979861,-7.139203 -17.776628,-11.218747c-7.796766,-3.739583 -19.335981,-12.238633 -25.885265,-18.697912c-6.549283,-6.459279 -12.786697,-11.898671 -14.03418,-11.898671c-1.247483,0 -6.549283,-4.419507 -11.851085,-9.858899c-5.301801,-5.779355 -14.969791,-13.938444 -21.519076,-18.35795c-6.549283,-4.759469 -15.281663,-11.898671 -19.647851,-16.318178c-4.054318,-4.419507 -8.732378,-7.819127 -9.979861,-7.139203c-1.559353,0.339962 -2.494965,-0.679924 -2.494965,-2.719696c0,-1.69981 -3.742448,-5.439393 -8.420508,-8.159089c-4.98993,-2.719696 -7.484896,-5.099431 -6.237413,-5.439393c3.742448,0 -23.390299,-27.196963 -27.444619,-27.196963c-1.559353,0 -4.98993,-4.759469 -7.173025,-10.198861c-2.494965,-5.779355 -5.301801,-9.518937 -6.861155,-8.499051c-2.806836,2.039772 -15.593533,-15.978216 -15.593533,-21.757571c0,-2.039772 -1.871224,-3.739583 -4.36619,-3.739583c-2.494965,0 -6.549283,-3.059659 -9.044249,-6.799241c-2.494965,-3.739583 -5.301801,-5.779355 -6.237413,-4.419507c-1.247483,1.019886 -2.183095,0.339962 -2.183095,-2.039772c0,-2.039772 -3.118707,-7.479165 -6.861155,-11.898671c-4.054318,-4.419507 -11.227344,-13.598481 -16.529145,-20.737685c-4.98993,-6.799241 -13.410438,-17.678026 -18.71224,-23.457381c-4.98993,-6.119317 -9.667991,-12.918557 -10.291732,-15.298292c-0.31187,-2.379734 -2.806836,-6.799241 -5.301801,-9.518937c-2.806836,-2.719696 -4.054318,-6.119317 -3.118707,-7.819127c0.935612,-1.69981 -1.247483,-3.739583 -4.67806,-5.099431c-5.613672,-2.039772 -7.484896,-5.779355 -6.549283,-12.578595c0,-1.69981 -1.559353,-2.719696 -3.430577,-2.719696c-2.183095,0 -7.484896,-8.159089 -11.851085,-18.017988c-10.915473,-25.157191 -11.539215,-25.837115 -26.197136,-20.057761c-7.173025,2.379734 -14.03418,6.119317 -15.905404,7.819127c-1.559353,1.69981 -7.796766,3.059659 -13.722309,3.059659c-10.603603,0 -27.756489,4.759469 -38.360092,10.538823c-3.118707,1.69981 -8.420508,3.059659 -11.539215,3.059659c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -4.36619,3.399621 -9.35612,3.399621c-5.301801,0 -11.851085,1.359848 -14.969791,3.399621c-2.806836,1.69981 -16.217274,5.779355 -29.315842,8.839013c-13.410438,3.059659 -23.702171,6.799241 -22.766559,8.159089c0.935612,1.359848 -11.539215,3.399621 -27.444619,4.419507c-15.593533,1.359848 -42.10254,3.739583 -58.319814,5.439393c-16.217274,2.039772 -43.973763,4.759469 -61.438521,5.779355c-17.776628,1.359848 -32.122678,3.059659 -32.122678,4.079545c0,2.379734 19.335981,21.077647 22.142817,21.077647c1.247483,0 6.237413,3.739583 10.603603,8.159089c10.603603,10.538823 13.098568,28.556811 6.549283,43.175179c-2.806836,5.779355 -4.98993,12.918557 -4.98993,15.638254c0,2.379734 -2.183095,5.439393 -4.67806,6.459279c-2.494965,1.359848 -4.67806,5.779355 -4.67806,10.198861c0,4.419507 -1.247483,8.159089 -3.118707,8.159089c-1.559353,0 -3.118707,3.739583 -3.118707,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,2.379734 -3.118707,5.099431c0,2.719696 -1.247483,5.099431 -3.118707,5.099431c-1.559353,0 -3.118707,1.69981 -3.118707,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.806836,0 5.613672,2.379734 6.549283,5.099431c1.247483,2.719696 3.742448,5.099431 6.237413,5.099431c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,2.039772 3.430577,3.399621 7.796766,3.399621c4.36619,0 7.796766,1.359848 7.796766,2.719696c0,1.69981 4.98993,4.759469 10.915473,7.479165c5.925543,2.719696 10.915473,5.779355 10.915473,7.479165c0,1.359848 2.806836,2.719696 6.549283,2.719696c3.430577,0 5.613672,1.359848 4.36619,3.399621c-0.935612,1.69981 4.054318,4.759469 10.915473,6.799241c6.861155,2.039772 12.474826,5.099431 12.474826,6.799241c0,2.039772 2.806836,3.399621 6.237413,3.399621c3.118707,0 7.173025,2.039772 8.420508,4.419507c2.494965,4.079545 25.885265,17.678026 29.627713,16.65814c0.935612,-0.339962 3.742448,1.69981 5.613672,4.419507c2.183095,2.719696 7.173025,5.099431 11.539215,5.099431c4.054318,0 6.861155,1.359848 5.925543,3.059659c-1.247483,1.69981 4.054318,5.439393 11.227344,7.819127c7.173025,2.719696 15.593533,8.499051 18.71224,13.258519c6.861155,9.858899 8.420508,38.075748 3.118707,62.553015c-1.871224,9.518937 -4.36619,21.757571 -5.301801,27.196963c-1.247483,5.779355 -4.67806,16.318178 -7.796766,23.797342c-3.430577,7.479165 -6.861155,18.017988 -7.796766,23.117419c-0.935612,5.099431 -3.118707,8.499051 -4.67806,7.479165c-1.871224,-1.019886 -3.118707,1.69981 -3.118707,6.459279c0,4.759469 -1.247483,9.518937 -3.118707,10.538823c-1.559353,1.019886 -3.118707,5.099431 -3.118707,8.839013c0,3.739583 -1.247483,5.779355 -3.118707,4.759469c-1.559353,-1.019886 -3.118707,0.339962 -3.118707,3.059659c0,6.459279 -12.474826,36.035977 -17.776628,42.155293c-1.871224,2.039772 -4.67806,7.139203 -5.613672,10.878785c-1.871224,6.119317 -4.67806,6.799241 -33.05829,6.799241c-28.692101,0 -30.875196,-0.339962 -30.875196,-6.799241c0,-3.739583 0.935612,-6.799241 2.494965,-6.799241c1.247483,0 5.613672,-8.159089 9.979861,-18.017988c4.36619,-9.518937 9.667991,-19.037874 11.851085,-20.397723c1.871224,-1.359848 3.742448,-4.759469 3.742448,-7.139203c0,-6.119317 7.484896,-22.437495 10.291732,-22.437495c1.247483,0 2.183095,-2.379734 2.183095,-5.099431c0,-2.719696 1.247483,-5.099431 2.494965,-5.099431c1.559353,0 4.67806,-6.459279 6.861155,-14.278406c2.183095,-8.159089 4.98993,-17.678026 6.237413,-21.417609c1.559353,-3.739583 4.36619,-12.918557 6.237413,-20.397723c2.183095,-7.479165 5.613672,-18.017988 8.108638,-23.117419c10.291732,-22.437495 4.67806,-33.31628 -22.142817,-43.515141c-6.861155,-2.719696 -15.281663,-7.479165 -18.400369,-10.538823c-3.430577,-3.399621 -8.732378,-6.119317 -11.851085,-6.119317c-3.118707,0 -5.613672,-1.359848 -5.613672,-3.059659c0,-1.69981 -9.044249,-7.139203 -20.271593,-12.238633c-11.227344,-5.439393 -20.271593,-10.878785 -20.271593,-12.238633c0,-1.359848 -4.98993,-4.419507 -10.915473,-6.799241c-5.925543,-2.379734 -10.915473,-5.439393 -10.915473,-6.799241c0,-1.359848 -3.430577,-3.399621 -7.796766,-4.419507c-4.36619,-1.359848 -10.603603,-4.759469 -13.410438,-8.159089c-3.118707,-3.059659 -11.227344,-8.839013 -17.776628,-12.578595c-18.400369,-10.198861 -38.671962,-33.31628 -39.607574,-44.874989c-1.247483,-19.717799 0.935612,-26.857001 11.539215,-39.435596c5.925543,-7.139203 10.915473,-15.298292 10.915473,-18.017988c0,-2.719696 1.559353,-4.759469 3.118707,-4.759469c1.871224,0 3.118707,-3.739583 3.118707,-8.499051c0,-4.759469 1.559353,-8.499051 3.118707,-8.499051c5.301801,0 3.430577,-16.998102 -2.183095,-19.377837c-2.806836,-1.359848 -9.35612,-6.459279 -14.657921,-11.898671c-4.98993,-5.099431 -9.979861,-9.518937 -11.539215,-9.518937c-2.806836,0 -16.529145,-12.238633 -25.573394,-22.777457c-5.613672,-7.139203 -9.35612,-7.819127 -33.993902,-7.819127c-14.969791,0 -27.444619,1.019886 -27.444619,2.039772c0,3.739583 9.044249,11.558709 13.722309,11.558709c5.925543,0 23.702171,19.377837 24.014041,26.517039c1.247483,22.777457 -8.108638,55.07385 -15.905404,55.07385c-1.871224,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,2.379734 -3.118707,5.439393c0,2.719696 -1.247483,4.419507 -2.494965,3.399621c-1.559353,-1.019886 -4.67806,3.399621 -6.861155,9.858899c-2.494965,6.459279 -5.301801,11.898671 -6.549283,11.898671c-1.247483,0 -6.237413,7.139203 -10.915473,16.318178c-4.67806,8.839013 -9.35612,16.65814 -10.291732,17.678026c-0.935612,1.019886 -4.054318,6.459279 -6.549283,11.898671c-2.494965,5.779355 -5.301801,10.878785 -6.237413,11.898671c-4.36619,4.759469 -12.162956,23.117419 -10.291732,25.157191c0.935612,1.019886 0.31187,2.039772 -1.559353,2.039772c-2.183095,0 -3.742448,3.059659 -3.742448,6.799241c0,3.739583 -2.806836,10.198861 -6.237413,14.618368c-12.786697,15.298292 -14.346051,18.017988 -18.71224,32.976318c-2.494965,8.499051 -5.613672,16.318178 -7.173025,17.338064c-1.247483,1.019886 -2.806836,5.099431 -3.118707,9.178975c0,3.739583 -1.559353,6.119317 -2.806836,5.439393c-1.247483,-1.019886 -2.494965,1.359848 -2.494965,5.099431c0,4.079545 -1.559353,7.139203 -3.430577,7.139203c-1.871224,0 -2.806836,5.439393 -2.183095,12.578595c0.623741,9.518937 2.806836,13.938444 8.420508,16.65814c4.054318,2.379734 8.108638,5.439393 9.35612,7.139203c0.935612,1.359848 5.613672,4.759469 10.291732,7.479165c4.67806,2.719696 11.227344,7.139203 14.346051,10.198861c8.420508,7.819127 18.71224,13.938444 24.014041,13.938444c2.494965,0 4.67806,1.359848 4.67806,2.719696c0,1.69981 6.549283,6.799241 14.969791,11.218747c8.108638,4.419507 15.905404,9.858899 17.152886,12.238633c1.247483,2.379734 5.301801,4.419507 8.420508,4.419507c3.430577,0 9.044249,3.059659 12.474826,6.799241c3.430577,3.739583 8.108638,6.799241 10.603603,6.799241c2.494965,0 4.98993,1.019886 5.613672,2.719696c0.623741,1.359848 8.108638,6.119317 16.529145,10.538823c8.732378,4.419507 18.088498,9.178975 20.895334,10.878785c3.118707,1.69981 7.796766,3.059659 10.291732,3.059659c2.494965,0 4.67806,2.039772 4.67806,4.419507c0,2.719696 6.861155,6.459279 15.593533,9.178975c8.420508,2.379734 14.657921,5.779355 13.722309,7.479165c-0.935612,1.359848 1.247483,2.719696 4.67806,2.719696c3.430577,0 7.173025,1.69981 8.108638,3.399621c1.247483,2.379734 -19.335981,3.399621 -59.879167,3.059659l-61.750391,-0.339962l-17.464757,-10.538823l0.000003,-0.000007l0.000016,-0.000008zm1002.352309,-260.070961c-0.935612,-29.236735 -3.118707,-55.07385 -4.67806,-57.453585c-1.559353,-2.379734 -4.36619,-18.35795 -5.613672,-35.696015c-4.36619,-47.934648 -11.851085,-95.869296 -15.593533,-97.229143c-1.559353,-0.679924 -3.118707,-6.459279 -3.118707,-12.918557c0,-13.258519 -6.549283,-38.755672 -9.979861,-38.755672c-1.559353,0 -2.494965,-2.379734 -2.494965,-5.099431c0,-4.759469 -11.227344,-28.896773 -15.281663,-32.296394c-0.935612,-1.019886 -5.925543,-10.878785 -11.227344,-22.097533c-4.98993,-11.218747 -10.291732,-20.737685 -11.539215,-21.417609c-1.559353,-0.679924 -2.494965,-4.079545 -2.494965,-7.819127c0,-3.399621 -1.247483,-6.459279 -3.118707,-6.459279c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-2.719696 -0.935612,-5.099431 -2.183095,-5.099431c-3.118707,0 -10.291732,-16.65814 -10.291732,-23.117419c0,-2.379734 -1.247483,-3.399621 -3.118707,-2.379734c-1.559353,1.019886 -3.118707,-0.339962 -3.118707,-3.059659c0,-3.059659 -1.247483,-5.439393 -3.118707,-5.439393c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-3.059659 -2.183095,-6.119317 -4.67806,-7.139203c-2.494965,-1.359848 -4.67806,-4.079545 -4.67806,-6.459279c0,-6.119317 -12.474826,-29.236735 -19.335981,-36.035977c-3.118707,-3.059659 -5.613672,-8.159089 -5.613672,-11.218747c0,-3.059659 -2.183095,-5.439393 -4.98993,-5.439393c-2.494965,0 -4.054318,-1.359848 -3.118707,-2.719696c0.935612,-1.69981 -1.247483,-6.119317 -4.36619,-10.198861c-3.430577,-4.079545 -6.237413,-8.159089 -6.237413,-9.518937c0,-1.359848 -2.183095,-4.759469 -4.67806,-7.819127c-13.410438,-16.318178 -16.217274,-20.057761 -18.088498,-25.157191c-2.806836,-8.159089 -8.108638,-7.139203 -15.281663,2.719696c-3.430577,4.759469 -8.108638,8.499051 -10.603603,8.499051c-2.494965,0 -8.108638,3.739583 -12.162956,8.159089c-4.054318,4.759469 -10.603603,9.178975 -14.03418,10.538823c-3.430577,1.019886 -6.237413,4.419507 -6.237413,7.139203c0,2.719696 -1.871224,4.759469 -4.36619,4.759469c-2.494965,0 -9.044249,4.419507 -14.657921,9.858899c-5.613672,5.779355 -14.03418,11.898671 -19.024111,14.278406c-4.67806,2.039772 -7.796766,5.099431 -6.861155,6.799241c0.935612,1.69981 -0.623741,3.059659 -3.118707,3.059659c-2.806836,0 -6.549283,3.059659 -8.732378,6.799241c-2.183095,3.739583 -5.613672,6.799241 -7.796766,6.799241c-2.183095,0 -4.054318,1.359848 -4.054318,3.059659c0,1.69981 -3.430577,4.079545 -7.796766,5.099431c-4.36619,1.359848 -7.796766,3.739583 -7.796766,5.439393c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.806836,3.399621 -6.237413,3.399621c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -3.118707,3.399621 -6.861155,3.399621c-3.742448,0 -5.613672,1.019886 -4.67806,2.379734c2.494965,2.719696 -19.335981,17.678026 -25.885265,18.017988c-5.925543,0 -13.410438,12.578595 -9.35612,15.298292c1.871224,1.019886 3.118707,5.099431 3.118707,8.839013c0,3.399621 0.935612,6.459279 2.494965,6.459279c1.247483,0 5.613672,6.799241 9.979861,15.298292c4.36619,8.499051 8.732378,15.298292 9.979861,15.298292c1.247483,0 4.67806,5.439393 7.484896,11.898671c2.806836,6.459279 6.237413,11.898671 7.796766,11.898671c1.559353,0 4.36619,3.739583 6.549283,8.159089c4.98993,9.858899 19.024111,29.236735 33.682032,46.234837c28.068359,32.976318 37.42448,44.535027 37.42448,47.594686c0,2.039772 0.935612,3.059659 2.494965,2.719696c1.247483,-0.679924 8.732378,6.459279 17.152886,15.298292c8.108638,8.839013 15.281663,15.978216 16.217274,15.978216c0.935612,0 8.732378,7.479165 17.152886,16.65814c8.732378,9.178975 19.647851,18.697912 24.325912,21.077647c4.67806,2.039772 12.162956,9.178975 16.217274,15.298292c4.36619,5.779355 8.732378,10.198861 9.667991,9.518937c1.247483,-0.679924 3.742448,1.019886 5.925543,3.739583c2.183095,2.719696 5.925543,5.099431 8.108638,5.099431c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,2.039772 1.871224,3.399621 4.054318,3.399621c1.871224,0 8.108638,4.419507 13.098568,9.518937c5.301801,5.099431 15.905404,13.598481 24.325912,18.697912c8.108638,5.099431 14.657921,10.538823 14.657921,11.898671c0,1.359848 7.796766,6.119317 17.152886,10.878785c9.35612,4.759469 17.152886,9.518937 17.152886,11.218747c0,1.359848 2.183095,2.379734 4.67806,2.379734c2.494965,0 4.67806,1.359848 4.67806,3.059659c0,1.69981 8.420508,6.799241 18.71224,11.218747c10.291732,4.079545 18.71224,9.858899 18.71224,11.898671c0,2.379734 2.806836,4.419507 6.237413,4.419507c3.430577,0 6.237413,1.69981 6.237413,3.399621c0,2.039772 2.806836,3.399621 6.549283,3.399621c3.430577,0 5.613672,1.359848 4.36619,3.059659c-1.871224,3.399621 9.979861,6.459279 16.217274,4.419507c2.494965,-0.679924 3.118707,-15.638254 1.871224,-54.393926l-0.000002,-0.000004l0.000008,-0.000004zm-1930.79127,-14.278406c4.36619,-3.399621 8.732378,-5.439393 9.979861,-4.419507c0.935612,1.019886 1.871224,0.679924 1.871224,-1.359848c0,-1.69981 5.613672,-6.119317 12.474826,-9.518937c6.861155,-3.399621 12.474826,-7.479165 12.474826,-9.178975c0,-1.359848 2.806836,-2.719696 6.237413,-2.719696c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 2.183095,-3.399621 4.98993,-3.399621c2.494965,0 3.742448,-1.359848 2.806836,-3.399621c-0.935612,-1.69981 0.935612,-3.399621 4.36619,-3.399621c3.742448,0 6.549283,-1.359848 6.549283,-3.399621c0,-1.69981 1.871224,-3.399621 4.36619,-3.399621c5.925543,0 20.895334,-8.839013 18.71224,-11.218747c-0.935612,-1.019886 1.559353,-3.739583 5.613672,-6.119317c3.742448,-2.039772 8.420508,-6.119317 9.667991,-8.499051c1.247483,-2.719696 4.67806,-4.759469 6.861155,-4.759469c2.494965,0 4.67806,-1.359848 4.67806,-3.399621c0,-1.69981 1.559353,-3.399621 3.118707,-3.399621c3.742448,0 22.766559,-13.938444 24.325912,-17.678026c0.623741,-1.69981 2.183095,-2.719696 3.742448,-2.719696c2.494965,0 9.979861,-6.459279 28.692101,-24.477266c4.98993,-5.439393 10.603603,-9.518937 12.162956,-9.518937c1.559353,0 2.806836,-1.69981 2.806836,-3.739583c0,-4.079545 7.796766,-13.258519 11.539215,-13.258519c1.247483,0 6.549283,-4.759469 11.539215,-10.198861c4.98993,-5.779355 10.291732,-10.198861 11.851085,-10.198861c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-2.719696 3.430577,-6.799241 7.796766,-9.178975c4.36619,-2.379734 7.796766,-6.799241 7.796766,-9.518937c0,-3.059659 0.935612,-4.419507 1.871224,-3.059659c1.871224,2.039772 10.603603,-5.439393 10.603603,-9.518937c0,-1.019886 3.430577,-5.439393 7.796766,-9.858899c4.36619,-4.419507 7.796766,-9.518937 7.796766,-11.558709c0,-2.039772 2.806836,-4.759469 6.237413,-5.779355c3.430577,-1.019886 6.237413,-3.739583 6.237413,-5.779355c0,-1.69981 4.36619,-7.819127 9.35612,-12.918557c5.301801,-5.099431 9.35612,-10.878785 9.35612,-12.578595c0,-1.359848 5.613672,-9.518937 12.162956,-17.678026c6.861155,-8.499051 11.851085,-16.318178 11.227344,-17.338064c-0.623741,-1.359848 1.559353,-4.419507 4.98993,-6.799241c3.118707,-2.719696 5.925543,-6.799241 5.925543,-9.178975c0,-2.379734 1.247483,-4.419507 2.806836,-4.419507c1.559353,0 4.36619,-4.419507 6.549283,-10.198861c2.183095,-5.439393 4.98993,-10.198861 6.549283,-10.198861c1.559353,0 2.806836,-2.379734 2.806836,-5.099431c0,-3.059659 2.806836,-8.499051 6.237413,-12.578595c3.430577,-4.079545 6.237413,-9.178975 6.237413,-11.558709c0,-4.759469 -25.261524,-25.157191 -31.187066,-25.157191c-1.871224,0 -4.054318,-2.379734 -4.98993,-5.099431c-1.247483,-2.719696 -3.742448,-5.099431 -6.237413,-5.099431c-2.494965,0 -4.36619,-1.359848 -4.36619,-3.399621c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-2.806836,0 -10.915473,-6.459279 -20.271593,-15.978216c-2.494965,-2.379734 -4.98993,-4.419507 -5.925543,-4.419507c-1.871224,0 -3.118707,-1.019886 -26.820877,-23.797342c-7.796766,-7.479165 -14.969791,-13.598481 -16.217274,-13.598481c-0.935612,0 -21.830946,-21.077647 -45.844987,-47.254724l-44.285634,-46.914762l-10.603603,11.558709c-5.925543,6.459279 -10.915473,12.578595 -10.915473,13.258519c0,2.379734 -13.098568,21.757571 -22.454688,33.31628c-8.108638,9.518937 -9.044249,11.558709 -8.732378,17.678026c0.31187,1.019886 -2.806836,4.759469 -6.861155,8.159089c-4.054318,3.739583 -5.925543,6.459279 -4.67806,6.799241c1.247483,0 -0.623741,3.399621 -4.054318,7.819127c-3.430577,4.079545 -12.786697,18.35795 -20.271593,31.276508c-7.484896,13.258519 -14.969791,25.497153 -16.529145,27.196963c-1.247483,2.039772 -4.67806,8.499051 -6.861155,14.618368c-2.494965,5.779355 -5.613672,10.878785 -6.549283,10.878785c-0.935612,0 -5.301801,8.499051 -9.35612,18.697912c-4.054318,10.198861 -8.108638,18.697912 -9.35612,18.697912c-0.935612,0 -4.36619,6.119317 -7.484896,13.598481c-3.118707,7.479165 -6.861155,13.598481 -8.420508,13.598481c-1.247483,0 -2.494965,3.059659 -2.494965,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -0.935612,6.799241 -2.183095,6.799241c-8.732378,0 -10.291732,21.417609 -10.291732,131.905271c0,106.068156 3.118707,157.062462 9.35612,157.062462c1.247483,0 5.925543,-3.059659 9.979861,-6.799241l-0.000002,0.000007l0.000006,0zm1090.923576,-286.927962c103.852931,-10.198861 140.341798,-15.298292 140.341798,-19.377837c0,-1.359848 11.539215,-3.399621 25.885265,-4.419507c25.885265,-1.69981 62.686003,-7.139203 56.760461,-8.499051c-1.559353,-0.679924 6.861155,-3.739583 18.71224,-7.139203c12.162956,-3.399621 26.197136,-7.819127 31.187066,-9.518937c5.301801,-2.039772 17.152886,-6.119317 26.509006,-9.518937c17.464757,-5.779355 34.617644,-12.918557 44.285634,-18.697912c3.118707,-1.69981 8.420508,-3.059659 11.851085,-3.059659c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 1.871224,-3.399621 4.054318,-3.399621c1.871224,-0.339962 11.539215,-4.759469 20.895334,-10.198861c9.35612,-5.439393 21.830946,-12.238633 27.444619,-15.298292c5.301801,-2.719696 9.979861,-6.799241 9.979861,-8.499051c0,-2.039772 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 2.183095,-3.399621 4.67806,-3.399621c2.494965,0 4.67806,-1.359848 4.67806,-3.059659c0,-1.69981 2.494965,-3.739583 5.613672,-4.759469c7.796766,-2.719696 23.702171,-13.598481 26.197136,-18.017988c1.247483,-2.039772 6.549283,-5.779355 11.851085,-8.159089c4.98993,-2.379734 8.732378,-5.099431 8.108638,-6.459279c-0.935612,-1.359848 2.494965,-4.079545 7.173025,-6.459279c4.67806,-2.379734 11.539215,-7.139203 15.281663,-10.878785c3.742448,-3.739583 7.484896,-6.799241 8.732378,-6.799241c1.247483,0 4.36619,-2.719696 7.173025,-6.119317c2.806836,-3.059659 12.162956,-11.898671 20.583464,-19.037874c19.335981,-16.65814 24.637782,-21.757571 41.166927,-40.11552c32.122678,-35.356052 53.953625,-62.553015 53.953625,-66.63256c0,-2.379734 1.559353,-3.399621 3.118707,-2.379734c1.871224,1.019886 3.118707,-0.339962 3.118707,-3.059659c0,-2.719696 3.118707,-7.819127 7.173025,-11.218747c3.742448,-3.399621 10.291732,-11.898671 14.346051,-18.697912c3.742448,-7.139203 8.420508,-12.918557 9.979861,-12.918557c1.559353,0 2.806836,-2.039772 2.806836,-4.419507c0,-2.379734 3.118707,-8.159089 7.173025,-12.578595c14.657921,-17.338064 45.844987,-70.372142 45.844987,-78.531231c0,-3.739583 1.247483,-6.119317 2.806836,-5.099431c2.494965,1.69981 12.162956,-25.497153 10.291732,-28.216849c-0.623741,-0.679924 0,-2.379734 1.559353,-3.399621c1.559353,-1.019886 5.925543,-9.518937 9.979861,-19.037874c3.742448,-9.178975 9.044249,-21.417609 11.227344,-26.517039c2.494965,-5.439393 4.67806,-11.898671 4.67806,-14.618368c0,-2.719696 1.247483,-7.479165 2.806836,-10.878785c1.559353,-3.059659 4.67806,-12.918557 7.173025,-21.757571c2.183095,-9.178975 4.98993,-16.318178 6.237413,-16.318178c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-2.379734 3.430577,-11.898671 7.796766,-21.417609c6.861155,-14.95833 9.35612,-27.536925 16.841016,-83.630661c1.247483,-8.499051 3.742448,-17.678026 5.613672,-20.397723c1.871224,-2.379734 4.36619,-13.598481 5.613672,-24.817229c1.247483,-11.218747 3.430577,-29.576697 4.67806,-40.795444c1.247483,-11.218747 2.494965,-18.697912 3.118707,-16.998102c0.623741,2.039772 2.183095,-9.518937 3.742448,-25.497153c1.247483,-15.978216 3.118707,-38.755672 4.36619,-50.994306c0.935612,-12.238633 3.430577,-23.117419 5.613672,-24.477266c4.67806,-3.399621 4.36619,-87.030282 -0.623741,-96.209257c-3.118707,-6.119317 -3.430577,-5.439393 -2.183095,4.079545c1.247483,11.558709 -3.430577,18.697912 -6.549283,9.858899c-0.935612,-2.719696 -3.742448,-4.079545 -6.237413,-3.059659c-5.301801,2.039772 -19.959722,-1.359848 -19.959722,-5.099431c0,-5.099431 18.088498,-10.198861 21.519076,-6.459279c3.742448,4.079545 3.742448,3.739583 4.98993,-17.338064c0.623741,-7.819127 -0.31187,-13.598481 -1.871224,-12.238633c-1.559353,1.019886 -2.806836,-1.69981 -2.806836,-5.779355c0,-12.918557 -4.36619,-3.739583 -6.237413,13.258519c-1.247483,13.938444 -2.494965,15.978216 -9.35612,17.338064c-4.36619,0.339962 -8.732378,2.719696 -9.979861,5.099431c-1.871224,2.719696 -2.494965,2.379734 -2.494965,-1.019886c0,-2.379734 -1.871224,-3.739583 -4.67806,-2.379734c-2.806836,1.019886 -4.67806,0 -4.67806,-3.059659c0,-2.719696 -1.247483,-5.099431 -2.806836,-5.099431c-6.237413,0 -12.786697,-10.878785 -11.227344,-18.017988c0.935612,-4.419507 -0.935612,-11.558709 -4.67806,-17.678026c-5.301801,-8.499051 -6.237413,-9.178975 -6.237413,-3.399621c-0.31187,9.518937 -12.474826,-17.678026 -12.474826,-27.536925c0,-4.079545 -2.806836,-13.938444 -6.237413,-22.097533c-3.430577,-8.159089 -6.237413,-19.377837 -6.237413,-24.477266c0,-5.439393 -1.247483,-8.839013 -2.806836,-7.819127c-3.118707,2.379734 -11.227344,-121.366448 -8.732378,-137.684626c4.67806,-33.31628 5.613672,-38.41571 6.549283,-39.435596c1.871224,-2.379734 16.217274,-2.039772 23.078429,0.339962c4.054318,1.69981 6.861155,1.019886 6.861155,-1.019886c0,-2.039772 -2.806836,-3.739583 -6.237413,-3.739583c-4.98993,0 -6.237413,-2.379734 -6.549283,-10.878785c-0.31187,-6.119317 -0.31187,-12.918557 0,-14.95833c0.31187,-2.379734 -1.559353,-4.759469 -4.36619,-6.119317c-2.494965,-1.019886 -4.67806,-4.079545 -4.67806,-7.139203c0,-3.059659 -2.806836,-8.499051 -6.237413,-12.578595c-3.430577,-4.079545 -6.237413,-9.518937 -6.237413,-12.578595c0,-2.719696 -0.935612,-4.079545 -1.871224,-2.719696c-2.183095,2.039772 -10.603603,-5.779355 -10.603603,-9.518937c0,-1.359848 -4.67806,-7.479165 -10.291732,-13.938444c-12.786697,-14.618368 -15.281663,-18.017988 -20.583464,-29.236735c-2.494965,-5.099431 -5.613672,-8.499051 -7.173025,-7.479165c-1.247483,1.019886 -2.494965,0.339962 -2.494965,-1.359848c0,-5.099431 -37.73635,-44.874989 -47.404341,-50.314382c-4.98993,-2.719696 -12.786697,-9.518937 -17.776628,-14.95833c-4.67806,-5.779355 -9.667991,-10.198861 -10.915473,-10.198861c-0.935612,0 -7.796766,-6.119317 -14.657921,-13.598481c-7.173025,-7.479165 -14.969791,-13.598481 -17.152886,-13.598481c-2.494965,0 -4.36619,-2.039772 -4.36619,-4.759469c0,-2.719696 -4.054318,-6.799241 -9.044249,-9.178975c-4.98993,-2.379734 -8.420508,-5.779355 -7.796766,-7.139203c0.935612,-1.359848 -0.31187,-2.719696 -2.806836,-2.719696c-2.494965,0 -5.613672,-2.379734 -6.549283,-5.439393c-0.935612,-2.719696 -3.118707,-4.419507 -4.36619,-3.399621c-1.559353,1.019886 -4.67806,-1.359848 -6.861155,-5.099431c-2.494965,-3.399621 -6.237413,-6.459279 -8.420508,-6.459279c-4.98993,0 -17.152886,-7.139203 -20.271593,-11.558709c-0.935612,-2.039772 -13.410438,-7.479165 -27.132747,-12.238633c-14.03418,-5.099431 -24.325912,-10.198861 -23.078429,-11.218747c0.935612,-1.359848 -3.118707,-2.379734 -9.35612,-2.379734c-6.237413,0 -11.539215,-1.359848 -11.539215,-3.399621c0,-1.69981 -4.054318,-3.399621 -9.35612,-3.399621c-4.98993,0 -9.35612,-1.359848 -9.35612,-3.059659c0,-3.399621 -12.786697,-6.119317 -42.10254,-9.178975c-10.291732,-1.359848 -20.583464,-3.739583 -22.766559,-5.779355c-5.613672,-5.099431 -9.979861,-5.099431 -140.965539,-9.518937c-90.442492,-3.059659 -136.911221,-3.059659 -188.681751,0c-37.73635,2.039772 -119.758334,4.079545 -182.444338,4.079545c-62.686003,0.339962 -123.500782,2.039772 -135.663738,3.739583c-31.810807,4.419507 -114.768404,9.178975 -195.542906,11.558709c-40.543186,1.019886 -70.170899,3.399621 -69.235287,5.099431c0.935612,1.69981 -9.35612,3.059659 -23.390299,3.059659c-13.722309,0 -25.573394,1.359848 -26.509006,3.059659c-0.935612,1.69981 -7.173025,3.739583 -13.410438,4.759469c-19.959722,3.059659 -61.438521,13.258519 -67.052192,16.318178c-3.118707,1.69981 -9.044249,3.059659 -13.098568,3.059659c-4.36619,0 -9.667991,2.379734 -12.474826,5.099431c-2.494965,2.719696 -7.484896,5.099431 -10.915473,5.099431c-3.430577,0 -7.173025,1.359848 -8.108638,3.399621c-0.935612,1.69981 -5.301801,3.399621 -9.667991,3.399621c-4.054318,0 -7.484896,1.69981 -7.484896,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,1.69981 -4.67806,3.399621 -8.108638,3.399621c-3.118707,0 -5.925543,1.69981 -5.925543,3.399621c0,2.039772 -1.871224,3.399621 -4.054318,3.399621c-2.183095,0 -9.979861,3.059659 -17.152886,6.799241c-6.861155,3.739583 -14.969791,6.799241 -17.464757,6.799241c-2.494965,0 -5.301801,1.359848 -6.237413,2.719696c-0.935612,1.69981 -11.851085,7.139203 -24.325912,12.578595c-12.474826,5.099431 -23.390299,10.538823 -24.325912,11.558709c-0.935612,1.019886 -5.613672,4.419507 -10.915473,7.139203c-4.98993,2.719696 -12.162956,7.819127 -15.281663,11.218747c-3.430577,3.059659 -8.108638,5.779355 -10.291732,5.779355c-2.494965,0 -4.98993,2.379734 -5.925543,5.099431c-1.247483,2.719696 -4.054318,5.099431 -6.237413,5.099431c-4.67806,0 -8.420508,2.719696 -20.271593,14.618368c-3.118707,3.059659 -7.796766,5.779355 -9.979861,5.779355c-2.183095,0 -5.925543,3.059659 -8.420508,6.799241c-2.494965,3.739583 -5.613672,6.799241 -6.861155,6.799241c-4.36619,0 -29.315842,25.497153 -68.923416,70.712104c-5.301801,5.779355 -10.915473,10.878785 -12.162956,10.878785c-1.247483,0 -2.494965,2.039772 -2.494965,4.759469c0,2.379734 -4.054318,8.839013 -8.732378,14.618368c-10.291732,11.558709 -39.919445,57.113622 -35.241385,54.053964c1.559353,-1.359848 3.742448,-0.679924 4.98993,1.359848c0.935612,1.69981 0,3.399621 -2.494965,3.399621c-5.301801,0 -12.162956,8.159089 -9.667991,11.218747c1.247483,1.019886 4.98993,0 8.420508,-2.719696c3.742448,-2.719696 7.796766,-3.739583 9.667991,-2.039772c5.301801,4.419507 33.05829,7.479165 33.05829,3.739583c0,-2.039772 -3.742448,-3.739583 -8.420508,-3.739583c-6.237413,-0.339962 -6.861155,-1.019886 -2.806836,-2.039772c3.118707,-1.019886 14.969791,-0.679924 25.885265,0.679924c16.217274,1.69981 19.335981,3.059659 16.529145,6.799241c-2.806836,3.399621 -2.183095,4.759469 2.183095,6.119317c3.118707,0.679924 1.871224,1.359848 -2.494965,1.019886c-5.925543,-0.679924 -7.796766,0.679924 -6.861155,3.739583c0.935612,2.379734 3.430577,4.419507 5.925543,4.419507c2.494965,0 4.36619,1.69981 4.36619,3.739583c0,2.379734 3.742448,3.059659 10.915473,1.69981c8.732378,-2.039772 10.603603,-1.359848 9.044249,2.719696c-1.247483,3.059659 0.623741,5.439393 5.613672,6.459279c5.301801,1.019886 4.67806,1.69981 -3.118707,2.039772c-9.979861,0.339962 -10.291732,0.679924 -9.35612,15.298292c0.623741,8.159089 1.871224,14.278406 3.430577,13.258519c1.247483,-0.679924 2.183095,0.339962 2.183095,2.039772c0,2.039772 1.871224,3.739583 4.054318,3.739583c2.183095,0 7.484896,2.719696 11.539215,5.779355c4.36619,3.399621 10.603603,5.779355 14.03418,5.439393c4.98993,-0.339962 4.98993,-0.339962 0.935612,1.019886c-5.925543,2.039772 -7.484896,13.258519 -2.494965,16.65814c1.871224,1.019886 4.67806,8.839013 6.549283,16.65814c4.36619,18.697912 12.786697,19.717799 15.593533,2.039772c1.247483,-6.459279 2.183095,15.298292 2.183095,48.27461c0,42.155293 -1.247483,64.252826 -4.36619,73.091838c-2.183095,7.139203 -4.054318,18.35795 -3.742448,24.817229l0.31187,11.898671l1.871224,-11.898671l2.183095,-11.898671l2.183095,11.898671c1.559353,7.139203 1.247483,12.238633 -0.935612,12.918557c-1.559353,0.679924 -3.118707,3.739583 -3.118707,6.459279c0,4.419507 -0.935612,4.419507 -4.67806,1.019886c-3.742448,-3.399621 -4.67806,-3.059659 -4.67806,1.359848c0,4.419507 -1.871224,5.439393 -6.861155,3.739583c-5.925543,-1.69981 -6.237413,-1.359848 -2.494965,1.69981c3.118707,2.719696 3.430577,4.419507 1.247483,5.439393c-1.871224,1.019886 -2.806836,5.439393 -1.871224,9.858899c0.623741,5.099431 0,8.499051 -2.183095,8.499051c-1.871224,0 -3.430577,-2.039772 -3.742448,-4.079545c0,-3.399621 -0.623741,-3.399621 -1.871224,0c-1.247483,3.399621 -2.494965,3.059659 -5.925543,-1.69981c-3.742448,-5.779355 -4.054318,-5.779355 -4.36619,-0.339962c0,3.739583 -1.559353,5.099431 -4.67806,4.079545c-4.98993,-2.379734 -6.237413,-10.198861 -2.183095,-12.238633c1.559353,-0.339962 3.742448,-5.099431 4.98993,-10.198861c1.559353,-7.139203 0.935612,-9.518937 -2.806836,-9.518937c-2.494965,0 -4.67806,-1.359848 -4.67806,-3.399621c0,-1.69981 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 -5.613672,-3.399621 -12.474826,-3.399621l-12.474826,0l0,16.65814c0,11.558709 1.247483,17.338064 4.67806,18.697912c6.237413,2.379734 5.925543,8.839013 -1.559353,19.037874c-7.796766,10.878785 -7.796766,14.618368 0,10.198861c3.430577,-2.039772 5.301801,-5.439393 4.36619,-8.499051c-1.559353,-4.079545 0.935612,-5.099431 11.539215,-4.759469l13.722309,0.339962l-10.915473,4.079545c-10.603603,4.419507 -10.603603,4.759469 -3.118707,6.119317c7.796766,1.69981 7.796766,1.69981 -0.623741,2.379734c-9.667991,0.339962 -11.851085,5.779355 -3.118707,8.159089c4.36619,1.359848 4.36619,1.69981 -0.935612,2.039772c-7.796766,0.679924 -21.207205,12.578595 -19.024111,16.998102c1.247483,1.69981 -0.935612,2.379734 -4.98993,1.019886c-4.36619,-1.019886 -5.925543,-0.679924 -4.36619,2.039772c2.183095,4.079545 -3.430577,5.779355 -13.098568,4.419507c-2.494965,-0.339962 -8.108638,2.039772 -12.474826,5.439393c-4.67806,3.059659 -9.35612,5.439393 -10.915473,5.099431c-1.247483,-0.339962 -4.98993,2.379734 -8.420508,6.119317c-4.36619,4.759469 -10.291732,6.799241 -21.207205,6.799241c-8.108638,0 -19.647851,1.359848 -25.573394,3.399621c-7.484896,2.379734 -15.593533,2.039772 -27.132747,-0.679924c-15.281663,-4.079545 -16.217274,-4.759469 -17.464757,-16.318178c-0.623741,-6.459279 -1.247483,3.059659 -1.559353,21.417609c-0.31187,21.417609 0.623741,32.636356 2.494965,31.276508c1.871224,-1.359848 3.118707,4.079545 3.118707,13.938444c0,22.097533 6.549283,59.833319 11.539215,65.272712c2.183095,2.379734 4.054318,8.159089 4.054318,12.238633c0,4.419507 2.183095,13.598481 4.67806,20.057761c2.494965,6.799241 4.67806,15.978216 4.67806,20.737685c0,4.419507 2.183095,10.538823 4.67806,13.598481c2.494965,2.719696 4.67806,8.839013 4.67806,13.598481c0,4.759469 1.559353,8.839013 3.118707,8.839013c1.871224,0 3.118707,3.739583 3.118707,8.499051c0,4.759469 0.935612,8.499051 2.494965,8.499051c3.430577,0 9.979861,17.338064 9.979861,25.837115c0,4.419507 1.559353,8.839013 3.118707,9.858899c1.871224,1.019886 3.118707,5.099431 3.118707,8.839013c0,3.739583 1.247483,6.119317 2.806836,5.099431c1.247483,-1.019886 4.98993,4.079545 8.108638,11.558709c3.118707,7.479165 6.861155,13.598481 8.420508,13.598481c1.247483,0 2.494965,3.059659 2.494965,6.799241c0,3.739583 1.559353,6.799241 3.430577,6.799241c1.559353,0 2.494965,1.359848 1.559353,2.719696c-0.935612,1.69981 1.871224,8.499051 5.925543,14.95833c4.054318,6.799241 10.915473,20.737685 15.281663,30.936546c4.054318,10.198861 9.979861,21.757571 13.410438,25.157191c3.118707,3.399621 8.732378,13.598481 12.786697,22.437495c3.742448,9.178975 8.420508,18.35795 9.979861,20.397723c10.915473,14.618368 18.088498,26.177077 23.390299,37.395824c3.430577,6.799241 7.173025,12.578595 8.420508,12.578595c1.247483,0 4.67806,5.099431 7.484896,10.878785c2.806836,6.119317 9.044249,14.95833 13.722309,19.717799c4.36619,4.759469 10.915473,13.938444 14.346051,20.397723c3.118707,6.459279 9.667991,15.638254 14.657921,20.397723c4.67806,4.419507 8.420508,10.198861 8.420508,12.918557c0,2.379734 1.247483,3.399621 3.118707,2.379734c1.559353,-1.019886 3.118707,0.339962 3.118707,3.059659c0,3.059659 1.247483,5.439393 2.494965,5.439393c1.559353,0 4.36619,4.079545 6.549283,8.839013c1.871224,5.099431 4.36619,8.159089 5.613672,7.139203c0.935612,-1.359848 5.925543,4.419507 11.227344,12.238633c5.301801,7.819127 13.098568,18.017988 17.776628,22.777457c4.36619,4.759469 9.044249,11.218747 10.291732,14.618368c0.935612,3.059659 4.054318,5.779355 6.861155,5.779355c2.494965,0 4.67806,1.359848 4.67806,2.719696c0,4.759469 43.973763,53.034078 56.136719,61.873091c5.925543,4.419507 13.098568,10.538823 15.905404,13.258519c8.420508,9.178975 16.529145,15.298292 25.573394,20.397723c4.67806,2.719696 8.420508,6.119317 8.420508,7.819127c0,1.359848 2.183095,2.719696 4.67806,2.719696c2.494965,0 4.67806,1.69981 4.67806,3.739583c0,1.69981 4.36619,5.099431 9.35612,6.799241c5.301801,2.039772 9.35612,5.779355 9.35612,8.499051c0,2.719696 2.806836,4.759469 6.237413,4.759469c3.430577,0 6.237413,1.359848 6.237413,2.719696c0,1.69981 4.98993,4.759469 10.915473,7.479165c6.237413,2.719696 13.410438,7.479165 16.217274,10.878785c2.806836,3.399621 7.796766,6.119317 10.915473,6.119317c3.430577,0 5.301801,1.359848 4.36619,2.719696c-1.247483,2.379734 6.237413,6.799241 20.895334,12.238633c3.118707,1.019886 4.67806,3.399621 3.742448,5.439393c-1.247483,2.039772 1.559353,3.399621 5.925543,3.399621c4.36619,0 8.108638,1.69981 8.108638,3.399621c0,2.039772 2.806836,3.399621 6.237413,3.399621c3.430577,0 6.237413,1.69981 6.237413,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.359848 4.67806,3.059659c0,1.69981 3.118707,3.739583 7.173025,5.099431c4.054318,1.019886 11.227344,5.439393 15.905404,9.858899c4.98993,4.759469 14.657921,10.198861 21.830946,12.918557c6.861155,2.379734 15.593533,6.119317 19.024111,8.499051c3.430577,2.379734 12.474826,6.119317 20.271593,8.499051c7.796766,2.379734 15.281663,5.439393 16.841016,7.139203c1.871224,1.359848 7.796766,2.719696 13.098568,2.719696c5.613672,0 11.227344,1.69981 12.162956,3.399621c0.935612,2.039772 7.484896,3.399621 14.03418,3.399621c6.549283,0 12.786697,1.359848 13.722309,3.059659c0.935612,1.69981 14.03418,4.759469 29.003972,7.139203c15.281663,2.039772 33.370161,5.439393 40.543186,7.139203c7.173025,1.69981 24.014041,3.059659 37.42448,3.399621c13.410438,0 30.563325,2.379734 38.360092,4.759469c19.647851,6.459279 215.814498,4.419507 290.039716,-3.059659l0.000005,-0.000002l-0.000008,-0.000014zm-1149.24339,-986.909801c-2.494965,-14.95833 -3.430577,-13.598481 -5.925543,7.479165c-1.247483,11.558709 -0.935612,14.618368 0.935612,10.198861c2.806836,-6.459279 3.118707,-6.119317 3.742448,1.69981l0.623741,8.499051l1.247483,-8.159089c0.935612,-4.419507 0.623741,-13.258519 -0.623741,-19.717799l0,0.000001zm147.826694,16.318178c3.742448,-2.719696 2.806836,-3.739583 -3.742448,-5.779355c-4.98993,-1.019886 -9.667991,-1.359848 -10.603603,0c-1.247483,1.019886 0.623741,2.039772 4.054318,2.379734c5.613672,0 5.613672,0.339962 -0.31187,3.059659l-6.237413,3.059659l6.237413,0c3.430577,0 8.420508,-1.019886 10.603603,-2.719696l0,-0.000001zm-159.677779,-69.012294c-0.623741,-4.419507 -1.247483,-1.019886 -1.247483,7.479165c0,8.499051 0.623741,11.898671 1.247483,7.819127c0.623741,-4.419507 0.623741,-11.218747 0,-15.298292l0,0.000001l0,-0.000001zm1984.433024,2.719696c0,-0.679924 -2.183095,-3.059659 -4.67806,-5.439393c-4.054318,-3.739583 -4.36619,-3.399621 -2.806836,1.359848c1.559353,4.759469 7.484896,7.819127 7.484896,4.079545zm27.132747,-60.173281l0.623741,-24.137304l-6.237413,7.819127c-7.484896,9.178975 -7.796766,23.117419 -0.31187,32.976318c2.806836,4.079545 5.301801,7.479165 5.301801,7.479165c0,0 0.31187,-10.878785 0.623741,-24.137304l-0.000001,0l0.000001,-0.000002zm-1998.155334,-9.858899c0,-1.69981 -0.623741,-3.399621 -1.247483,-3.399621c-0.935612,0 -2.494965,1.69981 -3.430577,3.399621c-0.935612,2.039772 -0.31187,3.399621 1.247483,3.399621c1.871224,0 3.430577,-1.359848 3.430577,-3.399621zm1990.358567,-36.035977l-1.871224,-20.057761l-2.183095,20.397723c-1.247483,10.878785 -3.742448,20.737685 -5.613672,21.417609c-2.183095,0.679924 -2.183095,2.719696 0.623741,5.439393c6.861155,8.499051 11.539215,-4.759469 9.044249,-27.196963l-0.000001,0l0.000002,-0.000001zm-1991.294179,18.35795c-0.935612,-2.379734 -1.559353,-0.679924 -1.559353,4.079545c0,4.759469 0.623741,6.459279 1.559353,4.419507c0.623741,-2.379734 0.623741,-6.459279 0,-8.499051l0,-0.000001zm11.539215,-16.998102c-0.935612,-3.399621 -0.31187,-6.119317 1.559353,-6.119317c1.871224,0 3.430577,1.69981 3.430577,4.079545c0,2.039772 0.623741,3.059659 1.559353,2.379734c0.623741,-1.019886 0.31187,-6.799241 -1.247483,-12.578595c-1.871224,-6.799241 -1.871224,-10.878785 0,-10.878785c3.118707,0 3.742448,-18.017988 0.623741,-21.417609c-0.935612,-1.359848 -3.742448,3.399621 -6.237413,10.198861c-4.67806,15.298292 -5.613672,53.034078 -0.935612,45.214951c1.559353,-2.719696 2.183095,-7.819127 1.247483,-10.878785l0.000001,0zm36.176997,-17.678026c0,-25.157191 -0.935612,-32.296394 -4.67806,-33.996204c-9.044249,-3.739583 -3.742448,-49.634458 5.613672,-49.634458c5.301801,0 -0.623741,-4.759469 -7.173025,-5.779355c-3.742448,-0.679924 -6.237413,1.019886 -6.237413,4.079545c0,2.719696 -3.430577,12.918557 -7.796766,22.777457c-8.108638,18.017988 -9.979861,25.497153 -4.67806,16.318178c2.806836,-4.419507 3.118707,-4.419507 3.118707,0c0,2.719696 -1.247483,7.139203 -2.806836,9.858899c-1.559353,2.719696 -2.183095,7.139203 -1.247483,9.518937c3.118707,8.839013 7.173025,-2.719696 7.173025,-20.057761c0,-8.839013 1.559353,-16.998102 3.118707,-18.017988c1.871224,-1.359848 3.118707,4.419507 3.118707,14.95833c0,9.178975 1.559353,18.017988 3.118707,19.037874c1.871224,1.019886 3.118707,15.638254 3.118707,32.636356c0,18.017988 1.247483,30.256622 3.118707,30.256622c1.871224,0 3.118707,-12.918557 3.118707,-31.956432l0.000001,-0.000001l-0.000004,0.000001zm-25.885265,0.679924c-0.935612,-2.719696 -1.871224,-1.69981 -1.871224,2.039772c-0.31187,3.739583 0.623741,5.779355 1.559353,4.419507c0.935612,-1.019886 1.247483,-4.079545 0.31187,-6.459279l0.000001,0zm1959.483371,-17.678026c0,-4.759469 -1.559353,-9.518937 -3.430577,-10.538823c-4.67806,-3.399621 -5.613672,-1.359848 -3.742448,9.518937c2.183095,11.558709 7.173025,12.238633 7.173025,1.019886zm-10.291732,-46.234837c-0.935612,-9.178975 -4.054318,-21.077647 -6.861155,-26.177077c-4.98993,-9.518937 -4.98993,-9.178975 -3.430577,9.858899c1.247483,18.017988 5.925543,33.31628 10.291732,33.31628c0.935612,0 0.935612,-7.479165 0,-16.998102zm-20.895334,-32.976318c-0.935612,-21.077647 0.935612,-24.477266 3.118707,-6.119317l2.183095,16.998102l-0.623741,-20.057761c-0.31187,-14.278406 -1.871224,-21.077647 -5.925543,-24.137304c-2.806836,-2.379734 -5.613672,-7.479165 -5.925543,-11.218747c0,-3.739583 -1.559353,-6.119317 -3.430577,-5.099431c-1.559353,1.019886 -2.183095,-1.69981 -1.247483,-7.139203c0.935612,-4.759469 0.623741,-8.839013 -0.935612,-8.839013c-4.98993,0 -1.871224,35.696015 3.742448,46.234837c3.430577,5.779355 5.925543,15.298292 5.925543,21.417609c0,5.779355 0.935612,10.538823 1.871224,10.538823c0.935612,0 1.559353,-5.779355 1.247483,-12.578595l-0.000001,0zm-1904.906006,-9.518937c-1.871224,-17.338064 -4.98993,-16.65814 -8.420508,1.019886c-1.871224,10.198861 -1.559353,11.218747 3.742448,10.198861c4.054318,-1.019886 5.301801,-3.739583 4.67806,-11.218747zm4.67806,-22.777457c-0.935612,-2.719696 -1.871224,-1.69981 -1.871224,2.039772c-0.31187,3.739583 0.623741,5.779355 1.559353,4.419507c0.935612,-1.019886 1.247483,-4.079545 0.31187,-6.459279l0.000001,0zm1863.427207,-37.395824c-2.183095,-2.379734 -3.742448,-2.719696 -3.742448,-0.679924c0,4.759469 3.742448,8.839013 5.925543,6.459279c0.623741,-1.019886 -0.31187,-3.739583 -2.183095,-5.779355zm10.291732,-6.119317c0.935612,-1.69981 0.31187,-3.399621 -1.247483,-3.399621c-1.871224,0 -3.430577,1.69981 -3.430577,3.399621c0,2.039772 0.623741,3.399621 1.247483,3.399621c0.935612,0 2.494965,-1.359848 3.430577,-3.399621zm-1826.002728,-151.62307c6.237413,-6.119317 8.420508,-9.858899 6.237413,-11.558709c-2.183095,-1.359848 0,-4.079545 5.925543,-6.459279c4.98993,-2.379734 9.979861,-6.799241 11.227344,-9.858899c1.559353,-4.759469 2.183095,-4.759469 4.67806,-0.679924c1.871224,3.059659 3.118707,3.399621 3.118707,1.019886c0,-5.099431 19.024111,-24.817229 24.325912,-24.817229c1.871224,0 3.742448,-3.399621 4.054318,-7.479165c0.31187,-7.479165 0.31187,-7.479165 2.806836,0.679924c1.559353,5.779355 2.494965,6.459279 2.806836,2.719696c0.31187,-3.399621 1.559353,-6.119317 3.118707,-6.119317c1.559353,0 3.742448,-3.739583 4.67806,-8.499051c1.247483,-4.759469 3.742448,-8.499051 6.237413,-8.499051c2.183095,0 7.173025,-3.059659 10.915473,-6.459279c5.925543,-5.779355 15.905404,-11.898671 64.245356,-40.11552c23.078429,-13.598481 32.434549,-18.017988 38.671962,-18.017988c13.098568,0 47.09247,-23.797342 47.09247,-32.976318c0,-1.019886 -6.237413,-7.819127 -14.03418,-15.298292c-7.796766,-7.479165 -13.410438,-14.618368 -12.474826,-15.978216c0.623741,-1.69981 -0.623741,-5.779355 -3.118707,-9.178975c-3.430577,-5.099431 -4.36619,-5.439393 -4.67806,-1.359848c0,4.079545 -0.623741,4.419507 -2.806836,0.339962c-3.118707,-5.099431 -25.261524,-2.379734 -25.261524,3.059659c0,4.419507 -161.237132,4.419507 -162.796486,0c-0.623741,-2.039772 -11.539215,-4.419507 -24.325912,-5.099431c-12.786697,-1.019886 -29.003972,-3.059659 -35.865127,-5.099431c-6.861155,-1.69981 -17.152886,-3.399621 -22.766559,-3.399621c-6.237413,0 -9.667991,-1.359848 -8.420508,-3.399621c0.935612,-1.69981 1.559353,-3.399621 0.935612,-3.739583c-0.623741,0 -7.173025,-1.019886 -14.969791,-2.039772c-7.796766,-1.019886 -14.657921,-3.059659 -15.593533,-4.419507c-0.935612,-1.359848 -9.667991,-3.399621 -19.335981,-4.759469c-9.979861,-1.359848 -18.088498,-4.079545 -18.088498,-5.779355c0,-1.69981 -6.237413,-3.059659 -13.722309,-3.059659c-8.108638,0 -15.905404,-2.039772 -18.71224,-5.099431c-2.494965,-3.059659 -10.291732,-5.099431 -18.088498,-5.099431c-7.484896,0 -14.969791,-1.359848 -16.841016,-3.399621c-4.98993,-5.439393 -70.170899,-5.099431 -73.289606,0.339962c-4.67806,7.819127 -3.118707,20.057761 2.183095,20.057761c2.806836,0 4.36619,2.039772 3.430577,4.419507c-0.623741,2.039772 2.494965,9.518937 7.173025,15.978216c4.67806,6.459279 9.667991,15.638254 10.915473,20.397723l2.806836,8.499051l2.183095,-8.499051c1.871224,-7.819127 2.183095,-7.479165 2.494965,3.059659c0.31187,7.479165 3.430577,15.298292 9.667991,23.117419c4.98993,6.119317 9.35612,12.918557 9.35612,14.95833c0,2.039772 1.247483,2.379734 3.118707,1.359848c1.559353,-1.019886 3.118707,1.019886 3.118707,4.759469c0,4.079545 1.559353,7.139203 3.118707,7.139203c1.871224,0 3.118707,1.69981 3.118707,3.739583c0,2.379734 4.054318,8.839013 9.35612,14.618368c4.98993,5.779355 13.410438,15.978216 18.71224,22.437495c5.925543,7.479165 8.732378,9.518937 7.484896,5.099431c-1.559353,-5.099431 -0.31187,-4.419507 4.67806,2.719696c3.742448,5.099431 9.044249,9.178975 11.227344,9.178975c2.494965,0 5.301801,1.69981 6.549283,4.079545c1.559353,2.719696 0,3.059659 -5.301801,1.69981l-7.484896,-2.039772l7.484896,6.799241c4.054318,3.399621 9.979861,6.459279 13.098568,6.459279c3.742448,0 7.173025,3.399621 9.044249,8.499051c1.559353,4.759469 5.613672,9.518937 8.420508,10.878785c3.118707,1.019886 11.851085,6.799241 19.647851,12.578595c7.796766,5.779355 14.969791,10.198861 16.529145,9.518937c1.247483,-0.339962 2.183095,2.379734 2.183095,5.779355c0,4.759469 3.118707,7.139203 10.291732,8.839013c5.301801,1.359848 11.851085,4.079545 14.03418,5.779355c2.494965,2.719696 3.742448,2.039772 3.742448,-1.69981c0,-2.719696 -1.871224,-6.119317 -3.742448,-6.799241c-2.806836,-1.359848 -2.494965,-2.039772 0.623741,-2.039772c2.494965,-0.339962 6.237413,2.719696 7.796766,6.799241c3.118707,7.139203 7.173025,9.858899 32.746419,22.777457c18.71224,9.178975 22.766559,9.178975 34.305773,-1.359848l0.000001,0l0,-0.000001zm148.138564,-247.832327c6.861155,-2.379734 16.841016,-3.399621 22.142817,-2.719696c9.667991,1.69981 19.024111,-5.439393 11.227344,-8.499051c-2.183095,-0.679924 -3.742448,-2.719696 -3.742448,-4.419507c0,-1.69981 -9.667991,-13.598481 -21.830946,-26.517039c-11.851085,-12.918557 -21.830946,-25.497153 -21.830946,-27.536925c0,-2.039772 -3.430577,-7.479165 -7.796766,-11.898671c-4.054318,-4.759469 -8.420508,-14.278406 -9.667991,-21.417609c-2.183095,-14.278406 -12.474826,-34.676128 -17.464757,-34.676128c-1.871224,0 -2.494965,-2.379734 -1.247483,-5.099431c0.935612,-2.719696 0,-4.759469 -2.183095,-4.079545c-2.183095,0.339962 -4.054318,-4.419507 -4.67806,-12.238633c-0.623741,-6.799241 -2.183095,-11.898671 -3.430577,-11.218747c-1.247483,1.019886 -4.054318,0.339962 -6.549283,-1.69981c-3.430577,-2.039772 -3.742448,-3.059659 -0.623741,-3.059659c2.183095,0 3.118707,-1.69981 2.183095,-3.399621c-1.247483,-2.039772 -3.430577,-2.719696 -4.98993,-1.69981c-1.559353,1.359848 -4.36619,-2.039772 -6.237413,-7.479165c-1.559353,-5.099431 -4.054318,-10.198861 -5.301801,-11.218747c-4.36619,-3.399621 -9.979861,-16.998102 -10.291732,-24.477266c0,-4.419507 -0.935612,-5.779355 -1.871224,-3.399621c-2.183095,5.779355 -7.173025,5.099431 -7.173025,-1.019886c0,-2.379734 -2.183095,-6.119317 -4.98993,-7.819127c-3.742448,-2.039772 -4.67806,-6.119317 -3.742448,-12.238633c0.935612,-4.759469 0.31187,-8.839013 -0.935612,-8.839013c-1.559353,0 -2.806836,-4.419507 -2.806836,-9.858899c0,-8.499051 -0.935612,-9.858899 -6.861155,-8.499051c-4.054318,0.679924 -5.301801,0.679924 -3.118707,-0.679924c1.871224,-1.019886 3.742448,-4.759469 3.742448,-8.499051c0,-5.439393 -2.183095,-6.459279 -15.593533,-6.459279c-10.915473,0 -15.281663,1.359848 -14.657921,4.419507c0.31187,2.379734 -1.871224,3.739583 -5.613672,3.399621c-9.667991,-1.359848 -23.702171,2.719696 -21.519076,6.119317c0.935612,1.69981 -1.247483,3.059659 -4.67806,3.059659c-3.430577,0 -8.108638,2.379734 -10.915473,5.099431c-2.806836,3.059659 -10.291732,5.099431 -19.024111,5.099431c-9.667991,0 -14.657921,1.69981 -15.905404,5.099431c-1.247483,2.719696 -5.301801,5.099431 -9.35612,5.099431c-4.054318,0 -7.484896,1.359848 -7.484896,3.059659c0,1.69981 -4.36619,4.079545 -9.35612,5.439393c-4.98993,1.359848 -9.35612,4.079545 -9.35612,6.459279c0,2.719696 -3.742448,3.739583 -10.915473,2.719696c-7.796766,-1.019886 -11.227344,0 -12.786697,4.079545c-0.935612,3.059659 -5.301801,5.439393 -9.35612,5.439393c-4.67806,0 -7.484896,2.039772 -7.484896,5.099431c0,4.419507 -5.613672,6.799241 -13.098568,5.439393c-1.559353,0 -2.494965,2.039772 -2.494965,4.759469c0,3.059659 -2.806836,5.099431 -7.796766,5.099431c-4.36619,0 -7.796766,1.019886 -7.796766,2.719696c0,1.359848 -7.173025,6.119317 -15.593533,10.538823c-8.732378,4.419507 -19.024111,11.898671 -23.390299,16.65814c-4.36619,4.419507 -7.796766,7.479165 -7.796766,6.119317c0,-1.019886 -2.806836,1.019886 -6.237413,4.759469c-3.430577,3.739583 -6.237413,8.839013 -6.237413,10.878785c0,2.379734 -4.36619,4.759469 -9.35612,5.099431c-5.301801,0.339962 -13.722309,3.739583 -18.400369,7.819127c-4.98993,3.739583 -9.979861,6.799241 -11.227344,6.799241c-0.935612,0 -8.108638,6.459279 -15.593533,14.618368c-11.227344,11.218747 -14.03418,16.65814 -14.03418,25.497153c0,9.858899 0.935612,10.878785 6.237413,9.178975c7.173025,-2.379734 8.732378,3.399621 1.871224,6.119317c-2.806836,1.359848 -3.742448,4.759469 -2.806836,8.839013c1.871224,8.499051 12.162956,9.178975 34.305773,3.399621c10.603603,-3.059659 19.335981,-3.059659 36.176997,0c12.474826,2.379734 35.865127,6.459279 52.082401,9.518937c16.217274,2.719696 31.187066,7.139203 33.05829,9.858899c1.871224,2.379734 10.915473,5.439393 20.271593,6.799241c9.35612,1.019886 18.400369,4.419507 20.583464,7.479165c3.118707,4.079545 4.67806,4.419507 8.732378,0.679924c2.494965,-2.379734 4.67806,-2.719696 4.67806,-1.019886c0,4.759469 19.335981,11.218747 33.682032,11.218747c10.291732,0 12.474826,1.019886 11.227344,5.099431c-1.559353,4.079545 0.935612,5.099431 12.162956,5.099431c8.420508,0 16.217274,2.039772 19.024111,5.099431c5.613672,6.459279 34.929514,7.139203 37.112609,1.019886c0.935612,-3.399621 4.054318,-3.059659 12.786697,1.69981c6.237413,3.059659 14.969791,5.779355 19.024111,5.779355c4.36619,0 7.796766,1.69981 7.796766,3.399621c0,4.759469 78.903277,0.339962 95.120552,-5.099431l-0.000004,-0.000002l-0.000002,-0.000008z" id="svg_2" stroke-width="0" stroke="null"></path> <path d="m1386.286398,7360.440312c-0.935612,-1.019886 -21.207205,-3.739583 -45.221246,-5.779355c-68.611546,-5.439393 -78.903277,-6.459279 -78.903277,-9.518937c0,-1.69981 -9.35612,-3.739583 -20.895334,-5.099431c-29.003972,-3.059659 -53.953625,-8.499051 -53.953625,-11.898671c0,-1.359848 -4.67806,-3.399621 -9.979861,-4.419507c-24.325912,-4.759469 -30.251454,-6.799241 -28.692101,-9.518937c0.935612,-1.69981 -2.806836,-3.059659 -8.108638,-3.059659c-4.98993,0 -12.162956,-1.359848 -15.593533,-3.399621c-3.430577,-1.69981 -9.044249,-4.759469 -12.474826,-6.799241c-3.430577,-1.69981 -9.044249,-3.399621 -12.474826,-3.399621c-3.430577,0 -6.237413,-2.379734 -6.237413,-5.099431c0,-2.719696 -2.806836,-5.099431 -6.237413,-5.099431c-7.173025,0 -21.830946,-6.799241 -27.444619,-12.578595c-2.183095,-2.379734 -7.484896,-5.439393 -11.851085,-6.459279c-4.054318,-1.019886 -7.484896,-3.399621 -7.484896,-5.099431c0,-1.69981 -3.742448,-3.059659 -8.108638,-3.059659c-4.36619,0 -7.173025,-1.359848 -5.925543,-3.399621c0.935612,-1.69981 0,-3.399621 -2.494965,-3.399621c-5.925543,0 -24.014041,-10.198861 -24.014041,-13.258519c0,-1.359848 -5.613672,-5.439393 -12.474826,-8.839013c-7.173025,-3.399621 -16.841016,-11.218747 -21.830946,-17.678026c-4.98993,-6.119317 -10.603603,-11.218747 -12.474826,-11.218747c-1.559353,0 -3.118707,-1.359848 -3.118707,-3.399621c0,-1.69981 -1.871224,-3.399621 -3.742448,-3.399621c-2.183095,0 -7.484896,-4.759469 -11.539215,-10.198861c-4.054318,-5.779355 -9.044249,-10.198861 -11.539215,-10.198861c-2.494965,0 -4.36619,-1.359848 -4.36619,-3.059659c0,-2.039772 -8.420508,-12.918557 -18.71224,-24.477266c-10.291732,-11.558709 -18.71224,-23.797342 -18.71224,-27.196963c0,-3.739583 -1.871224,-6.459279 -4.054318,-6.459279c-2.183095,0 -7.173025,-6.119317 -11.227344,-13.598481c-3.742448,-7.479165 -7.796766,-13.598481 -9.044249,-13.598481c-1.247483,0 -4.054318,-5.099431 -6.549283,-10.878785c-2.494965,-6.119317 -5.301801,-11.898671 -6.237413,-12.918557c-3.742448,-3.399621 -9.667991,-16.998102 -9.667991,-22.097533c0,-2.719696 -2.183095,-5.099431 -4.67806,-5.099431c-2.494965,0 -4.67806,-2.719696 -4.67806,-6.459279c0,-3.399621 -2.183095,-8.159089 -4.67806,-10.538823c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.379734 -2.183095,-5.439393 -4.67806,-6.459279c-2.494965,-1.359848 -4.67806,-4.079545 -4.67806,-6.799241c0,-2.719696 -1.247483,-4.759469 -3.118707,-4.759469c-1.559353,0 -3.118707,-3.059659 -3.118707,-7.139203c0,-3.739583 -1.247483,-5.779355 -3.118707,-4.759469c-1.559353,1.019886 -3.118707,-0.339962 -3.118707,-3.399621c0,-3.059659 -2.806836,-8.499051 -6.237413,-12.578595c-3.430577,-4.079545 -6.237413,-9.518937 -6.237413,-11.898671c0,-2.379734 -1.247483,-4.419507 -2.806836,-4.419507c-1.559353,0 -3.430577,-3.399621 -4.67806,-7.819127c-0.935612,-4.079545 -4.36619,-10.878785 -7.796766,-14.95833c-8.732378,-9.858899 -19.024111,-30.596584 -19.024111,-37.395824c0,-3.059659 -0.935612,-4.759469 -1.871224,-3.399621c-2.494965,2.719696 -23.078429,-39.775558 -23.078429,-46.914762c0,-3.059659 -2.183095,-6.119317 -4.67806,-7.139203c-2.494965,-1.359848 -4.67806,-5.099431 -4.67806,-8.499051c0,-3.399621 -1.247483,-6.459279 -3.118707,-6.459279c-1.559353,0 -3.118707,-1.69981 -3.118707,-3.399621c0,-2.039772 -2.806836,-10.198861 -6.237413,-17.678026c-3.430577,-7.819127 -6.237413,-17.678026 -6.237413,-21.757571c0,-4.419507 -1.559353,-8.839013 -3.118707,-9.858899c-1.871224,-1.019886 -3.118707,-7.139203 -3.118707,-13.598481c0,-6.119317 -1.247483,-11.898671 -2.494965,-12.578595c-4.054318,-1.69981 -16.217274,-73.091838 -16.217274,-94.509447c0,-10.198861 -2.183095,-33.996204 -4.67806,-52.694116c-5.301801,-39.095634 -5.925543,-108.447891 -1.247483,-130.885385c1.871224,-8.499051 4.36619,-29.916659 5.925543,-47.594686c2.806836,-30.596584 6.549283,-61.533129 11.227344,-94.169485c1.247483,-8.159089 3.430577,-14.618368 4.67806,-14.618368c1.559353,0 2.806836,-3.399621 2.806836,-7.479165c0,-7.479165 6.549283,-30.256622 9.35612,-33.31628c0.935612,-1.019886 3.742448,-8.499051 5.925543,-16.998102c4.98993,-19.717799 10.603603,-33.996204 13.410438,-33.996204c0.935612,0 3.430577,-5.099431 5.613672,-11.558709c1.871224,-6.459279 6.861155,-15.978216 10.915473,-21.077647c4.36619,-5.439393 7.796766,-11.898671 7.796766,-13.938444c0,-2.379734 1.559353,-4.419507 3.118707,-4.419507c1.871224,0 3.118707,-2.039772 3.118707,-4.419507c0,-2.719696 2.806836,-7.479165 6.237413,-10.878785c3.430577,-3.399621 6.237413,-8.159089 6.237413,-10.878785c0,-2.379734 1.871224,-4.419507 4.36619,-4.419507c2.183095,0 5.925543,-4.419507 8.108638,-10.198861c2.183095,-5.439393 4.98993,-9.178975 6.549283,-8.159089c1.559353,1.019886 2.806836,0 2.806836,-2.039772c0,-2.379734 4.67806,-8.839013 10.291732,-14.618368c5.301801,-5.439393 9.667991,-11.558709 9.35612,-13.258519c-0.623741,-1.359848 0,-2.719696 1.559353,-2.719696c1.247483,0 6.549283,-4.079545 11.539215,-8.839013c5.301801,-4.759469 13.098568,-11.218747 18.088498,-14.278406c4.67806,-3.059659 8.420508,-7.139203 8.732378,-9.178975c0,-1.69981 13.098568,-10.198861 29.003972,-18.697912c15.905404,-8.499051 28.38023,-16.318178 27.756489,-17.678026c-0.623741,-1.69981 1.247483,-2.719696 4.054318,-2.719696c6.861155,0 27.132747,-7.479165 29.315842,-10.878785c0.935612,-1.359848 7.484896,-4.759469 14.03418,-7.479165c6.861155,-2.379734 12.162956,-6.459279 11.851085,-8.499051c-0.623741,-2.039772 3.118707,-3.739583 8.108638,-3.739583c5.301801,0 10.291732,-1.69981 11.227344,-3.399621c0.935612,-2.039772 5.301801,-3.399621 9.35612,-3.399621c4.054318,0 8.420508,-1.359848 9.35612,-3.399621c0.935612,-1.69981 5.301801,-3.399621 9.667991,-3.399621c4.054318,0 7.484896,-1.359848 7.484896,-3.059659c0,-2.719696 13.410438,-5.099431 59.255426,-10.198861c12.786697,-1.359848 22.142817,-3.059659 20.271593,-3.739583c-1.559353,-0.339962 2.494965,-2.039772 9.35612,-3.399621c6.861155,-1.359848 20.583464,-5.099431 30.563325,-8.159089c9.979861,-3.059659 22.142817,-5.439393 27.132747,-5.439393c4.67806,0 9.35612,-1.69981 9.979861,-4.079545c1.247483,-3.739583 11.851085,-5.439393 64.245356,-11.558709c10.915473,-1.359848 18.088498,-3.399621 15.905404,-5.099431c-2.183095,-1.359848 5.301801,-3.399621 16.217274,-4.419507c39.607574,-3.739583 54.265495,-5.779355 60.502909,-8.839013c3.430577,-1.359848 37.73635,-5.439393 76.408312,-8.839013c87.011915,-7.819127 362.393709,-10.878785 425.703454,-5.099431c86.076303,8.159089 102.293577,10.198861 104.164801,13.258519c0.935612,1.69981 6.549283,4.079545 12.162956,5.439393c25.261524,5.439393 28.692101,6.459279 28.692101,8.839013c0,1.69981 4.054318,3.739583 9.044249,5.099431c4.98993,1.019886 15.593533,6.459279 23.390299,12.238633c8.108638,5.439393 15.593533,9.858899 16.841016,9.858899c1.247483,0 4.36619,3.059659 6.861155,6.799241c2.494965,3.739583 5.925543,6.799241 7.796766,6.799241c4.054318,0 13.722309,9.858899 20.271593,20.397723c2.494965,4.419507 7.796766,10.878785 11.539215,14.618368c3.742448,3.739583 10.915473,13.258519 15.593533,20.737685c4.67806,7.819127 11.227344,16.318178 14.03418,19.377837c3.118707,3.059659 5.613672,7.139203 5.613672,9.518937c0,2.039772 1.559353,3.739583 3.118707,3.739583c1.871224,0 3.118707,3.059659 3.118707,6.799241c0,3.739583 1.871224,6.799241 4.054318,6.799241c1.871224,0 7.173025,8.159089 11.539215,18.017988c4.36619,9.518937 8.732378,18.35795 9.667991,19.377837c0.935612,1.019886 3.430577,7.139203 5.925543,13.598481c2.494965,6.459279 4.98993,12.578595 6.237413,13.598481c3.118707,3.059659 9.35612,20.737685 9.35612,27.196963c0,3.399621 0.935612,6.799241 2.494965,7.479165c1.247483,0.679924 6.237413,12.578595 11.227344,26.517039c4.98993,13.938444 9.979861,26.177077 11.227344,27.196963c1.247483,1.019886 3.118707,6.459279 4.054318,11.898671c2.806836,16.318178 7.796766,34.336166 8.420508,30.596584c0.31187,-1.69981 3.118707,7.479165 6.237413,20.397723c3.118707,13.258519 8.420508,33.656242 11.851085,45.894875c3.430577,12.238633 8.108638,30.596584 9.979861,40.795444c2.183095,10.198861 5.301801,22.437495 7.484896,26.857001c4.67806,11.218747 4.054318,212.136313 -0.935612,213.836123c-1.871224,0.679924 -3.430577,5.439393 -3.430577,10.198861c0,14.618368 -9.35612,60.173281 -12.786697,61.193167c-1.559353,0.679924 -2.806836,6.799241 -2.806836,13.598481c0,11.898671 -4.36619,30.596584 -9.667991,42.155293c-1.559353,3.399621 -2.806836,9.858899 -2.806836,14.618368c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,3.739583 -3.118707,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,4.759469 -3.118707,10.198861c0,5.779355 -0.935612,10.198861 -2.494965,10.198861c-1.247483,0 -4.054318,6.119317 -5.925543,13.598481c-3.430577,11.558709 -9.35612,26.177077 -24.014041,61.193167c-1.871224,4.759469 -4.054318,9.178975 -4.98993,10.198861c-3.742448,4.079545 -9.35612,17.338064 -9.35612,21.757571c0,2.719696 -0.935612,5.439393 -2.183095,6.119317c-3.430577,1.359848 -16.529145,29.576697 -16.529145,35.356052c0,2.719696 -2.183095,4.759469 -4.67806,4.759469c-2.494965,0 -4.67806,3.059659 -4.67806,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,2.379734 -3.118707,5.099431c0,2.719696 -1.247483,5.099431 -3.118707,5.099431c-1.559353,0 -3.118707,2.379734 -3.118707,5.439393c0,3.059659 -2.494965,8.159089 -5.613672,11.218747c-2.806836,3.059659 -7.484896,10.198861 -9.979861,15.638254c-2.494965,5.779355 -7.173025,13.258519 -10.603603,17.338064c-3.118707,4.079545 -5.613672,8.159089 -5.301801,9.518937c0.623741,2.379734 -3.118707,7.479165 -14.346051,20.737685c-4.054318,4.419507 -7.173025,9.858899 -7.173025,11.898671c0,2.039772 -1.247483,2.719696 -3.118707,1.69981c-1.559353,-1.019886 -3.118707,0 -3.118707,2.719696c0,2.719696 -3.118707,8.499051 -6.861155,13.258519c-4.054318,4.419507 -10.603603,13.938444 -14.969791,20.737685c-4.36619,6.799241 -8.732378,12.578595 -9.979861,12.578595c-1.559353,0 -2.494965,2.039772 -2.494965,4.419507c0,2.039772 -5.613672,10.198861 -12.474826,17.338064c-6.861155,7.479165 -12.474826,14.95833 -12.474826,16.998102c0,3.739583 -68.611546,76.831421 -72.353994,76.831421c-1.247483,0 -9.35612,5.439393 -17.776628,11.898671c-8.108638,6.459279 -16.529145,11.898671 -18.71224,11.898671c-1.871224,0 -3.430577,1.69981 -3.430577,3.399621c0,2.039772 -1.871224,3.399621 -4.36619,3.399621c-2.183095,0 -5.925543,2.379734 -8.108638,5.099431c-2.183095,2.719696 -4.98993,4.079545 -6.549283,3.059659c-1.559353,-1.019886 -2.806836,0 -2.806836,1.69981c0,2.039772 -3.742448,3.739583 -8.108638,3.739583c-4.36619,0 -7.173025,1.359848 -6.237413,3.059659c0.935612,1.359848 -4.054318,4.759469 -10.915473,7.139203c-6.861155,2.719696 -13.410438,6.119317 -14.657921,8.159089c-4.36619,7.139203 -19.647851,12.918557 -46.468728,18.017988c-5.613672,1.019886 -10.291732,3.059659 -10.291732,4.759469c0,1.69981 -3.430577,3.059659 -7.484896,3.059659c-4.36619,0 -8.732378,1.69981 -9.667991,3.399621c-0.935612,2.039772 -6.549283,3.399621 -12.162956,3.399621c-5.301801,0 -11.539215,1.69981 -13.410438,3.739583c-1.559353,1.69981 -16.217274,5.439393 -32.122678,8.159089c-15.905404,2.719696 -29.939584,6.119317 -30.875196,7.819127c-2.183095,4.079545 -24.949653,6.799241 -89.19501,10.878785c-80.774502,5.099431 -158.742167,7.479165 -161.237132,5.099431l-0.000002,0.000005l0.000008,0.000001zm202.092189,-176.100336c8.732378,-0.339962 18.088498,-2.719696 20.583464,-5.099431c3.430577,-3.059659 17.152886,-4.079545 47.404341,-3.739583c41.790669,0.339962 47.09247,-0.339962 47.09247,-7.819127c0,-2.039772 5.925543,-6.119317 13.410438,-8.499051c10.603603,-4.079545 13.098568,-6.459279 13.098568,-13.258519c0,-4.759469 1.247483,-7.819127 2.806836,-6.799241c1.559353,1.359848 3.430577,1.019886 4.054318,-0.679924c0.31187,-1.359848 6.861155,-7.479165 14.346051,-13.938444c7.484896,-6.119317 12.786697,-11.898671 12.474826,-12.578595c-1.871224,-1.69981 -47.404341,-11.558709 -54.577366,-11.558709c-4.054318,0 -7.173025,-1.359848 -7.173025,-3.059659c0,-2.719696 -3.430577,-3.739583 -31.810807,-9.178975c-6.549283,-1.019886 -11.851085,-3.059659 -11.851085,-4.419507c0,-1.359848 -4.98993,-4.419507 -10.915473,-6.799241c-5.925543,-2.379734 -12.786697,-6.119317 -14.969791,-8.159089c-5.613672,-5.779355 -17.152886,-12.578595 -21.207205,-12.578595c-4.36619,0 -12.162956,-8.499051 -12.162956,-13.258519c0,-2.039772 -1.559353,-3.739583 -3.118707,-3.739583c-1.871224,0 -4.98993,-3.739583 -6.861155,-8.499051c-1.871224,-4.759469 -5.301801,-8.499051 -7.484896,-8.499051c-2.183095,0 -5.925543,-3.399621 -7.796766,-7.479165c-2.183095,-4.419507 -6.237413,-10.198861 -9.35612,-13.258519c-3.118707,-3.059659 -4.98993,-6.119317 -4.36619,-7.139203c0.935612,-1.019886 -0.31187,-3.739583 -3.118707,-6.119317c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.719696 -1.247483,-3.739583 -3.118707,-2.719696c-1.559353,1.019886 -3.118707,-0.679924 -3.118707,-4.079545c0,-3.399621 -2.806836,-9.858899 -5.925543,-14.278406l-5.613672,-7.819127l-4.98993,13.938444c-2.806836,7.479165 -6.861155,13.938444 -9.044249,13.938444c-1.871224,0 -2.494965,1.019886 -1.559353,2.379734c2.494965,2.379734 -11.227344,29.576697 -20.271593,39.775558c-3.118707,3.739583 -5.613672,8.159089 -5.613672,9.858899c0,1.69981 -2.494965,5.779355 -5.301801,8.839013c-3.118707,3.059659 -10.603603,12.238633 -16.529145,20.737685c-10.603603,15.298292 -23.078429,27.876887 -26.509006,27.196963c-0.935612,-0.339962 -5.925543,4.419507 -10.915473,10.198861c-4.67806,5.439393 -10.915473,10.198861 -13.722309,10.198861c-2.806836,0 -4.98993,1.69981 -4.98993,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.118707,0 -6.549283,2.379734 -7.796766,5.099431c-0.935612,2.719696 -4.98993,5.099431 -9.044249,5.099431c-9.667991,0 -21.519076,12.238633 -20.271593,21.417609c0.935612,6.459279 17.152886,18.35795 32.434549,23.797342c3.430577,1.359848 11.539215,4.759469 18.400369,7.819127c24.325912,10.878785 35.241385,11.558709 165.603322,7.139203l-0.000003,-0.000002l0.000001,0.000002zm-224.858748,-126.125917c3.430577,-1.359848 9.979861,-4.079545 14.657921,-6.119317c4.67806,-2.039772 7.796766,-4.759469 6.861155,-6.459279c-0.935612,-1.69981 -0.31187,-3.059659 1.559353,-3.059659c4.054318,0 31.498937,-29.576697 31.498937,-33.996204c0,-2.039772 2.183095,-3.399621 4.67806,-3.399621c4.054318,0 5.301801,-2.039772 4.36619,-8.839013c0,-1.019886 2.494965,-4.419507 5.613672,-7.479165c3.118707,-3.059659 7.484896,-9.858899 9.979861,-14.95833c2.494965,-5.439393 5.613672,-9.518937 7.173025,-9.518937c1.247483,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 1.247483,-5.099431 3.118707,-5.099431c1.559353,0 5.301801,-5.099431 7.796766,-10.878785c2.806836,-6.119317 8.108638,-17.338064 11.851085,-25.157191c3.742448,-7.479165 9.35612,-20.397723 12.474826,-28.896773c3.118707,-8.159089 6.861155,-17.678026 8.732378,-20.737685c1.559353,-3.399621 2.806836,-11.558709 2.806836,-18.017988c0,-6.459279 1.559353,-11.898671 3.118707,-11.898671c1.871224,0 3.118707,-21.077647 3.118707,-56.093736c0,-35.01609 -1.247483,-56.093736 -3.118707,-56.093736c-1.559353,0 -3.118707,-6.799241 -3.118707,-14.95833c0,-8.499051 -1.247483,-16.318178 -3.118707,-17.338064c-1.559353,-1.019886 -3.118707,-5.099431 -3.118707,-8.839013c0,-3.399621 -0.935612,-6.459279 -2.494965,-6.459279c-1.247483,0 -4.054318,-4.759469 -6.549283,-10.538823c-2.494965,-6.119317 -10.291732,-17.678026 -17.776628,-26.177077c-7.484896,-8.499051 -13.722309,-16.65814 -13.722309,-18.35795c0,-1.359848 -1.247483,-2.719696 -3.118707,-2.719696c-1.559353,0 -6.861155,-4.419507 -11.539215,-10.198861c-4.36619,-5.439393 -10.291732,-10.198861 -13.098568,-10.198861c-2.806836,0 -7.796766,-3.739583 -10.915473,-8.499051c-3.118707,-4.759469 -7.484896,-8.499051 -9.35612,-8.499051c-2.183095,0 -8.732378,-4.079545 -14.657921,-8.839013c-5.925543,-4.759469 -15.593533,-11.218747 -21.519076,-14.278406c-5.925543,-3.059659 -11.539215,-6.459279 -12.474826,-7.479165c-3.430577,-4.079545 -19.335981,-10.198861 -26.820877,-10.198861c-4.36619,0 -7.173025,-1.359848 -6.237413,-3.059659c6.861155,-11.558709 -130.050066,-13.938444 -146.267341,-2.379734c-4.054318,3.059659 -10.291732,5.439393 -13.722309,5.439393c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -4.67806,3.399621 -8.108638,3.399621c-3.118707,0 -5.925543,1.69981 -5.925543,3.399621c0,2.039772 -2.806836,3.399621 -6.237413,3.399621c-3.430577,0 -6.237413,1.359848 -6.237413,2.719696c0,1.69981 -5.613672,5.779355 -12.474826,9.178975c-13.098568,6.459279 -40.543186,33.656242 -40.543186,40.455482c0,2.039772 6.237413,9.858899 14.03418,17.338064c7.796766,7.479165 14.03418,15.298292 14.03418,18.017988c0,2.379734 4.67806,6.459279 10.603603,9.178975c5.613672,2.719696 11.227344,7.139203 12.162956,10.198861c1.247483,3.059659 5.925543,5.099431 11.227344,5.099431c6.861155,0 10.915473,2.719696 14.657921,8.499051c3.430577,5.779355 7.796766,8.499051 14.03418,8.499051c7.173025,0 9.667991,2.379734 13.722309,11.898671c2.806836,8.159089 7.796766,13.598481 14.969791,16.998102c5.925543,2.719696 11.539215,7.819127 12.474826,11.898671c2.183095,9.858899 7.484896,8.499051 13.098568,-3.399621c7.484896,-15.638254 14.03418,-12.578595 18.71224,8.159089c2.806836,11.898671 4.67806,13.598481 17.152886,17.678026c27.444619,9.178975 51.146788,4.079545 57.696073,-11.558709c1.559353,-4.079545 4.054318,-7.479165 5.301801,-7.479165c1.559353,0 2.494965,-2.379734 2.494965,-5.439393c0,-6.119317 7.484896,-14.95833 12.786697,-14.95833c1.871224,0 5.925543,-2.719696 8.732378,-5.779355c7.796766,-9.518937 18.088498,-14.618368 28.38023,-14.618368c5.613672,0 9.044249,-1.359848 7.796766,-3.399621c-3.430577,-6.119317 47.404341,-5.779355 52.706142,0.339962c1.871224,1.69981 5.613672,3.059659 8.732378,3.059659c7.173025,0 16.841016,5.779355 29.003972,17.678026c4.98993,5.439393 11.227344,9.518937 13.410438,9.518937c2.183095,0 3.430577,1.359848 2.183095,3.059659c-0.935612,1.69981 0.935612,5.779355 3.742448,9.178975c13.722309,14.618368 19.647851,35.696015 19.647851,69.692218c0,17.678026 -1.247483,33.656242 -2.494965,35.696015c-1.559353,1.69981 -5.301801,10.198861 -8.108638,19.377837c-3.118707,8.839013 -6.861155,15.298292 -8.420508,13.938444c-1.559353,-1.019886 -2.806836,0.679924 -2.806836,3.399621c0,3.059659 -4.98993,8.839013 -10.915473,12.918557c-5.925543,4.419507 -10.915473,9.518937 -10.915473,11.218747c0,2.039772 -6.549283,5.779355 -14.657921,8.159089c-8.420508,2.719696 -15.593533,6.119317 -16.529145,7.479165c-0.935612,1.359848 -14.346051,3.059659 -29.627713,3.739583c-28.068359,1.019886 -28.068359,1.019886 -27.132747,9.518937c0.623741,4.759469 2.494965,10.198861 4.054318,12.238633c1.871224,2.719696 -0.623741,5.779355 -8.108638,9.518937c-7.796766,4.079545 -10.915473,7.819127 -10.915473,13.598481c0,4.419507 -2.183095,9.858899 -4.67806,12.238633c-6.237413,5.779355 -5.925543,11.218747 1.559353,18.697912c3.430577,3.399621 6.237413,9.518937 6.237413,13.258519c0.31187,8.499051 6.861155,36.035977 9.979861,41.135407c2.183095,4.079545 13.410438,4.079545 22.766559,0.339962l0.000003,-0.000001l0.000004,0zm450.964978,-32.976318c4.98993,-5.779355 9.044249,-11.898671 9.044249,-13.598481c0,-1.69981 1.559353,-2.719696 3.742448,-2.039772c1.871224,0.339962 4.98993,-2.379734 6.861155,-6.119317c1.871224,-3.739583 7.173025,-13.938444 11.539215,-22.097533c4.36619,-8.499051 9.044249,-19.377837 10.291732,-24.477266c0.935612,-5.439393 4.054318,-9.518937 6.237413,-9.518937c2.806836,0 3.742448,-2.379734 2.806836,-6.799241c-0.935612,-4.419507 -4.36619,-6.799241 -9.044249,-6.799241c-4.054318,0 -7.484896,-1.359848 -7.484896,-3.399621c0,-1.69981 -2.183095,-3.399621 -4.67806,-3.399621c-2.494965,0 -4.67806,-1.359848 -4.67806,-3.059659c0,-1.69981 -2.806836,-4.079545 -5.925543,-5.439393c-8.732378,-3.059659 -34.617644,-30.936546 -34.617644,-37.395824c0,-3.059659 -1.247483,-4.759469 -2.806836,-3.739583c-3.118707,2.039772 -6.237413,-6.459279 -9.979861,-26.857001c-1.247483,-7.479165 -3.430577,-18.697912 -4.67806,-24.817229c-2.494965,-14.278406 9.044249,-65.272712 14.969791,-65.272712c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-6.459279 23.702171,-32.976318 29.315842,-32.976318c2.806836,0 4.98993,-1.359848 4.98993,-3.399621c0,-1.69981 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 3.430577,-3.399621 7.484896,-3.399621c4.36619,0 8.732378,-1.359848 9.667991,-3.399621c0.935612,-1.69981 13.722309,-3.399621 28.068359,-3.399621c14.346051,0 27.132747,1.69981 28.068359,3.399621c0.935612,2.039772 4.67806,3.399621 8.108638,3.399621c3.118707,0 5.925543,1.69981 5.925543,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.69981 4.67806,3.399621c0,2.039772 2.806836,3.399621 6.549283,3.399621c3.430577,0 5.301801,1.69981 4.36619,3.399621c-0.935612,2.039772 -0.623741,3.399621 1.247483,3.399621c4.054318,0 19.024111,16.318178 19.024111,20.397723c0,2.039772 1.247483,3.399621 2.806836,3.399621c2.494965,0 5.613672,7.819127 8.420508,21.417609c1.559353,6.799241 13.722309,22.437495 13.722309,17.338064c0,-1.69981 1.559353,-0.339962 3.430577,3.059659c4.36619,8.159089 8.420508,7.139203 9.667991,-2.719696c0.623741,-4.759469 2.183095,-8.499051 3.742448,-8.499051c1.559353,0.339962 4.36619,-3.059659 6.237413,-7.139203c3.430577,-7.479165 16.529145,-18.017988 27.756489,-22.097533c2.806836,-1.359848 5.301801,-4.079545 5.301801,-6.459279c0,-2.719696 2.806836,-5.439393 5.925543,-6.799241c11.227344,-3.739583 12.786697,-9.518937 7.796766,-27.876887c-2.494965,-9.518937 -6.861155,-19.377837 -9.35612,-21.417609c-2.183095,-2.379734 -4.36619,-7.139203 -4.36619,-10.878785c0,-3.399621 -4.67806,-11.558709 -10.291732,-17.678026c-5.613672,-6.119317 -12.786697,-16.65814 -15.905404,-23.457381c-2.806836,-7.139203 -6.549283,-12.578595 -8.108638,-12.578595c-1.871224,0 -3.118707,-2.039772 -3.118707,-4.759469c0,-2.379734 -4.054318,-9.178975 -9.35612,-14.95833c-4.98993,-6.119317 -9.35612,-12.238633 -9.35612,-14.278406c0,-2.039772 -6.549283,-10.198861 -14.346051,-18.35795c-22.142817,-22.777457 -25.885265,-25.837115 -30.875196,-25.837115c-2.494965,0 -4.67806,-1.019886 -4.67806,-2.719696c0,-4.079545 -29.627713,-17.678026 -38.360092,-17.678026c-4.36619,0 -10.291732,-2.379734 -13.098568,-5.439393c-4.36619,-4.759469 -13.410438,-5.779355 -64.245356,-5.439393c-32.434549,0.339962 -61.438521,1.69981 -64.557227,3.739583c-2.806836,1.69981 -16.529145,4.759469 -30.251454,7.139203c-13.722309,2.379734 -28.068359,6.459279 -31.810807,8.839013c-3.742448,2.719696 -11.227344,4.759469 -16.217274,4.759469c-4.98993,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -5.301801,3.399621 -9.667991,3.399621c-4.36619,0 -6.861155,1.359848 -5.925543,3.399621c1.247483,2.039772 -1.871224,3.399621 -7.484896,3.399621c-4.98993,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -4.36619,3.399621 -7.173025,3.399621c-2.806836,0 -10.291732,4.759469 -16.217274,10.198861c-5.925543,5.779355 -13.098568,10.878785 -15.905404,11.898671c-4.98993,1.69981 -18.400369,26.177077 -18.400369,33.656242c0,2.379734 -2.183095,8.839013 -4.67806,14.618368c-15.281663,33.31628 -23.078429,151.963032 -12.474826,190.03878c2.494965,9.178975 4.67806,21.077647 4.67806,26.517039c0,13.598481 6.549283,36.035977 9.667991,33.996204c1.559353,-1.019886 2.806836,1.359848 2.806836,5.439393c0,3.739583 1.247483,9.518937 2.806836,12.918557c1.559353,3.059659 4.36619,9.858899 6.237413,15.298292c7.173025,19.377837 10.915473,26.177077 21.830946,40.795444c6.237413,8.159089 14.03418,19.037874 17.464757,23.797342c3.430577,5.099431 7.796766,9.178975 9.979861,9.178975c2.183095,0 4.054318,1.69981 4.054318,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.69981 4.67806,3.399621c0,2.039772 1.871224,3.399621 4.36619,3.399621c2.494965,0 6.549283,2.039772 8.732378,4.419507c9.044249,9.178975 18.400369,12.238633 54.889236,18.017988c7.173025,1.359848 14.03418,3.739583 14.969791,5.099431c0.935612,1.69981 15.593533,3.059659 33.05829,3.059659c30.875196,0 31.187066,0 40.231315,-10.538823l0.000002,-0.000005l0.000005,-0.000001zm-553.882297,-247.832327c1.247483,-2.039772 -3.118707,-3.059659 -11.539215,-3.059659l-13.410438,0.679924l10.915473,2.379734c5.925543,1.359848 11.227344,2.719696 11.539215,3.059659c0.31187,0 1.559353,-1.019886 2.494965,-3.059659l0,0.000001zm879.163397,-124.086145c2.806836,-4.759469 6.549283,-7.819127 8.108638,-6.799241c1.871224,1.359848 3.118707,-0.679924 3.118707,-3.739583c0,-3.399621 1.247483,-10.538823 2.806836,-16.318178c8.420508,-30.596584 12.786697,-61.193167 12.786697,-86.010396l0,-28.216849l-10.915473,0c-5.925543,0 -10.915473,1.69981 -10.915473,3.399621c0,2.039772 -10.915473,3.399621 -26.509006,3.399621c-15.593533,0 -26.509006,-1.359848 -26.509006,-3.399621c0,-1.69981 -2.806836,-3.399621 -5.925543,-3.399621c-3.430577,0 -7.173025,-1.69981 -8.420508,-3.739583c-0.935612,-2.039772 -6.861155,-6.119317 -12.786697,-8.839013c-5.925543,-2.719696 -11.539215,-7.819127 -12.474826,-11.218747c-0.935612,-3.739583 -2.806836,-5.779355 -4.36619,-4.759469c-1.559353,0.679924 -4.36619,-1.359848 -6.549283,-5.439393c-2.183095,-3.739583 -4.98993,-6.799241 -6.237413,-6.799241c-4.054318,0 -17.464757,-16.65814 -24.637782,-30.596584c-3.742448,-7.479165 -8.108638,-13.598481 -9.667991,-13.598481c-1.247483,0 -2.494965,-2.379734 -2.494965,-5.099431c0,-5.099431 -5.925543,-18.697912 -9.667991,-22.097533c-6.861155,-6.119317 -12.162956,-127.145803 -6.237413,-133.605082c1.871224,-2.039772 3.430577,-7.479165 3.430577,-11.898671c0,-4.419507 1.247483,-6.799241 3.118707,-5.779355c1.871224,1.019886 3.118707,-1.019886 3.118707,-4.759469c0,-3.739583 1.559353,-7.819127 3.118707,-8.839013c1.871224,-1.019886 3.118707,-4.419507 3.118707,-7.479165c0,-11.558709 51.77053,-72.751876 70.170899,-82.610776c14.03418,-7.819127 13.410438,-18.017988 -2.806836,-45.894875c-7.796766,-12.918557 -15.593533,-25.497153 -17.464757,-27.876887c-1.559353,-2.379734 -3.118707,-5.779355 -3.118707,-7.819127c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-2.719696 -1.871224,-5.099431 -4.36619,-5.099431c-2.494965,0 -5.301801,-3.059659 -6.549283,-6.459279c-0.935612,-3.739583 -8.108638,-12.918557 -15.593533,-20.397723c-7.796766,-7.819127 -14.03418,-15.638254 -14.03418,-17.338064c0,-1.69981 -3.430577,-4.079545 -7.796766,-5.439393c-4.36619,-1.019886 -7.796766,-3.399621 -7.796766,-4.759469c0,-1.359848 -4.67806,-5.099431 -9.979861,-8.159089c-5.613672,-3.059659 -12.474826,-7.139203 -14.969791,-8.839013c-2.494965,-1.359848 -16.529145,-6.119317 -31.187066,-10.538823c-14.657921,-4.079545 -29.315842,-8.499051 -32.746419,-10.198861c-12.786697,-5.439393 -73.601476,-7.479165 -243.259117,-7.139203c-175.895053,0 -258.540779,2.379734 -251.367754,7.139203c3.430577,2.379734 -75.784571,12.918557 -124.436394,16.318178c-11.227344,1.019886 -21.830946,3.059659 -23.702171,4.759469c-1.871224,1.69981 -14.03418,4.759469 -26.509006,6.799241c-39.607574,6.119317 -43.350022,7.139203 -43.350022,10.198861c0,1.69981 -5.613672,3.059659 -12.162956,3.059659c-6.861155,0 -13.410438,1.69981 -14.346051,3.399621c-0.935612,2.039772 -8.108638,3.399621 -15.905404,3.399621c-7.484896,0 -13.722309,1.359848 -13.722309,3.059659c0,1.359848 -6.549283,4.079545 -14.657921,5.099431c-26.509006,4.419507 -48.963694,8.499051 -63.933486,11.558709c-8.420508,1.69981 -14.969791,2.379734 -14.969791,1.69981c0,-0.679924 -3.118707,1.019886 -6.861155,3.739583c-3.742448,3.059659 -9.979861,5.439393 -14.03418,5.439393c-8.420508,0 -22.766559,6.799241 -22.766559,10.878785c0,1.359848 -2.806836,2.719696 -6.237413,2.719696c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -6.861155,3.399621 -13.098568,3.399621c-6.237413,0 -10.291732,1.019886 -9.35612,2.379734c2.494965,2.379734 -11.851085,11.218747 -18.400369,11.218747c-2.494965,0 -5.301801,2.379734 -6.237413,5.099431c-1.247483,2.719696 -3.118707,4.079545 -4.67806,3.059659c-1.559353,-1.019886 -2.806836,1.359848 -2.806836,4.759469c0,3.739583 2.494965,7.479165 5.613672,8.839013c8.420508,3.059659 15.905404,9.178975 32.746419,26.857001c15.281663,15.978216 36.488867,45.554913 36.488867,50.654344c0,1.359848 4.054318,12.578595 9.35612,24.817229c4.98993,12.238633 9.35612,24.477266 9.35612,26.857001c0,2.379734 2.183095,10.538823 4.98993,17.678026c4.36619,10.878785 4.98993,21.077647 3.430577,57.453585c-0.935612,26.517039 -3.118707,44.535027 -4.98993,45.214951c-1.871224,0.679924 -3.430577,6.459279 -3.430577,12.578595c0,6.459279 -1.247483,12.578595 -3.118707,13.598481c-1.559353,1.019886 -3.118707,4.759469 -3.118707,8.159089c0,13.598481 -20.271593,48.614572 -39.607574,68.33237c-10.915473,11.218747 -20.895334,20.397723 -22.454688,20.397723c-1.559353,0 -3.430577,1.019886 -4.054318,2.719696c-1.871224,4.759469 -41.790669,24.477266 -49.899306,24.477266c-4.36619,0 -8.732378,1.69981 -9.35612,3.399621c-0.623741,2.379734 -14.346051,4.079545 -33.682032,4.419507c-33.05829,0.339962 -45.533117,-2.379734 -37.112609,-8.159089c3.430577,-2.379734 3.118707,-3.059659 -0.935612,-3.059659c-8.420508,0 -14.969791,3.739583 -14.969791,8.839013c0,2.719696 -2.494965,4.759469 -5.925543,4.759469c-4.98993,0 -5.301801,1.69981 -3.118707,16.998102c2.494965,16.998102 9.35612,32.296394 13.098568,28.556811c0.935612,-1.019886 3.742448,1.019886 5.925543,5.099431c2.183095,4.079545 6.549283,7.139203 9.667991,7.139203c3.118707,0 4.98993,1.359848 4.054318,3.059659c-4.98993,8.499051 71.730252,14.95833 81.086372,6.799241c1.871224,-1.69981 13.722309,-4.079545 26.509006,-5.099431c17.152886,-1.69981 26.820877,-0.679924 38.04822,3.399621c8.108638,3.059659 15.281663,5.439393 15.905404,5.439393c0.935612,0 6.549283,-5.439393 12.474826,-11.898671c6.237413,-6.459279 13.410438,-11.898671 16.217274,-11.898671c2.494965,0 3.742448,-1.359848 2.806836,-3.399621c-0.935612,-1.69981 -0.31187,-3.399621 1.871224,-3.399621c1.871224,0 5.925543,-2.719696 8.732378,-6.459279c2.806836,-3.399621 9.667991,-8.839013 15.281663,-11.898671c5.301801,-3.059659 9.979861,-7.139203 9.979861,-8.839013c0,-2.039772 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 1.871224,-3.399621 4.054318,-3.399621c5.613672,0 20.895334,-8.159089 20.895334,-10.878785c0,-1.69981 2.806836,-2.719696 6.237413,-2.719696c5.925543,0 18.400369,-6.119317 21.830946,-10.538823c2.806836,-3.739583 43.038152,-16.65814 51.458659,-16.65814c4.67806,0 11.227344,-2.039772 14.969791,-4.079545c3.742448,-2.379734 19.959722,-5.099431 35.553255,-6.119317c15.905404,-1.019886 30.563325,-3.739583 32.122678,-5.439393c2.494965,-2.719696 1.247483,-7.479165 -4.36619,-16.65814c-4.36619,-7.139203 -8.108638,-14.278406 -8.108638,-15.638254c0,-1.69981 -2.183095,-3.059659 -4.67806,-3.059659c-2.494965,0 -4.67806,-1.69981 -4.67806,-3.739583c0,-2.039772 -2.183095,-5.779355 -4.67806,-8.499051c-2.494965,-3.059659 -4.67806,-8.159089 -4.67806,-11.558709c0,-3.399621 -1.247483,-7.139203 -2.806836,-8.499051c-4.36619,-2.719696 -12.786697,-22.097533 -12.786697,-29.236735c0,-3.059659 -1.247483,-6.459279 -3.118707,-7.139203c-9.044249,-3.399621 -10.603603,-68.672332 -1.871224,-78.531231c2.183095,-2.379734 5.925543,-9.178975 8.420508,-14.95833c2.183095,-6.119317 5.301801,-11.218747 6.549283,-11.218747c1.559353,0 2.494965,-1.69981 2.494965,-3.739583c0,-3.739583 14.03418,-18.697912 33.682032,-36.375938c5.925543,-5.099431 14.346051,-12.918557 18.71224,-17.678026c4.67806,-4.759469 12.786697,-10.878785 17.776628,-13.598481c5.301801,-2.719696 12.162956,-7.819127 15.281663,-10.878785c3.430577,-3.399621 7.796766,-6.119317 9.979861,-6.119317c2.183095,0 4.36619,-1.359848 4.98993,-2.719696c1.247483,-3.739583 30.563325,-21.077647 35.553255,-21.077647c2.494965,0 4.36619,-1.359848 4.36619,-3.399621c0,-1.69981 4.054318,-3.399621 9.044249,-3.399621c5.301801,0 10.291732,-1.359848 11.227344,-3.399621c0.935612,-2.039772 6.861155,-3.399621 12.786697,-3.399621c5.925543,0 10.603603,-1.359848 10.603603,-3.399621c0,-1.69981 3.430577,-3.399621 7.796766,-3.399621c4.36619,0 7.796766,-1.359848 7.796766,-3.059659c0,-1.69981 3.118707,-3.739583 7.173025,-4.759469c3.742448,-1.019886 14.657921,-4.759469 24.014041,-8.499051c9.35612,-3.739583 27.444619,-8.499051 39.919445,-10.878785c12.162956,-2.039772 21.830946,-5.439393 20.583464,-7.139203c-1.871224,-3.739583 146.267341,-4.079545 149.697918,-0.339962c1.247483,1.359848 19.335981,4.759469 40.231315,7.819127c43.350022,6.459279 53.018013,10.198861 77.343924,30.596584c28.068359,23.117419 57.384201,54.733888 63.933486,68.672332c2.494965,5.099431 5.925543,9.178975 7.484896,9.178975c1.871224,0 3.118707,2.039772 3.118707,4.419507c0,2.039772 4.36619,9.518937 9.35612,15.978216c4.98993,6.459279 9.35612,13.938444 9.35612,16.318178c0,2.039772 1.247483,4.079545 2.494965,4.079545c2.494965,0 13.410438,26.517039 17.776628,43.515141c1.247483,4.079545 3.430577,6.799241 4.98993,5.779355c1.559353,-1.359848 2.806836,11.898671 2.806836,31.956432c0,20.397723 -1.247483,34.336166 -3.118707,34.336166c-1.559353,0 -4.98993,5.439393 -7.484896,11.898671c-5.613672,14.278406 -33.370161,45.894875 -40.543186,45.894875c-2.806836,0 -4.98993,2.379734 -4.98993,5.099431c0,2.719696 -2.183095,5.099431 -4.67806,5.099431c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -1.871224,3.399621 -4.36619,3.399621c-3.430577,0 -9.979861,9.178975 -7.173025,10.538823c0.31187,0 14.657921,1.69981 31.810807,3.399621c35.241385,3.399621 67.052192,8.499051 62.374133,9.858899c-3.118707,1.019886 16.217274,5.779355 36.488867,9.178975c6.549283,1.019886 13.098568,3.739583 15.281663,6.459279c1.871224,2.719696 5.925543,4.759469 9.044249,4.759469c7.484896,0 31.810807,15.298292 29.003972,18.017988c-0.935612,1.359848 0.935612,2.379734 4.67806,2.379734c3.742448,0 6.861155,1.69981 6.861155,3.399621c0,2.039772 1.559353,3.399621 3.430577,3.399621c1.871224,0 4.98993,2.039772 7.173025,4.419507c2.183095,2.039772 7.796766,7.139203 12.162956,10.878785c4.67806,3.739583 8.420508,8.499051 8.420508,10.878785c0,2.379734 1.559353,4.419507 3.430577,4.419507c3.742448,0 21.519076,20.397723 21.519076,24.477266c0,1.359848 1.871224,4.419507 4.054318,6.799241c2.183095,2.379734 8.108638,10.538823 13.098568,18.017988c5.301801,7.479165 10.291732,14.278406 11.227344,15.298292c0.935612,1.019886 3.742448,6.799241 6.237413,12.918557c2.494965,5.779355 5.301801,10.878785 6.549283,10.878785c1.559353,0 2.494965,2.039772 2.494965,4.419507c0,7.819127 9.667991,27.196963 18.400369,37.055862c9.044249,10.198861 14.657921,8.839013 23.390299,-5.779355l0.000003,0l0.000007,0.000002zm-613.449593,-64.252826c6.861155,-16.65814 5.613672,-19.037874 -10.915473,-19.037874c-8.420508,0 -15.905404,1.019886 -17.152886,2.039772c-2.806836,3.399621 1.247483,11.558709 5.925543,11.558709c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,5.099431 7.173025,12.918557 10.915473,12.578595c1.559353,-0.339962 4.67806,-5.099431 6.861155,-10.538823l-0.000001,0l-0.000001,0zm77.343924,-93.829523c0.935612,-1.69981 4.98993,-3.399621 9.044249,-3.399621c3.742448,0 12.474826,-2.719696 19.335981,-6.459279c6.549283,-3.399621 17.776628,-8.499051 24.637782,-10.878785c6.861155,-2.719696 13.722309,-6.799241 14.969791,-8.839013c1.247483,-2.379734 4.054318,-4.419507 6.237413,-4.419507c2.183095,0 7.796766,-3.739583 12.786697,-8.499051c4.98993,-4.759469 10.291732,-8.499051 11.851085,-8.499051c1.247483,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.439393c0,-2.719696 1.247483,-4.419507 2.494965,-3.399621c1.559353,1.019886 4.67806,-2.039772 6.861155,-6.459279c2.183095,-4.759469 4.98993,-8.499051 6.237413,-8.499051c0.935612,0 9.979861,-8.499051 19.959722,-18.697912c9.667991,-10.198861 19.024111,-18.697912 20.271593,-18.697912c1.247483,0 7.484896,-5.439393 13.722309,-11.898671c6.237413,-6.459279 13.098568,-11.898671 14.657921,-11.898671c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-3.059659 -2.806836,-5.099431 -7.484896,-5.099431c-4.36619,0 -8.732378,-1.359848 -9.667991,-3.399621c-0.935612,-1.69981 -8.732378,-3.399621 -17.152886,-3.399621c-8.420508,0 -16.217274,-1.359848 -17.152886,-3.399621c-0.935612,-1.69981 -13.722309,-3.399621 -27.756489,-3.399621c-14.346051,0 -33.370161,-1.69981 -42.41441,-3.399621c-9.35612,-2.039772 -51.77053,-3.739583 -94.808681,-3.739583c-43.038152,-0.339962 -74.848959,-1.69981 -70.482769,-3.059659c6.549283,-2.379734 5.613672,-2.719696 -5.301801,-3.059659c-7.484896,-0.339962 -13.410438,1.359848 -13.410438,3.059659c0,2.039772 -15.281663,3.399621 -39.607574,3.399621c-42.41441,0 -103.852931,6.459279 -103.852931,10.878785c0,1.359848 -4.98993,2.719696 -10.915473,2.719696c-5.925543,0 -10.915473,1.69981 -10.915473,3.399621c0,2.039772 -2.494965,3.399621 -5.301801,3.399621c-3.118707,0 -9.044249,3.059659 -13.410438,6.799241c-4.36619,3.739583 -10.603603,6.799241 -14.03418,6.799241c-3.430577,0 -10.915473,4.419507 -16.841016,9.858899c-9.35612,8.159089 -9.979861,10.198861 -6.861155,16.65814c1.871224,4.079545 4.98993,7.479165 6.549283,7.479165c1.871224,0 3.118707,2.379734 3.118707,5.099431c0,2.719696 1.559353,5.099431 3.430577,5.099431c1.559353,0 2.494965,1.359848 1.559353,2.719696c-0.935612,1.69981 3.118707,8.499051 9.044249,15.298292c5.925543,7.139203 10.915473,13.938444 10.915473,15.298292c0,4.419507 9.35612,14.618368 21.207205,23.797342c15.905404,12.238633 50.834918,31.276508 57.072331,31.276508c3.430577,0 5.925543,1.69981 5.925543,3.399621c0,2.039772 5.301801,3.399621 11.851085,3.399621c6.237413,0 13.722309,1.69981 16.217274,3.399621c6.549283,4.419507 183.068079,4.419507 185.563044,0l0,0.000002l0.000002,0.000001zm-345.552694,-202.617376c-0.935612,-1.019886 -3.742448,-1.359848 -5.925543,-0.339962c-2.494965,1.019886 -1.559353,2.039772 1.871224,2.039772c3.430577,0.339962 5.301801,-0.679924 4.054318,-1.69981l0.000001,0zm10.291732,-8.159089c0,-1.69981 1.871224,-3.399621 4.36619,-3.399621c2.494965,0 9.667991,-2.719696 16.529145,-6.459279c16.217274,-8.499051 32.434549,-13.938444 42.41441,-13.938444c4.36619,0 9.35612,-2.039772 10.603603,-4.759469c2.806836,-5.099431 19.335981,-7.819127 67.987804,-10.878785c20.583464,-1.359848 29.003972,-3.059659 24.949653,-5.099431c-3.430577,-1.359848 34.617644,-2.719696 84.205079,-2.719696c49.899306,0 87.635656,1.359848 84.205079,2.719696c-3.742448,1.69981 11.227344,3.739583 37.42448,5.099431c35.865127,1.69981 106.347896,7.139203 110.090344,8.499051c0.623741,0.339962 0,2.039772 -0.935612,3.739583c-1.247483,2.039772 5.301801,3.399621 16.841016,3.399621c19.647851,0 24.325912,-4.419507 14.346051,-13.598481c-2.494965,-2.379734 -3.742448,-5.779355 -2.494965,-7.819127c0.935612,-2.039772 0.31187,-2.379734 -1.559353,-1.019886c-2.183095,1.359848 -5.301801,-1.019886 -7.484896,-6.119317c-1.871224,-4.759469 -4.67806,-8.839013 -5.925543,-8.839013c-1.247483,0 -5.301801,-5.439393 -9.044249,-11.898671c-3.742448,-6.459279 -7.796766,-11.898671 -9.35612,-11.898671c-1.247483,0 -6.861155,-4.419507 -12.474826,-10.198861c-5.613672,-5.439393 -12.786697,-10.198861 -15.905404,-10.198861c-3.118707,0 -7.484896,-3.059659 -9.667991,-6.799241c-2.183095,-3.739583 -7.173025,-6.799241 -10.915473,-6.799241c-4.054318,0 -7.173025,-1.359848 -7.173025,-3.399621c0,-2.039772 -9.35612,-3.399621 -22.142817,-3.399621c-11.851085,0 -21.207205,-1.359848 -20.271593,-3.059659c4.054318,-7.139203 -114.768404,-10.198861 -141.589281,-3.399621c-7.796766,2.039772 -18.71224,4.419507 -24.325912,5.439393c-5.613672,1.019886 -10.915473,3.059659 -11.851085,4.759469c-0.935612,1.69981 -5.613672,3.059659 -10.915473,3.059659c-4.98993,0 -9.044249,1.359848 -9.044249,2.719696c0,1.359848 -6.549283,4.419507 -14.657921,6.799241c-8.420508,2.719696 -17.464757,6.119317 -20.271593,7.819127c-3.118707,1.69981 -8.420508,3.059659 -11.539215,3.059659c-3.430577,0 -6.861155,1.359848 -7.796766,3.059659c-0.935612,1.69981 -8.732378,4.759469 -17.152886,7.139203c-8.732378,2.039772 -17.152886,6.119317 -19.335981,8.839013c-1.871224,2.719696 -6.237413,4.759469 -9.35612,4.759469c-5.925543,0 -25.885265,10.878785 -32.434549,18.017988c-1.871224,2.379734 -10.915473,9.518937 -19.647851,15.978216c-9.044249,6.459279 -16.217274,13.598481 -16.217274,15.978216c0,2.039772 -2.806836,5.099431 -6.237413,6.119317c-3.430577,1.019886 -6.237413,3.739583 -6.237413,5.439393c0,1.69981 -1.871224,3.059659 -4.054318,3.059659c-2.183095,0 -5.613672,3.059659 -7.796766,6.799241c-3.430577,6.119317 -3.118707,6.799241 4.054318,6.799241c4.36619,0 7.796766,-1.359848 7.796766,-3.399621l-0.000001,0l-0.000004,-0.000003z" id="svg_3" stroke-width="0" stroke="null"></path> <path d="m557.957919,6372.850587c0,-4.759469 0.623741,-6.459279 1.559353,-4.079545c0.623741,2.039772 0.623741,6.119317 0,8.499051c-0.935612,2.039772 -1.559353,0.339962 -1.559353,-4.419507l0,0.000001z" id="svg_4" stroke-width="0" stroke="null"></path> <path d="m547.978057,6237.205733c0,-1.69981 -0.935612,-5.439393 -1.871224,-8.499051c-1.247483,-3.739583 -0.31187,-5.439393 3.118707,-5.439393c3.118707,0 4.98993,3.059659 4.98993,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,-1.359848 -3.118707,-3.059659l0.000001,0.000001z" id="svg_5" stroke-width="0" stroke="null"></path> <path d="m522.092792,6197.090212c-1.247483,-1.019886 -2.183095,-6.459279 -2.183095,-11.898671c0,-13.598481 7.484896,-10.538823 8.732378,3.399621c0.935612,10.198861 -1.871224,13.938444 -6.549283,8.499051l0,-0.000001z" id="svg_6" stroke-width="0" stroke="null"></path> <path d="m497.45501,6146.095906c2.183095,-1.019886 4.98993,-0.679924 5.925543,0.339962c1.247483,1.019886 -0.623741,2.039772 -4.054318,1.69981c-3.430577,0 -4.36619,-1.019886 -1.871224,-2.039772l-0.000001,0z" id="svg_7" stroke-width="0" stroke="null"></path> <path d="m2238.628918,6132.837387c0,-3.739583 0.935612,-4.759469 1.871224,-2.039772c0.935612,2.379734 0.623741,5.439393 -0.31187,6.459279c-0.935612,1.359848 -1.871224,-0.679924 -1.559353,-4.419507l-0.000001,0z" id="svg_8" stroke-width="0" stroke="null"></path> <path d="m993.329363,5785.736144c2.183095,-1.019886 4.98993,-0.679924 5.925543,0.339962c1.247483,1.019886 -0.623741,2.039772 -4.054318,1.69981c-3.430577,0 -4.36619,-1.019886 -1.871224,-2.039772l-0.000001,0z" id="svg_9" stroke-width="0" stroke="null"></path> <path d="m376.449193,5685.787304c0,-1.69981 1.559353,-2.379734 3.118707,-1.359848c1.871224,1.019886 3.118707,2.719696 3.118707,3.739583c0,0.679924 -1.247483,1.359848 -3.118707,1.359848c-1.559353,0 -3.118707,-1.69981 -3.118707,-3.739583z" id="svg_10" stroke-width="0" stroke="null"></path> <path d="m111.982871,5924.100694c0,-4.759469 0.623741,-6.459279 1.559353,-4.079545c0.623741,2.039772 0.623741,6.119317 0,8.499051c-0.935612,2.039772 -1.559353,0.339962 -1.559353,-4.419507l0,0.000001z" id="svg_11" stroke-width="0" stroke="null"></path> </g> </g> </svg> <span class="text-xl font-bold sm:text-2xl">知道的越多，才知知道的越少</span> </a> <nav aria-label="Main menu" class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <a class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" data-astro-prefetch href="/astro-theme-cactus/"> Home </a><a class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" data-astro-prefetch href="/astro-theme-cactus/posts/"> Blog </a> </nav> </div> <site-search class="ms-auto" id="search" data-astro-cid-otpdt6jm> <button class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2" data-open-modal disabled data-astro-cid-otpdt6jm> <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M0 0h24v24H0z" stroke="none" data-astro-cid-otpdt6jm></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md" data-astro-cid-otpdt6jm> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6" data-astro-cid-otpdt6jm> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal data-astro-cid-otpdt6jm>Close</button> <div class="search-container" data-astro-cid-otpdt6jm> <div id="cactus__search" data-astro-cid-otpdt6jm></div> </div> </div> </dialog> </site-search>    <theme-toggle class="ms-2 sm:ms-4"> <button class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2" type="button"> <span class="sr-only">Dark Theme</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0" fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100" fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path> <path d="M19 11h2m-1 -1v2"></path> </svg> </button> </theme-toggle>  <mobile-button> <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header>  <main id="main">  <div class="gap-x-10 lg:flex lg:items-start"> <aside class="sticky top-20 order-2 -me-32 hidden basis-64 lg:block"> <h2 class="font-semibold">Table of Contents</h2> <ul class="mt-4 text-xs"> <li class=""> <a aria-label="Scroll to section: Java 中锁的分类" class="block line-clamp-2 hover:text-accent mt-3" href="#java-中锁的分类"><span class="me-0.5">#</span>Java 中锁的分类</a>  </li><li class=""> <a aria-label="Scroll to section: ReentrantLock" class="block line-clamp-2 hover:text-accent mt-3" href="#reentrantlock"><span class="me-0.5">#</span>ReentrantLock</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 公平锁" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#公平锁"><span class="me-0.5">#</span>公平锁</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 非公平锁" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#非公平锁"><span class="me-0.5">#</span>非公平锁</a>  </li> </ul> </li><li class=""> <a aria-label="Scroll to section: synchronized 在 JDK1.6 的优化" class="block line-clamp-2 hover:text-accent mt-3" href="#synchronized-在-jdk16-的优化"><span class="me-0.5">#</span>synchronized 在 JDK1.6 的优化</a>  </li><li class=""> <a aria-label="Scroll to section: synchronized 的实现原理" class="block line-clamp-2 hover:text-accent mt-3" href="#synchronized-的实现原理"><span class="me-0.5">#</span>synchronized 的实现原理</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 对象结构" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#对象结构"><span class="me-0.5">#</span>对象结构</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 上锁的原理" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#上锁的原理"><span class="me-0.5">#</span>上锁的原理</a>  </li> </ul> </li><li class=""> <a aria-label="Scroll to section: ReentrantLock和synchronized的区别" class="block line-clamp-2 hover:text-accent mt-3" href="#reentrantlock和synchronized的区别"><span class="me-0.5">#</span>ReentrantLock和synchronized的区别</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 用法不同" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#用法不同"><span class="me-0.5">#</span>用法不同</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 获取锁和释放锁方式不同" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#获取锁和释放锁方式不同"><span class="me-0.5">#</span>获取锁和释放锁方式不同</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 锁类型不同" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#锁类型不同"><span class="me-0.5">#</span>锁类型不同</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 响应中断不同" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#响应中断不同"><span class="me-0.5">#</span>响应中断不同</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 底层实现不同" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#底层实现不同"><span class="me-0.5">#</span>底层实现不同</a>  </li> </ul> </li><li class=""> <a aria-label="Scroll to section: ReentrantReadWriteLock的实现原理" class="block line-clamp-2 hover:text-accent mt-3" href="#reentrantreadwritelock的实现原理"><span class="me-0.5">#</span>ReentrantReadWriteLock的实现原理</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 提供的方法" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#提供的方法"><span class="me-0.5">#</span>提供的方法</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 写锁的获取与释放" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#写锁的获取与释放"><span class="me-0.5">#</span>写锁的获取与释放</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 读锁的获取与释放" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#读锁的获取与释放"><span class="me-0.5">#</span>读锁的获取与释放</a>  </li> </ul> </li><li class=""> <a aria-label="Scroll to section: 死锁" class="block line-clamp-2 hover:text-accent mt-3" href="#死锁"><span class="me-0.5">#</span>死锁</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 形成死锁的四个必要条件" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#形成死锁的四个必要条件"><span class="me-0.5">#</span>形成死锁的四个必要条件</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 处理死锁的方法" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#处理死锁的方法"><span class="me-0.5">#</span>处理死锁的方法</a>  </li> </ul> </li><li class=""> <a aria-label="Scroll to section: AQS" class="block line-clamp-2 hover:text-accent mt-3" href="#aqs"><span class="me-0.5">#</span>AQS</a>  </li><li class=""> <a aria-label="Scroll to section: 面试须知" class="block line-clamp-2 hover:text-accent mt-3" href="#面试须知"><span class="me-0.5">#</span>面试须知</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: AQS 唤醒节点时,为何从后往前找" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#aqs-唤醒节点时为何从后往前找"><span class="me-0.5">#</span>AQS 唤醒节点时,为何从后往前找</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap在1.8做了什么优化" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap在18做了什么优化"><span class="me-0.5">#</span>ConcurrentHashMap在1.8做了什么优化</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap 的散列算法" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap-的散列算法"><span class="me-0.5">#</span>ConcurrentHashMap 的散列算法</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 为什么 ConcurrentHashMap 的数组长度需要时 2^n" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#为什么-concurrenthashmap-的数组长度需要时-2n"><span class="me-0.5">#</span>为什么 ConcurrentHashMap 的数组长度需要时 2^n</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap 初始化流程" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap-初始化流程"><span class="me-0.5">#</span>ConcurrentHashMap 初始化流程</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap 扩容流程" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap-扩容流程"><span class="me-0.5">#</span>ConcurrentHashMap 扩容流程</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap 读取数据流程" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap-读取数据流程"><span class="me-0.5">#</span>ConcurrentHashMap 读取数据流程</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: ConcurrentHashMap 计数器的实现" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#concurrenthashmap-计数器的实现"><span class="me-0.5">#</span>ConcurrentHashMap 计数器的实现</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: CAS 和自旋" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#cas-和自旋"><span class="me-0.5">#</span>CAS 和自旋</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 自旋" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#自旋"><span class="me-0.5">#</span>自旋</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: CAS" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#cas"><span class="me-0.5">#</span>CAS</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 自旋锁和 CAS 的关系是什么呢?" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#自旋锁和-cas-的关系是什么呢"><span class="me-0.5">#</span>自旋锁和 CAS 的关系是什么呢?</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 什么是 ABA 问题" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#什么是-aba-问题"><span class="me-0.5">#</span>什么是 ABA 问题</a>  </li> </ul> </li> </ul> </li> </ul> </aside> <article class="flex-grow break-words" data-pagefind-body> <div id="blog-hero"><h1 class="title mb-3 sm:mb-1"> ReentrantLock &amp; synchronized &amp; ReentrantReadWriteLock </h1> <div class="flex flex-wrap items-center gap-x-3 gap-y-2"> <p class="font-semibold"> <time datetime="2022-09-25T15:20:35.000Z"> September 25, 2022 </time> /  71 min read </p> <span class="rounded-lg bg-quote/10 p-1 text-quote">
Last Updated:
<time datetime="2024-05-16T14:00:40.000Z" class="ms-1"> May 16, 2024 </time> </span> </div> <div class="mt-3"> <svg aria-hidden="true" class="inline-block h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg>  <a aria-label="View more blogs with the tag java" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/astro-theme-cactus/tags/java/"> java </a> ,  <a aria-label="View more blogs with the tag lock" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/astro-theme-cactus/tags/lock/"> lock </a>  </div></div> <div class="prose prose-sm prose-cactus mt-12 prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none">  <h2 id="java-中锁的分类">Java 中锁的分类</h2>
<ol>
<li>
<p><strong>可重入锁、不可重入锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock,ReentrantReadWriteLock 都是可重入锁。</p>
<p><strong>重入</strong>: 当前线程获取到 A 锁,在获取之后尝试再次获取 A 锁是可以直接拿到的</p>
<p><strong>不可重入</strong>: 当前线程获取到 A 锁,在获取之后尝试再次获取 A 锁,无法获取到的,因为 A 锁被当前线程占用着,需要等待自己释放锁再获取锁。</p>
</li>
<li>
<p><strong>乐观锁、悲观锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock,ReentrantReadWriteLock 都是悲观锁。</p>
<p>Java 中提供的 CAS 操作,就是乐观锁的一种实现。</p>
<p><strong>悲观锁</strong>: 获取不到资源时,会将当前线程挂起(进入 BLOCKED、WAITING),线程挂起会涉及到用户态和内核态的切换,而这种切换是比较消耗资源的。</p>
<ul>
<li>用户态: JVM 可以自行执行的指令,不需要借助操作系统执行。</li>
<li>内核态: JVM 不可以自行执行,需要操作系统才可以执行。</li>
</ul>
<p><strong>乐观锁</strong>: 获取不到资源,可以再次让 CPU 调度,重新尝试获取锁资源。</p>
<p>Atomic 原子性类中,就是基于 CAS 乐观锁实现的。</p>
</li>
<li>
<p><strong>公平锁、非公平锁</strong></p>
<p>Java 中提供的 synchronized 只能是非公平锁。</p>
<p>Java 中提供的 ReentrantLock,ReentrantReadWriteLock 可以实现公平锁和非公平锁。</p>
<p><strong>公平锁</strong>: 线程 A 获取到了锁资源,线程 B 没有获得,线程 B 去排队,线程 C 来了,锁被 A 持有,同时线程 B 在排队,直接排到 B 的后面,等待 B 拿到锁资源或者 B 取消后,才可以尝试去竞争锁资源。</p>
<p><strong>非公平锁</strong>: 线程 A 获取到了锁资源,线程 B 没有获得,线程 B 去排队,线程 C 来了,先尝试竞争一波。</p>
<ul>
<li>拿到锁资源: 开心,插队成功。</li>
<li>没有拿到锁资源: 依然要排到 B 的后面,等待 B 拿到锁资源或者 B 取消后,才可以尝试去竞争锁资源。</li>
</ul>
</li>
<li>
<p><strong>互斥锁、共享锁</strong></p>
<p>Java 中提供的 synchronized,ReentrantLock 是互斥锁。</p>
<p>Java 中提供的 ReentrantReadWriteLock 有互斥锁也有共享锁。</p>
<p><strong>互斥锁</strong>: 同一个时间点,只会有一个线程持有者当前互斥锁。</p>
<p><strong>共享锁</strong>: 同一个时间点,当前共享锁可以被多个线程同时持有。</p>
</li>
</ol>
<h2 id="reentrantlock">ReentrantLock</h2>
<p>实现加锁 lock() ----&gt; 线程阻塞:</p>
<ul>
<li>wait() 可以阻塞线程,但是必须要结合synchronized 一起使用。</li>
<li>sleep() 可以阻塞线程,但是必须指定时间,只能通过中断方式唤醒。</li>
<li>park() 可以阻塞线程,unpark() 进行唤醒。</li>
<li>while(true)  可以阻塞线程,cas。</li>
</ul>
<h3 id="公平锁">公平锁</h3>
<div class="expressive-code"><link rel="stylesheet" href="/astro-theme-cactus/_astro/ec.v6sg1.css"/><script type="module" src="/astro-theme-cactus/_astro/ec.3zb7u.js"></script><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">FairSync</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">extends</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">Sync</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> serialVersionUID </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">3000897897090466540L</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">    </span></span><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* Fair version of tryAcquire.  Don&#39;t grant access unless</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* recursive call or no waiters or is first.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ReservedStackAccess</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryAcquire</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">acquires</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Thread</span><span style="--0:#F8F8F2"> current </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// state 0 加锁</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (c </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// hasQueuedPredecessors() 被设计为用于公平的同步器,以避免碰撞</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 如果当前线程之前有一个排队线程,则为true,如果当前线程位于队列的头部或者队列为空,则为false</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// compareAndSetState(0, acquires) cas</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#50FA7B;--1:#6F42C1">hasQueuedPredecessors</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetState</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">, acquires)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#50FA7B;--1:#6F42C1">setExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">(current);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 判断加锁线程是否为当前线程 state+1 重入</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (current </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> acquires;</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (nextc </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">Error</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Maximum lock count exceeded</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#50FA7B;--1:#6F42C1">setState</span><span style="--0:#F8F8F2;--1:#24292E">(nextc);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 加锁失败</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="static final class FairSync extends Sync {    private static final long serialVersionUID = -3000897897090466540L;    /**     * Fair version of tryAcquire.  Don't grant access unless     * recursive call or no waiters or is first.     */    @ReservedStackAccess private boolean tryAcquire(int acquires) {        final Thread current = Thread.currentThread();        int c = getState();        // state 0 加锁        if (c == 0) {            // hasQueuedPredecessors() 被设计为用于公平的同步器,以避免碰撞            // 如果当前线程之前有一个排队线程,则为true,如果当前线程位于队列的头部或者队列为空,则为false            // compareAndSetState(0, acquires) cas            if (!hasQueuedPredecessors() &#38;&#38;                    compareAndSetState(0, acquires)) {                setExclusiveOwnerThread(current);                return true;            }        }        // 判断加锁线程是否为当前线程 state+1 重入        else if (current == getExclusiveOwnerThread()) {            int nextc = c + acquires;            if (nextc < 0)                throw new Error(&#34;Maximum lock count exceeded&#34;);            setState(nextc);            return true;        }        // 加锁失败        return false;    }}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">hasQueuedPredecessors</span><span style="--0:#F8F8F2;--1:#24292E">(){</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E"> h,s;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">((h</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">head)</span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">){</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// (s = h.next) == null 防止空指针的标准写法,除了防止空指针,还会将当前节点复制到h变量上</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">((s</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">h.next)</span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E">s.waitStatus</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">){</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">s</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// traverse in case of concurrent cancellation</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> p</span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">tail;p</span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E">h</span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E">p</span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;p</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">p.prev){</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(p.waitStatus</span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">s</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(s</span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E">s.thread</span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E">Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public final boolean hasQueuedPredecessors(){        Node h,s;        if((h=head)!=null){        // (s = h.next) == null 防止空指针的标准写法,除了防止空指针,还会将当前节点复制到h变量上        if((s=h.next)==null||s.waitStatus>0){        s=null; // traverse in case of concurrent cancellation        for(Node p=tail;p!=h&#38;&#38;p!=null;p=p.prev){        if(p.waitStatus<=0)        s=p;        }        }        if(s!=null&#38;&#38;s.thread!=Thread.currentThread())        return true;        }        return false;        }"><div></div></button></div></figure></div>
<h3 id="非公平锁">非公平锁</h3>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">NonfairSync</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">extends</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">Sync</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> serialVersionUID </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">7316153563782823691L</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryAcquire</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">acquires</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">nonfairTryAcquire</span><span style="--0:#F8F8F2;--1:#24292E">(acquires);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="static final class NonfairSync extends Sync {  private static final long serialVersionUID = 7316153563782823691L;  private boolean tryAcquire(int acquires) {    return nonfairTryAcquire(acquires);  }}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">nonfairTryAcquire</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> acquires){</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Thread</span><span style="--0:#F8F8F2"> current</span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(c</span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">){</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetState</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">,acquires)){</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">setExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">(current);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(current</span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#50FA7B;--1:#6F42C1">getExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">()){</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextc</span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">c</span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E">acquires;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E">(nextc</span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#96A1C2;--1:#616972">// overflow</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">Error</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Maximum lock count exceeded</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">setState</span><span style="--0:#F8F8F2;--1:#24292E">(nextc);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="final boolean nonfairTryAcquire(int acquires){final Thread current=Thread.currentThread();        int c=getState();        if(c==0){        if(compareAndSetState(0,acquires)){        setExclusiveOwnerThread(current);        return true;        }        }        else if(current==getExclusiveOwnerThread()){        int nextc=c+acquires;        if(nextc< 0) // overflow        throw new Error(&#34;Maximum lock count exceeded&#34;);        setState(nextc);        return true;        }        return false;        }"><div></div></button></div></figure></div>
<h2 id="synchronized-在-jdk16-的优化">synchronized 在 JDK1.6 的优化</h2>
<p>在JDK1.5 的时候 Doug lee 推出了 ReentrantLock,lock 的性能远高于 synchronized,所以 JDK1.6 的时候团队就对 synchronized 进行了大量的优化。</p>
<p><strong>锁消除</strong>: 在 synchronized 修饰的代码中,如果不存在操作临界资源的情况,会触发锁消除,你即便写了 synchronized,也不会触发。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 没有操作临界资源</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 此时这个方法的 synchronized 可以认为没有</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public synchronized void method() {  // 没有操作临界资源  // 此时这个方法的 synchronized 可以认为没有}"><div></div></button></div></figure></div>
<p><strong>锁膨胀</strong>: 如果在一个循环中,频繁的获取和释放资源,这样带来的消耗很大,锁膨胀就是将锁的范围放大,避免频繁的竞争和获取锁资源带来不必要的消耗。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">, i </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">99999</span><span style="--0:#F8F8F2;--1:#24292E">;i</span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E">(对象) {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// 这时上面的锁会触发锁膨胀</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void method() {  for(int i = 0, i < 99999;i++) {    synchronized(对象) {    }  }}// 这时上面的锁会触发锁膨胀"><div></div></button></div></figure></div>
<p><strong>锁升级</strong>: ReentrantLock 的实现,是先基于乐观锁的 CAS 尝试获取锁资源,如果拿不到锁资源,才会挂起线程。</p>
<p>synchronized 在 JDK1.6 之前,完全就是获取不到锁,立即挂起当前线程,所以 synchronized 性能很差。</p>
<p>synchronized 就在 JDK1.6 做了锁升级的优化。</p>
<ul>
<li><strong>无锁、匿名偏向</strong>: 当前线程没有作为锁的存在。</li>
<li><strong>偏向锁</strong>: 如果当前锁资源,只有一个线程在频繁的获取和释放,那么这个线程过来,只需要判断,当前指向的线程是否当前线程。
<ul>
<li>如果是,直接拿着锁资源走。</li>
<li>如果不是,基于 CAS 的方式,尝试将偏向锁指向当前线程,如果获取不到,触发锁升级,升级为轻量级锁。(偏向锁状态出现了所竞争的情况)</li>
</ul>
</li>
<li><strong>轻量级锁</strong>: 会采用自旋锁的方式去频繁的以 CAS 的形式获取锁资源(采用的是自适应自旋锁)
<ul>
<li>如果成功获取到,拿着锁资源走。</li>
<li>如果自旋了一定的次数,没拿到锁,锁升级。</li>
</ul>
</li>
<li><strong>重量级锁</strong>: 就是最传统的 synchronized 方式,拿不到锁资源,就挂起当前线程。(用户态&amp;内核态)</li>
</ul>
<h2 id="synchronized-的实现原理">synchronized 的实现原理</h2>
<p>synchronized 是基于对象实现的。</p>
<p>synchronized 的底层实现是完全依赖JVM虚拟机的,所以先看看对象的存储结构。</p>
<h3 id="对象结构">对象结构</h3>
<p>JVM是虚拟机,是一种标准规范,主要作用就是运行java的类文件的。而虚拟机有很多实现版本,HotSpot就是虚拟机的一种实现,是基于热点代码探测的,有JIT即时编译功能,能提供更高质量的本地代码。HotSpot 虚拟机中对象在内存中可分为对象头(Header)、实例数据(Instance Data)和对齐填充(Padding)。其组成结构如下图:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281129677.png" alt="image-20230825223549259"/>
<p>1)实例数据: 存放类的属性数据信息,包括父类的属性信息。如果是数组,那么实例部分还包括数组的长度,这部分内存按4字节对齐。</p>
<p>2)对齐填充: 虚拟机要求对象起始地址必须是8字节的整数倍。填充数据不是必须存在的,仅仅是为了字节对齐。</p>
<p>3)对象头</p>
<p>对于元数据指针,虚拟机通过这个指针来确定这个对象是哪个类的实例;</p>
<p>对于标记字段,用于存储对象自身的运行时数据,其组成如下图</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281129588.png" alt="img"/>
<p>锁信息占3位)在jdk1.6之前只有重量级锁,而1.6后对其进行了优化,就有了偏向锁和轻量级锁。</p>
<h3 id="上锁的原理">上锁的原理</h3>
<p>JVM规范中描述: 每个对象有一个监视器锁(monitor)。</p>
<p>monitorenter指向同步代码块开始的位置,monitorexit指向同步代码块结束的位置。</p>
<p>当monitor被占用时就会处于锁定状态,线程执行monitorenter指令时尝试获取monitor的所有权,执行monitorexit 释放所有权,过程如下:</p>
<ol>
<li>如果monitor的进入数为0,则该线程进入monitor,然后将进入数设置为1,该线程即为monitor的所有者。</li>
<li>如果线程已经占有该monitor,只是重新进入,则进入monitor的进入数加1。</li>
<li>如果其他线程已经占用了monitor,则该线程进入阻塞状态,直到monitor的进入数为0,再重新尝试获取monitor的所有权。</li>
</ol>
<p>Synchronized的语义底层是通过一个monitor的对象来完成,其实wait/notify等方法也依赖于monitor对象。</p>
<p>这就是为什么只有在同步的块或者方法中才能调用wait/notify等方法,否则会抛出java.lang.IllegalMonitorStateException的异常的原因。</p>
<p><strong>Synchronized是通过对象内部的一个叫做监视器锁(monitor)来实现的。</strong></p>
<p>但是监视器锁本质又是依赖于底层的操作系统的互斥锁(Mutex Lock)来实现的。而操作系统实现线程之间的切换这就需要从用户态转换到核心态,这个成本非常高,状态之间的转换需要相对比较长的时间,这就是为什么Synchronized效率低的原因。</p>
<p>因此,这种依赖于操作系统互斥锁(Mutex Lock)所实现的锁我们称之为“重量级锁”。</p>
<h2 id="reentrantlock和synchronized的区别">ReentrantLock和synchronized的区别</h2>
<p>在 Java 中,常用的锁有两种: synchronized(内置锁)和 ReentrantLock(可重入锁)。</p>
<h3 id="用法不同">用法不同</h3>
<p><strong>synchronized 可用来修饰普通方法、静态方法和代码块,而 ReentrantLock 只能用在代码块上。</strong></p>
<p>使用 synchronized 修饰代码块:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 加锁代码</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">//...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void method() {  // 加锁代码  synchronized(this) {    //...  }}"><div></div></button></div></figure></div>
<p>ReentrantLock 在使用之前需要先创建 ReentrantLock 对象,然后使用 lock 方法进行加锁,使用完之后再调用 unlock 方法释放锁,具体使用如下:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">lockExample</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">ReentrantLock</span><span style="--0:#F8F8F2"> lcok </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ReentrantLock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// lock 加锁操作</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">lock.</span><span style="--0:#50FA7B;--1:#6F42C1">lock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// ...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">finally</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 释放锁</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">lock.</span><span style="--0:#50FA7B;--1:#6F42C1">unlock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void lockExample() {  private final ReentrantLock lcok = new ReentrantLock();  public void method() {    // lock 加锁操作    lock.lock();    try {      // ...    } finally {      // 释放锁      lock.unlock();    }  }}"><div></div></button></div></figure></div>
<h3 id="获取锁和释放锁方式不同">获取锁和释放锁方式不同</h3>
<p><strong>synchronized 会自动加锁和释放锁</strong>,当进入 synchronized 修饰的代码块之后会自动加锁,当离开 synchronized 的代码段之后会自动释放锁,如下图所示:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">APP</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> count </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;i </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">10</span><span style="--0:#F8F8F2;--1:#24292E">;i</span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">count</span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">System.out.</span><span style="--0:#50FA7B;--1:#6F42C1">println</span><span style="--0:#F8F8F2;--1:#24292E">(count);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public class APP {  public void method() {    int count = 0;    synchronized(this) {      for(int i = 0;i < 10;i++) {        count++;      }    }    System.out.println(count);  }}"><div></div></button></div></figure></div>
<p><strong>而 ReentrantLock 需要手动加锁和释放锁</strong>,如下图所示:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">lockExample</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">ReentrantLock</span><span style="--0:#F8F8F2"> lcok </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ReentrantLock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">method</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// lock 加锁操作</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">lock.</span><span style="--0:#50FA7B;--1:#6F42C1">lock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// ...</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">finally</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 释放锁</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">lock.</span><span style="--0:#50FA7B;--1:#6F42C1">unlock</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void lockExample() {  private final ReentrantLock lcok = new ReentrantLock();  public void method() {    // lock 加锁操作    lock.lock();    try {      // ...    } finally {      // 释放锁      lock.unlock();    }  }}"><div></div></button></div></figure></div>
<blockquote>
<p>PS: 在使用 ReentrantLock 时要特别小心,unlock 释放锁的操作一定要放在 finally 中,否者有可能会出现锁一直被占用,从而导致其他线程一直阻塞的问题。</p>
</blockquote>
<h3 id="锁类型不同">锁类型不同</h3>
<p><strong>synchronized 属于非公平锁,而 ReentrantLock 既可以是公平锁也可以是非公平锁。</strong> 默认情况下 ReentrantLock 为非公平锁,这点查看源码可知:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ReentrantLock</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">sync </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">NonfairSync</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public ReentrantLock() {  sync = new NonfairSync();}"><div></div></button></div></figure></div>
<p>使用 new ReentrantLock(true) 可以创建公平锁,查看源码可知:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ReentrantLock</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> fair) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">sync </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> fair </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">FairSync</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">NonfairSync</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public ReentrantLock(boolean fair) {  sync = fair ? FairSync() : new NonfairSync();}"><div></div></button></div></figure></div>
<h3 id="响应中断不同">响应中断不同</h3>
<p><strong>ReentrantLock 可以使用 lockInterruptibly 获取锁并响应中断指令,而 synchronized 不能响应中断,也就是如果发生了死锁,使用 synchronized 会一直等待下去,而使用 ReentrantLock 可以响应中断并释放锁,从而解决死锁的问题</strong>,比如以下 ReentrantLock 响应中断的示例:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281129252.jpg" alt="img"/>
<p>以上程序的执行结果如下所示:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281129878.jpg" alt="img"/>
<h3 id="底层实现不同">底层实现不同</h3>
<p><strong>synchronized 是 JVM 层面通过监视器(Monitor)实现的,而 ReentrantLock 是通过 AQS(AbstractQueuedSynchronizer)程序级别的 API 实现。</strong> synchronized 通过监视器实现,可通过观察编译后的字节码得出结论,如下图所示:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281129738.jpg" alt="img"/>
<p>其中 monitorenter 表示进入监视器,相当于加锁操作,而 monitorexit 表示退出监视器,相当于释放锁的操作。 ReentrantLock 是通过 AQS 实现,可通过观察 ReentrantLock 的源码得出结论,核心实现源码如下:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402281137689.jpg" alt="img"/>
<h2 id="reentrantreadwritelock的实现原理">ReentrantReadWriteLock的实现原理</h2>
<p>在很多场景下,我们用到的都是互斥锁,线程间相互竞争资源;但是有时候我们的场景会存在读多写少的情况,这个时候如果还是使用互斥锁,就会导致资源的浪费,为什么呢?</p>
<p>因为如果同时都在读的时候,是不需要锁资源的,只有读和写在同时工作的时候才需要锁资源,所以如果直接用互斥锁,肯定会导致资源的浪费。</p>
<h3 id="提供的方法">提供的方法</h3>
<ul>
<li>readLock(): 获取读锁对象(不是获取锁资源)</li>
<li>writeLock(): 获取写锁对象(不是获取锁资源)</li>
<li>getReadLockCount(): 获取当前读锁被获取的次数,包括线程重入的次数</li>
<li>getReadHoldCount(): 返回当前线程获取读锁的次数</li>
<li>isWriteLocked(): 判断写锁是否被获取</li>
<li>getWriteHoldCount(): 返回当前写锁被获取的次数</li>
</ul>
<p><strong>ReentrantReadWriteLock 还是基于 AQS 实现的,还是对 state 进行操作,拿到锁资源就去干活,如果没有拿到,依然去 AQS 队列中排队。</strong></p>
<p><strong>读锁操作: 基于 state 高 16 位进行操作。</strong></p>
<p><strong>写锁操作: 基于 state 低 16 位进行操作。</strong></p>
<p><strong>ReentrantReadWriteLock 依然是可重入锁。</strong></p>
<p><strong>写锁重入</strong>: 读写锁中写锁的重入方式,基本和 ReentrantLock 一致,没有什么区别,依然是对 state + 1 操作即可,只要确认持有锁资源的线程,是当前写锁线程即可,只不过之前 ReentrantLock 的重入次数是 state 的正数取值范围,但是读写锁中写锁范围就小了。</p>
<p><strong>读锁重入</strong>: 因为读锁是共享锁,读锁在获取锁资源操作时,是要对 state 的高 16 位进行 +1 操作。因为读锁是共享锁,所以同一时间会有多个读线程持有读锁资源。这样一来,多个读操作在持有读锁时,无法确认每个线程读锁重入的次数。为了去记录读锁重入的次数,每个读操作的线程,都会有一个 ThreadLocal 记录重入的次数。</p>
<p><strong>写锁的饥饿问题</strong>: 读锁是共享锁,当有线程持有读锁资源时,再来一个线程想要获取读锁,直接对 state 修改即可。在读锁资源先被占用后,来了一个写锁资源,此时,大量的需要获取读锁的线程请求锁资源,如果可以绕过写锁,直接拿资源,会造成写锁长时间无法获取写锁资源。</p>
<p><strong>锁降级</strong>: 当前线程先获取到写锁,然后再获取读锁,再把写锁释放,最后释放读锁。</p>
<p><strong>读锁在拿到锁资源后,如果再有读线程需要获取读锁资源,需要去 AQS 队列排队,如果队列的前面需要获取写锁资源的线程,那么后续读线程是无法拿到锁资源的。持有读锁的线程,只会让写锁线程之前的读线程拿到锁资源。</strong></p>
<h3 id="写锁的获取与释放">写锁的获取与释放</h3>
<p>获取锁的源码:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryAcquire</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> acquires) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* Walkthrough:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 1. If read count nonzero or write count nonzero</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    and owner is a different thread, fail.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 2. If count would saturate, fail. (This can only</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    happen if count is already nonzero.)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 3. Otherwise, this thread is eligible for lock if</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    it is either a reentrant acquire or</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    queue policy allows it. If so, update state</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    and set owner.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Thread</span><span style="--0:#F8F8F2;--1:#24292E"> current </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> w </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">exclusiveCount</span><span style="--0:#F8F8F2;--1:#24292E">(c);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (c </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// (Note: if c != 0 and w == 0 then shared count != 0)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (w </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> current </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (w </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">exclusiveCount</span><span style="--0:#F8F8F2;--1:#24292E">(acquires) </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> MAX_COUNT)</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">Error</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Maximum lock count exceeded</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// Reentrant acquire</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">setState</span><span style="--0:#F8F8F2;--1:#24292E">(c </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> acquires);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">writerShouldBlock</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetState</span><span style="--0:#F8F8F2;--1:#24292E">(c, c </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> acquires))</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#50FA7B;--1:#6F42C1">setExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">(current);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected final boolean tryAcquire(int acquires) {    /*     * Walkthrough:     * 1. If read count nonzero or write count nonzero     *    and owner is a different thread, fail.     * 2. If count would saturate, fail. (This can only     *    happen if count is already nonzero.)     * 3. Otherwise, this thread is eligible for lock if     *    it is either a reentrant acquire or     *    queue policy allows it. If so, update state     *    and set owner.     */    Thread current = Thread.currentThread();    int c = getState();    int w = exclusiveCount(c);    if (c != 0) {        // (Note: if c != 0 and w == 0 then shared count != 0)        if (w == 0 || current != getExclusiveOwnerThread())            return false;        if (w + exclusiveCount(acquires) > MAX_COUNT)            throw new Error(&#34;Maximum lock count exceeded&#34;);        // Reentrant acquire        setState(c + acquires);        return true;    }    if (writerShouldBlock() ||        !compareAndSetState(c, c + acquires))        return false;    setExclusiveOwnerThread(current);    return true;}"><div></div></button></div></figure></div>
<p>释放锁的源码:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryRelease</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> releases) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#50FA7B;--1:#6F42C1">isHeldExclusively</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">IllegalMonitorStateException</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> releases;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> free </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">exclusiveCount</span><span style="--0:#F8F8F2;--1:#24292E">(nextc) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (free)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">setExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#50FA7B;--1:#6F42C1">setState</span><span style="--0:#F8F8F2;--1:#24292E">(nextc);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> free;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected final boolean tryRelease(int releases) {    if (!isHeldExclusively())        throw new IllegalMonitorStateException();    int nextc = getState() - releases;    boolean free = exclusiveCount(nextc) == 0;    if (free)        setExclusiveOwnerThread(null);    setState(nextc);    return free;}"><div></div></button></div></figure></div>
<h3 id="读锁的获取与释放">读锁的获取与释放</h3>
<p>获取锁的源码:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryAcquireShared</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> unused) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* Walkthrough:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 1. If write lock held by another thread, fail.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 2. Otherwise, this thread is eligible for</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    lock wrt state, so ask if it should block</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    because of queue policy. If not, try</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    to grant by CASing state and updating count.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    Note that step does not check for reentrant</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    acquires, which is postponed to full version</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    to avoid having to check hold count in</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    the more typical non-reentrant case.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 3. If step 2 fails either because thread</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    apparently not eligible or CAS fails or count</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*    saturated, chain to version with full retry loop.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Thread</span><span style="--0:#F8F8F2;--1:#24292E"> current </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">exclusiveCount</span><span style="--0:#F8F8F2;--1:#24292E">(c) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">getExclusiveOwnerThread</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> current)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> r </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">sharedCount</span><span style="--0:#F8F8F2;--1:#24292E">(c);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#50FA7B;--1:#6F42C1">readerShouldBlock</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">r </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> MAX_COUNT </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetState</span><span style="--0:#F8F8F2;--1:#24292E">(c, c </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> SHARED_UNIT)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (r </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">firstReader </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> current;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">firstReaderHoldCount </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (firstReader </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> current) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">firstReaderHoldCount</span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">HoldCounter</span><span style="--0:#F8F8F2;--1:#24292E"> rh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> cachedHoldCounter;</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (rh </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">rh.tid </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> LockSupport.</span><span style="--0:#50FA7B;--1:#6F42C1">getThreadId</span><span style="--0:#F8F8F2;--1:#24292E">(current))</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">cachedHoldCounter </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> rh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> readHolds.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (rh.count </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">readHolds.</span><span style="--0:#50FA7B;--1:#6F42C1">set</span><span style="--0:#F8F8F2;--1:#24292E">(rh);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">rh.count</span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">fullTryAcquireShared</span><span style="--0:#F8F8F2;--1:#24292E">(current);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected final int tryAcquireShared(int unused) {    /*     * Walkthrough:     * 1. If write lock held by another thread, fail.     * 2. Otherwise, this thread is eligible for     *    lock wrt state, so ask if it should block     *    because of queue policy. If not, try     *    to grant by CASing state and updating count.     *    Note that step does not check for reentrant     *    acquires, which is postponed to full version     *    to avoid having to check hold count in     *    the more typical non-reentrant case.     * 3. If step 2 fails either because thread     *    apparently not eligible or CAS fails or count     *    saturated, chain to version with full retry loop.     */    Thread current = Thread.currentThread();    int c = getState();    if (exclusiveCount(c) != 0 &#38;&#38;        getExclusiveOwnerThread() != current)        return -1;    int r = sharedCount(c);    if (!readerShouldBlock() &#38;&#38;        r < MAX_COUNT &#38;&#38;        compareAndSetState(c, c + SHARED_UNIT)) {        if (r == 0) {            firstReader = current;            firstReaderHoldCount = 1;        } else if (firstReader == current) {            firstReaderHoldCount++;        } else {            HoldCounter rh = cachedHoldCounter;            if (rh == null ||                rh.tid != LockSupport.getThreadId(current))                cachedHoldCounter = rh = readHolds.get();            else if (rh.count == 0)                readHolds.set(rh);            rh.count++;        }        return 1;    }    return fullTryAcquireShared(current);}"><div></div></button></div></figure></div>
<p>释放锁的源码:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryReleaseShared</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> unused) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Thread</span><span style="--0:#F8F8F2;--1:#24292E"> current </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">currentThread</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (firstReader </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> current) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// assert firstReaderHoldCount &gt; 0;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (firstReaderHoldCount </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">firstReader </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">firstReaderHoldCount</span><span style="--0:#FF79C6;--1:#BF3441">--</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">HoldCounter</span><span style="--0:#F8F8F2;--1:#24292E"> rh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> cachedHoldCounter;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (rh </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">rh.tid </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> LockSupport.</span><span style="--0:#50FA7B;--1:#6F42C1">getThreadId</span><span style="--0:#F8F8F2;--1:#24292E">(current))</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">rh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> readHolds.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> count </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> rh.count;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (count </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">readHolds.</span><span style="--0:#50FA7B;--1:#6F42C1">remove</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (count </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">unmatchedUnlockException</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">--</span><span style="--0:#F8F8F2;--1:#24292E">rh.count;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E"> (;;) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getState</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> SHARED_UNIT;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetState</span><span style="--0:#F8F8F2;--1:#24292E">(c, nextc))</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// Releasing the read lock has no effect on readers,</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// but it may allow waiting writers to proceed if</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// both read and write locks are now free.</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> nextc </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected final boolean tryReleaseShared(int unused) {    Thread current = Thread.currentThread();    if (firstReader == current) {        // assert firstReaderHoldCount > 0;        if (firstReaderHoldCount == 1)            firstReader = null;        else            firstReaderHoldCount--;    } else {        HoldCounter rh = cachedHoldCounter;        if (rh == null ||            rh.tid != LockSupport.getThreadId(current))            rh = readHolds.get();        int count = rh.count;        if (count <= 1) {            readHolds.remove();            if (count <= 0)                throw unmatchedUnlockException();        }        --rh.count;    }    for (;;) {        int c = getState();        int nextc = c - SHARED_UNIT;        if (compareAndSetState(c, nextc))            // Releasing the read lock has no effect on readers,            // but it may allow waiting writers to proceed if            // both read and write locks are now free.            return nextc == 0;    }}"><div></div></button></div></figure></div>
<h2 id="死锁">死锁</h2>
<h3 id="形成死锁的四个必要条件">形成死锁的四个必要条件</h3>
<ol>
<li><strong>互斥条件</strong>: 进程要求对所分配的资源(如打印机)进行排他性控制,即在一段时间内莫资源仅为一个进程所占有。此时若有其他进程请求资源,则请求进程只能等待。</li>
<li><strong>不可剥夺条件</strong>: 进程所获得的资源在未使用完毕之前,不能被其他进程强行夺走,即只能由获得该资源的进程自己来释放(只能是主动释放)。</li>
<li><strong>请求与保持条件</strong>: 进程已经保持了至少一个资源,但又提出了新的资源请求,而该资源已被其他进程占有,此时请求进程被阻塞,但对自己获得的资源保持不放。</li>
<li><strong>循环等待条件</strong>: 存在一种进程资源的循环等待链,链中每一个进程已获取的资源同时被链中下一个进程所请求。即存在一个处于等待状态的进程集合
<code>{P1,P2,...Pn}</code>,其中Pi等待的资源被 P(i+1)占有(i=0,1,…n-1),Pn等待的资源被P0占有。</li>
</ol>
<p>以上四个条件是死锁的必要条件,只要系统产生死锁,这些条件必然成立,而只要上述条件之一不满足,就不会发生死锁。</p>
<h3 id="处理死锁的方法">处理死锁的方法</h3>
<ol>
<li>
<p><strong>预防死锁</strong></p>
<p>通过设置某些限制条件,去破坏产生死锁的四个必要条件中的一个或几个条件,来防止死锁的产生。</p>
<ul>
<li>
<p>破坏“互斥”条件</p>
<p>就是在系统里取消互斥。若资源不被一个进程独占使用,那么死锁是肯定不会发生的。但一般来说在所列的四个条件中,“互斥”条件是无法破坏的。</p>
</li>
<li>
<p>破坏“占有并等待”条件</p>
<p>破坏“占有并等待”条件,就是在系统中不允许进程在已获得某种资源的情况下,申请其他资源。即要想出一个办法,阻止进程在持有资源的同时申请其他资源:</p>
<ol>
<li>一次申请所需的全部资源,即“一次性分配”。</li>
<li>要求每个进程提出新的资源申请前,释放它所占有的资源,即“先释放后申请”。</li>
</ol>
</li>
<li>
<p>破坏“不可抢占”条件</p>
<p>破坏“不可抢占”条件就是允许对资源实行抢夺:</p>
<ol>
<li>占有某些资源的同时再请求被拒绝,则该进程必须释放已占有的资源,如果有必要,可再次请求这些资源和另外的资源。</li>
<li>设置进程优先级,优先级高的可以抢占资源。</li>
</ol>
</li>
<li>
<p>破坏“循环等待”条件</p>
<p>将系统中的所有资源统一编号,所有进程必须按照资源编号顺序提出申请。</p>
</li>
</ul>
</li>
<li>
<p><strong>避免死锁</strong></p>
<p>在资源的动态分配过程中,用某种方法去防止系统进入不安全状态,从而避免死锁的产生。</p>
<ul>
<li>
<p>加锁顺序: 线程按照一定的顺序加锁。</p>
</li>
<li>
<p>加锁时限: 线程尝试获取锁的时候加上一定的时限,超过时限则放弃对该锁的请求,并释放自己占有的锁。</p>
</li>
<li>
<p>死锁检测: 每当一个线程获得了锁,会在线程和锁相关的数据结构中(map、graph等等)将其记下。除此之外,每当有线程请求锁,也需要记录在这个数据结构中。</p>
</li>
</ul>
</li>
<li>
<p><strong>检测死锁</strong></p>
<p>允许系统在运行过程中产生死锁,但可设置检测机构及时检测死锁的发生,并采取适当措施加以清除。</p>
<p>一般来说,由于操作系统有并发,共享以及随机性等特点,通过预防和避免的手段达到排除死锁的目的是很困难的。这需要较大的系统开销,而且不能充分利用资源。为此,一种简便的方法是系统为进程分配资源时,不采取任何限制性措施,但是提供了检测和解脱死锁的手段: 能发现死锁并从死锁状态中恢复出来。因此,在实际的操作系统中往往采用死锁的检测与恢复方法来排除死锁。</p>
</li>
<li>
<p><strong>解除死锁</strong></p>
<p>当检测出死锁后,便采取适当措施将进程从死锁状态中解脱出来。</p>
<ul>
<li>
<p>资源剥夺法</p>
<p>挂起某些死锁进程,并抢占它的资源,将这些资源分配给其他的死锁进程。但应防止被挂起的进程长时间得不到资源,而处于资源匮乏的状态。</p>
</li>
<li>
<p>撤销进程法</p>
<p>强制撤销部分、甚至全部死锁进程并剥夺这些进程的资源。撤销的原则可以按进程优先级和撤销进程代价的高低进行。</p>
</li>
<li>
<p>进程回退法</p>
<p>让一(多)个进程回退到足以回避死锁的地步,进程回退时自愿释放资源而不是被剥夺。要求系统保持进程的历史信息,设置还原点。</p>
</li>
</ul>
</li>
</ol>
<h2 id="aqs">AQS</h2>
<p>AQS 就是 AbstractQueuedSynchronized 抽象类,AQS 其实就是 JUC 并发包下的一个基类,JUC 下的很多内容都是基于 AQS 实现了部分功能,比如 ReentrantLock、ThreadPoolExecutor、阻塞队列、CountDownLacth、Semaphore、CyclicBarrier等等都是基于 AQS 实现的。</p>
<p>首先 AQS 中提供了一个由 volatile 修饰,并且采用 CAS 方式修改的 int 类型的 state 变量。</p>
<p>其次 AQS 中维护了一个双向链表,有 head,有 tail,并且每个节点都是 Node 对象。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Node</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> SHARED </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">Node</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> EXCLUSIVE </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> CANCELLED </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> SIGEL     </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> CONDITION </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> PROPAGATE </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">3</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 上述的状态都存储在 waitStatus</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">volatile</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> waitStatus;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">volatile</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> prev;</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">volatile</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> next;</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">volatile</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Thread</span><span style="--0:#F8F8F2"> thread;</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="static final class Node {  static final Node SHARED = new Node();  static final Node EXCLUSIVE = null;  static final int CANCELLED =  1;  static final int SIGEL     = -1;  static final int CONDITION = -2;  static final int PROPAGATE = -3;  // 上述的状态都存储在 waitStatus  volatile int waitStatus;  volatile Node prev;  volatile Node next;  volatile Thread thread;}"><div></div></button></div></figure></div>
<h2 id="面试须知">面试须知</h2>
<h3 id="aqs-唤醒节点时为何从后往前找">AQS 唤醒节点时,为何从后往前找</h3>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">unparkSuccessor</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> node) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* If status is negative (i.e., possibly needing signal) try</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* to clear in anticipation of signalling.  It is OK if this</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* fails or if status is changed by waiting thread.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> ws </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> node.waitStatus;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (ws </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">node.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetWaitStatus</span><span style="--0:#F8F8F2;--1:#24292E">(ws, </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* Thread to unpark is held in successor, which is normally</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* just the next node.  But if cancelled or apparently null,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* traverse backwards from tail to find the actual</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* non-cancelled successor.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E"> s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> node.next;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (s </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> s.waitStatus </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> p </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tail; p </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> node </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> p </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.prev)</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (p.waitStatus </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (s </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">LockSupport.</span><span style="--0:#50FA7B;--1:#6F42C1">unpark</span><span style="--0:#F8F8F2;--1:#24292E">(s.thread);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void unparkSuccessor(Node node) {    /*     * If status is negative (i.e., possibly needing signal) try     * to clear in anticipation of signalling.  It is OK if this     * fails or if status is changed by waiting thread.     */    int ws = node.waitStatus;    if (ws < 0)        node.compareAndSetWaitStatus(ws, 0);    /*     * Thread to unpark is held in successor, which is normally     * just the next node.  But if cancelled or apparently null,     * traverse backwards from tail to find the actual     * non-cancelled successor.     */    Node s = node.next;    if (s == null || s.waitStatus > 0) {        s = null;        for (Node p = tail; p != node &#38;&#38; p != null; p = p.prev)            if (p.waitStatus <= 0)                s = p;    }    if (s != null)        LockSupport.unpark(s.thread);}"><div></div></button></div></figure></div>
<p>在阅读 AQS 源码的过程中,也许会存在这样的困惑,为什么当next指针对应的节点为null 或者取消时,从tail 向前遍历寻找最近的一个非取消的节点。</p>
<p>当前任释放时,需要获取继任者;AQS的实现方式是从tail 向前遍历,之所以这样是与入队时的逻辑有关。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Inserts node into queue, initializing if necessary. See picture above.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">node</span><span style="--0:#96A1C2;--1:#616972"> the node to insert</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@return</span><span style="--0:#96A1C2;--1:#616972"> node&#39;s predecessor</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">enq</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> node) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E"> (;;) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E"> t </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tail;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (t </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) { </span><span style="--0:#96A1C2;--1:#616972">// Must initialize</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetHead</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">Node</span><span style="--0:#F8F8F2;--1:#24292E">()))</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">tail </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> head;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">node.prev </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> t;</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetTail</span><span style="--0:#F8F8F2;--1:#24292E">(t, node)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 假设线程1执行到这里被挂起,此时 next 指针还没有关联到,后新来的线程 n 可能已经被排列到后面去了,所以当 t 被需要时,它的 next 指针还没有设置或者重置;故需要从后到前寻找,而如果找寻下一个,而这个可能被遗漏了;</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 故api文档中有这样一说 (Or, said differently, the next-links are an optimization so that we don&#39;t usually need a backward scan.)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">t.next </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> node;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> t;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Inserts node into queue, initializing if necessary. See picture above. * @param node the node to insert * @return node's predecessor */private Node enq(final Node node) {    for (;;) {        Node t = tail;        if (t == null) { // Must initialize            if (compareAndSetHead(new Node()))                tail = head;        } else {            node.prev = t;            if (compareAndSetTail(t, node)) {            // 假设线程1执行到这里被挂起,此时 next 指针还没有关联到,后新来的线程 n 可能已经被排列到后面去了,所以当 t 被需要时,它的 next 指针还没有设置或者重置;故需要从后到前寻找,而如果找寻下一个,而这个可能被遗漏了;            // 故api文档中有这样一说 (Or, said differently, the next-links are an optimization so that we don't usually need a backward scan.)                t.next = node;                return t;            }        }    }}"><div></div></button></div></figure></div>
<p>源码内部类Node上的注释中有对这个场景的完整描述:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">isOnSyncQueue</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2"> node) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (node.waitStatus </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> Node.CONDITION </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> node.prev </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (node.next </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#96A1C2;--1:#616972">// If has successor, it must be on queue</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* node.prev can be non-null, but not yet on queue because</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 节点的前置前置节点可能为非空,但是尚未在同步队列中,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* the CAS to place it on queue can fail. So we have to</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 因为cas 入队时可能失败。</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* traverse from tail to make sure it actually made it.  It</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 所以我们不得不后序遍历以确保正确的发现它。</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* will always be near the tail in calls to this method, and</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 它总是在靠近尾节点,当执行这个方法时</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* unless the CAS failed (which is unlikely), it will be</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* 除非cas 失败(这不太可能),所以我们不会遍历太多</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">* there, so we hardly evertraverse much.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">     </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">findNodeFromTail</span><span style="--0:#F8F8F2;--1:#24292E">(node);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E"> </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=" final boolean isOnSyncQueue(Node node) {    if (node.waitStatus == Node.CONDITION || node.prev == null)        return false;    if (node.next != null) // If has successor, it must be on queue        return true;    /*     * node.prev can be non-null, but not yet on queue because     * 节点的前置前置节点可能为非空,但是尚未在同步队列中,     * the CAS to place it on queue can fail. So we have to     * 因为cas 入队时可能失败。     * traverse from tail to make sure it actually made it.  It     * 所以我们不得不后序遍历以确保正确的发现它。     * will always be near the tail in calls to this method, and     * 它总是在靠近尾节点,当执行这个方法时     * unless the CAS failed (which is unlikely), it will be     * 除非cas 失败(这不太可能),所以我们不会遍历太多     * there, so we hardly evertraverse much.     */    return findNodeFromTail(node); }"><div></div></button></div></figure></div>
<p>另一方面如果下一个节点时null(已经被GC ),如何找到下一个有效节点,也只能从后往前找了。</p>
<h3 id="concurrenthashmap在18做了什么优化">ConcurrentHashMap在1.8做了什么优化</h3>
<p>JDK1.8 放弃了锁分段的做法,采用CAS和synchronized方式处理并发。以put操作为例,CAS方式确定key的数组下标,synchronized保证链表节点的同步效果。</p>
<p>JDK1.8 ConcurrentHashMap是<strong>数组+链表</strong>,或者<strong>数组+红黑树</strong>结构,并发控制使用<strong>Synchronized关键字和CAS操作</strong>。</p>
<ol>
<li>
<p>存储结构的优化</p>
<p>数组+链表 -&gt; 数组+链表+红黑树</p>
</li>
<li>
<p>写数据加锁的优化</p>
</li>
<li>
<p>扩容的优化</p>
<p>协助扩容</p>
</li>
<li>
<p>计数器的优化</p>
<p>LongAddr -&gt; Cell[] 分段和汇总</p>
</li>
</ol>
<p>线程安全,但是复合操作时,只保证弱一致性/最终一致性。</p>
<h3 id="concurrenthashmap-的散列算法">ConcurrentHashMap 的散列算法</h3>
<p>当需要向 ConcurrentHashMap 中写入数据时,会根据 key 的 hashcode 来确定当前数据要放在数组的哪一个索引位置上。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Maps the specified key to the specified value in this table.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Neither the key nor the value can be null.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* &lt;p&gt;The value can be retrieved by calling the {@code get} method</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* with a key that is equal to the original key.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">key</span><span style="--0:#96A1C2;--1:#616972"> key with which the specified value is to be associated</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">value</span><span style="--0:#96A1C2;--1:#616972"> value to be associated with the specified key</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@return</span><span style="--0:#96A1C2;--1:#616972"> the previous value associated with {@code key}, or</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*         {@code null} if there was no mapping for {@code key}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@throws</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">NullPointerException</span><span style="--0:#96A1C2;--1:#616972"> if the specified key or value is null</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> key, </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> value) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">putVal</span><span style="--0:#F8F8F2;--1:#24292E">(key, value, </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/** Implementation for put and putIfAbsent */</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">putVal</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> key, </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> value, </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> onlyIfAbsent) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 不允许 key 或者 value 值为 null(HashMap 没有这个限制)</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (key </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">NullPointerException</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 根据 key 的 hashcode 计算出一个哈希值,后面得出当前 key-value 要存储在那个数组索引位置</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> hash </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">spread</span><span style="--0:#F8F8F2;--1:#24292E">(key.</span><span style="--0:#50FA7B;--1:#6F42C1">hashCode</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> binCount </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">...</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Maps the specified key to the specified value in this table. * Neither the key nor the value can be null. * * <p>The value can be retrieved by calling the {@code get} method * with a key that is equal to the original key. * * @param key key with which the specified value is to be associated * @param value value to be associated with the specified key * @return the previous value associated with {@code key}, or *         {@code null} if there was no mapping for {@code key} * @throws NullPointerException if the specified key or value is null */public V put(K key, V value) {    return putVal(key, value, false);}/** Implementation for put and putIfAbsent */final V putVal(K key, V value, boolean onlyIfAbsent) {  // 不允许 key 或者 value 值为 null(HashMap 没有这个限制)  if (key == null || value == null) throw new NullPointerException();  // 根据 key 的 hashcode 计算出一个哈希值,后面得出当前 key-value 要存储在那个数组索引位置  int hash = spread(key.hashCode());  int binCount = 0;  ...}"><div></div></button></div></figure></div>
<p>当向 map 中放数据时,用的是 put() 方法,这个方法在 ConcurrentHashMap 的源码实际上是调用了 putVal() 方法。</p>
<p>方法中先对 key 和 value 值进行判空,ConcurrentHashMap 是不允许 key 或者 value 值为 null 的,这也是和 HashMap 的一个区别,然后开始计算 key 的 hashcode,以获取后面得出当前 key-value 要存储在哪个数组索引位置,而在计算 key 的 hash 值时,调用了一个名为 spread 的方法。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Spreads (XORs) higher bits of hash to lower and also forces top</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* bit to 0. Because the table uses power-of-two masking, sets of</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* hashes that vary only in bits above the current mask will</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* always collide. (Among known examples are sets of Float keys</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* holding consecutive whole numbers in small tables.)  So we</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* apply a transform that spreads the impact of higher bits</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* downward. There is a tradeoff between speed, utility, and</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* quality of bit-spreading. Because many common sets of hashes</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* are already reasonably distributed (so don&#39;t benefit from</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* spreading), and because we use trees to handle large sets of</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* collisions in bins, we just XOR some shifted bits in the</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* cheapest possible way to reduce systematic lossage, as well as</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* to incorporate impact of the highest bits that would otherwise</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* never be used in index calculations because of table bounds.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// 将哈希值的高位传播(XOR)到低位,并将最高位强制为0。 因为表使用了2次方掩码,仅在当前掩码以上的位数不同的一组哈希值总是会发生碰撞。(已知的例子包括在小表中持有连续整数的Float键的集合)。因此,我们应用一个转换,将高位的影响向下分散。在速度、实用性和位传播的质量之间有一个权衡。因为许多常见的哈希集已经是合理分布的(所以不受益于传播),而且因为我们使用树来处理大集的碰撞,我们只是以最便宜的方式XOR一些移位的比特,以减少系统损失,以及纳入最高比特的影响,否则由于表的界限,永远不会被用于索引计算。</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">spread</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> h) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> (h </span><span style="--0:#FF79C6;--1:#BF3441">^</span><span style="--0:#F8F8F2;--1:#24292E"> (h </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">)) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> HASH_BITS;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Spreads (XORs) higher bits of hash to lower and also forces top * bit to 0. Because the table uses power-of-two masking, sets of * hashes that vary only in bits above the current mask will * always collide. (Among known examples are sets of Float keys * holding consecutive whole numbers in small tables.)  So we * apply a transform that spreads the impact of higher bits * downward. There is a tradeoff between speed, utility, and * quality of bit-spreading. Because many common sets of hashes * are already reasonably distributed (so don't benefit from * spreading), and because we use trees to handle large sets of * collisions in bins, we just XOR some shifted bits in the * cheapest possible way to reduce systematic lossage, as well as * to incorporate impact of the highest bits that would otherwise * never be used in index calculations because of table bounds. */// 将哈希值的高位传播(XOR)到低位,并将最高位强制为0。 因为表使用了2次方掩码,仅在当前掩码以上的位数不同的一组哈希值总是会发生碰撞。(已知的例子包括在小表中持有连续整数的Float键的集合)。因此,我们应用一个转换,将高位的影响向下分散。在速度、实用性和位传播的质量之间有一个权衡。因为许多常见的哈希集已经是合理分布的(所以不受益于传播),而且因为我们使用树来处理大集的碰撞,我们只是以最便宜的方式XOR一些移位的比特,以减少系统损失,以及纳入最高比特的影响,否则由于表的界限,永远不会被用于索引计算。static final int spread(int h) {    return (h ^ (h >>> 16)) &#38; HASH_BITS;}"><div></div></button></div></figure></div>
<p>这个方法将 key 的 hashcode 的高低 16 位进行 ”^“(异或)运算,最终又与 HASH_BITS 进行 ”&amp;“(与)运算,此处巧妙的使用了一个转换,通过将 key 的 hashcode 右移 16 位,将其哈希值的高位向下传播到地位,并通过与 HASH_BITS 即0x7fffffff(Integer的最大值,最高位是0,其余都是1)进行的与运算将最高位强制为0。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Encodings for Node hash fields. See above for explanation.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> MOVED     </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// 代表当前 hash 位置的数据正在扩容</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> TREEBIN   </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// 代表当前 hash 位置下挂载的是一个红黑树</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> RESERVED  </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">3</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// 预留当前索引位置</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> HASH_BITS </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0x7fffffff</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// usable bits of normal node hash</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/* * Encodings for Node hash fields. See above for explanation. */static final int MOVED     = -1; // 代表当前 hash 位置的数据正在扩容static final int TREEBIN   = -2; // 代表当前 hash 位置下挂载的是一个红黑树static final int RESERVED  = -3; // 预留当前索引位置static final int HASH_BITS = 0x7fffffff; // usable bits of normal node hash"><div></div></button></div></figure></div>
<p>简单来讲就是之前用传统的方式计算 hashcode 时,由于数组长度没那么长,就导致只有低位参与计算,产生哈希冲突的概率较高,将高位与低位进行异或运算可以使得高位也参与到运算中,尽可能的减少哈希冲突,此外附属在哈希值中有特殊含义,因此采用了 spread() 方法中的方式避免生成负的哈希值。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/** Implementation for put and putIfAbsent */</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">putVal</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> key, </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> value, </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> onlyIfAbsent) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (key </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">NullPointerException</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> hash </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">spread</span><span style="--0:#F8F8F2;--1:#24292E">(key.</span><span style="--0:#50FA7B;--1:#6F42C1">hashCode</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> binCount </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table;;) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// n: 数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// i: 当前 Node 要存放的索引位置</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// f: 当前数组 i 索引位置上的 Node 对象</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// fn: 当前数组 i 索引位置上数据的哈希值</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">      </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; f; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> n, i, fh; </span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> fk; </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> fv;</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 对是否进行过初始化的处理</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 判断数组是否进行过初始化 如果没有 调用 initTable() 进行初始化</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (tab </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">initTable</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 已初始化 基于 i = (n - 1) &amp; hash 计算出当前 Node 需要存储在哪个索引位置</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 通过 tabAt() 方法获取哈希表 i 位置上的数据</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果该位置为空 -&gt; 该位置没有数据</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 基于 CAS 方法将数据放在 i 位置上 -&gt; 成功放置后结束循环</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((f </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> hash)) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">casTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(hash, key, value)))</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;                   </span><span style="--0:#96A1C2;--1:#616972">// no lock when adding to empty bin</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果哈希表 i 位置不为空(无法直接放在数组上,产生了哈希冲突)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 判断当前位置是否在扩容 (fh = f.hash) == MOVED</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果等于-1,则说明数组正在进行扩容,会调用 helpTransfer() 方法进行协助扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((fh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f.hash) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> MOVED)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">helpTransfer</span><span style="--0:#F8F8F2;--1:#24292E">(tab, f);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 在不获取锁定的情况下检查第一个节点</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (onlyIfAbsent </span><span style="--0:#96A1C2;--1:#616972">// check first node without acquiring lock</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> fh </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> hash</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> ((fk </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f.key) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> key </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (fk </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> key.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(fk)))</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> (fv </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f.val) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> fv;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果不等于-1,则说明未在扩容期间,而且此时此位置下挂的不是一个链表,而是一个红黑树,接下来就是将数据存放到红黑树中的相应位置。</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">          </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">V</span><span style="--0:#F8F8F2;--1:#24292E"> oldVal </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 针对首个节点进行加锁操作,而不是segment,进一步减少线程冲突</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E"> (f) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> f) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (fh </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                      </span></span><span style="--0:#F8F8F2;--1:#24292E">binCount </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f;; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">binCount) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                          </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">K</span><span style="--0:#F8F8F2;--1:#24292E"> ek;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                          </span><span style="--0:#96A1C2;--1:#616972">// 如果在链表中找到值为key的节点e,直接设置e.val =value即可。</span></div></div><div class="ec-line"><div class="code"><span class="indent">                          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (e.hash </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> hash </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                              </span></span><span style="--0:#F8F8F2;--1:#24292E">((ek </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.key) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> key </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                </span></span><span style="--0:#F8F8F2;--1:#24292E">(ek </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> key.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(ek)))) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                              </span></span><span style="--0:#F8F8F2;--1:#24292E">oldVal </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.val;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">onlyIfAbsent)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                  </span></span><span style="--0:#F8F8F2;--1:#24292E">e.val </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> value;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                              </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                          </span><span style="--0:#96A1C2;--1:#616972">// 如果没有找到值为key的节点,直接新建Node并加入链表即可。</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                          </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; pred </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.next) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                              </span></span><span style="--0:#F8F8F2;--1:#24292E">pred.next </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(hash, key, value);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                              </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#96A1C2;--1:#616972">// 如果首节点为TreeBin类型,说明为红黑树结构,执行putTreeVal操作。</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (f </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> TreeBin) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                      </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                      </span></span><span style="--0:#F8F8F2;--1:#24292E">binCount </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> ((</span><span style="--0:#8BE9FD;--0fs:italic">TreeBin</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">)f).</span><span style="--0:#50FA7B;--1:#6F42C1">putTreeVal</span><span style="--0:#F8F8F2;--1:#24292E">(hash, key,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                                      </span></span><span style="--0:#F8F8F2;--1:#24292E">value)) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                          </span></span><span style="--0:#F8F8F2;--1:#24292E">oldVal </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.val;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">onlyIfAbsent)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                              </span></span><span style="--0:#F8F8F2;--1:#24292E">p.val </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> value;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (f </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> ReservationNode)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                      </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">IllegalStateException</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Recursive update</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">              </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (binCount </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#96A1C2;--1:#616972">// 如果节点数&gt;＝8,那么转换链表结构为红黑树结构。</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (binCount </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> TREEIFY_THRESHOLD)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#50FA7B;--1:#6F42C1">treeifyBin</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i);</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (oldVal </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> oldVal;</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 计数增加1,有可能触发transfer操作(扩容)。</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#50FA7B;--1:#6F42C1">addCount</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">1L</span><span style="--0:#F8F8F2;--1:#24292E">, binCount);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** Implementation for put and putIfAbsent */final V putVal(K key, V value, boolean onlyIfAbsent) {    if (key == null || value == null) throw new NullPointerException();    int hash = spread(key.hashCode());    int binCount = 0;    for (Node<K,V>[] tab = table;;) {      // n: 数组长度      // i: 当前 Node 要存放的索引位置      // f: 当前数组 i 索引位置上的 Node 对象      // fn: 当前数组 i 索引位置上数据的哈希值      Node<K,V> f; int n, i, fh; K fk; V fv;      // 对是否进行过初始化的处理      // 判断数组是否进行过初始化 如果没有 调用 initTable() 进行初始化      if (tab == null || (n = tab.length) == 0)          tab = initTable();      // 已初始化 基于 i = (n - 1) &#38; hash 计算出当前 Node 需要存储在哪个索引位置      // 通过 tabAt() 方法获取哈希表 i 位置上的数据      // 如果该位置为空 -> 该位置没有数据      // 基于 CAS 方法将数据放在 i 位置上 -> 成功放置后结束循环      else if ((f = tabAt(tab, i = (n - 1) &#38; hash)) == null) {          if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value)))              break;                   // no lock when adding to empty bin      }      // 如果哈希表 i 位置不为空(无法直接放在数组上,产生了哈希冲突)      // 判断当前位置是否在扩容 (fh = f.hash) == MOVED      // 如果等于-1,则说明数组正在进行扩容,会调用 helpTransfer() 方法进行协助扩容       else if ((fh = f.hash) == MOVED)          tab = helpTransfer(tab, f);      // 在不获取锁定的情况下检查第一个节点      else if (onlyIfAbsent // check first node without acquiring lock                &#38;&#38; fh == hash                &#38;&#38; ((fk = f.key) == key || (fk != null &#38;&#38; key.equals(fk)))                &#38;&#38; (fv = f.val) != null)          return fv;      // 如果不等于-1,则说明未在扩容期间,而且此时此位置下挂的不是一个链表,而是一个红黑树,接下来就是将数据存放到红黑树中的相应位置。      else {          V oldVal = null;          // 针对首个节点进行加锁操作,而不是segment,进一步减少线程冲突          synchronized (f) {              if (tabAt(tab, i) == f) {                  if (fh >= 0) {                      binCount = 1;                      for (Node<K,V> e = f;; ++binCount) {                          K ek;                          // 如果在链表中找到值为key的节点e,直接设置e.val =value即可。                          if (e.hash == hash &#38;&#38;                              ((ek = e.key) == key ||                                (ek != null &#38;&#38; key.equals(ek)))) {                              oldVal = e.val;                              if (!onlyIfAbsent)                                  e.val = value;                              break;                          }                          // 如果没有找到值为key的节点,直接新建Node并加入链表即可。                          Node<K,V> pred = e;                          if ((e = e.next) == null) {                              pred.next = new Node<K,V>(hash, key, value);                              break;                          }                      }                  }                  // 如果首节点为TreeBin类型,说明为红黑树结构,执行putTreeVal操作。                  else if (f instanceof TreeBin) {                      Node<K,V> p;                      binCount = 2;                      if ((p = ((TreeBin<K,V>)f).putTreeVal(hash, key,                                                      value)) != null) {                          oldVal = p.val;                          if (!onlyIfAbsent)                              p.val = value;                      }                  }                  else if (f instanceof ReservationNode)                      throw new IllegalStateException(&#34;Recursive update&#34;);              }          }          if (binCount != 0) {              // 如果节点数>＝8,那么转换链表结构为红黑树结构。              if (binCount >= TREEIFY_THRESHOLD)                  treeifyBin(tab, i);              if (oldVal != null)                  return oldVal;              break;          }      }  }  // 计数增加1,有可能触发transfer操作(扩容)。  addCount(1L, binCount);  return null;}"><div></div></button></div></figure></div>
<h3 id="为什么-concurrenthashmap-的数组长度需要时-2n">为什么 ConcurrentHashMap 的数组长度需要时 2^n</h3>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((f </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> hash)) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">casTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(hash, key, value)))</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;                   </span><span style="--0:#96A1C2;--1:#616972">// no lock when adding to empty bin</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="else if ((f = tabAt(tab, i = (n - 1) &#38; hash)) == null) {    if (casTabAt(tab, i, null, new Node<K,V>(hash, key, value)))        break;                   // no lock when adding to empty bin}"><div></div></button></div></figure></div>
<p>可以看到,在计算当前 Node 具体存放的索引位置时,使用了 n-1,n 代表数组长度,即这个索引位置是通过数组长度-1 与通过 spread() 方法返回的哈希值与运算计算出的,当数组长度为 2^n 时,可以最大程度的避免哈希冲突,因此有这个要求,就算给 ConcurrentHashMap 传入的大小不是 2^n,ConcurrentHashMap 也会计算出大于该数的最小 2^n,赋值给 n。</p>
<h3 id="concurrenthashmap-初始化流程">ConcurrentHashMap 初始化流程</h3>
<p>数组是懒加载的,第一次执行put()方法的时候才会进行初始化。</p>
<p>initTable()就是初始化方法,这里面有一个很重要的变量sizeCtl。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Initializes table, using the size recorded in sizeCtl.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">initTable</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 声明标识</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] tab; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 判断有没有初始化,并且完成 tab 的赋值</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> ((tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将 sizeCtl 赋值给 sc 变量,判断 sizeCtl 是否小于 0,即是否已经有线程在行始化了</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sizeCtl) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">Thread.</span><span style="--0:#50FA7B;--1:#6F42C1">yield</span><span style="--0:#F8F8F2;--1:#24292E">(); </span><span style="--0:#96A1C2;--1:#616972">// lost initialization race; just spin</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 可以尝试初始化数组,线程会以 CAS 的方式,将 sizeCtl 改为-1,代表当前线程以始化数组</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc, </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// U.compareAndSetInt(this, SIZECTL, sc, -1) 以 CAS 的方式sizeCtrl的为-1</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 修改成功则开始初始化</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// DCL 再次判断当前数组是否已经初始化完成</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 开始初始化</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// sizeCtl &gt; 0 就初始化 sizeCtl 长度的数组</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// sizeCtl = 0 就初始化默认长度的数组</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (sc </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> sc </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> DEFAULT_CAPACITY;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">SuppressWarnings</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">unchecked</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 真正初始化操作</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">          </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] nt </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[])</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[n];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">table </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nt;</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 将 sc 赋值为下一次扩容的阈值</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 如果n=16 n&gt;&gt;&gt;2=4 16-4=12</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 其实就是在当前数组的基础上,增加当前数组长度的 0.75</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">finally</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">sizeCtl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> tab;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Initializes table, using the size recorded in sizeCtl. */private final Node<K,V>[] initTable() {  // 声明标识  Node<K,V>[] tab; int sc;  // 判断有没有初始化,并且完成 tab 的赋值  while ((tab = table) == null || tab.length == 0) {    // 将 sizeCtl 赋值给 sc 变量,判断 sizeCtl 是否小于 0,即是否已经有线程在行始化了    if ((sc = sizeCtl) < 0)        Thread.yield(); // lost initialization race; just spin    // 可以尝试初始化数组,线程会以 CAS 的方式,将 sizeCtl 改为-1,代表当前线程以始化数组    else if (U.compareAndSetInt(this, SIZECTL, sc, -1)) {      // U.compareAndSetInt(this, SIZECTL, sc, -1) 以 CAS 的方式sizeCtrl的为-1      // 修改成功则开始初始化      try {        // DCL 再次判断当前数组是否已经初始化完成        if ((tab = table) == null || tab.length == 0) {          // 开始初始化          // sizeCtl > 0 就初始化 sizeCtl 长度的数组          // sizeCtl = 0 就初始化默认长度的数组          int n = (sc > 0) ? sc : DEFAULT_CAPACITY;          @SuppressWarnings(&#34;unchecked&#34;)          // 真正初始化操作          Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];          table = tab = nt;          // 将 sc 赋值为下一次扩容的阈值          // 如果n=16 n>>>2=4 16-4=12          // 其实就是在当前数组的基础上,增加当前数组长度的 0.75          sc = n - (n >>> 2);        }      } finally {          sizeCtl = sc;      }      break;    }  }  return tab;}"><div></div></button></div></figure></div>
<p>sizeCtl 是数组在初始化和扩容操作时一个控制变量,它的不同值代表不同含义</p>
<ul>
<li>’&gt;0’: 代表当前数组已经初始化完成,此时 sizeCtl 的值代表当前数组的扩容阈值,或者数组的初始化大小</li>
<li>0: 代表当前数组还没初始化</li>
<li>-1: 代表当前数组正在初始化</li>
<li>&lt;-1: 低于 16 为代表当前数组正在扩容的线程个数
<ul>
<li>如果是 1 个线程,值就是-2</li>
<li>如果是 2 个线程,值就是-3</li>
</ul>
</li>
</ul>
<p>初始化大致流程:</p>
<p>基于一个while循环,先去判断数组初始化了没有,如果没有,会再次比较sizeCtl的情况,如果正在初始化,则会通过Thread.yield()让出CPU资源,如果没有初始化,则会通过CAS的方式修改sizeCtl的值为-1,修改过后还会再次判断数组是否被初始化了(DCL,以免在当前线程修改sizeCtl的值的时候,已经有别的线程对当前数组完成了初始化),如果当前数组仍然没有被初始化,才会真正开始初始化。</p>
<h3 id="concurrenthashmap-扩容流程">ConcurrentHashMap 扩容流程</h3>
<p>主要有三种方式会触发扩容</p>
<ol>
<li>
<p>执行 treeifyBin() 方法进行链表转红黑树前,会先尝试通过 tryPresize() 方法进行数组扩容。</p>
<p>当链表长度 &gt; 8 时,会尝试将链表转为红黑树。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Replaces all linked nodes in bin at given index unless table is</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* too small, in which case resizes instead.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// 在链表长度大于等于 8 时,尝试将链表转为红黑树</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">treeifyBin</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] tab, </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> index) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">   </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; b; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#96A1C2;--1:#616972">// 数组不能为空</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (tab </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 在真正进行链表 -&gt; 红黑树前,会先判断数组长度是否小于MIN_TREEIFY_CAPACITY</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// MIN_TREEIFY_CAPACITY 即 64</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> MIN_TREEIFY_CAPACITY)</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#96A1C2;--1:#616972">// 如果数组长度小于 64,不能将链表转为红黑树,先尝试扩容操作</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#50FA7B;--1:#6F42C1">tryPresize</span><span style="--0:#F8F8F2;--1:#24292E">(n </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((b </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, index)) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> b.hash </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E"> (b) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, index) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> b) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                 </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; hd </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, tl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> b; e </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">; e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.next) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                     </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">                         </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">TreeNode</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(e.hash, e.key, e.val,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                                           </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                     </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((p.prev </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tl) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                         </span></span><span style="--0:#F8F8F2;--1:#24292E">hd </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                     </span><span style="--0:#FF79C6;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                         </span></span><span style="--0:#F8F8F2;--1:#24292E">tl.next </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                     </span></span><span style="--0:#F8F8F2;--1:#24292E">tl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                 </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, index, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">TreeBin</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(hd));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">             </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">         </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">     </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Replaces all linked nodes in bin at given index unless table is * too small, in which case resizes instead. */// 在链表长度大于等于 8 时,尝试将链表转为红黑树private final void treeifyBin(Node<K,V>[] tab, int index) {   Node<K,V> b; int n;   // 数组不能为空    if (tab != null) {     // 在真正进行链表 -> 红黑树前,会先判断数组长度是否小于MIN_TREEIFY_CAPACITY     // MIN_TREEIFY_CAPACITY 即 64     if ((n = tab.length) < MIN_TREEIFY_CAPACITY)       // 如果数组长度小于 64,不能将链表转为红黑树,先尝试扩容操作       tryPresize(n << 1);     else if ((b = tabAt(tab, index)) != null &#38;&#38; b.hash >= 0) {         synchronized (b) {             if (tabAt(tab, index) == b) {                 TreeNode<K,V> hd = null, tl = null;                 for (Node<K,V> e = b; e != null; e = e.next) {                     TreeNode<K,V> p =                         new TreeNode<K,V>(e.hash, e.key, e.val,                                           null, null);                     if ((p.prev = tl) == null)                         hd = p;                     else                         tl.next = p;                     tl = p;                 }                 setTabAt(tab, index, new TreeBin<K,V>(hd));             }         }     }}"><div></div></button></div></figure></div>
</li>
<li>
<p>执行 putAll() 方法时,会尝试通过 tryPreSize() 方法对数组进行扩容。</p>
<p>putAll() 方法会传入一个 Map,原先的数组很可能会不够用,因此触发扩容。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Copies all of the mappings from the specified map to this one.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* These mappings replace any mappings that this map had for any of the</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* keys currently in the specified map.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">m</span><span style="--0:#96A1C2;--1:#616972"> mappings to be stored in this map</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">putAll</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Map</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;?</span><span style="--0:#F8F8F2;--1:#24292E"> extends K, </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> extends V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> m) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#50FA7B;--1:#6F42C1">tryPresize</span><span style="--0:#F8F8F2;--1:#24292E">(m.</span><span style="--0:#50FA7B;--1:#6F42C1">size</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Map</span><span style="--0:#F8F8F2">.</span><span style="--0:#8BE9FD;--0fs:italic">Entry</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">extends</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">extends</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; e </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> m.</span><span style="--0:#50FA7B;--1:#6F42C1">entrySet</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">putVal</span><span style="--0:#F8F8F2;--1:#24292E">(e.</span><span style="--0:#50FA7B;--1:#6F42C1">getKey</span><span style="--0:#F8F8F2;--1:#24292E">(), e.</span><span style="--0:#50FA7B;--1:#6F42C1">getValue</span><span style="--0:#F8F8F2;--1:#24292E">(), </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Copies all of the mappings from the specified map to this one. * These mappings replace any mappings that this map had for any of the * keys currently in the specified map. * * @param m mappings to be stored in this map */public void putAll(Map<? extends K, ? extends V> m) {    tryPresize(m.size());    for (Map.Entry<? extends K, ? extends V> e : m.entrySet())        putVal(e.getKey(), e.getValue(), false);}"><div></div></button></div></figure></div>
<p>向 tryPresize() 中传入需要添加的 Map 的 size。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Tries to presize table to accommodate the given number of elements.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">size</span><span style="--0:#96A1C2;--1:#616972"> number of elements (doesn&#39;t need to be perfectly accurate)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// size 是将之前的数组长度,左移一位得到的结果</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tryPresize</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> size) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 如果扩容的长度达到了最大值,就使用最大值</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 否则需要保证数组的长度的为 2 的 n 次幂</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 这块的操作是为了初始化操作准备的,因为调用 putAll 方法时,也会触发 tryPresize 方法</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 如果刚刚 new 的ConcurrentHashMap 直接调用了 putAll 方法的话,会通过 tryPresize方法进行初始化</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (size </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> (MAXIMUM_CAPACITY </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY </span><span style="--0:#FF79C6;--1:#BF3441">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#50FA7B;--1:#6F42C1">tableSizeFor</span><span style="--0:#F8F8F2;--1:#24292E">(size </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> (size </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> ((sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sizeCtl) </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 类似初始化的操作</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (tab </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (sc </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> c) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> sc </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> c;</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc, </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (table </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> tab) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">SuppressWarnings</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">unchecked</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] nt </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[])</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[n];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">table </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">finally</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                   </span></span><span style="--0:#F8F8F2;--1:#24292E">sizeCtl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 越界处理</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (c </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> sc </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY)</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// transfer() 实现扩容操作</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (tab </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> table) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 计算扩容标识戳(用于协助扩容)</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> rs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">resizeStamp</span><span style="--0:#F8F8F2;--1:#24292E">(n);</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 代表没有线程正在扩容,我是第一个扩容的</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                   </span></span><span style="--0:#F8F8F2;--1:#24292E">(rs </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> RESIZE_STAMP_SHIFT) </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">))</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#50FA7B;--1:#6F42C1">transfer</span><span style="--0:#F8F8F2;--1:#24292E">(tab, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Tries to presize table to accommodate the given number of elements. * * @param size number of elements (doesn't need to be perfectly accurate) */// size 是将之前的数组长度,左移一位得到的结果private final void tryPresize(int size) { // 如果扩容的长度达到了最大值,就使用最大值 // 否则需要保证数组的长度的为 2 的 n 次幂 // 这块的操作是为了初始化操作准备的,因为调用 putAll 方法时,也会触发 tryPresize 方法 // 如果刚刚 new 的ConcurrentHashMap 直接调用了 putAll 方法的话,会通过 tryPresize方法进行初始化   int c = (size >= (MAXIMUM_CAPACITY >>> 1)) ? MAXIMUM_CAPACITY :       tableSizeFor(size + (size >>> 1) + 1);   int sc;   while ((sc = sizeCtl) >= 0) {       Node<K,V>[] tab = table; int n;     // 类似初始化的操作       if (tab == null || (n = tab.length) == 0) {           n = (sc > c) ? sc : c;           if (U.compareAndSetInt(this, SIZECTL, sc, -1)) {               try {                   if (table == tab) {                       @SuppressWarnings(&#34;unchecked&#34;)                       Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n];                       table = nt;                       sc = n - (n >>> 2);                   }               } finally {                   sizeCtl = sc;               }           }       }     // 越界处理       else if (c <= sc || n >= MAXIMUM_CAPACITY)           break;     // transfer() 实现扩容操作       else if (tab == table) {         // 计算扩容标识戳(用于协助扩容)           int rs = resizeStamp(n);         // 代表没有线程正在扩容,我是第一个扩容的           if (U.compareAndSetInt(this, SIZECTL, sc,                                   (rs << RESIZE_STAMP_SHIFT) + 2))               transfer(tab, null);       }   }}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">transfer</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2">[] tab, </span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] nextTab) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// n = 数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// stride = 每次线程一次性迁移多少数据到新数组</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length, stride;</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 基于 CPU 的内核数量来计算,每个线程一次性迁移多少长度的数据最合理</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// NCPU = 4</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 数组长度为(1024-512-256-128)/ 4 = 32</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// MIN_TRANSFER_STRIDE = 16,为每个线程迁移数据的最小长度</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((stride </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (NCPU </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">3</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">/</span><span style="--0:#F8F8F2;--1:#24292E"> NCPU </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> n) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> MIN_TRANSFER_STRIDE)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">stride </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> MIN_TRANSFER_STRIDE; </span><span style="--0:#96A1C2;--1:#616972">// subdivide range</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 第一个进来扩容的线程需要把新数组构建出来</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (nextTab </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {            </span><span style="--0:#96A1C2;--1:#616972">// initiating</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">SuppressWarnings</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">unchecked</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 将原数组长度左移一位,构建新数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">           </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] nt </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[])</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[n </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">];</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 赋值操作</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">nextTab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Throwable</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">ex</span><span style="--0:#F8F8F2;--1:#24292E">) {      </span><span style="--0:#96A1C2;--1:#616972">// try to cope with OOME</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 到这里,说明已经达到了数组长度的最大取值范围</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">sizeCtl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> Integer.MAX_VALUE;</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 设置 sizeCtl 后直接结束</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 将成员变量的新数组赋值</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">nextTable </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextTab;</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 迁移数据时,用到的标识,默认为老数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">transferIndex </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 新数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextn </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextTab.length;</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 在老数组迁移数据后,做的标识</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">   </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ForwardingNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; fwd </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">ForwardingNode</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(nextTab);</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 迁移数据时,需要用到的标识</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// advance: true,代表当前线程需要接收任务,然后再执行迁移,如果为 false,代表已经接收完任务</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// finishing: false,是否迁移结束</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> finishing </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// to ensure sweep before committing nextTab</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// 循环 i=15 代表当前线程迁移数据的索引值</span></div></div><div class="ec-line"><div class="code"><span class="indent"> </span><span style="--0:#96A1C2;--1:#616972">// bound=0</span></div></div><div class="ec-line"><div class="code"><span class="indent">   </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">, bound </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;;) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// f = null</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// fh = 0</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; f; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> fh;</span></div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#96A1C2;--1:#616972">// 当前线程要接收任务</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> (advance) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// nextIndex = 16</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// nextBound = 16</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> nextIndex, nextBound;</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 第一次进来,这两个判断肯定进不去</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 对 i 进行--,并且判断当前任务是否处理完毕</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">--</span><span style="--0:#F8F8F2;--1:#24292E">i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> bound </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> finishing)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 判断 transferIndex 是否小于等于 0,代表没有任务可领取,结束了</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 在线程领取任务后,会对 transferIndex 进行修改,修改为 transferIndex - stride</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 在任务都领取完之后,transferIndex 肯定是小于等于 0 的,代表没有迁移数据的任务可以领取</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((nextIndex </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> transferIndex) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.compareAndSetInt</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                   </span></span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, TRANSFERINDEX, nextIndex,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                     </span></span><span style="--0:#F8F8F2;--1:#24292E">nextBound </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (nextIndex </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> stride </span><span style="--0:#FF79C6;--1:#BF3441">?</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                 </span></span><span style="--0:#F8F8F2;--1:#24292E">nextIndex </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> stride </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">))) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 对 bound 赋值</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">bound </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextBound;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 对 i 赋值</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextIndex </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 设置 advance 为 false,代表当前线程领取到任务了</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> nextn) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// finishing 为 true 代表扩容结束</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (finishing) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 将 nextTable 新数组设置为 null</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">nextTable </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 将当前数组的引用指向新数组</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">table </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextTab;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 重新计算扩容阈值 64-16=48</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">sizeCtl </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 当前线程没有接收到任务,让当前线程结束扩容操作</span></div></div><div class="ec-line"><div class="code"><span class="indent">         </span><span style="--0:#96A1C2;--1:#616972">// 采用 CAS 的方式,将 sizeCtl - 1,代表当前并发扩容的线程数 - 1</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sizeCtl, sc </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// sizeCtl 的高 16 位是基于数组长度计算的扩容戳,低 16 位是当前正在扩容的线程数</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((sc </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">resizeStamp</span><span style="--0:#F8F8F2;--1:#24292E">(n) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> RESIZE_STAMP_SHIFT)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                 </span><span style="--0:#96A1C2;--1:#616972">// 代表当前线程并不是最后一个退出扩容的线程,直接结束当前线程扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 如果是最后一个退出扩容的线程,将 finishing和advance 设置位 true</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">finishing </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">             </span><span style="--0:#96A1C2;--1:#616972">// 将 i 设置为老数组长度,让最后一个线程再从尾到头再检查一下,是否数据全部迁移完毕</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> n; </span><span style="--0:#96A1C2;--1:#616972">// recheck before commit</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((f </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i)) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">casTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, fwd);</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((fh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f.hash) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> MOVED)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">; </span><span style="--0:#96A1C2;--1:#616972">// already processed</span></div></div><div class="ec-line"><div class="code"><span class="indent">       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">           </span><span style="--0:#FF79C6;--1:#BF3441">synchronized</span><span style="--0:#F8F8F2;--1:#24292E"> (f) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">               </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> f) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                   </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; ln, hn;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (fh </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> runBit </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> fh </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; lastRun </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f.next; p </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.next) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> b </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.hash </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> n;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (b </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> runBit) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">runBit </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> b;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">lastRun </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (runBit </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">ln </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> lastRun;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">hn </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">hn </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> lastRun;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">ln </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> f; p </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> lastRun; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.next) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> ph </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> p.hash; </span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> pk </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> p.key; </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> pv </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p.val;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((ph </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> n) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">ln </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(ph, pk, pv, ln);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#FF79C6;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">hn </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(ph, pk, pv, hn);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(nextTab, i, ln);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(nextTab, i </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> n, hn);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i, fwd);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                   </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (f </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> TreeBin) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeBin</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; t </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">TreeBin</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">K,V</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">)f;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; lo </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, loTail </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                       </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; hi </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, hiTail </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> lc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">, hc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> t.first; e </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">; e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.next) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> h </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.hash;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                           </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TreeNode</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">TreeNode</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">(h, e.key, e.val, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((h </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> n) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((p.prev </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> loTail) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                   </span></span><span style="--0:#F8F8F2;--1:#24292E">lo </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                   </span></span><span style="--0:#F8F8F2;--1:#24292E">loTail.next </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">loTail </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">lc;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                           </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((p.prev </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> hiTail) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                   </span></span><span style="--0:#F8F8F2;--1:#24292E">hi </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">else</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                                   </span></span><span style="--0:#F8F8F2;--1:#24292E">hiTail.next </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                               </span></span><span style="--0:#F8F8F2;--1:#24292E">hiTail </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> p;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                               </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">hc;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">ln </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (lc </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> UNTREEIFY_THRESHOLD) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">untreeify</span><span style="--0:#F8F8F2;--1:#24292E">(lo) </span><span style="--0:#FF79C6;--1:#BF3441">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">(hc </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">TreeBin</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(lo) </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> t;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">hn </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (hc </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> UNTREEIFY_THRESHOLD) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">untreeify</span><span style="--0:#F8F8F2;--1:#24292E">(hi) </span><span style="--0:#FF79C6;--1:#BF3441">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                           </span></span><span style="--0:#F8F8F2;--1:#24292E">(lc </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">TreeBin</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;(hi) </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> t;</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(nextTab, i, ln);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(nextTab, i </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> n, hn);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                       </span><span style="--0:#50FA7B;--1:#6F42C1">setTabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, i, fwd);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                       </span></span><span style="--0:#F8F8F2;--1:#24292E">advance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">               </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">           </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">       </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">   </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private final void transfer(Node<K,V>[] tab, Node<K,V>[] nextTab) { // n = 数组长度 // stride = 每次线程一次性迁移多少数据到新数组   int n = tab.length, stride; // 基于 CPU 的内核数量来计算,每个线程一次性迁移多少长度的数据最合理 // NCPU = 4 // 数组长度为(1024-512-256-128)/ 4 = 32 // MIN_TRANSFER_STRIDE = 16,为每个线程迁移数据的最小长度   if ((stride = (NCPU > 1) ? (n >>> 3) / NCPU : n) < MIN_TRANSFER_STRIDE)       stride = MIN_TRANSFER_STRIDE; // subdivide range // 第一个进来扩容的线程需要把新数组构建出来   if (nextTab == null) {            // initiating       try {           @SuppressWarnings(&#34;unchecked&#34;)         // 将原数组长度左移一位,构建新数组长度           Node<K,V>[] nt = (Node<K,V>[])new Node<?,?>[n << 1];         // 赋值操作           nextTab = nt;       } catch (Throwable ex) {      // try to cope with OOME         // 到这里,说明已经达到了数组长度的最大取值范围           sizeCtl = Integer.MAX_VALUE;         // 设置 sizeCtl 后直接结束           return;       }     // 将成员变量的新数组赋值       nextTable = nextTab;     // 迁移数据时,用到的标识,默认为老数组长度       transferIndex = n;   } // 新数组长度   int nextn = nextTab.length; // 在老数组迁移数据后,做的标识   ForwardingNode<K,V> fwd = new ForwardingNode<K,V>(nextTab); // 迁移数据时,需要用到的标识 // advance: true,代表当前线程需要接收任务,然后再执行迁移,如果为 false,代表已经接收完任务   boolean advance = true; // finishing: false,是否迁移结束   boolean finishing = false; // to ensure sweep before committing nextTab // 循环 i=15 代表当前线程迁移数据的索引值 // bound=0   for (int i = 0, bound = 0;;) {     // f = null     // fh = 0       Node<K,V> f; int fh;     // 当前线程要接收任务       while (advance) {         // nextIndex = 16         // nextBound = 16           int nextIndex, nextBound;         // 第一次进来,这两个判断肯定进不去         // 对 i 进行--,并且判断当前任务是否处理完毕           if (--i >= bound || finishing)               advance = false;         // 判断 transferIndex 是否小于等于 0,代表没有任务可领取,结束了         // 在线程领取任务后,会对 transferIndex 进行修改,修改为 transferIndex - stride         // 在任务都领取完之后,transferIndex 肯定是小于等于 0 的,代表没有迁移数据的任务可以领取           else if ((nextIndex = transferIndex) <= 0) {               i = -1;               advance = false;           }           else if (U.compareAndSetInt                   (this, TRANSFERINDEX, nextIndex,                     nextBound = (nextIndex > stride ?                                 nextIndex - stride : 0))) {             // 对 bound 赋值               bound = nextBound;             // 对 i 赋值               i = nextIndex - 1;             // 设置 advance 为 false,代表当前线程领取到任务了               advance = false;           }       }       if (i < 0 || i >= n || i + n >= nextn) {           int sc;         // finishing 为 true 代表扩容结束           if (finishing) {             // 将 nextTable 新数组设置为 null               nextTable = null;             // 将当前数组的引用指向新数组               table = nextTab;             // 重新计算扩容阈值 64-16=48               sizeCtl = (n << 1) - (n >>> 1);               return;           }         // 当前线程没有接收到任务,让当前线程结束扩容操作         // 采用 CAS 的方式,将 sizeCtl - 1,代表当前并发扩容的线程数 - 1           if (U.compareAndSetInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {             // sizeCtl 的高 16 位是基于数组长度计算的扩容戳,低 16 位是当前正在扩容的线程数               if ((sc - 2) != resizeStamp(n) << RESIZE_STAMP_SHIFT)                 // 代表当前线程并不是最后一个退出扩容的线程,直接结束当前线程扩容                   return;             // 如果是最后一个退出扩容的线程,将 finishing和advance 设置位 true               finishing = advance = true;             // 将 i 设置为老数组长度,让最后一个线程再从尾到头再检查一下,是否数据全部迁移完毕               i = n; // recheck before commit           }       }       else if ((f = tabAt(tab, i)) == null)           advance = casTabAt(tab, i, null, fwd);       else if ((fh = f.hash) == MOVED)           advance = true; // already processed       else {           synchronized (f) {               if (tabAt(tab, i) == f) {                   Node<K,V> ln, hn;                   if (fh >= 0) {                       int runBit = fh &#38; n;                       Node<K,V> lastRun = f;                       for (Node<K,V> p = f.next; p != null; p = p.next) {                           int b = p.hash &#38; n;                           if (b != runBit) {                               runBit = b;                               lastRun = p;                           }                       }                       if (runBit == 0) {                           ln = lastRun;                           hn = null;                       }                       else {                           hn = lastRun;                           ln = null;                       }                       for (Node<K,V> p = f; p != lastRun; p = p.next) {                           int ph = p.hash; K pk = p.key; V pv = p.val;                           if ((ph &#38; n) == 0)                               ln = new Node<K,V>(ph, pk, pv, ln);                           else                               hn = new Node<K,V>(ph, pk, pv, hn);                       }                       setTabAt(nextTab, i, ln);                       setTabAt(nextTab, i + n, hn);                       setTabAt(tab, i, fwd);                       advance = true;                   }                   else if (f instanceof TreeBin) {                       TreeBin<K,V> t = (TreeBin<K,V>)f;                       TreeNode<K,V> lo = null, loTail = null;                       TreeNode<K,V> hi = null, hiTail = null;                       int lc = 0, hc = 0;                       for (Node<K,V> e = t.first; e != null; e = e.next) {                           int h = e.hash;                           TreeNode<K,V> p = new TreeNode<K,V>                               (h, e.key, e.val, null, null);                           if ((h &#38; n) == 0) {                               if ((p.prev = loTail) == null)                                   lo = p;                               else                                   loTail.next = p;                               loTail = p;                               ++lc;                           }                           else {                               if ((p.prev = hiTail) == null)                                   hi = p;                               else                                   hiTail.next = p;                               hiTail = p;                               ++hc;                           }                       }                       ln = (lc <= UNTREEIFY_THRESHOLD) ? untreeify(lo) :                           (hc != 0) ? new TreeBin<K,V>(lo) : t;                       hn = (hc <= UNTREEIFY_THRESHOLD) ? untreeify(hi) :                           (lc != 0) ? new TreeBin<K,V>(hi) : t;                       setTabAt(nextTab, i, ln);                       setTabAt(nextTab, i + n, hn);                       setTabAt(tab, i, fwd);                       advance = true;                   }               }           }       }   }}"><div></div></button></div></figure></div>
<p>首先要确定扩容的大小</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* The largest possible table capacity.  This value must be</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* exactly 1&lt;&lt;30 to stay within Java array allocation and indexing</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* bounds for power of two table sizes, and is further required</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* because the top two bits of 32bit hash fields are used for</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* control purposes.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">30</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * The largest possible table capacity.  This value must be * exactly 1<<30 to stay within Java array allocation and indexing * bounds for power of two table sizes, and is further required * because the top two bits of 32bit hash fields are used for * control purposes. */private static final int MAXIMUM_CAPACITY = 1 << 30;"><div></div></button></div></figure></div>
<p>大于最大值就取最大值(MAXIMUM_CAPACITY),不是 2^n 就计算大于它且离他最近的 2^n。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Returns a power of two table size for the given desired capacity.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* See Hackers Delight, sec 3.2</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tableSizeFor</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> c) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> Integer.</span><span style="--0:#50FA7B;--1:#6F42C1">numberOfLeadingZeros</span><span style="--0:#F8F8F2;--1:#24292E">(c </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">numberOfLeadingZeros</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> i) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// HD, Count leading 0&#39;s</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">32</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">31</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">) { n </span><span style="--0:#FF79C6;--1:#BF3441">-=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">; i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">16</span><span style="--0:#F8F8F2;--1:#24292E">; }</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">8</span><span style="--0:#F8F8F2;--1:#24292E">) { n </span><span style="--0:#FF79C6;--1:#BF3441">-=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">8</span><span style="--0:#F8F8F2;--1:#24292E">; i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">8</span><span style="--0:#F8F8F2;--1:#24292E">; }</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">4</span><span style="--0:#F8F8F2;--1:#24292E">) { n </span><span style="--0:#FF79C6;--1:#BF3441">-=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">4</span><span style="--0:#F8F8F2;--1:#24292E">; i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">4</span><span style="--0:#F8F8F2;--1:#24292E">; }</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">) { n </span><span style="--0:#FF79C6;--1:#BF3441">-=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">; i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;=</span><span style="--0:#F8F8F2;--1:#24292E">  </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">; }</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> (i </span><span style="--0:#FF79C6;--1:#BF3441">&gt;&gt;&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Returns a power of two table size for the given desired capacity. * See Hackers Delight, sec 3.2 */private static final int tableSizeFor(int c) {    int n = -1 >>> Integer.numberOfLeadingZeros(c - 1);    return (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;}public static int numberOfLeadingZeros(int i) {    // HD, Count leading 0's    if (i <= 0)        return i == 0 ? 32 : 0;    int n = 31;    if (i >= 1 << 16) { n -= 16; i >>>= 16; }    if (i >= 1 <<  8) { n -=  8; i >>>=  8; }    if (i >= 1 <<  4) { n -=  4; i >>>=  4; }    if (i >= 1 <<  2) { n -=  2; i >>>=  2; }    return n - (i >>> 1);}"><div></div></button></div></figure></div>
<p>接着就进入了 while 循环,</p>
</li>
<li>
<p>执行 addCount() 操作时,如果当前元素个数达到了扩容阈值,也会进行扩容。</p>
</li>
</ol>
<h3 id="concurrenthashmap-读取数据流程">ConcurrentHashMap 读取数据流程</h3>
<p>ConcurrentHashMap 的数据查询都是以 get() 方法为入口的。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Returns the value to which the specified key is mapped,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* or {@code null} if this map contains no mapping for the key.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* &lt;p&gt;More formally, if this map contains a mapping from a key</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* {@code k} to a value {@code v} such that {@code key.equals(k)},</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* then this method returns {@code v}; otherwise it returns</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* {@code null}.  (There can be at most one such mapping.)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@throws</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">NullPointerException</span><span style="--0:#96A1C2;--1:#616972"> if the specified key is null</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">V</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> key) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// tab: 数组,e: 查询指定位置的节点 n: 数组长度</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--1:#24292E"><span style="--0:#F8F8F2">&gt;[] tab; </span><span style="--0:#8BE9FD;--0fs:italic">Node</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt; e, p; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> n, eh; </span><span style="--0:#8BE9FD;--0fs:italic">K</span><span style="--0:#F8F8F2"> ek;</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 基于传入的 key,计算 hash 值</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> h </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">spread</span><span style="--0:#F8F8F2;--1:#24292E">(key.</span><span style="--0:#50FA7B;--1:#6F42C1">hashCode</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 数组不为 null,数组上得有数据</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> (n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length) </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 查询对应数组的位置上的数据</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">(e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">tabAt</span><span style="--0:#F8F8F2;--1:#24292E">(tab, (n </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> h)) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// hash 值一致+key 一致 返回 value</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((eh </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.hash) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> h) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// key 的==或者 equals 是否一致,如果一致,数组上就是要查询的数据</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((ek </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.key) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> key </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (ek </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> key.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(ek)))</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> e.val;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// hash 值&lt;0 (特殊情况,会通过 find() 方法进行 value 的获取)</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (eh </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 三种情况: 数组迁移走了、节点位置被占、红黑树</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 如果当前数据已经迁移到新数组 ,调用 ForwardingNode 中的 find()</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> (p </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.</span><span style="--0:#50FA7B;--1:#6F42C1">find</span><span style="--0:#F8F8F2;--1:#24292E">(h, key)) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> p.val </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 走链表操作</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> ((e </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.next) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 如果 hash 值一致,并且 key 的==或者 equals 一致,返回当前链表位置的数据</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (e.hash </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> h </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">              </span></span><span style="--0:#F8F8F2;--1:#24292E">((ek </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> e.key) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> key </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (ek </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> key.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(ek))))</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> e.val;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 如果上述三个流程都没有知道指定 key 对应的 value,那就是 key 不存在,返回 null 即可</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Returns the value to which the specified key is mapped, * or {@code null} if this map contains no mapping for the key. * * <p>More formally, if this map contains a mapping from a key * {@code k} to a value {@code v} such that {@code key.equals(k)}, * then this method returns {@code v}; otherwise it returns * {@code null}.  (There can be at most one such mapping.) * * @throws NullPointerException if the specified key is null */public V get(Object key) {  // tab: 数组,e: 查询指定位置的节点 n: 数组长度  Node<K,V>[] tab; Node<K,V> e, p; int n, eh; K ek;  // 基于传入的 key,计算 hash 值  int h = spread(key.hashCode());  // 数组不为 null,数组上得有数据  if ((tab = table) != null &#38;&#38; (n = tab.length) > 0 &#38;&#38;      // 查询对应数组的位置上的数据      (e = tabAt(tab, (n - 1) &#38; h)) != null) {      // hash 值一致+key 一致 返回 value      if ((eh = e.hash) == h) {          // key 的==或者 equals 是否一致,如果一致,数组上就是要查询的数据          if ((ek = e.key) == key || (ek != null &#38;&#38; key.equals(ek)))              return e.val;      }      // hash 值<0 (特殊情况,会通过 find() 方法进行 value 的获取)      else if (eh < 0)          // 三种情况: 数组迁移走了、节点位置被占、红黑树          // 如果当前数据已经迁移到新数组 ,调用 ForwardingNode 中的 find()          return (p = e.find(h, key)) != null ? p.val : null;      // 走链表操作      while ((e = e.next) != null) {          // 如果 hash 值一致,并且 key 的==或者 equals 一致,返回当前链表位置的数据          if (e.hash == h &#38;&#38;              ((ek = e.key) == key || (ek != null &#38;&#38; key.equals(ek))))              return e.val;      }  }  // 如果上述三个流程都没有知道指定 key 对应的 value,那就是 key 不存在,返回 null 即可  return null;}"><div></div></button></div></figure></div>
<h3 id="concurrenthashmap-计数器的实现">ConcurrentHashMap 计数器的实现</h3>
<p>计数器是用来统计 ConcurrentHashMap 的元素个数的,通过 addCount() 方法是吸纳,可以看到 addCount() 方法中有两个重要的对象: CounterCell[] 数组和 baseCount 变量。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* Adds to count, and if table is too small and not already</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* resizing, initiates transfer. If already resizing, helps</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* perform transfer if work is available.  Rechecks occupancy</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* after a transfer to see if another resize is already needed</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* because resizings are lagging additions.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">x</span><span style="--0:#96A1C2;--1:#616972"> the count to add</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">check</span><span style="--0:#96A1C2;--1:#616972"> if &lt;0, don&#39;t check resize, if &lt;= 1 only check if uncontended</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">addCount</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> x, </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> check) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// b: 原来的 baseCount</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// s: 是自增后的元素个数</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">CounterCell</span><span style="--0:#F8F8F2;--1:#24292E">[] cs; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> b, s;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 判断 CounterCell 不为 null,代表之前有冲突问题,有冲突直接进入 if 中</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 如果 CounterCell[] 为 null,直接执行 || 后面的 CAS 操作,直接修改 baseCount</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> ((cs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> counterCells) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果对 baseCount++ 成功,直接告辞,如果 CAS 失败,直接进入 if 中</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetLong</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, BASECOUNT, b </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> baseCount, s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> b </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> x)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 进入这里,说明有并发问题</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 进入的方式有两种:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 1.CounterCell[] 有值</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 2.CounterCell[] 无值,但是 CAS 失败</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// m: 数组长度 - 1</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// c: 当前线程基于随机数,获得到的数组上的某一个 CounterCell</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">      </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">CounterCell</span><span style="--0:#F8F8F2;--1:#24292E"> c; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> v; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> m;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 是否有冲突,默认为 true,代表没有冲突</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> uncontended </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 判断 CounterCell[] 没有初始化,执行 fullAddCount 方法执行初始化</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (cs </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> (m </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> cs.length </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// CounterCell[] 已经初始化,基于随机数拿到数组上的一个 CounterCell,如果为 null 执行 fullAddCount</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">(c </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> cs[ThreadLocalRandom.</span><span style="--0:#50FA7B;--1:#6F42C1">getProbe</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> m]) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// CounterCell[] 已经初始化,并且指定索引位置上有 CounterCell</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 直接 CAS 修改指定的 CounterCell 上的 value 即可</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// CAS 成功,直接告辞</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// CAS 失败,代表有冲突,uncontended = false,执行 fullAddCount 方法</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">(uncontended </span><span style="--0:#FF79C6;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetLong</span><span style="--0:#F8F8F2;--1:#24292E">(c, CELLVALUE, v </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> c.value, v </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> x))) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#50FA7B;--1:#6F42C1">fullAddCount</span><span style="--0:#F8F8F2;--1:#24292E">(x, uncontended);</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 如果链表长度小于等于 1,不去判断扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (check </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 将所有 CounterCell 中记录的数累加,得到最终的元素个数</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">sumCount</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 判断 check 大于等于 0,remove 的操作就是小于 0的,因为添加时,才需要判断是否需要扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (check </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">      </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Node</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">K</span><span style="--0:#F8F8F2;--1:#24292E">,</span><span style="--0:#F8F8F2;--1:#BF3441">V</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] tab, nt; </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> n, sc;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 当前元素个数是否大于扩容阈值,并且数组不为 null,数组长度没有达到最大值</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> (s </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E">)(sc </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> sizeCtl) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> (tab </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> table) </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">              </span></span><span style="--0:#F8F8F2;--1:#24292E">(n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> tab.length) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> MAXIMUM_CAPACITY) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 扩容表示戳</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> rs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">resizeStamp</span><span style="--0:#F8F8F2;--1:#24292E">(n) </span><span style="--0:#FF79C6;--1:#BF3441">&lt;&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> RESIZE_STAMP_SHIFT;</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (sc </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#96A1C2;--1:#616972">// 判断是否可以协助扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (sc </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> rs </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> MAX_RESIZERS </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> sc </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> rs </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                  </span></span><span style="--0:#F8F8F2;--1:#24292E">(nt </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> nextTable) </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> transferIndex </span><span style="--0:#FF79C6;--1:#BF3441">&lt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#FF79C6;--1:#BF3441">break</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#96A1C2;--1:#616972">// 协助扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc, sc </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">))</span></div></div><div class="ec-line"><div class="code"><span class="indent">                  </span><span style="--0:#50FA7B;--1:#6F42C1">transfer</span><span style="--0:#F8F8F2;--1:#24292E">(tab, nt);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#96A1C2;--1:#616972">// 没有线程执行扩容,我来执行扩容</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (U.</span><span style="--0:#50FA7B;--1:#6F42C1">compareAndSetInt</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, SIZECTL, sc, rs </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">))</span></div></div><div class="ec-line"><div class="code"><span class="indent">              </span><span style="--0:#50FA7B;--1:#6F42C1">transfer</span><span style="--0:#F8F8F2;--1:#24292E">(tab, </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">s </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">sumCount</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * Adds to count, and if table is too small and not already * resizing, initiates transfer. If already resizing, helps * perform transfer if work is available.  Rechecks occupancy * after a transfer to see if another resize is already needed * because resizings are lagging additions. * * @param x the count to add * @param check if <0, don't check resize, if <= 1 only check if uncontended */private final void addCount(long x, int check) {  // b: 原来的 baseCount  // s: 是自增后的元素个数  CounterCell[] cs; long b, s;  // 判断 CounterCell 不为 null,代表之前有冲突问题,有冲突直接进入 if 中  // 如果 CounterCell[] 为 null,直接执行 || 后面的 CAS 操作,直接修改 baseCount  if ((cs = counterCells) != null ||      // 如果对 baseCount++ 成功,直接告辞,如果 CAS 失败,直接进入 if 中      !U.compareAndSetLong(this, BASECOUNT, b = baseCount, s = b + x)) {      // 进入这里,说明有并发问题      // 进入的方式有两种:      // 1.CounterCell[] 有值      // 2.CounterCell[] 无值,但是 CAS 失败      // m: 数组长度 - 1      // c: 当前线程基于随机数,获得到的数组上的某一个 CounterCell      CounterCell c; long v; int m;      // 是否有冲突,默认为 true,代表没有冲突      boolean uncontended = true;      // 判断 CounterCell[] 没有初始化,执行 fullAddCount 方法执行初始化      if (cs == null || (m = cs.length - 1) < 0 ||          // CounterCell[] 已经初始化,基于随机数拿到数组上的一个 CounterCell,如果为 null 执行 fullAddCount          (c = cs[ThreadLocalRandom.getProbe() &#38; m]) == null ||          // CounterCell[] 已经初始化,并且指定索引位置上有 CounterCell          // 直接 CAS 修改指定的 CounterCell 上的 value 即可          // CAS 成功,直接告辞          // CAS 失败,代表有冲突,uncontended = false,执行 fullAddCount 方法          !(uncontended =            U.compareAndSetLong(c, CELLVALUE, v = c.value, v + x))) {          fullAddCount(x, uncontended);          return;      }      // 如果链表长度小于等于 1,不去判断扩容      if (check <= 1)          return;      // 将所有 CounterCell 中记录的数累加,得到最终的元素个数      s = sumCount();  }  // 判断 check 大于等于 0,remove 的操作就是小于 0的,因为添加时,才需要判断是否需要扩容  if (check >= 0) {      Node<K,V>[] tab, nt; int n, sc;      // 当前元素个数是否大于扩容阈值,并且数组不为 null,数组长度没有达到最大值      while (s >= (long)(sc = sizeCtl) &#38;&#38; (tab = table) != null &#38;&#38;              (n = tab.length) < MAXIMUM_CAPACITY) {          // 扩容表示戳          int rs = resizeStamp(n) << RESIZE_STAMP_SHIFT;          if (sc < 0) {              // 判断是否可以协助扩容              if (sc == rs + MAX_RESIZERS || sc == rs + 1 ||                  (nt = nextTable) == null || transferIndex <= 0)                  break;              // 协助扩容              if (U.compareAndSetInt(this, SIZECTL, sc, sc + 1))                  transfer(tab, nt);          }          // 没有线程执行扩容,我来执行扩容          else if (U.compareAndSetInt(this, SIZECTL, sc, rs + 2))              transfer(tab, null);          s = sumCount();      }  }}"><div></div></button></div></figure></div>
<p>他们是记录数据的两个位置:</p>
<ul>
<li>并发量不高时,会通过 baseCount 进行追加</li>
<li>并发量较高时,CAS 试图操作 baseCount 失败后,会切换到 CounterCell[] 数组来计数,有多个 CounterCell 可供不同的线程进行选择。</li>
</ul>
<p>当我们需要获取 ConcurrentHashMap 的元素个数时,会调用 size() 方法。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">* {@inheritDoc}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972"> </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">size</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> n </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">sumCount</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> ((n </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0L</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">(n </span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E">)Integer.MAX_VALUE) </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> Integer.MAX_VALUE </span><span style="--0:#FF79C6;--1:#BF3441">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E">)n);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="/** * {@inheritDoc} */public int size() {    long n = sumCount();    return ((n < 0L) ? 0 :            (n > (long)Integer.MAX_VALUE) ? Integer.MAX_VALUE :            (int)n);}"><div></div></button></div></figure></div>
<p>而 size() 方法中调用了 sumCount() 方法</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">sumCount</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">CounterCell</span><span style="--0:#F8F8F2;--1:#24292E">[] cs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> counterCells;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">long</span><span style="--0:#F8F8F2;--1:#24292E"> sum </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> baseCount;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (cs </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">CounterCell</span><span style="--0:#F8F8F2"> c </span></span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> cs)</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (c </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">sum </span><span style="--0:#FF79C6;--1:#BF3441">+=</span><span style="--0:#F8F8F2;--1:#24292E"> c.value;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> sum;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="final long sumCount() {    CounterCell[] cs = counterCells;    long sum = baseCount;    if (cs != null) {        for (CounterCell c : cs)            if (c != null)                sum += c.value;    }    return sum;}"><div></div></button></div></figure></div>
<p>在 sumCount() 对 baseCount 还有数组 CounterCell[] 中的每个记录进行累加,返回最终值。</p>
<h3 id="cas-和自旋">CAS 和自旋</h3>
<h4 id="自旋">自旋</h4>
<p>顾名思义,自旋可以理解为“自我旋转“,放到程序中就是”自我循环“,比如 while 循环或者 for 循环。结合着锁来理解的话就是,先获取一次锁,如果获取不到锁,会不停的循环获取,直到获取到。不像普通的锁那样,如果获取不到锁就进入阻塞状态。</p>
<h4 id="cas">CAS</h4>
<p>CAS 是什么,compare-and-swap,比较并交换,它是一种思想、一种算法。
CAS 算法有 3 个基本操作数:</p>
<ul>
<li>内存地址 V</li>
<li>旧的预期值 A</li>
<li>要修改的新值 B</li>
</ul>
<p>在并发场景下,各个代码的执行顺序不能确定,为了保证并发安全,我们可以使用普通的互斥锁,比如 Java 的 synchronized、ReentrantLock 等。而 CAS 的特点是避免使用互斥锁,当多个线程并发使用 CAS 更新同一个变量时,只有一个可以操作成功,其他都会失败。而且用 CAS 更新失败的线程并不会阻塞,会快速失败并返回一个失败的状态,允许你再次尝试。</p>
<p>而 CAS 是一种原子操作,用于实现多线程环境下的同步和并发控制。
基本原理如下:</p>
<ol>
<li>读取内存值: 首先,CAS 会读取内存中的一个变量的当前值。</li>
<li>比较内存值和预期值: 接下来,CAS 会将读取的值与预期值进行比较。如果两者相等,则说明内存中的值没有被其他线程修改。</li>
<li>如果相等,则将新值写入内存: 在比较阶段,如果发现内存值与预期值相等,CAS 会尝试将新值写入内存中。这个写入操作是原子的,即在这个过程中不会被其他线程中断。</li>
<li>如果写入成功,则操作完成,否则重复上述步骤,如果写入操作成功,CAS 完成。如果写入操作失败,说明在比较和写入的过程中,内存值已经被其他线程修改,此时需要重新执行整个 CAS 操作。</li>
</ol>
<p>CAS 的基本原理就是利用比较和写入的原子性操作来实现对共享变量的原子操作,从而避免了传统锁机制中的死锁和线程阻塞问题。</p>
<h4 id="自旋锁和-cas-的关系是什么呢">自旋锁和 CAS 的关系是什么呢?</h4>
<p>其实他们是两个不同的概念,自旋是一种锁优化的机制,在锁优化中<code>自旋锁</code>指线程空转重试获取锁,避免线程上下文切换带来的开销。
CAS 是一种乐观锁机制,CAS 是通过比较并替换,失败的时候可以直接返回 false 不用自旋的获取。只是一般应用场景下,CAS 都会带有重试机制(while 或者 for 实现空转,不断尝试获取)。
如果硬有关系,那么可以这样理解 <strong>自旋锁 = 循环 + CAS</strong>。</p>
<p>CAS 有哪些缺点呢?</p>
<ol>
<li>自旋等待: CAS 在执行时会进行自旋等待,如果失败则需要重试,这会消耗处理器资源。</li>
<li>aba 问题: CAS 只能检测到共享变量的值是否发生了变化,但无法检测到变量的值是否经历了类似 a-&gt;b-&gt;a 的变化,这可能导致一些意外的问题。</li>
<li>无法保证公平性: CAS 操作时非阻塞的,因此无法保证等待线程的公平性,可能导致某些线程长时间无法获得执行机会。</li>
<li>无法解决死锁: CAS 无法解决死锁问题,如果多个线程同时执行 CAS 操作,可能导致死锁的发生。</li>
<li>限制性: CAS 操作通常只能应用于单个变量,对于复杂的数据结构,需要额外的处理来实现原子操作。</li>
</ol>
<p>总的来说,CAS 虽然具有高效的特点,但也存在着一些局限性和缺点。</p>
<h4 id="什么是-aba-问题">什么是 ABA 问题</h4>
<p>ABA 问题是在分布式系统中常见的一种数据一致性问题。它的名称来源于三个操作: A(原始值)、B(第一个读取)、A(第二个读取)。ABA 问题发生在一个线程 T1 读取了一个共享变量的值 A,然后另一个线程 T2 修改了这个共享变量的值为 B,然后又改回 A,最后线程 T1 再次读取这个共享变量的值,发现仍然是 A。在这种情况下,线程 T1 可能会错误地认为共享变量的值没有改变,从而导致数据不一致。</p>
<p>解决 ABA 问题的常见方案是使用版本号或者标记来跟踪数据的变化。通过在每次数据变化时增加版本号或者标记,可以避免 ABA 问题的发生。另外,使用 CAS 操作也可以解决 ABA 问题,CAS 操作会在更新变量时检查变量的值是否仍然是预期值,从而避免了 ABA 问题的发生。</p>
<p>简单的说就是:</p>
<p>比如线程 1 从内存位置 V 中取出 A,辞职线程 2 也取出 A,且线程 2 做了一次 CAS 将值改为了 B,然后又做了一次 CAS 将值改回了 A。此时线程 1 做 CAS 发现内存中还是 A,则线程 1 操作成功。这个时候实际上 A 值已经被其他线程改变过,这与设计思想是不符合的。</p>
<p>那么这个问题出现在哪里呢?</p>
<ul>
<li>如果只在乎结果,ABA 不介意 B 的存在,没什么问题</li>
<li>如果 B 的存在会造成影响,需要通过 AtomicStampRefrence,加时间戳解决。</li>
</ul>   </div> </article> </div> <button aria-label="Back to Top" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:bg-zinc-700 sm:end-8 sm:h-12 sm:w-12" data-show="false" id="to-top-btn"><svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs"> <div class="me-0 sm:me-4">
&copy; chou401 2024.<span class="inline-block">&nbsp;🚀&nbsp;花易谢、雾易失、梦易逝、云易散</span> </div> <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"> <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/astro-theme-cactus/"> Home </a><a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/astro-theme-cactus/posts/"> Blog </a> </nav> </footer> </body></html> 