<!DOCTYPE html><html lang="en-EN"> <head><meta charset="utf-8"><meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport"><meta content="IE=edge" http-equiv="X-UA-Compatible"><title>Feign &amp; openFeign • 知道的越多,才知知道的越少</title><link href="/astro-theme-cactus/favicon.ico" rel="icon" sizes="any"><link href="/astro-theme-cactus/icon.svg" rel="icon" type="image/svg+xml"><link href="/astro-theme-cactus/apple-touch-icon.png" rel="apple-touch-icon"><link href="/astro-theme-cactus/manifest.webmanifest" rel="manifest"><link href="https://chou401.github.io/astro-theme-cactus/posts/feign-and-open-feign-definition/" rel="canonical"><meta content="Feign &#38; openFeign • 知道的越多,才知知道的越少" name="title"><meta content="feign &#38; openFeign 介绍以及使用" name="description"><meta content="chou401" name="author"><meta content="" name="theme-color"><meta content="article" property="og:type"><meta content="Feign &#38; openFeign" property="og:title"><meta content="feign &#38; openFeign 介绍以及使用" property="og:description"><meta content="https://chou401.github.io/astro-theme-cactus/posts/feign-and-open-feign-definition/" property="og:url"><meta content="知道的越多,才知知道的越少" property="og:site_name"><meta content="en-EN" property="og:locale"><meta content="https://chou401.github.io/og-image/feign-and-open-feign-definition.png" property="og:image"><meta content="1200" property="og:image:width"><meta content="630" property="og:image:height"><meta content="chou401" property="article:author"><meta content="2024-05-16T14:00:40.000Z" property="article:published_time"><meta content="summary_large_image" property="twitter:card"><meta content="https://chou401.github.io/astro-theme-cactus/posts/feign-and-open-feign-definition/" property="twitter:url"><meta content="Feign &#38; openFeign" property="twitter:title"><meta content="feign &#38; openFeign 介绍以及使用" property="twitter:description"><meta content="https://chou401.github.io/og-image/feign-and-open-feign-definition.png" property="twitter:image"><link href="/sitemap-index.xml" rel="sitemap"><link href="/rss.xml" rel="alternate" title="知道的越多,才知知道的越少" type="application/rss+xml"><link href="http://localhost:4321/astro-theme-cactus/" rel="webmention"><meta content="Astro v4.5.16" name="generator"><link rel="stylesheet" href="/astro-theme-cactus/_astro/_slug_.vObVOHgF.css"><script type="module" src="/astro-theme-cactus/_astro/hoisted.BjpvhLSh.js"></script>
<script type="module" src="/astro-theme-cactus/_astro/page.BG5lM7_G.js"></script></head> <body> <script>
	const lightModePref = window.matchMedia("(prefers-color-scheme: light)");

	function getUserPref() {
		const storedTheme = typeof localStorage !== "undefined" && localStorage.getItem("theme");
		return storedTheme || (lightModePref.matches ? "light" : "dark");
	}

	function setTheme(newTheme) {
		if (newTheme !== "light" && newTheme !== "dark") {
			return console.warn(
				`Invalid theme value '${newTheme}' received. Expected 'light' or 'dark'.`,
			);
		}

		const root = document.documentElement;

		// root already set to newTheme, exit early
		if (newTheme === root.getAttribute("data-theme")) {
			return;
		}

		root.setAttribute("data-theme", newTheme);

		const colorThemeMetaTag = document.querySelector("meta[name='theme-color']");
		const bgColour = getComputedStyle(document.body).getPropertyValue("--theme-bg");
		colorThemeMetaTag.setAttribute("content", `hsl(${bgColour})`);
		if (typeof localStorage !== "undefined") {
			localStorage.setItem("theme", newTheme);
		}
	}

	// initial setup
	setTheme(getUserPref());

	// View Transitions hook to restore theme
	document.addEventListener("astro:after-swap", () => setTheme(getUserPref()));

	// listen for theme-change custom event, fired in src/components/ThemeToggle.astro
	document.addEventListener("theme-change", (e) => {
		setTheme(e.detail.theme);
	});

	// listen for prefers-color-scheme change.
	lightModePref.addEventListener("change", (e) => setTheme(e.matches ? "light" : "dark"));
</script> <a class="sr-only focus:not-sr-only focus:fixed focus:start-1 focus:top-1.5" href="#main">skip to content
</a> <header class="group relative mb-8 flex items-center sm:ps-[3.5rem]" id="main-header"> <div class="flex sm:flex-col"> <a class="inline-flex items-center grayscale hover:filter-none sm:relative sm:inline-block" href="/astro-theme-cactus/"> <svg aria-hidden="true" class="me-3 h-10 w-6 sm:absolute sm:start-[-3.5rem] sm:me-0 sm:h-20 sm:w-12" fill="none" focusable="false" viewBox="0 0 272 480" xmlns="http://www.w3.org/2000/svg"> <g stroke="null"> <title>Layer 1</title> <g transform="translate(0,800) scale(0.10000000149011612,-0.10000000149011612) " fill="#000000" id="svg_1" stroke="null"> <path d="m1330.461549,8010.447731c-9.667991,-6.119317 -19.647851,-12.578595 -21.830946,-14.618368c-2.494965,-2.039772 -11.851085,-7.819127 -20.583464,-12.238633c-9.044249,-4.759469 -15.593533,-9.518937 -14.346051,-10.538823c0.935612,-1.359848 0,-2.379734 -2.806836,-2.379734c-2.494965,0 -9.979861,-4.419507 -16.841016,-10.198861c-6.549283,-5.439393 -14.657921,-10.198861 -17.464757,-10.198861c-3.118707,0 -5.613672,-1.019886 -5.613672,-2.379734c0,-1.69981 -6.549283,-7.139203 -14.969791,-12.918557c-17.464757,-11.898671 -18.088498,-12.578595 -30.251454,-24.137304c-9.044249,-8.499051 -9.35612,-9.518937 -9.35612,-39.435596c0,-23.117419 1.247483,-31.61647 4.67806,-34.336166c2.494965,-2.379734 6.549283,-10.198861 9.044249,-17.678026c2.494965,-7.479165 5.301801,-14.278406 6.237413,-15.298292c3.742448,-3.399621 9.667991,-16.998102 9.667991,-22.437495c0,-3.059659 2.806836,-9.518937 5.925543,-14.618368c3.430577,-5.099431 6.549283,-11.558709 7.173025,-13.938444c0.623741,-2.719696 2.806836,-7.139203 4.98993,-9.518937c1.871224,-2.379734 3.742448,-6.799241 3.742448,-9.518937c0,-2.719696 1.559353,-4.759469 3.118707,-4.759469c1.871224,0 3.118707,-2.039772 3.118707,-4.419507c0,-2.379734 2.806836,-7.819127 6.237413,-11.898671c3.430577,-4.079545 6.237413,-8.499051 6.237413,-9.858899c0,-4.759469 13.722309,-32.636356 19.335981,-39.775558c3.118707,-3.739583 6.237413,-9.518937 7.484896,-12.918557c0.935612,-3.399621 3.118707,-5.439393 4.67806,-4.419507c1.559353,1.359848 2.806836,-1.019886 2.806836,-4.759469c0,-4.079545 0.935612,-7.139203 2.494965,-7.139203c2.806836,0 9.979861,-16.65814 9.979861,-23.457381c0,-4.079545 0.623741,-4.419507 2.494965,-1.019886c1.871224,2.719696 4.054318,0.339962 6.861155,-7.819127c2.494965,-6.459279 5.925543,-11.898671 7.484896,-11.898671c1.871224,0 -0.623741,-2.379734 -5.613672,-5.099431c-4.67806,-2.719696 -11.227344,-5.099431 -14.03418,-5.099431c-4.36619,0 -4.36619,-0.679924 -0.31187,-3.399621c3.118707,-2.379734 3.430577,-3.399621 0.623741,-3.399621c-5.613672,0 -27.756489,-16.65814 -42.10254,-30.936546c-13.410438,-13.938444 -18.088498,-15.298292 -69.235287,-20.057761c-31.498937,-2.719696 -61.750391,-6.799241 -102.917319,-13.258519c-8.420508,-1.019886 -17.776628,-3.739583 -20.271593,-5.439393c-2.494965,-1.69981 -11.539215,-4.419507 -20.271593,-5.779355c-26.509006,-4.079545 -35.865127,-6.799241 -35.865127,-9.858899c0,-1.69981 -2.494965,-3.059659 -5.301801,-3.059659c-6.861155,0 -39.607574,-14.278406 -40.855057,-17.678026c-0.623741,-1.69981 -3.742448,-2.719696 -6.861155,-2.719696c-3.118707,0 -6.861155,-1.359848 -7.796766,-3.399621c-0.935612,-1.69981 -6.861155,-3.399621 -12.786697,-3.399621c-5.925543,0 -10.291732,-1.359848 -9.044249,-3.059659c1.559353,-2.719696 -7.796766,-8.159089 -41.166927,-24.477266c-5.613672,-2.379734 -10.291732,-5.779355 -10.291732,-7.139203c0,-1.69981 -2.494965,-2.719696 -5.925543,-2.719696c-3.118707,0 -9.979861,-4.419507 -15.281663,-10.198861c-5.613672,-5.439393 -11.227344,-10.198861 -13.098568,-10.198861c-1.559353,0 -6.237413,6.119317 -9.979861,13.598481c-4.054318,7.479165 -9.35612,13.598481 -11.851085,13.938444c-3.118707,0 -3.430577,0.679924 -0.935612,2.039772c2.806836,1.019886 2.183095,3.739583 -2.183095,8.839013c-3.430577,3.739583 -6.237413,9.858899 -6.237413,13.258519c0,3.739583 -1.247483,5.439393 -3.118707,4.419507c-1.559353,-1.019886 -3.118707,0.339962 -3.118707,3.059659c0,3.059659 -1.247483,5.439393 -3.118707,5.439393c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -2.806836,6.799241c-1.247483,0 -9.044249,8.839013 -16.841016,19.717799c-14.657921,20.057761 -24.014041,31.956432 -39.607574,50.994306c-5.301801,6.119317 -9.35612,12.578595 -9.35612,14.618368c0,2.039772 -1.247483,2.719696 -2.806836,1.69981c-1.559353,-1.019886 -5.925543,3.399621 -9.979861,9.858899c-4.054318,6.459279 -8.420508,11.898671 -9.667991,11.898671c-1.559353,0 -2.494965,2.719696 -2.494965,5.779355c0,3.059659 -0.935612,4.759469 -1.871224,3.399621c-2.183095,-2.039772 -8.420508,3.739583 -41.166927,37.735786c-13.410438,13.258519 -24.949653,24.477266 -26.197136,24.477266c-1.559353,0 -4.98993,2.719696 -8.108638,6.119317c-3.118707,3.059659 -11.227344,10.538823 -17.776628,15.978216c-6.549283,5.779355 -14.969791,12.918557 -18.400369,15.978216c-14.969791,13.258519 -25.885265,21.757571 -34.305773,26.517039c-4.98993,2.719696 -13.098568,9.178975 -17.776628,14.618368c-4.67806,5.099431 -10.915473,9.178975 -13.410438,9.178975c-2.806836,0 -4.98993,1.359848 -4.98993,2.719696c0,1.69981 -4.98993,4.759469 -10.915473,7.479165c-5.925543,2.719696 -10.915473,6.119317 -10.915473,7.479165c0,3.399621 -28.068359,18.017988 -31.810807,16.998102c-1.559353,-0.339962 -2.494965,1.69981 -2.494965,4.419507c0,2.719696 -2.806836,5.099431 -6.237413,5.099431c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.359848 -4.67806,3.059659c0,1.69981 -4.67806,4.759469 -9.979861,7.139203c-25.261524,10.198861 -56.136719,28.556811 -53.641754,31.61647c1.247483,1.359848 -0.623741,2.379734 -4.36619,2.379734c-3.742448,0 -11.227344,3.059659 -16.841016,6.799241c-5.613672,3.739583 -12.786697,6.799241 -15.593533,6.799241c-3.118707,0 -5.613672,1.359848 -5.613672,3.059659c0,1.69981 -3.118707,4.419507 -6.861155,5.439393c-13.098568,4.419507 -36.800738,16.998102 -36.800738,19.377837c0,1.69981 -2.806836,2.719696 -6.237413,2.719696c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -4.054318,3.399621 -9.044249,3.399621c-5.301801,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -9.044249,3.399621 -20.583464,3.399621c-25.261524,0 -37.42448,-7.819127 -40.543186,-25.497153c-0.935612,-6.459279 -3.430577,-11.898671 -4.98993,-11.898671c-1.871224,0 -2.494965,-10.878785 -1.559353,-26.177077c0.935612,-20.057761 4.054318,-35.01609 12.786697,-60.513243c6.549283,-18.697912 12.474826,-39.095634 13.410438,-44.874989c0.935612,-6.119317 2.494965,-11.218747 3.742448,-11.218747c0.935612,0 3.742448,-5.099431 5.925543,-10.878785c2.494965,-6.119317 6.861155,-16.998102 10.291732,-24.137304c3.118707,-7.479165 5.925543,-15.298292 5.925543,-17.678026c0,-5.099431 16.217274,-40.455482 19.024111,-41.815331c1.247483,-0.679924 4.054318,-7.819127 6.237413,-16.318178c2.183095,-8.159089 5.301801,-14.95833 6.549283,-14.95833c1.247483,0 2.494965,-3.059659 2.494965,-6.799241c0,-3.739583 0.935612,-6.799241 2.494965,-6.799241c2.494965,0 9.979861,-16.65814 9.979861,-22.777457c0,-2.379734 1.559353,-4.419507 3.118707,-4.419507c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-4.759469 8.108638,-21.417609 12.474826,-25.497153c1.871224,-1.69981 9.35612,-19.037874 19.024111,-43.175179c2.494965,-6.119317 5.301801,-11.218747 6.549283,-11.218747c1.559353,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 2.806836,-8.159089 6.237413,-11.898671c3.430577,-3.739583 6.237413,-9.178975 6.237413,-11.898671c0,-2.719696 4.98993,-13.258519 10.915473,-23.457381c5.925543,-10.198861 10.915473,-20.397723 10.915473,-22.437495c0,-1.69981 1.559353,-3.399621 3.118707,-3.399621c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-3.739583 3.118707,-8.499051c0,-4.759469 1.247483,-8.499051 2.806836,-8.499051c1.559353,0 9.667991,-14.618368 17.776628,-32.296394c8.420508,-17.678026 15.593533,-31.276508 16.529145,-30.256622c1.247483,1.359848 14.346051,-26.177077 13.410438,-28.216849c-0.31187,-0.679924 3.118707,-4.759469 7.173025,-9.858899c4.054318,-4.759469 8.420508,-11.898671 9.35612,-15.298292c1.247483,-3.739583 3.430577,-6.459279 4.98993,-6.459279c1.559353,0 2.806836,-2.039772 2.806836,-4.419507c0,-3.739583 17.152886,-31.61647 28.068359,-45.554913c1.559353,-2.379734 3.118707,-5.099431 3.118707,-6.119317c0,-1.359848 1.871224,-4.079545 4.054318,-6.459279c1.871224,-2.379734 7.173025,-9.178975 11.539215,-15.638254c4.36619,-6.119317 11.539215,-15.638254 16.529145,-20.737685c4.67806,-5.439393 8.420508,-10.538823 8.420508,-11.558709c0,-1.019886 2.806836,-5.099431 6.237413,-9.178975c3.430577,-4.079545 6.237413,-9.518937 6.237413,-12.238633c0,-6.459279 -6.237413,-18.35795 -13.098568,-24.817229c-3.118707,-3.059659 -5.613672,-6.459279 -5.613672,-7.819127c0,-1.019886 -2.806836,-5.099431 -6.237413,-8.839013c-3.430577,-3.739583 -6.237413,-9.178975 -6.237413,-11.898671c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-2.039772 -3.118707,-4.759469c0,-2.379734 -3.430577,-7.479165 -7.796766,-10.878785c-4.36619,-3.399621 -7.796766,-8.159089 -7.796766,-10.538823c0,-2.379734 -1.247483,-4.419507 -3.118707,-4.419507c-1.559353,0 -3.118707,-2.039772 -3.118707,-4.079545c0,-3.739583 -4.98993,-11.558709 -19.335981,-29.916659c-2.183095,-2.719696 -3.742448,-5.099431 -3.118707,-5.099431c2.494965,0 -5.925543,-18.697912 -8.420508,-18.697912c-1.559353,0 -3.742448,-3.739583 -4.67806,-8.159089c-0.935612,-4.759469 -3.742448,-10.538823 -5.925543,-12.918557c-5.925543,-7.139203 -11.539215,-19.037874 -11.539215,-24.817229c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-3.059659 -3.118707,-6.459279c0,-3.399621 -2.183095,-7.479165 -4.98993,-8.499051c-2.494965,-1.019886 -3.742448,-3.399621 -2.806836,-5.439393c0.935612,-1.69981 0.31187,-3.399621 -1.247483,-3.399621c-1.871224,0 -3.430577,-2.039772 -3.430577,-4.759469c0,-2.719696 -1.247483,-5.439393 -2.806836,-6.119317c-1.559353,-0.339962 -6.237413,-9.858899 -10.915473,-20.397723c-4.36619,-10.878785 -9.35612,-19.717799 -11.227344,-19.717799c-1.559353,0 -3.118707,-3.059659 -3.118707,-6.459279c0,-3.739583 -1.559353,-7.819127 -3.118707,-8.839013c-1.871224,-1.019886 -3.118707,-5.779355 -3.118707,-10.538823c0,-4.419507 -1.247483,-8.159089 -2.494965,-8.159089c-3.430577,0 -9.979861,-15.638254 -9.979861,-23.457381c0,-3.739583 -2.183095,-7.139203 -4.67806,-8.499051c-2.494965,-1.019886 -4.67806,-5.099431 -4.67806,-8.839013c0,-3.739583 -1.247483,-9.518937 -2.806836,-12.918557c-1.559353,-3.059659 -4.67806,-12.918557 -7.173025,-21.757571c-2.183095,-9.178975 -4.98993,-16.318178 -6.237413,-16.318178c-1.247483,0 -2.494965,-4.419507 -2.494965,-10.198861c0,-5.439393 -1.247483,-10.198861 -2.494965,-10.198861c-3.430577,0 -13.410438,-38.075748 -15.281663,-59.833319c-0.935612,-10.198861 -3.118707,-19.377837 -4.36619,-20.397723c-1.559353,-1.019886 -2.806836,-9.178975 -2.806836,-18.35795c0,-8.839013 -1.559353,-16.998102 -3.430577,-17.678026c-3.430577,-1.359848 -7.173025,-29.236735 -10.915473,-79.89108c-1.247483,-15.638254 -3.430577,-28.216849 -4.67806,-28.216849c-1.559353,0 -2.806836,-25.837115 -2.806836,-57.793547c0,-32.296394 1.247483,-57.793547 2.806836,-57.793547c1.559353,0 3.430577,-8.159089 4.36619,-17.678026c2.183095,-25.837115 7.173025,-48.27461 11.227344,-49.634458c1.871224,-0.679924 3.430577,-6.459279 3.430577,-12.578595c0,-6.459279 1.247483,-12.238633 2.806836,-13.258519c1.559353,-1.019886 3.430577,-6.799241 4.36619,-12.918557c0.935612,-6.119317 3.118707,-17.338064 5.301801,-24.817229c2.183095,-7.479165 4.36619,-18.697912 5.301801,-24.477266c0.935612,-6.119317 2.806836,-11.218747 4.36619,-11.218747c1.559353,0 2.806836,-6.799241 2.806836,-15.298292c0,-8.499051 1.559353,-15.298292 3.118707,-15.298292c1.871224,0 3.118707,-1.69981 3.118707,-3.739583c0,-12.578595 13.410438,-50.314382 21.519076,-59.833319c4.98993,-5.779355 9.35612,-10.198861 9.979861,-9.518937c0.623741,0.339962 4.36619,-5.779355 7.796766,-13.938444l6.861155,-14.95833l-41.166927,0c-43.973763,0 -65.180969,-2.379734 -62.374133,-7.139203c0.935612,-1.69981 -4.67806,-3.059659 -12.162956,-3.059659c-8.420508,0 -15.281663,-2.039772 -17.776628,-5.099431c-2.183095,-3.059659 -9.044249,-5.099431 -15.905404,-5.099431c-6.861155,0 -12.162956,-1.359848 -12.162956,-3.399621c0,-1.69981 -2.494965,-3.399621 -5.613672,-3.399621c-2.806836,0 -10.603603,-3.059659 -16.841016,-6.459279c-5.925543,-3.739583 -12.162956,-5.779355 -13.098568,-4.759469c-0.935612,1.359848 -1.871224,-0.339962 -1.871224,-3.399621c0,-4.079545 -2.494965,-5.779355 -8.108638,-5.779355c-7.484896,0 -17.152886,-6.459279 -33.682032,-22.437495c-3.118707,-3.059659 -9.35612,-6.799241 -14.03418,-7.819127l-8.108638,-2.379734l-0.623741,-44.195065c-0.623741,-39.095634 0,-42.835217 3.742448,-33.656242c2.183095,5.439393 3.742448,15.298292 3.118707,21.757571c-0.623741,8.839013 0.623741,11.898671 4.98993,12.918557c6.549283,2.039772 8.108638,7.819127 2.183095,7.819127c-2.806836,0 -2.806836,1.019886 0,4.079545c2.183095,2.379734 3.742448,6.799241 3.742448,9.858899c0,3.059659 4.054318,7.479165 9.044249,9.858899c4.98993,2.039772 9.979861,6.459279 10.915473,9.178975c1.247483,3.399621 4.36619,4.419507 9.044249,3.059659c3.742448,-1.019886 9.044249,-0.339962 11.539215,1.359848c4.054318,2.719696 3.742448,3.399621 -0.623741,3.399621c-3.118707,0 -5.613672,1.69981 -5.613672,3.399621c0,2.039772 4.98993,3.399621 10.915473,3.399621c7.484896,0 10.915473,1.69981 10.915473,5.099431c0,2.719696 2.806836,5.099431 5.925543,5.099431c3.430577,0 7.173025,1.69981 8.108638,3.399621c0.935612,2.039772 5.301801,3.399621 9.667991,3.399621c4.36619,0 8.420508,2.379734 9.35612,5.099431c1.559353,3.739583 7.484896,5.099431 24.325912,5.439393c12.162956,0.339962 19.024111,1.359848 14.969791,2.039772c-9.667991,2.039772 -5.613672,7.819127 5.613672,7.819127c4.67806,0 9.35612,2.039772 9.979861,4.419507c1.247483,3.059659 15.281663,4.419507 53.329883,5.099431c43.973763,1.019886 52.082401,2.039772 52.082401,6.459279c0,2.719696 1.871224,4.419507 4.054318,3.399621c1.871224,-0.679924 3.430577,-3.399621 3.118707,-5.439393c-0.623741,-2.039772 1.871224,-3.739583 4.98993,-3.739583c7.484896,0 11.227344,-5.439393 5.925543,-7.819127c-3.118707,-1.359848 -2.806836,-2.039772 0.31187,-2.039772c5.613672,-0.339962 16.217274,-13.938444 14.03418,-17.678026c-0.935612,-1.69981 0.935612,-3.059659 4.054318,-3.399621c4.98993,0 4.98993,-0.339962 -0.623741,-3.059659c-3.430577,-1.359848 -9.044249,-2.039772 -12.786697,-1.019886c-3.742448,0.679924 -8.732378,-1.019886 -11.539215,-3.739583c-2.494965,-3.059659 -6.549283,-5.439393 -8.420508,-5.439393c-1.871224,0 -4.054318,-2.379734 -4.98993,-5.099431c-1.247483,-2.719696 -3.742448,-5.099431 -5.925543,-5.099431c-6.861155,0 -23.390299,-10.538823 -21.830946,-13.938444c1.247483,-1.69981 -1.559353,-3.059659 -6.237413,-3.059659c-4.36619,0 -8.732378,-2.379734 -9.667991,-5.099431c-1.247483,-2.719696 -4.67806,-5.099431 -8.108638,-5.099431c-3.430577,0 -9.979861,-4.079545 -14.657921,-9.178975c-19.959722,-22.777457 -38.360092,-36.7159 -42.10254,-32.296394c-1.247483,1.019886 -1.247483,-0.339962 -0.31187,-3.399621c1.247483,-3.739583 -0.31187,-6.799241 -5.301801,-9.858899c-4.054318,-2.039772 -8.420508,-6.119317 -9.667991,-8.499051c-1.247483,-2.719696 -4.67806,-4.759469 -6.861155,-4.759469c-2.494965,0 -4.67806,-3.059659 -4.67806,-6.799241c0,-6.119317 -11.227344,-15.978216 -16.217274,-14.278406c-1.247483,0.339962 -3.742448,-4.759469 -5.613672,-11.558709c-2.183095,-6.459279 -4.36619,-11.218747 -5.301801,-10.198861c-1.871224,2.039772 -22.142817,-24.817229 -24.637782,-32.636356c-1.247483,-3.399621 -3.118707,-6.119317 -4.67806,-6.119317c-1.559353,0 -2.806836,-2.379734 -2.806836,-5.099431c0,-2.719696 -1.247483,-5.099431 -3.118707,-5.099431c-1.559353,0 -3.118707,-2.719696 -3.118707,-6.459279c0,-3.399621 -2.183095,-8.159089 -4.67806,-10.538823c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.719696 -1.559353,-3.739583 -3.742448,-2.379734c-2.183095,1.69981 -2.806836,0.679924 -1.559353,-3.059659c1.247483,-3.399621 -0.935612,-8.499051 -5.613672,-13.258519c-4.36619,-4.419507 -7.796766,-11.898671 -7.796766,-16.65814c0,-7.819127 -1.247483,-8.839013 -7.796766,-7.139203c-4.36619,0.679924 -7.796766,3.739583 -7.796766,6.119317c0,2.719696 -1.247483,4.759469 -3.118707,4.759469c-1.559353,0 -3.118707,3.059659 -3.118707,7.139203c0,5.099431 -1.559353,6.459279 -4.67806,5.099431c-3.742448,-1.359848 -4.67806,1.019886 -4.67806,12.578595c0,7.819127 -1.559353,16.65814 -3.118707,19.377837c-4.98993,8.499051 -4.054318,-78.871193 0.935612,-89.749978c2.494965,-4.759469 5.301801,-7.819127 6.237413,-6.459279c1.247483,1.019886 2.183095,-2.719696 2.183095,-8.839013c0,-6.119317 -1.247483,-10.198861 -2.806836,-9.178975c-6.237413,4.419507 -7.484896,-27.876887 -8.732378,-192.418514l-0.935612,-172.700716l12.474826,0c10.915473,0 12.474826,1.019886 12.474826,7.819127c-0.31187,4.079545 -2.183095,11.218747 -4.67806,15.978216c-2.494965,4.759469 -4.67806,14.618368 -4.67806,22.097533c0,19.037874 -3.118707,30.596584 -6.549283,25.157191c-1.247483,-2.719696 -2.494965,20.737685 -2.183095,51.334268c0,30.936546 -0.623741,58.133509 -1.247483,60.853205c-0.31187,2.379734 0.935612,5.439393 3.118707,6.119317c1.871224,1.019886 3.742448,-0.679924 3.742448,-3.739583c0,-3.059659 3.430577,-6.119317 7.484896,-7.479165c4.36619,-1.019886 8.420508,-4.079545 9.35612,-7.139203c0.935612,-2.719696 3.118707,-3.739583 4.98993,-2.719696c1.871224,1.019886 3.118707,-1.359848 3.118707,-5.779355c0,-4.419507 3.742448,-11.558709 7.796766,-15.978216c4.36619,-4.419507 8.732378,-11.558709 9.667991,-15.978216c0.935612,-4.419507 3.742448,-8.159089 6.237413,-8.159089c2.494965,0 4.36619,-2.719696 4.36619,-5.779355c0,-3.059659 2.494965,-8.499051 5.301801,-11.898671c4.67806,-5.779355 4.67806,-7.139203 0.935612,-10.198861c-4.054318,-2.719696 -3.742448,-3.059659 0.623741,-1.69981c4.67806,1.69981 10.603603,-5.779355 9.35612,-11.898671c-0.31187,-1.69981 0.935612,-2.719696 2.806836,-2.719696c1.871224,0 2.806836,-2.379734 1.559353,-5.099431c-0.935612,-2.719696 -0.31187,-5.099431 1.247483,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-2.719696 2.806836,-6.459279 6.237413,-8.499051c3.430577,-2.039772 5.925543,-4.759469 5.613672,-6.119317c-0.623741,-1.359848 3.118707,-6.799241 7.796766,-12.238633c9.044249,-10.538823 10.915473,-21.077647 4.67806,-23.117419c-2.183095,-1.019886 9.35612,-1.69981 25.573394,-1.69981c16.217274,-0.339962 27.132747,0.339962 24.014041,1.359848c-2.806836,0.679924 -5.301801,3.059659 -5.301801,4.759469c0,1.69981 -2.183095,3.059659 -4.98993,3.059659c-2.494965,0 -3.742448,1.69981 -2.494965,3.739583c0.935612,2.039772 0.935612,4.759469 -0.623741,6.119317c-1.559353,1.019886 -9.35612,11.218747 -17.152886,22.437495c-15.281663,21.757571 -24.637782,40.455482 -24.637782,48.614572c0,3.059659 -0.935612,4.079545 -1.871224,3.059659c-2.494965,-2.379734 -13.722309,12.238633 -13.722309,17.678026c0,2.039772 -1.559353,3.739583 -3.118707,3.739583c-1.871224,0 -3.118707,2.039772 -2.806836,4.419507c0.935612,7.479165 -0.31187,13.598481 -2.183095,11.558709c-2.494965,-2.719696 -16.841016,20.057761 -16.841016,26.517039c0,2.719696 -1.871224,5.099431 -3.742448,5.099431c-2.806836,0 -2.494965,1.359848 0.623741,3.399621c4.054318,2.719696 3.742448,3.399621 -1.247483,3.399621c-4.054318,0 -4.98993,1.69981 -3.742448,5.779355c1.247483,3.399621 1.247483,4.759469 0,3.739583c-0.935612,-1.359848 -5.613672,1.359848 -9.979861,5.779355c-7.173025,7.139203 -7.484896,8.839013 -3.430577,13.938444c3.742448,5.439393 3.742448,5.779355 -0.935612,3.739583c-5.925543,-2.379734 -15.905404,6.119317 -19.335981,16.318178c-1.559353,4.759469 -2.806836,5.439393 -4.67806,2.379734c-1.871224,-3.399621 -3.742448,-1.359848 -6.549283,5.779355c-2.183095,5.779355 -4.67806,10.538823 -5.925543,10.538823c-1.247483,0 -1.871224,6.459279 -1.871224,14.278406c0,12.238633 1.247483,14.95833 6.549283,15.638254c3.430577,0.679924 9.979861,-2.719696 14.969791,-7.819127c4.67806,-4.759469 9.044249,-8.499051 9.979861,-8.499051c0.935612,0 9.044249,-6.119317 18.400369,-13.598481c9.35612,-7.479165 18.088498,-13.598481 19.647851,-13.598481c1.559353,0 5.925543,-3.739583 9.979861,-8.159089c3.742448,-4.759469 10.603603,-9.518937 15.281663,-10.538823c4.67806,-1.019886 12.474826,-5.779355 17.152886,-10.198861c4.98993,-4.759469 11.539215,-8.499051 14.657921,-8.499051c4.054318,0 4.98993,-1.69981 3.742448,-5.779355c-1.559353,-4.079545 -0.623741,-5.099431 2.806836,-3.739583c2.806836,1.359848 8.732378,0 13.722309,-3.059659c4.98993,-2.719696 12.162956,-5.779355 16.217274,-6.459279c3.742448,-1.019886 9.667991,-4.419507 12.786697,-7.819127c3.430577,-3.739583 10.603603,-7.479165 16.217274,-8.839013c11.539215,-2.379734 31.187066,-11.898671 34.305773,-16.318178c0.935612,-1.359848 7.173025,-3.399621 14.03418,-4.419507c6.549283,-1.019886 12.786697,-2.719696 13.722309,-4.419507c0.935612,-1.69981 8.108638,-3.739583 16.217274,-5.099431c9.044249,-1.359848 15.281663,-4.419507 16.529145,-8.159089c1.559353,-4.419507 2.494965,-4.759469 4.36619,-1.019886c1.871224,3.059659 3.430577,3.399621 4.67806,0.679924c1.247483,-2.039772 4.98993,-3.739583 8.420508,-3.739583c3.118707,0 5.925543,-1.359848 5.925543,-3.399621c0,-1.69981 7.173025,-3.399621 15.593533,-3.399621c8.732378,0 15.593533,-1.359848 15.593533,-3.399621c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-1.559353,0 -2.183095,-4.419507 -0.935612,-10.198861c1.247483,-7.819127 0.623741,-10.198861 -2.806836,-10.198861c-3.118707,0 -5.301801,-4.419507 -6.549283,-11.218747c-0.935612,-6.119317 -5.925543,-21.077647 -11.227344,-33.31628c-5.301801,-12.238633 -9.667991,-24.137304 -9.667991,-26.177077c0,-3.059659 75.4727,-4.079545 299.707707,-4.079545l299.707707,0l-1.559353,46.914762c-2.806836,71.73199 -4.98993,91.109827 -13.410438,115.927055c-4.054318,12.238633 -10.603603,31.61647 -14.03418,42.495255c-3.430577,11.218747 -10.603603,30.256622 -15.593533,42.155293c-4.98993,12.238633 -9.044249,23.797342 -9.044249,25.837115c-0.31187,2.039772 -2.806836,9.858899 -6.237413,17.338064c-3.430577,7.479165 -5.925543,14.618368 -6.237413,16.318178c0,1.359848 -4.98993,10.198861 -10.915473,19.377837c-5.925543,9.178975 -10.915473,18.017988 -10.915473,19.377837c0,3.059659 -14.03418,18.017988 -16.529145,18.017988c-0.935612,0 -6.237413,4.419507 -11.539215,9.518937c-11.851085,11.898671 -35.553255,26.177077 -48.963694,29.236735c-5.301801,1.359848 -14.657921,7.819127 -20.583464,13.938444c-10.915473,11.558709 -11.227344,11.898671 -7.173025,26.177077c4.67806,18.697912 13.722309,23.797342 34.617644,21.077647c8.732378,-1.019886 18.71224,-4.079545 22.454688,-6.799241c3.742448,-2.719696 9.044249,-4.759469 11.539215,-4.759469c3.742448,0 15.281663,-8.499051 48.339953,-35.356052c2.494965,-2.039772 12.162956,-12.238633 21.207205,-22.437495c22.142817,-24.477266 36.176997,-50.994306 53.018013,-100.288801c2.494965,-7.479165 7.173025,-19.717799 10.291732,-27.196963c9.35612,-21.757571 18.71224,-48.614572 18.71224,-52.354154c0,-2.039772 2.494965,-10.198861 5.925543,-18.35795c11.539215,-28.556811 15.905404,-45.214951 16.217274,-65.272712c0.31187,-11.218747 2.494965,-23.797342 4.98993,-27.876887c2.183095,-4.079545 4.054318,-13.258519 4.054318,-19.717799c0,-6.799241 1.559353,-15.298292 3.118707,-19.037874c2.183095,-4.419507 2.183095,-6.459279 0,-6.459279c-1.871224,0 -3.118707,-10.538823 -3.118707,-26.857001c0,-18.35795 -1.247483,-27.536925 -3.742448,-28.556811c-2.183095,-1.019886 175.583183,-2.039772 395.452,-2.039772l399.506318,-0.339962l2.183095,26.177077c0.935612,14.278406 1.871224,49.294496 1.871224,77.851307c0,28.556811 1.247483,55.753774 3.118707,60.513243c1.559353,5.099431 4.054318,21.077647 4.98993,36.375938c1.247483,15.638254 4.67806,32.636356 8.108638,39.775558c3.118707,6.799241 5.613672,15.298292 5.613672,19.377837c0,3.739583 5.613672,19.037874 12.474826,33.996204c6.861155,14.95833 12.474826,29.236735 12.474826,31.61647c0,2.039772 1.247483,4.079545 2.806836,4.079545c1.559353,0 3.742448,4.079545 4.67806,8.839013c3.742448,15.978216 18.088498,36.7159 49.587435,71.73199c35.553255,39.775558 44.909375,44.535027 61.12665,31.61647c10.915473,-8.159089 14.657921,-19.377837 11.227344,-32.976318c-0.935612,-5.099431 -14.969791,-23.457381 -31.810807,-41.475369c-19.647851,-21.417609 -32.434549,-38.41571 -38.04822,-50.994306c-4.67806,-10.538823 -9.979861,-22.097533 -11.851085,-25.837115c-13.410438,-26.177077 -28.068359,-76.151497 -30.563325,-104.028384c-1.247483,-11.898671 -3.118707,-25.497153 -4.67806,-30.256622c-1.559353,-4.759469 -3.118707,-41.815331 -3.742448,-82.610776l-0.935612,-73.771763l159.98965,0c155.935331,0 159.677779,0 159.677779,6.459279c0,3.739583 -1.247483,7.819127 -3.118707,8.839013c-1.559353,1.019886 -3.118707,6.459279 -3.118707,11.898671c0,5.439393 -1.247483,10.878785 -3.118707,11.898671c-1.559353,1.019886 -3.118707,6.459279 -3.118707,12.238633c0,5.439393 -0.935612,9.858899 -2.183095,9.858899c-3.430577,0 -10.291732,16.998102 -10.291732,25.837115c0,4.079545 -2.183095,9.178975 -4.67806,11.558709c-2.494965,2.379734 -4.67806,7.479165 -4.67806,11.558709c0,8.839013 -12.786697,42.835217 -16.217274,42.835217c-1.247483,0 -2.494965,2.379734 -2.494965,5.099431c0,8.159089 -7.484896,32.296394 -9.979861,32.296394c-1.559353,0 -2.494965,4.079545 -2.494965,8.839013c0,4.759469 -1.247483,7.819127 -3.118707,6.459279c-1.559353,-1.019886 -3.118707,1.019886 -3.118707,4.759469c0,4.079545 -1.247483,7.139203 -3.118707,7.139203c-1.559353,0 -3.118707,2.719696 -3.118707,6.119317c0,3.399621 -1.871224,8.839013 -4.36619,12.578595c-2.183095,3.739583 -5.925543,12.578595 -7.796766,19.717799c-2.183095,6.799241 -4.98993,11.898671 -6.237413,10.878785c-1.559353,-0.679924 -4.36619,4.759469 -6.549283,11.898671c-2.183095,7.479165 -5.925543,15.298292 -8.420508,17.338064c-2.183095,2.039772 -4.054318,5.779355 -4.054318,8.159089c0,2.379734 -2.183095,6.119317 -4.67806,8.499051c-2.494965,2.379734 -4.67806,6.799241 -4.67806,10.198861c0,3.399621 -1.871224,6.799241 -4.36619,7.819127c-2.494965,1.019886 -5.925543,7.479165 -8.108638,13.938444c-1.871224,6.799241 -4.98993,11.558709 -6.549283,10.538823c-1.559353,-1.359848 -2.806836,1.69981 -2.806836,6.119317c0,4.759469 -1.871224,9.178975 -4.36619,10.198861c-4.054318,1.69981 -7.173025,6.799241 -18.088498,29.576697c-2.183095,4.419507 -8.108638,13.258519 -13.410438,19.377837c-15.593533,18.35795 -17.152886,20.737685 -17.152886,28.216849c0,4.759469 2.183095,6.799241 6.549283,6.799241c3.430577,0 5.301801,1.69981 4.36619,3.399621c-0.935612,2.039772 1.559353,3.399621 5.925543,3.399621c5.925543,0 7.484896,1.359848 5.925543,5.099431c-0.935612,3.059659 -0.623741,5.099431 0.935612,4.419507c5.613672,-1.359848 16.841016,4.759469 16.841016,9.518937c0,2.719696 1.871224,4.759469 4.054318,4.759469c2.183095,0 8.108638,4.759469 13.098568,10.198861c4.98993,5.779355 10.915473,10.198861 13.098568,10.198861c2.183095,0 4.054318,1.69981 4.054318,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,2.039772 4.67806,4.419507c0,2.719696 3.430577,6.799241 7.796766,9.178975c4.36619,2.379734 7.796766,5.779355 7.796766,7.479165c0,1.359848 2.183095,2.719696 4.67806,2.719696c2.494965,0 4.67806,1.69981 4.67806,3.739583c0,1.69981 4.36619,5.099431 9.667991,7.139203c7.173025,2.719696 8.420508,4.419507 5.301801,6.459279c-3.118707,2.379734 -2.806836,3.059659 0.935612,3.059659c2.806836,0 8.420508,3.739583 12.474826,8.499051c4.054318,4.419507 9.044249,8.499051 10.915473,8.499051c4.36619,0 44.909375,42.495255 44.909375,47.254724c0,2.039772 1.871224,3.739583 4.054318,3.739583c1.871224,0 8.732378,7.819127 14.657921,17.338064c5.925543,9.518937 13.722309,20.737685 17.152886,25.157191c13.722309,17.338064 17.152886,22.097533 17.152886,23.797342c0,1.69981 8.420508,13.258519 16.529145,22.777457c2.806836,3.399621 5.301801,7.479165 5.301801,9.178975c0,2.039772 2.806836,8.839013 6.549283,15.298292c3.742448,6.799241 5.301801,12.238633 3.742448,12.238633c-1.247483,0 0,1.69981 3.118707,3.739583c2.806836,1.69981 5.301801,6.459279 5.301801,9.858899c0,3.739583 1.559353,6.799241 3.118707,6.799241c1.871224,0 3.118707,3.059659 3.118707,7.139203c0,3.739583 1.247483,6.119317 2.806836,5.099431c3.118707,-2.039772 9.667991,12.578595 9.667991,21.757571c0,3.739583 1.247483,6.799241 3.118707,6.799241c1.559353,0 4.054318,4.079545 4.98993,9.178975c1.247483,5.439393 3.118707,11.218747 4.054318,12.918557c1.247483,2.039772 5.301801,12.578595 9.35612,23.797342c3.742448,11.218747 8.420508,23.117419 9.979861,26.177077c1.559353,3.399621 2.806836,10.878785 2.806836,16.318178c0,5.779355 1.247483,9.858899 2.494965,8.839013c2.806836,-2.039772 9.979861,27.196963 9.979861,40.455482c0,4.419507 1.559353,9.178975 3.118707,10.198861c1.871224,1.019886 3.118707,11.898671 3.118707,24.137304c0,11.898671 1.247483,21.757571 2.494965,21.757571c1.559353,0 5.301801,16.318178 8.420508,36.7159c3.118707,20.057761 6.861155,37.735786 8.108638,39.775558c3.430577,3.739583 3.742448,142.444095 0.623741,145.843715c-3.430577,3.739583 -9.979861,38.755672 -9.979861,54.733888c-0.31187,7.479165 -1.247483,17.338064 -2.494965,21.757571c-1.871224,7.819127 -2.183095,7.819127 -4.36619,1.69981c-1.247483,-3.739583 -2.494965,6.459279 -2.494965,24.477266c-0.31187,16.998102 -1.559353,35.356052 -3.118707,40.795444c-1.559353,5.439393 -4.67806,25.497153 -6.861155,44.874989c-2.183095,20.737685 -4.98993,33.31628 -6.549283,30.596584c-1.247483,-2.719696 -2.494965,2.039772 -2.494965,11.558709c0,8.839013 -1.247483,16.998102 -3.118707,18.017988c-1.559353,1.019886 -3.118707,7.139203 -3.118707,13.258519c0,6.459279 -2.183095,15.978216 -4.67806,21.077647c-2.494965,5.439393 -5.613672,15.298292 -6.549283,21.757571c-1.247483,6.459279 -5.301801,16.65814 -9.044249,22.097533c-4.054318,5.779355 -8.732378,19.037874 -10.915473,29.916659c-1.871224,10.538823 -4.67806,19.377837 -5.925543,19.377837c-0.935612,0 -4.054318,7.139203 -6.237413,16.318178c-2.494965,8.839013 -5.925543,16.998102 -7.484896,18.35795c-1.871224,1.019886 -3.742448,5.099431 -4.054318,8.499051c-0.623741,3.739583 -3.118707,11.218747 -5.925543,16.65814c-2.494965,5.439393 -4.67806,12.578595 -4.67806,15.638254c0,3.059659 -1.559353,6.799241 -3.118707,7.819127c-1.871224,1.359848 -5.613672,8.159089 -8.420508,15.638254c-2.494965,7.139203 -5.925543,13.258519 -7.484896,13.258519c-1.559353,0 -2.806836,2.379734 -2.806836,5.099431c0,6.119317 -10.603603,27.196963 -18.71224,36.375938c-3.430577,4.079545 -5.301801,8.499051 -4.36619,9.858899c0.623741,1.359848 -1.247483,4.759469 -4.36619,7.139203c-3.430577,2.379734 -5.925543,5.439393 -5.613672,6.799241c0,1.019886 -4.36619,7.819127 -9.667991,14.618368c-5.613672,6.799241 -10.291732,13.258519 -10.291732,13.938444c0,1.019886 -3.118707,5.439393 -6.861155,10.198861c-4.054318,4.759469 -9.979861,11.898671 -13.410438,16.318178c-3.430577,4.079545 -9.667991,13.258519 -14.03418,20.057761c-4.36619,6.799241 -8.732378,12.578595 -9.979861,12.578595c-1.559353,0 -2.494965,2.379734 -2.494965,5.439393c0,2.719696 -1.247483,4.079545 -3.118707,3.059659c-1.559353,-1.019886 -3.118707,-0.339962 -3.118707,1.359848c0,2.039772 1.559353,3.739583 3.118707,3.739583c1.871224,0 3.118707,2.039772 3.118707,4.759469c0,2.719696 0.935612,5.439393 2.494965,6.119317c1.247483,0.679924 5.925543,7.139203 10.915473,14.95833c4.67806,7.479165 11.227344,16.998102 14.657921,21.077647c3.430577,4.079545 6.237413,8.839013 6.237413,10.878785c0,1.69981 1.247483,3.399621 2.494965,3.399621c1.559353,0 4.67806,4.079545 7.173025,9.518937c2.494965,5.099431 6.861155,11.898671 10.291732,15.298292c3.118707,3.059659 4.98993,5.779355 3.742448,5.779355c-1.247483,0 0,2.379734 2.494965,5.439393c2.806836,2.719696 4.98993,7.139203 4.98993,9.178975c0,2.379734 3.430577,8.499051 7.796766,13.598481c4.36619,5.099431 7.484896,9.178975 6.549283,9.178975c-0.935612,0 1.871224,5.439393 5.925543,12.238633c4.36619,6.799241 7.796766,14.95833 7.796766,18.017988c0,4.759469 0.623741,4.759469 3.118707,0.339962c2.183095,-3.739583 3.118707,-2.379734 3.118707,6.459279c0,6.459279 0.935612,10.538823 2.183095,9.518937c0.935612,-1.359848 4.36619,3.739583 7.484896,11.218747c3.118707,7.479165 7.173025,13.598481 9.044249,13.598481c1.559353,0 3.118707,3.059659 3.118707,6.799241c0,3.739583 1.247483,6.799241 2.806836,6.799241c1.559353,0 3.430577,4.419507 4.36619,9.858899c0.935612,5.439393 3.742448,11.898671 5.925543,14.278406c2.183095,2.719696 5.925543,8.839013 8.420508,14.278406c2.494965,5.099431 5.613672,9.178975 7.173025,9.178975c1.247483,0 2.494965,3.059659 2.494965,7.139203c0,3.739583 2.183095,9.178975 4.67806,12.238633c2.494965,2.719696 4.054318,6.459279 3.118707,8.159089c-1.247483,1.69981 0.31187,3.059659 2.806836,3.059659c2.806836,0 4.98993,3.059659 4.98993,6.799241c0,3.739583 1.559353,6.799241 3.118707,6.799241c1.871224,0 3.118707,2.719696 3.118707,6.119317c0,3.399621 2.806836,9.518937 6.237413,13.598481c3.430577,4.079545 6.237413,9.178975 6.237413,11.218747c0,2.379734 3.430577,9.178975 7.796766,15.298292c4.36619,6.119317 7.796766,12.918557 7.796766,14.95833c0,3.739583 5.301801,16.318178 12.786697,30.596584c1.559353,2.719696 5.301801,10.538823 8.420508,16.998102c2.806836,6.459279 6.237413,12.578595 7.796766,12.918557c1.247483,0.679924 2.183095,3.399621 2.183095,6.119317c0,2.719696 1.247483,7.479165 2.806836,10.878785c1.559353,3.059659 4.67806,10.538823 6.861155,16.65814c2.183095,5.779355 5.301801,9.858899 6.549283,9.178975c1.247483,-1.019886 2.494965,2.039772 2.494965,6.799241c0,4.759469 1.559353,9.518937 3.118707,10.538823c1.871224,1.019886 3.118707,4.759469 3.118707,8.499051c0,3.399621 2.183095,6.799241 4.67806,8.159089c2.494965,1.019886 4.67806,4.079545 4.67806,6.799241c0,8.159089 6.861155,22.437495 9.667991,20.397723c1.559353,-1.019886 2.806836,2.039772 2.806836,7.139203c0,4.759469 1.247483,11.558709 3.118707,15.298292c1.871224,3.739583 4.67806,9.858899 6.237413,13.598481c1.871224,3.739583 3.118707,9.178975 3.118707,11.898671c0,2.719696 1.247483,5.099431 2.494965,5.099431c1.247483,0 4.36619,7.139203 6.549283,16.318178c2.494965,8.839013 5.613672,17.678026 7.173025,20.057761c1.559353,2.039772 5.613672,16.65814 9.044249,32.296394c9.979861,43.175179 4.67806,101.308688 -9.044249,101.308688c-2.494965,0 -3.742448,2.039772 -2.494965,5.099431c1.247483,4.419507 -2.494965,5.099431 -23.078429,5.099431c-13.410438,0 -25.261524,-1.359848 -26.197136,-3.059659c-0.935612,-1.359848 -12.162956,-6.799241 -25.261524,-12.238633c-12.786697,-5.099431 -24.325912,-10.538823 -25.261524,-12.238633c-0.935612,-1.69981 -4.36619,-3.059659 -7.796766,-3.059659c-3.118707,0 -5.925543,-1.359848 -5.925543,-3.399621c0,-1.69981 -3.430577,-3.399621 -7.796766,-3.399621c-4.36619,0 -7.796766,-1.019886 -7.796766,-2.719696c0,-1.359848 -4.67806,-4.419507 -9.979861,-6.799241c-5.613672,-2.379734 -12.786697,-6.119317 -15.593533,-7.819127c-3.118707,-1.69981 -8.732378,-3.059659 -12.474826,-3.059659c-3.742448,0 -5.613672,-1.019886 -4.67806,-2.379734c2.494965,-2.379734 -11.851085,-11.218747 -18.400369,-11.218747c-2.494965,0 -4.36619,-2.379734 -4.36619,-5.099431c0,-2.719696 -2.806836,-5.099431 -5.925543,-5.099431c-3.430577,0 -7.173025,-1.359848 -8.108638,-3.399621c-0.935612,-1.69981 -6.549283,-3.399621 -11.851085,-3.739583c-8.420508,0 -9.044249,-0.679924 -3.742448,-3.059659c5.301801,-2.379734 5.301801,-3.059659 0.935612,-3.059659c-3.118707,-0.339962 -12.162956,-4.419507 -20.271593,-9.518937c-8.108638,-4.759469 -19.959722,-11.898671 -25.885265,-15.638254c-5.925543,-3.739583 -11.539215,-7.479165 -12.474826,-8.839013c-3.118707,-4.079545 -15.593533,-10.538823 -20.271593,-10.538823c-2.806836,0 -4.054318,-1.359848 -3.118707,-3.399621c0.935612,-1.69981 -0.31187,-3.399621 -2.806836,-3.399621c-4.36619,0 -11.539215,-5.099431 -22.142817,-15.978216c-2.183095,-2.039772 -9.979861,-7.139203 -17.776628,-11.218747c-7.796766,-3.739583 -19.335981,-12.238633 -25.885265,-18.697912c-6.549283,-6.459279 -12.786697,-11.898671 -14.03418,-11.898671c-1.247483,0 -6.549283,-4.419507 -11.851085,-9.858899c-5.301801,-5.779355 -14.969791,-13.938444 -21.519076,-18.35795c-6.549283,-4.759469 -15.281663,-11.898671 -19.647851,-16.318178c-4.054318,-4.419507 -8.732378,-7.819127 -9.979861,-7.139203c-1.559353,0.339962 -2.494965,-0.679924 -2.494965,-2.719696c0,-1.69981 -3.742448,-5.439393 -8.420508,-8.159089c-4.98993,-2.719696 -7.484896,-5.099431 -6.237413,-5.439393c3.742448,0 -23.390299,-27.196963 -27.444619,-27.196963c-1.559353,0 -4.98993,-4.759469 -7.173025,-10.198861c-2.494965,-5.779355 -5.301801,-9.518937 -6.861155,-8.499051c-2.806836,2.039772 -15.593533,-15.978216 -15.593533,-21.757571c0,-2.039772 -1.871224,-3.739583 -4.36619,-3.739583c-2.494965,0 -6.549283,-3.059659 -9.044249,-6.799241c-2.494965,-3.739583 -5.301801,-5.779355 -6.237413,-4.419507c-1.247483,1.019886 -2.183095,0.339962 -2.183095,-2.039772c0,-2.039772 -3.118707,-7.479165 -6.861155,-11.898671c-4.054318,-4.419507 -11.227344,-13.598481 -16.529145,-20.737685c-4.98993,-6.799241 -13.410438,-17.678026 -18.71224,-23.457381c-4.98993,-6.119317 -9.667991,-12.918557 -10.291732,-15.298292c-0.31187,-2.379734 -2.806836,-6.799241 -5.301801,-9.518937c-2.806836,-2.719696 -4.054318,-6.119317 -3.118707,-7.819127c0.935612,-1.69981 -1.247483,-3.739583 -4.67806,-5.099431c-5.613672,-2.039772 -7.484896,-5.779355 -6.549283,-12.578595c0,-1.69981 -1.559353,-2.719696 -3.430577,-2.719696c-2.183095,0 -7.484896,-8.159089 -11.851085,-18.017988c-10.915473,-25.157191 -11.539215,-25.837115 -26.197136,-20.057761c-7.173025,2.379734 -14.03418,6.119317 -15.905404,7.819127c-1.559353,1.69981 -7.796766,3.059659 -13.722309,3.059659c-10.603603,0 -27.756489,4.759469 -38.360092,10.538823c-3.118707,1.69981 -8.420508,3.059659 -11.539215,3.059659c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -4.36619,3.399621 -9.35612,3.399621c-5.301801,0 -11.851085,1.359848 -14.969791,3.399621c-2.806836,1.69981 -16.217274,5.779355 -29.315842,8.839013c-13.410438,3.059659 -23.702171,6.799241 -22.766559,8.159089c0.935612,1.359848 -11.539215,3.399621 -27.444619,4.419507c-15.593533,1.359848 -42.10254,3.739583 -58.319814,5.439393c-16.217274,2.039772 -43.973763,4.759469 -61.438521,5.779355c-17.776628,1.359848 -32.122678,3.059659 -32.122678,4.079545c0,2.379734 19.335981,21.077647 22.142817,21.077647c1.247483,0 6.237413,3.739583 10.603603,8.159089c10.603603,10.538823 13.098568,28.556811 6.549283,43.175179c-2.806836,5.779355 -4.98993,12.918557 -4.98993,15.638254c0,2.379734 -2.183095,5.439393 -4.67806,6.459279c-2.494965,1.359848 -4.67806,5.779355 -4.67806,10.198861c0,4.419507 -1.247483,8.159089 -3.118707,8.159089c-1.559353,0 -3.118707,3.739583 -3.118707,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,2.379734 -3.118707,5.099431c0,2.719696 -1.247483,5.099431 -3.118707,5.099431c-1.559353,0 -3.118707,1.69981 -3.118707,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.806836,0 5.613672,2.379734 6.549283,5.099431c1.247483,2.719696 3.742448,5.099431 6.237413,5.099431c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,2.039772 3.430577,3.399621 7.796766,3.399621c4.36619,0 7.796766,1.359848 7.796766,2.719696c0,1.69981 4.98993,4.759469 10.915473,7.479165c5.925543,2.719696 10.915473,5.779355 10.915473,7.479165c0,1.359848 2.806836,2.719696 6.549283,2.719696c3.430577,0 5.613672,1.359848 4.36619,3.399621c-0.935612,1.69981 4.054318,4.759469 10.915473,6.799241c6.861155,2.039772 12.474826,5.099431 12.474826,6.799241c0,2.039772 2.806836,3.399621 6.237413,3.399621c3.118707,0 7.173025,2.039772 8.420508,4.419507c2.494965,4.079545 25.885265,17.678026 29.627713,16.65814c0.935612,-0.339962 3.742448,1.69981 5.613672,4.419507c2.183095,2.719696 7.173025,5.099431 11.539215,5.099431c4.054318,0 6.861155,1.359848 5.925543,3.059659c-1.247483,1.69981 4.054318,5.439393 11.227344,7.819127c7.173025,2.719696 15.593533,8.499051 18.71224,13.258519c6.861155,9.858899 8.420508,38.075748 3.118707,62.553015c-1.871224,9.518937 -4.36619,21.757571 -5.301801,27.196963c-1.247483,5.779355 -4.67806,16.318178 -7.796766,23.797342c-3.430577,7.479165 -6.861155,18.017988 -7.796766,23.117419c-0.935612,5.099431 -3.118707,8.499051 -4.67806,7.479165c-1.871224,-1.019886 -3.118707,1.69981 -3.118707,6.459279c0,4.759469 -1.247483,9.518937 -3.118707,10.538823c-1.559353,1.019886 -3.118707,5.099431 -3.118707,8.839013c0,3.739583 -1.247483,5.779355 -3.118707,4.759469c-1.559353,-1.019886 -3.118707,0.339962 -3.118707,3.059659c0,6.459279 -12.474826,36.035977 -17.776628,42.155293c-1.871224,2.039772 -4.67806,7.139203 -5.613672,10.878785c-1.871224,6.119317 -4.67806,6.799241 -33.05829,6.799241c-28.692101,0 -30.875196,-0.339962 -30.875196,-6.799241c0,-3.739583 0.935612,-6.799241 2.494965,-6.799241c1.247483,0 5.613672,-8.159089 9.979861,-18.017988c4.36619,-9.518937 9.667991,-19.037874 11.851085,-20.397723c1.871224,-1.359848 3.742448,-4.759469 3.742448,-7.139203c0,-6.119317 7.484896,-22.437495 10.291732,-22.437495c1.247483,0 2.183095,-2.379734 2.183095,-5.099431c0,-2.719696 1.247483,-5.099431 2.494965,-5.099431c1.559353,0 4.67806,-6.459279 6.861155,-14.278406c2.183095,-8.159089 4.98993,-17.678026 6.237413,-21.417609c1.559353,-3.739583 4.36619,-12.918557 6.237413,-20.397723c2.183095,-7.479165 5.613672,-18.017988 8.108638,-23.117419c10.291732,-22.437495 4.67806,-33.31628 -22.142817,-43.515141c-6.861155,-2.719696 -15.281663,-7.479165 -18.400369,-10.538823c-3.430577,-3.399621 -8.732378,-6.119317 -11.851085,-6.119317c-3.118707,0 -5.613672,-1.359848 -5.613672,-3.059659c0,-1.69981 -9.044249,-7.139203 -20.271593,-12.238633c-11.227344,-5.439393 -20.271593,-10.878785 -20.271593,-12.238633c0,-1.359848 -4.98993,-4.419507 -10.915473,-6.799241c-5.925543,-2.379734 -10.915473,-5.439393 -10.915473,-6.799241c0,-1.359848 -3.430577,-3.399621 -7.796766,-4.419507c-4.36619,-1.359848 -10.603603,-4.759469 -13.410438,-8.159089c-3.118707,-3.059659 -11.227344,-8.839013 -17.776628,-12.578595c-18.400369,-10.198861 -38.671962,-33.31628 -39.607574,-44.874989c-1.247483,-19.717799 0.935612,-26.857001 11.539215,-39.435596c5.925543,-7.139203 10.915473,-15.298292 10.915473,-18.017988c0,-2.719696 1.559353,-4.759469 3.118707,-4.759469c1.871224,0 3.118707,-3.739583 3.118707,-8.499051c0,-4.759469 1.559353,-8.499051 3.118707,-8.499051c5.301801,0 3.430577,-16.998102 -2.183095,-19.377837c-2.806836,-1.359848 -9.35612,-6.459279 -14.657921,-11.898671c-4.98993,-5.099431 -9.979861,-9.518937 -11.539215,-9.518937c-2.806836,0 -16.529145,-12.238633 -25.573394,-22.777457c-5.613672,-7.139203 -9.35612,-7.819127 -33.993902,-7.819127c-14.969791,0 -27.444619,1.019886 -27.444619,2.039772c0,3.739583 9.044249,11.558709 13.722309,11.558709c5.925543,0 23.702171,19.377837 24.014041,26.517039c1.247483,22.777457 -8.108638,55.07385 -15.905404,55.07385c-1.871224,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,2.379734 -3.118707,5.439393c0,2.719696 -1.247483,4.419507 -2.494965,3.399621c-1.559353,-1.019886 -4.67806,3.399621 -6.861155,9.858899c-2.494965,6.459279 -5.301801,11.898671 -6.549283,11.898671c-1.247483,0 -6.237413,7.139203 -10.915473,16.318178c-4.67806,8.839013 -9.35612,16.65814 -10.291732,17.678026c-0.935612,1.019886 -4.054318,6.459279 -6.549283,11.898671c-2.494965,5.779355 -5.301801,10.878785 -6.237413,11.898671c-4.36619,4.759469 -12.162956,23.117419 -10.291732,25.157191c0.935612,1.019886 0.31187,2.039772 -1.559353,2.039772c-2.183095,0 -3.742448,3.059659 -3.742448,6.799241c0,3.739583 -2.806836,10.198861 -6.237413,14.618368c-12.786697,15.298292 -14.346051,18.017988 -18.71224,32.976318c-2.494965,8.499051 -5.613672,16.318178 -7.173025,17.338064c-1.247483,1.019886 -2.806836,5.099431 -3.118707,9.178975c0,3.739583 -1.559353,6.119317 -2.806836,5.439393c-1.247483,-1.019886 -2.494965,1.359848 -2.494965,5.099431c0,4.079545 -1.559353,7.139203 -3.430577,7.139203c-1.871224,0 -2.806836,5.439393 -2.183095,12.578595c0.623741,9.518937 2.806836,13.938444 8.420508,16.65814c4.054318,2.379734 8.108638,5.439393 9.35612,7.139203c0.935612,1.359848 5.613672,4.759469 10.291732,7.479165c4.67806,2.719696 11.227344,7.139203 14.346051,10.198861c8.420508,7.819127 18.71224,13.938444 24.014041,13.938444c2.494965,0 4.67806,1.359848 4.67806,2.719696c0,1.69981 6.549283,6.799241 14.969791,11.218747c8.108638,4.419507 15.905404,9.858899 17.152886,12.238633c1.247483,2.379734 5.301801,4.419507 8.420508,4.419507c3.430577,0 9.044249,3.059659 12.474826,6.799241c3.430577,3.739583 8.108638,6.799241 10.603603,6.799241c2.494965,0 4.98993,1.019886 5.613672,2.719696c0.623741,1.359848 8.108638,6.119317 16.529145,10.538823c8.732378,4.419507 18.088498,9.178975 20.895334,10.878785c3.118707,1.69981 7.796766,3.059659 10.291732,3.059659c2.494965,0 4.67806,2.039772 4.67806,4.419507c0,2.719696 6.861155,6.459279 15.593533,9.178975c8.420508,2.379734 14.657921,5.779355 13.722309,7.479165c-0.935612,1.359848 1.247483,2.719696 4.67806,2.719696c3.430577,0 7.173025,1.69981 8.108638,3.399621c1.247483,2.379734 -19.335981,3.399621 -59.879167,3.059659l-61.750391,-0.339962l-17.464757,-10.538823l0.000003,-0.000007l0.000016,-0.000008zm1002.352309,-260.070961c-0.935612,-29.236735 -3.118707,-55.07385 -4.67806,-57.453585c-1.559353,-2.379734 -4.36619,-18.35795 -5.613672,-35.696015c-4.36619,-47.934648 -11.851085,-95.869296 -15.593533,-97.229143c-1.559353,-0.679924 -3.118707,-6.459279 -3.118707,-12.918557c0,-13.258519 -6.549283,-38.755672 -9.979861,-38.755672c-1.559353,0 -2.494965,-2.379734 -2.494965,-5.099431c0,-4.759469 -11.227344,-28.896773 -15.281663,-32.296394c-0.935612,-1.019886 -5.925543,-10.878785 -11.227344,-22.097533c-4.98993,-11.218747 -10.291732,-20.737685 -11.539215,-21.417609c-1.559353,-0.679924 -2.494965,-4.079545 -2.494965,-7.819127c0,-3.399621 -1.247483,-6.459279 -3.118707,-6.459279c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-2.719696 -0.935612,-5.099431 -2.183095,-5.099431c-3.118707,0 -10.291732,-16.65814 -10.291732,-23.117419c0,-2.379734 -1.247483,-3.399621 -3.118707,-2.379734c-1.559353,1.019886 -3.118707,-0.339962 -3.118707,-3.059659c0,-3.059659 -1.247483,-5.439393 -3.118707,-5.439393c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-3.059659 -2.183095,-6.119317 -4.67806,-7.139203c-2.494965,-1.359848 -4.67806,-4.079545 -4.67806,-6.459279c0,-6.119317 -12.474826,-29.236735 -19.335981,-36.035977c-3.118707,-3.059659 -5.613672,-8.159089 -5.613672,-11.218747c0,-3.059659 -2.183095,-5.439393 -4.98993,-5.439393c-2.494965,0 -4.054318,-1.359848 -3.118707,-2.719696c0.935612,-1.69981 -1.247483,-6.119317 -4.36619,-10.198861c-3.430577,-4.079545 -6.237413,-8.159089 -6.237413,-9.518937c0,-1.359848 -2.183095,-4.759469 -4.67806,-7.819127c-13.410438,-16.318178 -16.217274,-20.057761 -18.088498,-25.157191c-2.806836,-8.159089 -8.108638,-7.139203 -15.281663,2.719696c-3.430577,4.759469 -8.108638,8.499051 -10.603603,8.499051c-2.494965,0 -8.108638,3.739583 -12.162956,8.159089c-4.054318,4.759469 -10.603603,9.178975 -14.03418,10.538823c-3.430577,1.019886 -6.237413,4.419507 -6.237413,7.139203c0,2.719696 -1.871224,4.759469 -4.36619,4.759469c-2.494965,0 -9.044249,4.419507 -14.657921,9.858899c-5.613672,5.779355 -14.03418,11.898671 -19.024111,14.278406c-4.67806,2.039772 -7.796766,5.099431 -6.861155,6.799241c0.935612,1.69981 -0.623741,3.059659 -3.118707,3.059659c-2.806836,0 -6.549283,3.059659 -8.732378,6.799241c-2.183095,3.739583 -5.613672,6.799241 -7.796766,6.799241c-2.183095,0 -4.054318,1.359848 -4.054318,3.059659c0,1.69981 -3.430577,4.079545 -7.796766,5.099431c-4.36619,1.359848 -7.796766,3.739583 -7.796766,5.439393c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.183095,3.399621 -4.67806,3.399621c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -2.806836,3.399621 -6.237413,3.399621c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -3.118707,3.399621 -6.861155,3.399621c-3.742448,0 -5.613672,1.019886 -4.67806,2.379734c2.494965,2.719696 -19.335981,17.678026 -25.885265,18.017988c-5.925543,0 -13.410438,12.578595 -9.35612,15.298292c1.871224,1.019886 3.118707,5.099431 3.118707,8.839013c0,3.399621 0.935612,6.459279 2.494965,6.459279c1.247483,0 5.613672,6.799241 9.979861,15.298292c4.36619,8.499051 8.732378,15.298292 9.979861,15.298292c1.247483,0 4.67806,5.439393 7.484896,11.898671c2.806836,6.459279 6.237413,11.898671 7.796766,11.898671c1.559353,0 4.36619,3.739583 6.549283,8.159089c4.98993,9.858899 19.024111,29.236735 33.682032,46.234837c28.068359,32.976318 37.42448,44.535027 37.42448,47.594686c0,2.039772 0.935612,3.059659 2.494965,2.719696c1.247483,-0.679924 8.732378,6.459279 17.152886,15.298292c8.108638,8.839013 15.281663,15.978216 16.217274,15.978216c0.935612,0 8.732378,7.479165 17.152886,16.65814c8.732378,9.178975 19.647851,18.697912 24.325912,21.077647c4.67806,2.039772 12.162956,9.178975 16.217274,15.298292c4.36619,5.779355 8.732378,10.198861 9.667991,9.518937c1.247483,-0.679924 3.742448,1.019886 5.925543,3.739583c2.183095,2.719696 5.925543,5.099431 8.108638,5.099431c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,2.039772 1.871224,3.399621 4.054318,3.399621c1.871224,0 8.108638,4.419507 13.098568,9.518937c5.301801,5.099431 15.905404,13.598481 24.325912,18.697912c8.108638,5.099431 14.657921,10.538823 14.657921,11.898671c0,1.359848 7.796766,6.119317 17.152886,10.878785c9.35612,4.759469 17.152886,9.518937 17.152886,11.218747c0,1.359848 2.183095,2.379734 4.67806,2.379734c2.494965,0 4.67806,1.359848 4.67806,3.059659c0,1.69981 8.420508,6.799241 18.71224,11.218747c10.291732,4.079545 18.71224,9.858899 18.71224,11.898671c0,2.379734 2.806836,4.419507 6.237413,4.419507c3.430577,0 6.237413,1.69981 6.237413,3.399621c0,2.039772 2.806836,3.399621 6.549283,3.399621c3.430577,0 5.613672,1.359848 4.36619,3.059659c-1.871224,3.399621 9.979861,6.459279 16.217274,4.419507c2.494965,-0.679924 3.118707,-15.638254 1.871224,-54.393926l-0.000002,-0.000004l0.000008,-0.000004zm-1930.79127,-14.278406c4.36619,-3.399621 8.732378,-5.439393 9.979861,-4.419507c0.935612,1.019886 1.871224,0.679924 1.871224,-1.359848c0,-1.69981 5.613672,-6.119317 12.474826,-9.518937c6.861155,-3.399621 12.474826,-7.479165 12.474826,-9.178975c0,-1.359848 2.806836,-2.719696 6.237413,-2.719696c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 2.183095,-3.399621 4.98993,-3.399621c2.494965,0 3.742448,-1.359848 2.806836,-3.399621c-0.935612,-1.69981 0.935612,-3.399621 4.36619,-3.399621c3.742448,0 6.549283,-1.359848 6.549283,-3.399621c0,-1.69981 1.871224,-3.399621 4.36619,-3.399621c5.925543,0 20.895334,-8.839013 18.71224,-11.218747c-0.935612,-1.019886 1.559353,-3.739583 5.613672,-6.119317c3.742448,-2.039772 8.420508,-6.119317 9.667991,-8.499051c1.247483,-2.719696 4.67806,-4.759469 6.861155,-4.759469c2.494965,0 4.67806,-1.359848 4.67806,-3.399621c0,-1.69981 1.559353,-3.399621 3.118707,-3.399621c3.742448,0 22.766559,-13.938444 24.325912,-17.678026c0.623741,-1.69981 2.183095,-2.719696 3.742448,-2.719696c2.494965,0 9.979861,-6.459279 28.692101,-24.477266c4.98993,-5.439393 10.603603,-9.518937 12.162956,-9.518937c1.559353,0 2.806836,-1.69981 2.806836,-3.739583c0,-4.079545 7.796766,-13.258519 11.539215,-13.258519c1.247483,0 6.549283,-4.759469 11.539215,-10.198861c4.98993,-5.779355 10.291732,-10.198861 11.851085,-10.198861c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-2.719696 3.430577,-6.799241 7.796766,-9.178975c4.36619,-2.379734 7.796766,-6.799241 7.796766,-9.518937c0,-3.059659 0.935612,-4.419507 1.871224,-3.059659c1.871224,2.039772 10.603603,-5.439393 10.603603,-9.518937c0,-1.019886 3.430577,-5.439393 7.796766,-9.858899c4.36619,-4.419507 7.796766,-9.518937 7.796766,-11.558709c0,-2.039772 2.806836,-4.759469 6.237413,-5.779355c3.430577,-1.019886 6.237413,-3.739583 6.237413,-5.779355c0,-1.69981 4.36619,-7.819127 9.35612,-12.918557c5.301801,-5.099431 9.35612,-10.878785 9.35612,-12.578595c0,-1.359848 5.613672,-9.518937 12.162956,-17.678026c6.861155,-8.499051 11.851085,-16.318178 11.227344,-17.338064c-0.623741,-1.359848 1.559353,-4.419507 4.98993,-6.799241c3.118707,-2.719696 5.925543,-6.799241 5.925543,-9.178975c0,-2.379734 1.247483,-4.419507 2.806836,-4.419507c1.559353,0 4.36619,-4.419507 6.549283,-10.198861c2.183095,-5.439393 4.98993,-10.198861 6.549283,-10.198861c1.559353,0 2.806836,-2.379734 2.806836,-5.099431c0,-3.059659 2.806836,-8.499051 6.237413,-12.578595c3.430577,-4.079545 6.237413,-9.178975 6.237413,-11.558709c0,-4.759469 -25.261524,-25.157191 -31.187066,-25.157191c-1.871224,0 -4.054318,-2.379734 -4.98993,-5.099431c-1.247483,-2.719696 -3.742448,-5.099431 -6.237413,-5.099431c-2.494965,0 -4.36619,-1.359848 -4.36619,-3.399621c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-2.806836,0 -10.915473,-6.459279 -20.271593,-15.978216c-2.494965,-2.379734 -4.98993,-4.419507 -5.925543,-4.419507c-1.871224,0 -3.118707,-1.019886 -26.820877,-23.797342c-7.796766,-7.479165 -14.969791,-13.598481 -16.217274,-13.598481c-0.935612,0 -21.830946,-21.077647 -45.844987,-47.254724l-44.285634,-46.914762l-10.603603,11.558709c-5.925543,6.459279 -10.915473,12.578595 -10.915473,13.258519c0,2.379734 -13.098568,21.757571 -22.454688,33.31628c-8.108638,9.518937 -9.044249,11.558709 -8.732378,17.678026c0.31187,1.019886 -2.806836,4.759469 -6.861155,8.159089c-4.054318,3.739583 -5.925543,6.459279 -4.67806,6.799241c1.247483,0 -0.623741,3.399621 -4.054318,7.819127c-3.430577,4.079545 -12.786697,18.35795 -20.271593,31.276508c-7.484896,13.258519 -14.969791,25.497153 -16.529145,27.196963c-1.247483,2.039772 -4.67806,8.499051 -6.861155,14.618368c-2.494965,5.779355 -5.613672,10.878785 -6.549283,10.878785c-0.935612,0 -5.301801,8.499051 -9.35612,18.697912c-4.054318,10.198861 -8.108638,18.697912 -9.35612,18.697912c-0.935612,0 -4.36619,6.119317 -7.484896,13.598481c-3.118707,7.479165 -6.861155,13.598481 -8.420508,13.598481c-1.247483,0 -2.494965,3.059659 -2.494965,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -0.935612,6.799241 -2.183095,6.799241c-8.732378,0 -10.291732,21.417609 -10.291732,131.905271c0,106.068156 3.118707,157.062462 9.35612,157.062462c1.247483,0 5.925543,-3.059659 9.979861,-6.799241l-0.000002,0.000007l0.000006,0zm1090.923576,-286.927962c103.852931,-10.198861 140.341798,-15.298292 140.341798,-19.377837c0,-1.359848 11.539215,-3.399621 25.885265,-4.419507c25.885265,-1.69981 62.686003,-7.139203 56.760461,-8.499051c-1.559353,-0.679924 6.861155,-3.739583 18.71224,-7.139203c12.162956,-3.399621 26.197136,-7.819127 31.187066,-9.518937c5.301801,-2.039772 17.152886,-6.119317 26.509006,-9.518937c17.464757,-5.779355 34.617644,-12.918557 44.285634,-18.697912c3.118707,-1.69981 8.420508,-3.059659 11.851085,-3.059659c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 1.871224,-3.399621 4.054318,-3.399621c1.871224,-0.339962 11.539215,-4.759469 20.895334,-10.198861c9.35612,-5.439393 21.830946,-12.238633 27.444619,-15.298292c5.301801,-2.719696 9.979861,-6.799241 9.979861,-8.499051c0,-2.039772 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 2.183095,-3.399621 4.67806,-3.399621c2.494965,0 4.67806,-1.359848 4.67806,-3.059659c0,-1.69981 2.494965,-3.739583 5.613672,-4.759469c7.796766,-2.719696 23.702171,-13.598481 26.197136,-18.017988c1.247483,-2.039772 6.549283,-5.779355 11.851085,-8.159089c4.98993,-2.379734 8.732378,-5.099431 8.108638,-6.459279c-0.935612,-1.359848 2.494965,-4.079545 7.173025,-6.459279c4.67806,-2.379734 11.539215,-7.139203 15.281663,-10.878785c3.742448,-3.739583 7.484896,-6.799241 8.732378,-6.799241c1.247483,0 4.36619,-2.719696 7.173025,-6.119317c2.806836,-3.059659 12.162956,-11.898671 20.583464,-19.037874c19.335981,-16.65814 24.637782,-21.757571 41.166927,-40.11552c32.122678,-35.356052 53.953625,-62.553015 53.953625,-66.63256c0,-2.379734 1.559353,-3.399621 3.118707,-2.379734c1.871224,1.019886 3.118707,-0.339962 3.118707,-3.059659c0,-2.719696 3.118707,-7.819127 7.173025,-11.218747c3.742448,-3.399621 10.291732,-11.898671 14.346051,-18.697912c3.742448,-7.139203 8.420508,-12.918557 9.979861,-12.918557c1.559353,0 2.806836,-2.039772 2.806836,-4.419507c0,-2.379734 3.118707,-8.159089 7.173025,-12.578595c14.657921,-17.338064 45.844987,-70.372142 45.844987,-78.531231c0,-3.739583 1.247483,-6.119317 2.806836,-5.099431c2.494965,1.69981 12.162956,-25.497153 10.291732,-28.216849c-0.623741,-0.679924 0,-2.379734 1.559353,-3.399621c1.559353,-1.019886 5.925543,-9.518937 9.979861,-19.037874c3.742448,-9.178975 9.044249,-21.417609 11.227344,-26.517039c2.494965,-5.439393 4.67806,-11.898671 4.67806,-14.618368c0,-2.719696 1.247483,-7.479165 2.806836,-10.878785c1.559353,-3.059659 4.67806,-12.918557 7.173025,-21.757571c2.183095,-9.178975 4.98993,-16.318178 6.237413,-16.318178c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-2.379734 3.430577,-11.898671 7.796766,-21.417609c6.861155,-14.95833 9.35612,-27.536925 16.841016,-83.630661c1.247483,-8.499051 3.742448,-17.678026 5.613672,-20.397723c1.871224,-2.379734 4.36619,-13.598481 5.613672,-24.817229c1.247483,-11.218747 3.430577,-29.576697 4.67806,-40.795444c1.247483,-11.218747 2.494965,-18.697912 3.118707,-16.998102c0.623741,2.039772 2.183095,-9.518937 3.742448,-25.497153c1.247483,-15.978216 3.118707,-38.755672 4.36619,-50.994306c0.935612,-12.238633 3.430577,-23.117419 5.613672,-24.477266c4.67806,-3.399621 4.36619,-87.030282 -0.623741,-96.209257c-3.118707,-6.119317 -3.430577,-5.439393 -2.183095,4.079545c1.247483,11.558709 -3.430577,18.697912 -6.549283,9.858899c-0.935612,-2.719696 -3.742448,-4.079545 -6.237413,-3.059659c-5.301801,2.039772 -19.959722,-1.359848 -19.959722,-5.099431c0,-5.099431 18.088498,-10.198861 21.519076,-6.459279c3.742448,4.079545 3.742448,3.739583 4.98993,-17.338064c0.623741,-7.819127 -0.31187,-13.598481 -1.871224,-12.238633c-1.559353,1.019886 -2.806836,-1.69981 -2.806836,-5.779355c0,-12.918557 -4.36619,-3.739583 -6.237413,13.258519c-1.247483,13.938444 -2.494965,15.978216 -9.35612,17.338064c-4.36619,0.339962 -8.732378,2.719696 -9.979861,5.099431c-1.871224,2.719696 -2.494965,2.379734 -2.494965,-1.019886c0,-2.379734 -1.871224,-3.739583 -4.67806,-2.379734c-2.806836,1.019886 -4.67806,0 -4.67806,-3.059659c0,-2.719696 -1.247483,-5.099431 -2.806836,-5.099431c-6.237413,0 -12.786697,-10.878785 -11.227344,-18.017988c0.935612,-4.419507 -0.935612,-11.558709 -4.67806,-17.678026c-5.301801,-8.499051 -6.237413,-9.178975 -6.237413,-3.399621c-0.31187,9.518937 -12.474826,-17.678026 -12.474826,-27.536925c0,-4.079545 -2.806836,-13.938444 -6.237413,-22.097533c-3.430577,-8.159089 -6.237413,-19.377837 -6.237413,-24.477266c0,-5.439393 -1.247483,-8.839013 -2.806836,-7.819127c-3.118707,2.379734 -11.227344,-121.366448 -8.732378,-137.684626c4.67806,-33.31628 5.613672,-38.41571 6.549283,-39.435596c1.871224,-2.379734 16.217274,-2.039772 23.078429,0.339962c4.054318,1.69981 6.861155,1.019886 6.861155,-1.019886c0,-2.039772 -2.806836,-3.739583 -6.237413,-3.739583c-4.98993,0 -6.237413,-2.379734 -6.549283,-10.878785c-0.31187,-6.119317 -0.31187,-12.918557 0,-14.95833c0.31187,-2.379734 -1.559353,-4.759469 -4.36619,-6.119317c-2.494965,-1.019886 -4.67806,-4.079545 -4.67806,-7.139203c0,-3.059659 -2.806836,-8.499051 -6.237413,-12.578595c-3.430577,-4.079545 -6.237413,-9.518937 -6.237413,-12.578595c0,-2.719696 -0.935612,-4.079545 -1.871224,-2.719696c-2.183095,2.039772 -10.603603,-5.779355 -10.603603,-9.518937c0,-1.359848 -4.67806,-7.479165 -10.291732,-13.938444c-12.786697,-14.618368 -15.281663,-18.017988 -20.583464,-29.236735c-2.494965,-5.099431 -5.613672,-8.499051 -7.173025,-7.479165c-1.247483,1.019886 -2.494965,0.339962 -2.494965,-1.359848c0,-5.099431 -37.73635,-44.874989 -47.404341,-50.314382c-4.98993,-2.719696 -12.786697,-9.518937 -17.776628,-14.95833c-4.67806,-5.779355 -9.667991,-10.198861 -10.915473,-10.198861c-0.935612,0 -7.796766,-6.119317 -14.657921,-13.598481c-7.173025,-7.479165 -14.969791,-13.598481 -17.152886,-13.598481c-2.494965,0 -4.36619,-2.039772 -4.36619,-4.759469c0,-2.719696 -4.054318,-6.799241 -9.044249,-9.178975c-4.98993,-2.379734 -8.420508,-5.779355 -7.796766,-7.139203c0.935612,-1.359848 -0.31187,-2.719696 -2.806836,-2.719696c-2.494965,0 -5.613672,-2.379734 -6.549283,-5.439393c-0.935612,-2.719696 -3.118707,-4.419507 -4.36619,-3.399621c-1.559353,1.019886 -4.67806,-1.359848 -6.861155,-5.099431c-2.494965,-3.399621 -6.237413,-6.459279 -8.420508,-6.459279c-4.98993,0 -17.152886,-7.139203 -20.271593,-11.558709c-0.935612,-2.039772 -13.410438,-7.479165 -27.132747,-12.238633c-14.03418,-5.099431 -24.325912,-10.198861 -23.078429,-11.218747c0.935612,-1.359848 -3.118707,-2.379734 -9.35612,-2.379734c-6.237413,0 -11.539215,-1.359848 -11.539215,-3.399621c0,-1.69981 -4.054318,-3.399621 -9.35612,-3.399621c-4.98993,0 -9.35612,-1.359848 -9.35612,-3.059659c0,-3.399621 -12.786697,-6.119317 -42.10254,-9.178975c-10.291732,-1.359848 -20.583464,-3.739583 -22.766559,-5.779355c-5.613672,-5.099431 -9.979861,-5.099431 -140.965539,-9.518937c-90.442492,-3.059659 -136.911221,-3.059659 -188.681751,0c-37.73635,2.039772 -119.758334,4.079545 -182.444338,4.079545c-62.686003,0.339962 -123.500782,2.039772 -135.663738,3.739583c-31.810807,4.419507 -114.768404,9.178975 -195.542906,11.558709c-40.543186,1.019886 -70.170899,3.399621 -69.235287,5.099431c0.935612,1.69981 -9.35612,3.059659 -23.390299,3.059659c-13.722309,0 -25.573394,1.359848 -26.509006,3.059659c-0.935612,1.69981 -7.173025,3.739583 -13.410438,4.759469c-19.959722,3.059659 -61.438521,13.258519 -67.052192,16.318178c-3.118707,1.69981 -9.044249,3.059659 -13.098568,3.059659c-4.36619,0 -9.667991,2.379734 -12.474826,5.099431c-2.494965,2.719696 -7.484896,5.099431 -10.915473,5.099431c-3.430577,0 -7.173025,1.359848 -8.108638,3.399621c-0.935612,1.69981 -5.301801,3.399621 -9.667991,3.399621c-4.054318,0 -7.484896,1.69981 -7.484896,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,1.69981 -4.67806,3.399621 -8.108638,3.399621c-3.118707,0 -5.925543,1.69981 -5.925543,3.399621c0,2.039772 -1.871224,3.399621 -4.054318,3.399621c-2.183095,0 -9.979861,3.059659 -17.152886,6.799241c-6.861155,3.739583 -14.969791,6.799241 -17.464757,6.799241c-2.494965,0 -5.301801,1.359848 -6.237413,2.719696c-0.935612,1.69981 -11.851085,7.139203 -24.325912,12.578595c-12.474826,5.099431 -23.390299,10.538823 -24.325912,11.558709c-0.935612,1.019886 -5.613672,4.419507 -10.915473,7.139203c-4.98993,2.719696 -12.162956,7.819127 -15.281663,11.218747c-3.430577,3.059659 -8.108638,5.779355 -10.291732,5.779355c-2.494965,0 -4.98993,2.379734 -5.925543,5.099431c-1.247483,2.719696 -4.054318,5.099431 -6.237413,5.099431c-4.67806,0 -8.420508,2.719696 -20.271593,14.618368c-3.118707,3.059659 -7.796766,5.779355 -9.979861,5.779355c-2.183095,0 -5.925543,3.059659 -8.420508,6.799241c-2.494965,3.739583 -5.613672,6.799241 -6.861155,6.799241c-4.36619,0 -29.315842,25.497153 -68.923416,70.712104c-5.301801,5.779355 -10.915473,10.878785 -12.162956,10.878785c-1.247483,0 -2.494965,2.039772 -2.494965,4.759469c0,2.379734 -4.054318,8.839013 -8.732378,14.618368c-10.291732,11.558709 -39.919445,57.113622 -35.241385,54.053964c1.559353,-1.359848 3.742448,-0.679924 4.98993,1.359848c0.935612,1.69981 0,3.399621 -2.494965,3.399621c-5.301801,0 -12.162956,8.159089 -9.667991,11.218747c1.247483,1.019886 4.98993,0 8.420508,-2.719696c3.742448,-2.719696 7.796766,-3.739583 9.667991,-2.039772c5.301801,4.419507 33.05829,7.479165 33.05829,3.739583c0,-2.039772 -3.742448,-3.739583 -8.420508,-3.739583c-6.237413,-0.339962 -6.861155,-1.019886 -2.806836,-2.039772c3.118707,-1.019886 14.969791,-0.679924 25.885265,0.679924c16.217274,1.69981 19.335981,3.059659 16.529145,6.799241c-2.806836,3.399621 -2.183095,4.759469 2.183095,6.119317c3.118707,0.679924 1.871224,1.359848 -2.494965,1.019886c-5.925543,-0.679924 -7.796766,0.679924 -6.861155,3.739583c0.935612,2.379734 3.430577,4.419507 5.925543,4.419507c2.494965,0 4.36619,1.69981 4.36619,3.739583c0,2.379734 3.742448,3.059659 10.915473,1.69981c8.732378,-2.039772 10.603603,-1.359848 9.044249,2.719696c-1.247483,3.059659 0.623741,5.439393 5.613672,6.459279c5.301801,1.019886 4.67806,1.69981 -3.118707,2.039772c-9.979861,0.339962 -10.291732,0.679924 -9.35612,15.298292c0.623741,8.159089 1.871224,14.278406 3.430577,13.258519c1.247483,-0.679924 2.183095,0.339962 2.183095,2.039772c0,2.039772 1.871224,3.739583 4.054318,3.739583c2.183095,0 7.484896,2.719696 11.539215,5.779355c4.36619,3.399621 10.603603,5.779355 14.03418,5.439393c4.98993,-0.339962 4.98993,-0.339962 0.935612,1.019886c-5.925543,2.039772 -7.484896,13.258519 -2.494965,16.65814c1.871224,1.019886 4.67806,8.839013 6.549283,16.65814c4.36619,18.697912 12.786697,19.717799 15.593533,2.039772c1.247483,-6.459279 2.183095,15.298292 2.183095,48.27461c0,42.155293 -1.247483,64.252826 -4.36619,73.091838c-2.183095,7.139203 -4.054318,18.35795 -3.742448,24.817229l0.31187,11.898671l1.871224,-11.898671l2.183095,-11.898671l2.183095,11.898671c1.559353,7.139203 1.247483,12.238633 -0.935612,12.918557c-1.559353,0.679924 -3.118707,3.739583 -3.118707,6.459279c0,4.419507 -0.935612,4.419507 -4.67806,1.019886c-3.742448,-3.399621 -4.67806,-3.059659 -4.67806,1.359848c0,4.419507 -1.871224,5.439393 -6.861155,3.739583c-5.925543,-1.69981 -6.237413,-1.359848 -2.494965,1.69981c3.118707,2.719696 3.430577,4.419507 1.247483,5.439393c-1.871224,1.019886 -2.806836,5.439393 -1.871224,9.858899c0.623741,5.099431 0,8.499051 -2.183095,8.499051c-1.871224,0 -3.430577,-2.039772 -3.742448,-4.079545c0,-3.399621 -0.623741,-3.399621 -1.871224,0c-1.247483,3.399621 -2.494965,3.059659 -5.925543,-1.69981c-3.742448,-5.779355 -4.054318,-5.779355 -4.36619,-0.339962c0,3.739583 -1.559353,5.099431 -4.67806,4.079545c-4.98993,-2.379734 -6.237413,-10.198861 -2.183095,-12.238633c1.559353,-0.339962 3.742448,-5.099431 4.98993,-10.198861c1.559353,-7.139203 0.935612,-9.518937 -2.806836,-9.518937c-2.494965,0 -4.67806,-1.359848 -4.67806,-3.399621c0,-1.69981 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 -5.613672,-3.399621 -12.474826,-3.399621l-12.474826,0l0,16.65814c0,11.558709 1.247483,17.338064 4.67806,18.697912c6.237413,2.379734 5.925543,8.839013 -1.559353,19.037874c-7.796766,10.878785 -7.796766,14.618368 0,10.198861c3.430577,-2.039772 5.301801,-5.439393 4.36619,-8.499051c-1.559353,-4.079545 0.935612,-5.099431 11.539215,-4.759469l13.722309,0.339962l-10.915473,4.079545c-10.603603,4.419507 -10.603603,4.759469 -3.118707,6.119317c7.796766,1.69981 7.796766,1.69981 -0.623741,2.379734c-9.667991,0.339962 -11.851085,5.779355 -3.118707,8.159089c4.36619,1.359848 4.36619,1.69981 -0.935612,2.039772c-7.796766,0.679924 -21.207205,12.578595 -19.024111,16.998102c1.247483,1.69981 -0.935612,2.379734 -4.98993,1.019886c-4.36619,-1.019886 -5.925543,-0.679924 -4.36619,2.039772c2.183095,4.079545 -3.430577,5.779355 -13.098568,4.419507c-2.494965,-0.339962 -8.108638,2.039772 -12.474826,5.439393c-4.67806,3.059659 -9.35612,5.439393 -10.915473,5.099431c-1.247483,-0.339962 -4.98993,2.379734 -8.420508,6.119317c-4.36619,4.759469 -10.291732,6.799241 -21.207205,6.799241c-8.108638,0 -19.647851,1.359848 -25.573394,3.399621c-7.484896,2.379734 -15.593533,2.039772 -27.132747,-0.679924c-15.281663,-4.079545 -16.217274,-4.759469 -17.464757,-16.318178c-0.623741,-6.459279 -1.247483,3.059659 -1.559353,21.417609c-0.31187,21.417609 0.623741,32.636356 2.494965,31.276508c1.871224,-1.359848 3.118707,4.079545 3.118707,13.938444c0,22.097533 6.549283,59.833319 11.539215,65.272712c2.183095,2.379734 4.054318,8.159089 4.054318,12.238633c0,4.419507 2.183095,13.598481 4.67806,20.057761c2.494965,6.799241 4.67806,15.978216 4.67806,20.737685c0,4.419507 2.183095,10.538823 4.67806,13.598481c2.494965,2.719696 4.67806,8.839013 4.67806,13.598481c0,4.759469 1.559353,8.839013 3.118707,8.839013c1.871224,0 3.118707,3.739583 3.118707,8.499051c0,4.759469 0.935612,8.499051 2.494965,8.499051c3.430577,0 9.979861,17.338064 9.979861,25.837115c0,4.419507 1.559353,8.839013 3.118707,9.858899c1.871224,1.019886 3.118707,5.099431 3.118707,8.839013c0,3.739583 1.247483,6.119317 2.806836,5.099431c1.247483,-1.019886 4.98993,4.079545 8.108638,11.558709c3.118707,7.479165 6.861155,13.598481 8.420508,13.598481c1.247483,0 2.494965,3.059659 2.494965,6.799241c0,3.739583 1.559353,6.799241 3.430577,6.799241c1.559353,0 2.494965,1.359848 1.559353,2.719696c-0.935612,1.69981 1.871224,8.499051 5.925543,14.95833c4.054318,6.799241 10.915473,20.737685 15.281663,30.936546c4.054318,10.198861 9.979861,21.757571 13.410438,25.157191c3.118707,3.399621 8.732378,13.598481 12.786697,22.437495c3.742448,9.178975 8.420508,18.35795 9.979861,20.397723c10.915473,14.618368 18.088498,26.177077 23.390299,37.395824c3.430577,6.799241 7.173025,12.578595 8.420508,12.578595c1.247483,0 4.67806,5.099431 7.484896,10.878785c2.806836,6.119317 9.044249,14.95833 13.722309,19.717799c4.36619,4.759469 10.915473,13.938444 14.346051,20.397723c3.118707,6.459279 9.667991,15.638254 14.657921,20.397723c4.67806,4.419507 8.420508,10.198861 8.420508,12.918557c0,2.379734 1.247483,3.399621 3.118707,2.379734c1.559353,-1.019886 3.118707,0.339962 3.118707,3.059659c0,3.059659 1.247483,5.439393 2.494965,5.439393c1.559353,0 4.36619,4.079545 6.549283,8.839013c1.871224,5.099431 4.36619,8.159089 5.613672,7.139203c0.935612,-1.359848 5.925543,4.419507 11.227344,12.238633c5.301801,7.819127 13.098568,18.017988 17.776628,22.777457c4.36619,4.759469 9.044249,11.218747 10.291732,14.618368c0.935612,3.059659 4.054318,5.779355 6.861155,5.779355c2.494965,0 4.67806,1.359848 4.67806,2.719696c0,4.759469 43.973763,53.034078 56.136719,61.873091c5.925543,4.419507 13.098568,10.538823 15.905404,13.258519c8.420508,9.178975 16.529145,15.298292 25.573394,20.397723c4.67806,2.719696 8.420508,6.119317 8.420508,7.819127c0,1.359848 2.183095,2.719696 4.67806,2.719696c2.494965,0 4.67806,1.69981 4.67806,3.739583c0,1.69981 4.36619,5.099431 9.35612,6.799241c5.301801,2.039772 9.35612,5.779355 9.35612,8.499051c0,2.719696 2.806836,4.759469 6.237413,4.759469c3.430577,0 6.237413,1.359848 6.237413,2.719696c0,1.69981 4.98993,4.759469 10.915473,7.479165c6.237413,2.719696 13.410438,7.479165 16.217274,10.878785c2.806836,3.399621 7.796766,6.119317 10.915473,6.119317c3.430577,0 5.301801,1.359848 4.36619,2.719696c-1.247483,2.379734 6.237413,6.799241 20.895334,12.238633c3.118707,1.019886 4.67806,3.399621 3.742448,5.439393c-1.247483,2.039772 1.559353,3.399621 5.925543,3.399621c4.36619,0 8.108638,1.69981 8.108638,3.399621c0,2.039772 2.806836,3.399621 6.237413,3.399621c3.430577,0 6.237413,1.69981 6.237413,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.359848 4.67806,3.059659c0,1.69981 3.118707,3.739583 7.173025,5.099431c4.054318,1.019886 11.227344,5.439393 15.905404,9.858899c4.98993,4.759469 14.657921,10.198861 21.830946,12.918557c6.861155,2.379734 15.593533,6.119317 19.024111,8.499051c3.430577,2.379734 12.474826,6.119317 20.271593,8.499051c7.796766,2.379734 15.281663,5.439393 16.841016,7.139203c1.871224,1.359848 7.796766,2.719696 13.098568,2.719696c5.613672,0 11.227344,1.69981 12.162956,3.399621c0.935612,2.039772 7.484896,3.399621 14.03418,3.399621c6.549283,0 12.786697,1.359848 13.722309,3.059659c0.935612,1.69981 14.03418,4.759469 29.003972,7.139203c15.281663,2.039772 33.370161,5.439393 40.543186,7.139203c7.173025,1.69981 24.014041,3.059659 37.42448,3.399621c13.410438,0 30.563325,2.379734 38.360092,4.759469c19.647851,6.459279 215.814498,4.419507 290.039716,-3.059659l0.000005,-0.000002l-0.000008,-0.000014zm-1149.24339,-986.909801c-2.494965,-14.95833 -3.430577,-13.598481 -5.925543,7.479165c-1.247483,11.558709 -0.935612,14.618368 0.935612,10.198861c2.806836,-6.459279 3.118707,-6.119317 3.742448,1.69981l0.623741,8.499051l1.247483,-8.159089c0.935612,-4.419507 0.623741,-13.258519 -0.623741,-19.717799l0,0.000001zm147.826694,16.318178c3.742448,-2.719696 2.806836,-3.739583 -3.742448,-5.779355c-4.98993,-1.019886 -9.667991,-1.359848 -10.603603,0c-1.247483,1.019886 0.623741,2.039772 4.054318,2.379734c5.613672,0 5.613672,0.339962 -0.31187,3.059659l-6.237413,3.059659l6.237413,0c3.430577,0 8.420508,-1.019886 10.603603,-2.719696l0,-0.000001zm-159.677779,-69.012294c-0.623741,-4.419507 -1.247483,-1.019886 -1.247483,7.479165c0,8.499051 0.623741,11.898671 1.247483,7.819127c0.623741,-4.419507 0.623741,-11.218747 0,-15.298292l0,0.000001l0,-0.000001zm1984.433024,2.719696c0,-0.679924 -2.183095,-3.059659 -4.67806,-5.439393c-4.054318,-3.739583 -4.36619,-3.399621 -2.806836,1.359848c1.559353,4.759469 7.484896,7.819127 7.484896,4.079545zm27.132747,-60.173281l0.623741,-24.137304l-6.237413,7.819127c-7.484896,9.178975 -7.796766,23.117419 -0.31187,32.976318c2.806836,4.079545 5.301801,7.479165 5.301801,7.479165c0,0 0.31187,-10.878785 0.623741,-24.137304l-0.000001,0l0.000001,-0.000002zm-1998.155334,-9.858899c0,-1.69981 -0.623741,-3.399621 -1.247483,-3.399621c-0.935612,0 -2.494965,1.69981 -3.430577,3.399621c-0.935612,2.039772 -0.31187,3.399621 1.247483,3.399621c1.871224,0 3.430577,-1.359848 3.430577,-3.399621zm1990.358567,-36.035977l-1.871224,-20.057761l-2.183095,20.397723c-1.247483,10.878785 -3.742448,20.737685 -5.613672,21.417609c-2.183095,0.679924 -2.183095,2.719696 0.623741,5.439393c6.861155,8.499051 11.539215,-4.759469 9.044249,-27.196963l-0.000001,0l0.000002,-0.000001zm-1991.294179,18.35795c-0.935612,-2.379734 -1.559353,-0.679924 -1.559353,4.079545c0,4.759469 0.623741,6.459279 1.559353,4.419507c0.623741,-2.379734 0.623741,-6.459279 0,-8.499051l0,-0.000001zm11.539215,-16.998102c-0.935612,-3.399621 -0.31187,-6.119317 1.559353,-6.119317c1.871224,0 3.430577,1.69981 3.430577,4.079545c0,2.039772 0.623741,3.059659 1.559353,2.379734c0.623741,-1.019886 0.31187,-6.799241 -1.247483,-12.578595c-1.871224,-6.799241 -1.871224,-10.878785 0,-10.878785c3.118707,0 3.742448,-18.017988 0.623741,-21.417609c-0.935612,-1.359848 -3.742448,3.399621 -6.237413,10.198861c-4.67806,15.298292 -5.613672,53.034078 -0.935612,45.214951c1.559353,-2.719696 2.183095,-7.819127 1.247483,-10.878785l0.000001,0zm36.176997,-17.678026c0,-25.157191 -0.935612,-32.296394 -4.67806,-33.996204c-9.044249,-3.739583 -3.742448,-49.634458 5.613672,-49.634458c5.301801,0 -0.623741,-4.759469 -7.173025,-5.779355c-3.742448,-0.679924 -6.237413,1.019886 -6.237413,4.079545c0,2.719696 -3.430577,12.918557 -7.796766,22.777457c-8.108638,18.017988 -9.979861,25.497153 -4.67806,16.318178c2.806836,-4.419507 3.118707,-4.419507 3.118707,0c0,2.719696 -1.247483,7.139203 -2.806836,9.858899c-1.559353,2.719696 -2.183095,7.139203 -1.247483,9.518937c3.118707,8.839013 7.173025,-2.719696 7.173025,-20.057761c0,-8.839013 1.559353,-16.998102 3.118707,-18.017988c1.871224,-1.359848 3.118707,4.419507 3.118707,14.95833c0,9.178975 1.559353,18.017988 3.118707,19.037874c1.871224,1.019886 3.118707,15.638254 3.118707,32.636356c0,18.017988 1.247483,30.256622 3.118707,30.256622c1.871224,0 3.118707,-12.918557 3.118707,-31.956432l0.000001,-0.000001l-0.000004,0.000001zm-25.885265,0.679924c-0.935612,-2.719696 -1.871224,-1.69981 -1.871224,2.039772c-0.31187,3.739583 0.623741,5.779355 1.559353,4.419507c0.935612,-1.019886 1.247483,-4.079545 0.31187,-6.459279l0.000001,0zm1959.483371,-17.678026c0,-4.759469 -1.559353,-9.518937 -3.430577,-10.538823c-4.67806,-3.399621 -5.613672,-1.359848 -3.742448,9.518937c2.183095,11.558709 7.173025,12.238633 7.173025,1.019886zm-10.291732,-46.234837c-0.935612,-9.178975 -4.054318,-21.077647 -6.861155,-26.177077c-4.98993,-9.518937 -4.98993,-9.178975 -3.430577,9.858899c1.247483,18.017988 5.925543,33.31628 10.291732,33.31628c0.935612,0 0.935612,-7.479165 0,-16.998102zm-20.895334,-32.976318c-0.935612,-21.077647 0.935612,-24.477266 3.118707,-6.119317l2.183095,16.998102l-0.623741,-20.057761c-0.31187,-14.278406 -1.871224,-21.077647 -5.925543,-24.137304c-2.806836,-2.379734 -5.613672,-7.479165 -5.925543,-11.218747c0,-3.739583 -1.559353,-6.119317 -3.430577,-5.099431c-1.559353,1.019886 -2.183095,-1.69981 -1.247483,-7.139203c0.935612,-4.759469 0.623741,-8.839013 -0.935612,-8.839013c-4.98993,0 -1.871224,35.696015 3.742448,46.234837c3.430577,5.779355 5.925543,15.298292 5.925543,21.417609c0,5.779355 0.935612,10.538823 1.871224,10.538823c0.935612,0 1.559353,-5.779355 1.247483,-12.578595l-0.000001,0zm-1904.906006,-9.518937c-1.871224,-17.338064 -4.98993,-16.65814 -8.420508,1.019886c-1.871224,10.198861 -1.559353,11.218747 3.742448,10.198861c4.054318,-1.019886 5.301801,-3.739583 4.67806,-11.218747zm4.67806,-22.777457c-0.935612,-2.719696 -1.871224,-1.69981 -1.871224,2.039772c-0.31187,3.739583 0.623741,5.779355 1.559353,4.419507c0.935612,-1.019886 1.247483,-4.079545 0.31187,-6.459279l0.000001,0zm1863.427207,-37.395824c-2.183095,-2.379734 -3.742448,-2.719696 -3.742448,-0.679924c0,4.759469 3.742448,8.839013 5.925543,6.459279c0.623741,-1.019886 -0.31187,-3.739583 -2.183095,-5.779355zm10.291732,-6.119317c0.935612,-1.69981 0.31187,-3.399621 -1.247483,-3.399621c-1.871224,0 -3.430577,1.69981 -3.430577,3.399621c0,2.039772 0.623741,3.399621 1.247483,3.399621c0.935612,0 2.494965,-1.359848 3.430577,-3.399621zm-1826.002728,-151.62307c6.237413,-6.119317 8.420508,-9.858899 6.237413,-11.558709c-2.183095,-1.359848 0,-4.079545 5.925543,-6.459279c4.98993,-2.379734 9.979861,-6.799241 11.227344,-9.858899c1.559353,-4.759469 2.183095,-4.759469 4.67806,-0.679924c1.871224,3.059659 3.118707,3.399621 3.118707,1.019886c0,-5.099431 19.024111,-24.817229 24.325912,-24.817229c1.871224,0 3.742448,-3.399621 4.054318,-7.479165c0.31187,-7.479165 0.31187,-7.479165 2.806836,0.679924c1.559353,5.779355 2.494965,6.459279 2.806836,2.719696c0.31187,-3.399621 1.559353,-6.119317 3.118707,-6.119317c1.559353,0 3.742448,-3.739583 4.67806,-8.499051c1.247483,-4.759469 3.742448,-8.499051 6.237413,-8.499051c2.183095,0 7.173025,-3.059659 10.915473,-6.459279c5.925543,-5.779355 15.905404,-11.898671 64.245356,-40.11552c23.078429,-13.598481 32.434549,-18.017988 38.671962,-18.017988c13.098568,0 47.09247,-23.797342 47.09247,-32.976318c0,-1.019886 -6.237413,-7.819127 -14.03418,-15.298292c-7.796766,-7.479165 -13.410438,-14.618368 -12.474826,-15.978216c0.623741,-1.69981 -0.623741,-5.779355 -3.118707,-9.178975c-3.430577,-5.099431 -4.36619,-5.439393 -4.67806,-1.359848c0,4.079545 -0.623741,4.419507 -2.806836,0.339962c-3.118707,-5.099431 -25.261524,-2.379734 -25.261524,3.059659c0,4.419507 -161.237132,4.419507 -162.796486,0c-0.623741,-2.039772 -11.539215,-4.419507 -24.325912,-5.099431c-12.786697,-1.019886 -29.003972,-3.059659 -35.865127,-5.099431c-6.861155,-1.69981 -17.152886,-3.399621 -22.766559,-3.399621c-6.237413,0 -9.667991,-1.359848 -8.420508,-3.399621c0.935612,-1.69981 1.559353,-3.399621 0.935612,-3.739583c-0.623741,0 -7.173025,-1.019886 -14.969791,-2.039772c-7.796766,-1.019886 -14.657921,-3.059659 -15.593533,-4.419507c-0.935612,-1.359848 -9.667991,-3.399621 -19.335981,-4.759469c-9.979861,-1.359848 -18.088498,-4.079545 -18.088498,-5.779355c0,-1.69981 -6.237413,-3.059659 -13.722309,-3.059659c-8.108638,0 -15.905404,-2.039772 -18.71224,-5.099431c-2.494965,-3.059659 -10.291732,-5.099431 -18.088498,-5.099431c-7.484896,0 -14.969791,-1.359848 -16.841016,-3.399621c-4.98993,-5.439393 -70.170899,-5.099431 -73.289606,0.339962c-4.67806,7.819127 -3.118707,20.057761 2.183095,20.057761c2.806836,0 4.36619,2.039772 3.430577,4.419507c-0.623741,2.039772 2.494965,9.518937 7.173025,15.978216c4.67806,6.459279 9.667991,15.638254 10.915473,20.397723l2.806836,8.499051l2.183095,-8.499051c1.871224,-7.819127 2.183095,-7.479165 2.494965,3.059659c0.31187,7.479165 3.430577,15.298292 9.667991,23.117419c4.98993,6.119317 9.35612,12.918557 9.35612,14.95833c0,2.039772 1.247483,2.379734 3.118707,1.359848c1.559353,-1.019886 3.118707,1.019886 3.118707,4.759469c0,4.079545 1.559353,7.139203 3.118707,7.139203c1.871224,0 3.118707,1.69981 3.118707,3.739583c0,2.379734 4.054318,8.839013 9.35612,14.618368c4.98993,5.779355 13.410438,15.978216 18.71224,22.437495c5.925543,7.479165 8.732378,9.518937 7.484896,5.099431c-1.559353,-5.099431 -0.31187,-4.419507 4.67806,2.719696c3.742448,5.099431 9.044249,9.178975 11.227344,9.178975c2.494965,0 5.301801,1.69981 6.549283,4.079545c1.559353,2.719696 0,3.059659 -5.301801,1.69981l-7.484896,-2.039772l7.484896,6.799241c4.054318,3.399621 9.979861,6.459279 13.098568,6.459279c3.742448,0 7.173025,3.399621 9.044249,8.499051c1.559353,4.759469 5.613672,9.518937 8.420508,10.878785c3.118707,1.019886 11.851085,6.799241 19.647851,12.578595c7.796766,5.779355 14.969791,10.198861 16.529145,9.518937c1.247483,-0.339962 2.183095,2.379734 2.183095,5.779355c0,4.759469 3.118707,7.139203 10.291732,8.839013c5.301801,1.359848 11.851085,4.079545 14.03418,5.779355c2.494965,2.719696 3.742448,2.039772 3.742448,-1.69981c0,-2.719696 -1.871224,-6.119317 -3.742448,-6.799241c-2.806836,-1.359848 -2.494965,-2.039772 0.623741,-2.039772c2.494965,-0.339962 6.237413,2.719696 7.796766,6.799241c3.118707,7.139203 7.173025,9.858899 32.746419,22.777457c18.71224,9.178975 22.766559,9.178975 34.305773,-1.359848l0.000001,0l0,-0.000001zm148.138564,-247.832327c6.861155,-2.379734 16.841016,-3.399621 22.142817,-2.719696c9.667991,1.69981 19.024111,-5.439393 11.227344,-8.499051c-2.183095,-0.679924 -3.742448,-2.719696 -3.742448,-4.419507c0,-1.69981 -9.667991,-13.598481 -21.830946,-26.517039c-11.851085,-12.918557 -21.830946,-25.497153 -21.830946,-27.536925c0,-2.039772 -3.430577,-7.479165 -7.796766,-11.898671c-4.054318,-4.759469 -8.420508,-14.278406 -9.667991,-21.417609c-2.183095,-14.278406 -12.474826,-34.676128 -17.464757,-34.676128c-1.871224,0 -2.494965,-2.379734 -1.247483,-5.099431c0.935612,-2.719696 0,-4.759469 -2.183095,-4.079545c-2.183095,0.339962 -4.054318,-4.419507 -4.67806,-12.238633c-0.623741,-6.799241 -2.183095,-11.898671 -3.430577,-11.218747c-1.247483,1.019886 -4.054318,0.339962 -6.549283,-1.69981c-3.430577,-2.039772 -3.742448,-3.059659 -0.623741,-3.059659c2.183095,0 3.118707,-1.69981 2.183095,-3.399621c-1.247483,-2.039772 -3.430577,-2.719696 -4.98993,-1.69981c-1.559353,1.359848 -4.36619,-2.039772 -6.237413,-7.479165c-1.559353,-5.099431 -4.054318,-10.198861 -5.301801,-11.218747c-4.36619,-3.399621 -9.979861,-16.998102 -10.291732,-24.477266c0,-4.419507 -0.935612,-5.779355 -1.871224,-3.399621c-2.183095,5.779355 -7.173025,5.099431 -7.173025,-1.019886c0,-2.379734 -2.183095,-6.119317 -4.98993,-7.819127c-3.742448,-2.039772 -4.67806,-6.119317 -3.742448,-12.238633c0.935612,-4.759469 0.31187,-8.839013 -0.935612,-8.839013c-1.559353,0 -2.806836,-4.419507 -2.806836,-9.858899c0,-8.499051 -0.935612,-9.858899 -6.861155,-8.499051c-4.054318,0.679924 -5.301801,0.679924 -3.118707,-0.679924c1.871224,-1.019886 3.742448,-4.759469 3.742448,-8.499051c0,-5.439393 -2.183095,-6.459279 -15.593533,-6.459279c-10.915473,0 -15.281663,1.359848 -14.657921,4.419507c0.31187,2.379734 -1.871224,3.739583 -5.613672,3.399621c-9.667991,-1.359848 -23.702171,2.719696 -21.519076,6.119317c0.935612,1.69981 -1.247483,3.059659 -4.67806,3.059659c-3.430577,0 -8.108638,2.379734 -10.915473,5.099431c-2.806836,3.059659 -10.291732,5.099431 -19.024111,5.099431c-9.667991,0 -14.657921,1.69981 -15.905404,5.099431c-1.247483,2.719696 -5.301801,5.099431 -9.35612,5.099431c-4.054318,0 -7.484896,1.359848 -7.484896,3.059659c0,1.69981 -4.36619,4.079545 -9.35612,5.439393c-4.98993,1.359848 -9.35612,4.079545 -9.35612,6.459279c0,2.719696 -3.742448,3.739583 -10.915473,2.719696c-7.796766,-1.019886 -11.227344,0 -12.786697,4.079545c-0.935612,3.059659 -5.301801,5.439393 -9.35612,5.439393c-4.67806,0 -7.484896,2.039772 -7.484896,5.099431c0,4.419507 -5.613672,6.799241 -13.098568,5.439393c-1.559353,0 -2.494965,2.039772 -2.494965,4.759469c0,3.059659 -2.806836,5.099431 -7.796766,5.099431c-4.36619,0 -7.796766,1.019886 -7.796766,2.719696c0,1.359848 -7.173025,6.119317 -15.593533,10.538823c-8.732378,4.419507 -19.024111,11.898671 -23.390299,16.65814c-4.36619,4.419507 -7.796766,7.479165 -7.796766,6.119317c0,-1.019886 -2.806836,1.019886 -6.237413,4.759469c-3.430577,3.739583 -6.237413,8.839013 -6.237413,10.878785c0,2.379734 -4.36619,4.759469 -9.35612,5.099431c-5.301801,0.339962 -13.722309,3.739583 -18.400369,7.819127c-4.98993,3.739583 -9.979861,6.799241 -11.227344,6.799241c-0.935612,0 -8.108638,6.459279 -15.593533,14.618368c-11.227344,11.218747 -14.03418,16.65814 -14.03418,25.497153c0,9.858899 0.935612,10.878785 6.237413,9.178975c7.173025,-2.379734 8.732378,3.399621 1.871224,6.119317c-2.806836,1.359848 -3.742448,4.759469 -2.806836,8.839013c1.871224,8.499051 12.162956,9.178975 34.305773,3.399621c10.603603,-3.059659 19.335981,-3.059659 36.176997,0c12.474826,2.379734 35.865127,6.459279 52.082401,9.518937c16.217274,2.719696 31.187066,7.139203 33.05829,9.858899c1.871224,2.379734 10.915473,5.439393 20.271593,6.799241c9.35612,1.019886 18.400369,4.419507 20.583464,7.479165c3.118707,4.079545 4.67806,4.419507 8.732378,0.679924c2.494965,-2.379734 4.67806,-2.719696 4.67806,-1.019886c0,4.759469 19.335981,11.218747 33.682032,11.218747c10.291732,0 12.474826,1.019886 11.227344,5.099431c-1.559353,4.079545 0.935612,5.099431 12.162956,5.099431c8.420508,0 16.217274,2.039772 19.024111,5.099431c5.613672,6.459279 34.929514,7.139203 37.112609,1.019886c0.935612,-3.399621 4.054318,-3.059659 12.786697,1.69981c6.237413,3.059659 14.969791,5.779355 19.024111,5.779355c4.36619,0 7.796766,1.69981 7.796766,3.399621c0,4.759469 78.903277,0.339962 95.120552,-5.099431l-0.000004,-0.000002l-0.000002,-0.000008z" id="svg_2" stroke-width="0" stroke="null"></path> <path d="m1386.286398,7360.440312c-0.935612,-1.019886 -21.207205,-3.739583 -45.221246,-5.779355c-68.611546,-5.439393 -78.903277,-6.459279 -78.903277,-9.518937c0,-1.69981 -9.35612,-3.739583 -20.895334,-5.099431c-29.003972,-3.059659 -53.953625,-8.499051 -53.953625,-11.898671c0,-1.359848 -4.67806,-3.399621 -9.979861,-4.419507c-24.325912,-4.759469 -30.251454,-6.799241 -28.692101,-9.518937c0.935612,-1.69981 -2.806836,-3.059659 -8.108638,-3.059659c-4.98993,0 -12.162956,-1.359848 -15.593533,-3.399621c-3.430577,-1.69981 -9.044249,-4.759469 -12.474826,-6.799241c-3.430577,-1.69981 -9.044249,-3.399621 -12.474826,-3.399621c-3.430577,0 -6.237413,-2.379734 -6.237413,-5.099431c0,-2.719696 -2.806836,-5.099431 -6.237413,-5.099431c-7.173025,0 -21.830946,-6.799241 -27.444619,-12.578595c-2.183095,-2.379734 -7.484896,-5.439393 -11.851085,-6.459279c-4.054318,-1.019886 -7.484896,-3.399621 -7.484896,-5.099431c0,-1.69981 -3.742448,-3.059659 -8.108638,-3.059659c-4.36619,0 -7.173025,-1.359848 -5.925543,-3.399621c0.935612,-1.69981 0,-3.399621 -2.494965,-3.399621c-5.925543,0 -24.014041,-10.198861 -24.014041,-13.258519c0,-1.359848 -5.613672,-5.439393 -12.474826,-8.839013c-7.173025,-3.399621 -16.841016,-11.218747 -21.830946,-17.678026c-4.98993,-6.119317 -10.603603,-11.218747 -12.474826,-11.218747c-1.559353,0 -3.118707,-1.359848 -3.118707,-3.399621c0,-1.69981 -1.871224,-3.399621 -3.742448,-3.399621c-2.183095,0 -7.484896,-4.759469 -11.539215,-10.198861c-4.054318,-5.779355 -9.044249,-10.198861 -11.539215,-10.198861c-2.494965,0 -4.36619,-1.359848 -4.36619,-3.059659c0,-2.039772 -8.420508,-12.918557 -18.71224,-24.477266c-10.291732,-11.558709 -18.71224,-23.797342 -18.71224,-27.196963c0,-3.739583 -1.871224,-6.459279 -4.054318,-6.459279c-2.183095,0 -7.173025,-6.119317 -11.227344,-13.598481c-3.742448,-7.479165 -7.796766,-13.598481 -9.044249,-13.598481c-1.247483,0 -4.054318,-5.099431 -6.549283,-10.878785c-2.494965,-6.119317 -5.301801,-11.898671 -6.237413,-12.918557c-3.742448,-3.399621 -9.667991,-16.998102 -9.667991,-22.097533c0,-2.719696 -2.183095,-5.099431 -4.67806,-5.099431c-2.494965,0 -4.67806,-2.719696 -4.67806,-6.459279c0,-3.399621 -2.183095,-8.159089 -4.67806,-10.538823c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.379734 -2.183095,-5.439393 -4.67806,-6.459279c-2.494965,-1.359848 -4.67806,-4.079545 -4.67806,-6.799241c0,-2.719696 -1.247483,-4.759469 -3.118707,-4.759469c-1.559353,0 -3.118707,-3.059659 -3.118707,-7.139203c0,-3.739583 -1.247483,-5.779355 -3.118707,-4.759469c-1.559353,1.019886 -3.118707,-0.339962 -3.118707,-3.399621c0,-3.059659 -2.806836,-8.499051 -6.237413,-12.578595c-3.430577,-4.079545 -6.237413,-9.518937 -6.237413,-11.898671c0,-2.379734 -1.247483,-4.419507 -2.806836,-4.419507c-1.559353,0 -3.430577,-3.399621 -4.67806,-7.819127c-0.935612,-4.079545 -4.36619,-10.878785 -7.796766,-14.95833c-8.732378,-9.858899 -19.024111,-30.596584 -19.024111,-37.395824c0,-3.059659 -0.935612,-4.759469 -1.871224,-3.399621c-2.494965,2.719696 -23.078429,-39.775558 -23.078429,-46.914762c0,-3.059659 -2.183095,-6.119317 -4.67806,-7.139203c-2.494965,-1.359848 -4.67806,-5.099431 -4.67806,-8.499051c0,-3.399621 -1.247483,-6.459279 -3.118707,-6.459279c-1.559353,0 -3.118707,-1.69981 -3.118707,-3.399621c0,-2.039772 -2.806836,-10.198861 -6.237413,-17.678026c-3.430577,-7.819127 -6.237413,-17.678026 -6.237413,-21.757571c0,-4.419507 -1.559353,-8.839013 -3.118707,-9.858899c-1.871224,-1.019886 -3.118707,-7.139203 -3.118707,-13.598481c0,-6.119317 -1.247483,-11.898671 -2.494965,-12.578595c-4.054318,-1.69981 -16.217274,-73.091838 -16.217274,-94.509447c0,-10.198861 -2.183095,-33.996204 -4.67806,-52.694116c-5.301801,-39.095634 -5.925543,-108.447891 -1.247483,-130.885385c1.871224,-8.499051 4.36619,-29.916659 5.925543,-47.594686c2.806836,-30.596584 6.549283,-61.533129 11.227344,-94.169485c1.247483,-8.159089 3.430577,-14.618368 4.67806,-14.618368c1.559353,0 2.806836,-3.399621 2.806836,-7.479165c0,-7.479165 6.549283,-30.256622 9.35612,-33.31628c0.935612,-1.019886 3.742448,-8.499051 5.925543,-16.998102c4.98993,-19.717799 10.603603,-33.996204 13.410438,-33.996204c0.935612,0 3.430577,-5.099431 5.613672,-11.558709c1.871224,-6.459279 6.861155,-15.978216 10.915473,-21.077647c4.36619,-5.439393 7.796766,-11.898671 7.796766,-13.938444c0,-2.379734 1.559353,-4.419507 3.118707,-4.419507c1.871224,0 3.118707,-2.039772 3.118707,-4.419507c0,-2.719696 2.806836,-7.479165 6.237413,-10.878785c3.430577,-3.399621 6.237413,-8.159089 6.237413,-10.878785c0,-2.379734 1.871224,-4.419507 4.36619,-4.419507c2.183095,0 5.925543,-4.419507 8.108638,-10.198861c2.183095,-5.439393 4.98993,-9.178975 6.549283,-8.159089c1.559353,1.019886 2.806836,0 2.806836,-2.039772c0,-2.379734 4.67806,-8.839013 10.291732,-14.618368c5.301801,-5.439393 9.667991,-11.558709 9.35612,-13.258519c-0.623741,-1.359848 0,-2.719696 1.559353,-2.719696c1.247483,0 6.549283,-4.079545 11.539215,-8.839013c5.301801,-4.759469 13.098568,-11.218747 18.088498,-14.278406c4.67806,-3.059659 8.420508,-7.139203 8.732378,-9.178975c0,-1.69981 13.098568,-10.198861 29.003972,-18.697912c15.905404,-8.499051 28.38023,-16.318178 27.756489,-17.678026c-0.623741,-1.69981 1.247483,-2.719696 4.054318,-2.719696c6.861155,0 27.132747,-7.479165 29.315842,-10.878785c0.935612,-1.359848 7.484896,-4.759469 14.03418,-7.479165c6.861155,-2.379734 12.162956,-6.459279 11.851085,-8.499051c-0.623741,-2.039772 3.118707,-3.739583 8.108638,-3.739583c5.301801,0 10.291732,-1.69981 11.227344,-3.399621c0.935612,-2.039772 5.301801,-3.399621 9.35612,-3.399621c4.054318,0 8.420508,-1.359848 9.35612,-3.399621c0.935612,-1.69981 5.301801,-3.399621 9.667991,-3.399621c4.054318,0 7.484896,-1.359848 7.484896,-3.059659c0,-2.719696 13.410438,-5.099431 59.255426,-10.198861c12.786697,-1.359848 22.142817,-3.059659 20.271593,-3.739583c-1.559353,-0.339962 2.494965,-2.039772 9.35612,-3.399621c6.861155,-1.359848 20.583464,-5.099431 30.563325,-8.159089c9.979861,-3.059659 22.142817,-5.439393 27.132747,-5.439393c4.67806,0 9.35612,-1.69981 9.979861,-4.079545c1.247483,-3.739583 11.851085,-5.439393 64.245356,-11.558709c10.915473,-1.359848 18.088498,-3.399621 15.905404,-5.099431c-2.183095,-1.359848 5.301801,-3.399621 16.217274,-4.419507c39.607574,-3.739583 54.265495,-5.779355 60.502909,-8.839013c3.430577,-1.359848 37.73635,-5.439393 76.408312,-8.839013c87.011915,-7.819127 362.393709,-10.878785 425.703454,-5.099431c86.076303,8.159089 102.293577,10.198861 104.164801,13.258519c0.935612,1.69981 6.549283,4.079545 12.162956,5.439393c25.261524,5.439393 28.692101,6.459279 28.692101,8.839013c0,1.69981 4.054318,3.739583 9.044249,5.099431c4.98993,1.019886 15.593533,6.459279 23.390299,12.238633c8.108638,5.439393 15.593533,9.858899 16.841016,9.858899c1.247483,0 4.36619,3.059659 6.861155,6.799241c2.494965,3.739583 5.925543,6.799241 7.796766,6.799241c4.054318,0 13.722309,9.858899 20.271593,20.397723c2.494965,4.419507 7.796766,10.878785 11.539215,14.618368c3.742448,3.739583 10.915473,13.258519 15.593533,20.737685c4.67806,7.819127 11.227344,16.318178 14.03418,19.377837c3.118707,3.059659 5.613672,7.139203 5.613672,9.518937c0,2.039772 1.559353,3.739583 3.118707,3.739583c1.871224,0 3.118707,3.059659 3.118707,6.799241c0,3.739583 1.871224,6.799241 4.054318,6.799241c1.871224,0 7.173025,8.159089 11.539215,18.017988c4.36619,9.518937 8.732378,18.35795 9.667991,19.377837c0.935612,1.019886 3.430577,7.139203 5.925543,13.598481c2.494965,6.459279 4.98993,12.578595 6.237413,13.598481c3.118707,3.059659 9.35612,20.737685 9.35612,27.196963c0,3.399621 0.935612,6.799241 2.494965,7.479165c1.247483,0.679924 6.237413,12.578595 11.227344,26.517039c4.98993,13.938444 9.979861,26.177077 11.227344,27.196963c1.247483,1.019886 3.118707,6.459279 4.054318,11.898671c2.806836,16.318178 7.796766,34.336166 8.420508,30.596584c0.31187,-1.69981 3.118707,7.479165 6.237413,20.397723c3.118707,13.258519 8.420508,33.656242 11.851085,45.894875c3.430577,12.238633 8.108638,30.596584 9.979861,40.795444c2.183095,10.198861 5.301801,22.437495 7.484896,26.857001c4.67806,11.218747 4.054318,212.136313 -0.935612,213.836123c-1.871224,0.679924 -3.430577,5.439393 -3.430577,10.198861c0,14.618368 -9.35612,60.173281 -12.786697,61.193167c-1.559353,0.679924 -2.806836,6.799241 -2.806836,13.598481c0,11.898671 -4.36619,30.596584 -9.667991,42.155293c-1.559353,3.399621 -2.806836,9.858899 -2.806836,14.618368c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,3.739583 -3.118707,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,4.759469 -3.118707,10.198861c0,5.779355 -0.935612,10.198861 -2.494965,10.198861c-1.247483,0 -4.054318,6.119317 -5.925543,13.598481c-3.430577,11.558709 -9.35612,26.177077 -24.014041,61.193167c-1.871224,4.759469 -4.054318,9.178975 -4.98993,10.198861c-3.742448,4.079545 -9.35612,17.338064 -9.35612,21.757571c0,2.719696 -0.935612,5.439393 -2.183095,6.119317c-3.430577,1.359848 -16.529145,29.576697 -16.529145,35.356052c0,2.719696 -2.183095,4.759469 -4.67806,4.759469c-2.494965,0 -4.67806,3.059659 -4.67806,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,3.059659 -3.118707,6.799241c0,3.739583 -1.247483,6.799241 -3.118707,6.799241c-1.559353,0 -3.118707,2.379734 -3.118707,5.099431c0,2.719696 -1.247483,5.099431 -3.118707,5.099431c-1.559353,0 -3.118707,2.379734 -3.118707,5.439393c0,3.059659 -2.494965,8.159089 -5.613672,11.218747c-2.806836,3.059659 -7.484896,10.198861 -9.979861,15.638254c-2.494965,5.779355 -7.173025,13.258519 -10.603603,17.338064c-3.118707,4.079545 -5.613672,8.159089 -5.301801,9.518937c0.623741,2.379734 -3.118707,7.479165 -14.346051,20.737685c-4.054318,4.419507 -7.173025,9.858899 -7.173025,11.898671c0,2.039772 -1.247483,2.719696 -3.118707,1.69981c-1.559353,-1.019886 -3.118707,0 -3.118707,2.719696c0,2.719696 -3.118707,8.499051 -6.861155,13.258519c-4.054318,4.419507 -10.603603,13.938444 -14.969791,20.737685c-4.36619,6.799241 -8.732378,12.578595 -9.979861,12.578595c-1.559353,0 -2.494965,2.039772 -2.494965,4.419507c0,2.039772 -5.613672,10.198861 -12.474826,17.338064c-6.861155,7.479165 -12.474826,14.95833 -12.474826,16.998102c0,3.739583 -68.611546,76.831421 -72.353994,76.831421c-1.247483,0 -9.35612,5.439393 -17.776628,11.898671c-8.108638,6.459279 -16.529145,11.898671 -18.71224,11.898671c-1.871224,0 -3.430577,1.69981 -3.430577,3.399621c0,2.039772 -1.871224,3.399621 -4.36619,3.399621c-2.183095,0 -5.925543,2.379734 -8.108638,5.099431c-2.183095,2.719696 -4.98993,4.079545 -6.549283,3.059659c-1.559353,-1.019886 -2.806836,0 -2.806836,1.69981c0,2.039772 -3.742448,3.739583 -8.108638,3.739583c-4.36619,0 -7.173025,1.359848 -6.237413,3.059659c0.935612,1.359848 -4.054318,4.759469 -10.915473,7.139203c-6.861155,2.719696 -13.410438,6.119317 -14.657921,8.159089c-4.36619,7.139203 -19.647851,12.918557 -46.468728,18.017988c-5.613672,1.019886 -10.291732,3.059659 -10.291732,4.759469c0,1.69981 -3.430577,3.059659 -7.484896,3.059659c-4.36619,0 -8.732378,1.69981 -9.667991,3.399621c-0.935612,2.039772 -6.549283,3.399621 -12.162956,3.399621c-5.301801,0 -11.539215,1.69981 -13.410438,3.739583c-1.559353,1.69981 -16.217274,5.439393 -32.122678,8.159089c-15.905404,2.719696 -29.939584,6.119317 -30.875196,7.819127c-2.183095,4.079545 -24.949653,6.799241 -89.19501,10.878785c-80.774502,5.099431 -158.742167,7.479165 -161.237132,5.099431l-0.000002,0.000005l0.000008,0.000001zm202.092189,-176.100336c8.732378,-0.339962 18.088498,-2.719696 20.583464,-5.099431c3.430577,-3.059659 17.152886,-4.079545 47.404341,-3.739583c41.790669,0.339962 47.09247,-0.339962 47.09247,-7.819127c0,-2.039772 5.925543,-6.119317 13.410438,-8.499051c10.603603,-4.079545 13.098568,-6.459279 13.098568,-13.258519c0,-4.759469 1.247483,-7.819127 2.806836,-6.799241c1.559353,1.359848 3.430577,1.019886 4.054318,-0.679924c0.31187,-1.359848 6.861155,-7.479165 14.346051,-13.938444c7.484896,-6.119317 12.786697,-11.898671 12.474826,-12.578595c-1.871224,-1.69981 -47.404341,-11.558709 -54.577366,-11.558709c-4.054318,0 -7.173025,-1.359848 -7.173025,-3.059659c0,-2.719696 -3.430577,-3.739583 -31.810807,-9.178975c-6.549283,-1.019886 -11.851085,-3.059659 -11.851085,-4.419507c0,-1.359848 -4.98993,-4.419507 -10.915473,-6.799241c-5.925543,-2.379734 -12.786697,-6.119317 -14.969791,-8.159089c-5.613672,-5.779355 -17.152886,-12.578595 -21.207205,-12.578595c-4.36619,0 -12.162956,-8.499051 -12.162956,-13.258519c0,-2.039772 -1.559353,-3.739583 -3.118707,-3.739583c-1.871224,0 -4.98993,-3.739583 -6.861155,-8.499051c-1.871224,-4.759469 -5.301801,-8.499051 -7.484896,-8.499051c-2.183095,0 -5.925543,-3.399621 -7.796766,-7.479165c-2.183095,-4.419507 -6.237413,-10.198861 -9.35612,-13.258519c-3.118707,-3.059659 -4.98993,-6.119317 -4.36619,-7.139203c0.935612,-1.019886 -0.31187,-3.739583 -3.118707,-6.119317c-2.494965,-2.379734 -4.67806,-6.459279 -4.67806,-9.178975c0,-2.719696 -1.247483,-3.739583 -3.118707,-2.719696c-1.559353,1.019886 -3.118707,-0.679924 -3.118707,-4.079545c0,-3.399621 -2.806836,-9.858899 -5.925543,-14.278406l-5.613672,-7.819127l-4.98993,13.938444c-2.806836,7.479165 -6.861155,13.938444 -9.044249,13.938444c-1.871224,0 -2.494965,1.019886 -1.559353,2.379734c2.494965,2.379734 -11.227344,29.576697 -20.271593,39.775558c-3.118707,3.739583 -5.613672,8.159089 -5.613672,9.858899c0,1.69981 -2.494965,5.779355 -5.301801,8.839013c-3.118707,3.059659 -10.603603,12.238633 -16.529145,20.737685c-10.603603,15.298292 -23.078429,27.876887 -26.509006,27.196963c-0.935612,-0.339962 -5.925543,4.419507 -10.915473,10.198861c-4.67806,5.439393 -10.915473,10.198861 -13.722309,10.198861c-2.806836,0 -4.98993,1.69981 -4.98993,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.118707,0 -6.549283,2.379734 -7.796766,5.099431c-0.935612,2.719696 -4.98993,5.099431 -9.044249,5.099431c-9.667991,0 -21.519076,12.238633 -20.271593,21.417609c0.935612,6.459279 17.152886,18.35795 32.434549,23.797342c3.430577,1.359848 11.539215,4.759469 18.400369,7.819127c24.325912,10.878785 35.241385,11.558709 165.603322,7.139203l-0.000003,-0.000002l0.000001,0.000002zm-224.858748,-126.125917c3.430577,-1.359848 9.979861,-4.079545 14.657921,-6.119317c4.67806,-2.039772 7.796766,-4.759469 6.861155,-6.459279c-0.935612,-1.69981 -0.31187,-3.059659 1.559353,-3.059659c4.054318,0 31.498937,-29.576697 31.498937,-33.996204c0,-2.039772 2.183095,-3.399621 4.67806,-3.399621c4.054318,0 5.301801,-2.039772 4.36619,-8.839013c0,-1.019886 2.494965,-4.419507 5.613672,-7.479165c3.118707,-3.059659 7.484896,-9.858899 9.979861,-14.95833c2.494965,-5.439393 5.613672,-9.518937 7.173025,-9.518937c1.247483,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 1.247483,-5.099431 3.118707,-5.099431c1.559353,0 5.301801,-5.099431 7.796766,-10.878785c2.806836,-6.119317 8.108638,-17.338064 11.851085,-25.157191c3.742448,-7.479165 9.35612,-20.397723 12.474826,-28.896773c3.118707,-8.159089 6.861155,-17.678026 8.732378,-20.737685c1.559353,-3.399621 2.806836,-11.558709 2.806836,-18.017988c0,-6.459279 1.559353,-11.898671 3.118707,-11.898671c1.871224,0 3.118707,-21.077647 3.118707,-56.093736c0,-35.01609 -1.247483,-56.093736 -3.118707,-56.093736c-1.559353,0 -3.118707,-6.799241 -3.118707,-14.95833c0,-8.499051 -1.247483,-16.318178 -3.118707,-17.338064c-1.559353,-1.019886 -3.118707,-5.099431 -3.118707,-8.839013c0,-3.399621 -0.935612,-6.459279 -2.494965,-6.459279c-1.247483,0 -4.054318,-4.759469 -6.549283,-10.538823c-2.494965,-6.119317 -10.291732,-17.678026 -17.776628,-26.177077c-7.484896,-8.499051 -13.722309,-16.65814 -13.722309,-18.35795c0,-1.359848 -1.247483,-2.719696 -3.118707,-2.719696c-1.559353,0 -6.861155,-4.419507 -11.539215,-10.198861c-4.36619,-5.439393 -10.291732,-10.198861 -13.098568,-10.198861c-2.806836,0 -7.796766,-3.739583 -10.915473,-8.499051c-3.118707,-4.759469 -7.484896,-8.499051 -9.35612,-8.499051c-2.183095,0 -8.732378,-4.079545 -14.657921,-8.839013c-5.925543,-4.759469 -15.593533,-11.218747 -21.519076,-14.278406c-5.925543,-3.059659 -11.539215,-6.459279 -12.474826,-7.479165c-3.430577,-4.079545 -19.335981,-10.198861 -26.820877,-10.198861c-4.36619,0 -7.173025,-1.359848 -6.237413,-3.059659c6.861155,-11.558709 -130.050066,-13.938444 -146.267341,-2.379734c-4.054318,3.059659 -10.291732,5.439393 -13.722309,5.439393c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -5.925543,3.399621 -11.227344,3.399621c-4.98993,0 -9.044249,1.69981 -9.044249,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -4.67806,3.399621 -8.108638,3.399621c-3.118707,0 -5.925543,1.69981 -5.925543,3.399621c0,2.039772 -2.806836,3.399621 -6.237413,3.399621c-3.430577,0 -6.237413,1.359848 -6.237413,2.719696c0,1.69981 -5.613672,5.779355 -12.474826,9.178975c-13.098568,6.459279 -40.543186,33.656242 -40.543186,40.455482c0,2.039772 6.237413,9.858899 14.03418,17.338064c7.796766,7.479165 14.03418,15.298292 14.03418,18.017988c0,2.379734 4.67806,6.459279 10.603603,9.178975c5.613672,2.719696 11.227344,7.139203 12.162956,10.198861c1.247483,3.059659 5.925543,5.099431 11.227344,5.099431c6.861155,0 10.915473,2.719696 14.657921,8.499051c3.430577,5.779355 7.796766,8.499051 14.03418,8.499051c7.173025,0 9.667991,2.379734 13.722309,11.898671c2.806836,8.159089 7.796766,13.598481 14.969791,16.998102c5.925543,2.719696 11.539215,7.819127 12.474826,11.898671c2.183095,9.858899 7.484896,8.499051 13.098568,-3.399621c7.484896,-15.638254 14.03418,-12.578595 18.71224,8.159089c2.806836,11.898671 4.67806,13.598481 17.152886,17.678026c27.444619,9.178975 51.146788,4.079545 57.696073,-11.558709c1.559353,-4.079545 4.054318,-7.479165 5.301801,-7.479165c1.559353,0 2.494965,-2.379734 2.494965,-5.439393c0,-6.119317 7.484896,-14.95833 12.786697,-14.95833c1.871224,0 5.925543,-2.719696 8.732378,-5.779355c7.796766,-9.518937 18.088498,-14.618368 28.38023,-14.618368c5.613672,0 9.044249,-1.359848 7.796766,-3.399621c-3.430577,-6.119317 47.404341,-5.779355 52.706142,0.339962c1.871224,1.69981 5.613672,3.059659 8.732378,3.059659c7.173025,0 16.841016,5.779355 29.003972,17.678026c4.98993,5.439393 11.227344,9.518937 13.410438,9.518937c2.183095,0 3.430577,1.359848 2.183095,3.059659c-0.935612,1.69981 0.935612,5.779355 3.742448,9.178975c13.722309,14.618368 19.647851,35.696015 19.647851,69.692218c0,17.678026 -1.247483,33.656242 -2.494965,35.696015c-1.559353,1.69981 -5.301801,10.198861 -8.108638,19.377837c-3.118707,8.839013 -6.861155,15.298292 -8.420508,13.938444c-1.559353,-1.019886 -2.806836,0.679924 -2.806836,3.399621c0,3.059659 -4.98993,8.839013 -10.915473,12.918557c-5.925543,4.419507 -10.915473,9.518937 -10.915473,11.218747c0,2.039772 -6.549283,5.779355 -14.657921,8.159089c-8.420508,2.719696 -15.593533,6.119317 -16.529145,7.479165c-0.935612,1.359848 -14.346051,3.059659 -29.627713,3.739583c-28.068359,1.019886 -28.068359,1.019886 -27.132747,9.518937c0.623741,4.759469 2.494965,10.198861 4.054318,12.238633c1.871224,2.719696 -0.623741,5.779355 -8.108638,9.518937c-7.796766,4.079545 -10.915473,7.819127 -10.915473,13.598481c0,4.419507 -2.183095,9.858899 -4.67806,12.238633c-6.237413,5.779355 -5.925543,11.218747 1.559353,18.697912c3.430577,3.399621 6.237413,9.518937 6.237413,13.258519c0.31187,8.499051 6.861155,36.035977 9.979861,41.135407c2.183095,4.079545 13.410438,4.079545 22.766559,0.339962l0.000003,-0.000001l0.000004,0zm450.964978,-32.976318c4.98993,-5.779355 9.044249,-11.898671 9.044249,-13.598481c0,-1.69981 1.559353,-2.719696 3.742448,-2.039772c1.871224,0.339962 4.98993,-2.379734 6.861155,-6.119317c1.871224,-3.739583 7.173025,-13.938444 11.539215,-22.097533c4.36619,-8.499051 9.044249,-19.377837 10.291732,-24.477266c0.935612,-5.439393 4.054318,-9.518937 6.237413,-9.518937c2.806836,0 3.742448,-2.379734 2.806836,-6.799241c-0.935612,-4.419507 -4.36619,-6.799241 -9.044249,-6.799241c-4.054318,0 -7.484896,-1.359848 -7.484896,-3.399621c0,-1.69981 -2.183095,-3.399621 -4.67806,-3.399621c-2.494965,0 -4.67806,-1.359848 -4.67806,-3.059659c0,-1.69981 -2.806836,-4.079545 -5.925543,-5.439393c-8.732378,-3.059659 -34.617644,-30.936546 -34.617644,-37.395824c0,-3.059659 -1.247483,-4.759469 -2.806836,-3.739583c-3.118707,2.039772 -6.237413,-6.459279 -9.979861,-26.857001c-1.247483,-7.479165 -3.430577,-18.697912 -4.67806,-24.817229c-2.494965,-14.278406 9.044249,-65.272712 14.969791,-65.272712c1.247483,0 2.494965,-2.039772 2.494965,-4.419507c0,-6.459279 23.702171,-32.976318 29.315842,-32.976318c2.806836,0 4.98993,-1.359848 4.98993,-3.399621c0,-1.69981 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 3.430577,-3.399621 7.484896,-3.399621c4.36619,0 8.732378,-1.359848 9.667991,-3.399621c0.935612,-1.69981 13.722309,-3.399621 28.068359,-3.399621c14.346051,0 27.132747,1.69981 28.068359,3.399621c0.935612,2.039772 4.67806,3.399621 8.108638,3.399621c3.118707,0 5.925543,1.69981 5.925543,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.69981 4.67806,3.399621c0,2.039772 2.806836,3.399621 6.549283,3.399621c3.430577,0 5.301801,1.69981 4.36619,3.399621c-0.935612,2.039772 -0.623741,3.399621 1.247483,3.399621c4.054318,0 19.024111,16.318178 19.024111,20.397723c0,2.039772 1.247483,3.399621 2.806836,3.399621c2.494965,0 5.613672,7.819127 8.420508,21.417609c1.559353,6.799241 13.722309,22.437495 13.722309,17.338064c0,-1.69981 1.559353,-0.339962 3.430577,3.059659c4.36619,8.159089 8.420508,7.139203 9.667991,-2.719696c0.623741,-4.759469 2.183095,-8.499051 3.742448,-8.499051c1.559353,0.339962 4.36619,-3.059659 6.237413,-7.139203c3.430577,-7.479165 16.529145,-18.017988 27.756489,-22.097533c2.806836,-1.359848 5.301801,-4.079545 5.301801,-6.459279c0,-2.719696 2.806836,-5.439393 5.925543,-6.799241c11.227344,-3.739583 12.786697,-9.518937 7.796766,-27.876887c-2.494965,-9.518937 -6.861155,-19.377837 -9.35612,-21.417609c-2.183095,-2.379734 -4.36619,-7.139203 -4.36619,-10.878785c0,-3.399621 -4.67806,-11.558709 -10.291732,-17.678026c-5.613672,-6.119317 -12.786697,-16.65814 -15.905404,-23.457381c-2.806836,-7.139203 -6.549283,-12.578595 -8.108638,-12.578595c-1.871224,0 -3.118707,-2.039772 -3.118707,-4.759469c0,-2.379734 -4.054318,-9.178975 -9.35612,-14.95833c-4.98993,-6.119317 -9.35612,-12.238633 -9.35612,-14.278406c0,-2.039772 -6.549283,-10.198861 -14.346051,-18.35795c-22.142817,-22.777457 -25.885265,-25.837115 -30.875196,-25.837115c-2.494965,0 -4.67806,-1.019886 -4.67806,-2.719696c0,-4.079545 -29.627713,-17.678026 -38.360092,-17.678026c-4.36619,0 -10.291732,-2.379734 -13.098568,-5.439393c-4.36619,-4.759469 -13.410438,-5.779355 -64.245356,-5.439393c-32.434549,0.339962 -61.438521,1.69981 -64.557227,3.739583c-2.806836,1.69981 -16.529145,4.759469 -30.251454,7.139203c-13.722309,2.379734 -28.068359,6.459279 -31.810807,8.839013c-3.742448,2.719696 -11.227344,4.759469 -16.217274,4.759469c-4.98993,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -5.301801,3.399621 -9.667991,3.399621c-4.36619,0 -6.861155,1.359848 -5.925543,3.399621c1.247483,2.039772 -1.871224,3.399621 -7.484896,3.399621c-4.98993,0 -10.291732,1.69981 -11.227344,3.399621c-0.935612,2.039772 -4.36619,3.399621 -7.173025,3.399621c-2.806836,0 -10.291732,4.759469 -16.217274,10.198861c-5.925543,5.779355 -13.098568,10.878785 -15.905404,11.898671c-4.98993,1.69981 -18.400369,26.177077 -18.400369,33.656242c0,2.379734 -2.183095,8.839013 -4.67806,14.618368c-15.281663,33.31628 -23.078429,151.963032 -12.474826,190.03878c2.494965,9.178975 4.67806,21.077647 4.67806,26.517039c0,13.598481 6.549283,36.035977 9.667991,33.996204c1.559353,-1.019886 2.806836,1.359848 2.806836,5.439393c0,3.739583 1.247483,9.518937 2.806836,12.918557c1.559353,3.059659 4.36619,9.858899 6.237413,15.298292c7.173025,19.377837 10.915473,26.177077 21.830946,40.795444c6.237413,8.159089 14.03418,19.037874 17.464757,23.797342c3.430577,5.099431 7.796766,9.178975 9.979861,9.178975c2.183095,0 4.054318,1.69981 4.054318,3.399621c0,2.039772 2.183095,3.399621 4.67806,3.399621c2.494965,0 4.67806,1.69981 4.67806,3.399621c0,2.039772 1.871224,3.399621 4.36619,3.399621c2.494965,0 6.549283,2.039772 8.732378,4.419507c9.044249,9.178975 18.400369,12.238633 54.889236,18.017988c7.173025,1.359848 14.03418,3.739583 14.969791,5.099431c0.935612,1.69981 15.593533,3.059659 33.05829,3.059659c30.875196,0 31.187066,0 40.231315,-10.538823l0.000002,-0.000005l0.000005,-0.000001zm-553.882297,-247.832327c1.247483,-2.039772 -3.118707,-3.059659 -11.539215,-3.059659l-13.410438,0.679924l10.915473,2.379734c5.925543,1.359848 11.227344,2.719696 11.539215,3.059659c0.31187,0 1.559353,-1.019886 2.494965,-3.059659l0,0.000001zm879.163397,-124.086145c2.806836,-4.759469 6.549283,-7.819127 8.108638,-6.799241c1.871224,1.359848 3.118707,-0.679924 3.118707,-3.739583c0,-3.399621 1.247483,-10.538823 2.806836,-16.318178c8.420508,-30.596584 12.786697,-61.193167 12.786697,-86.010396l0,-28.216849l-10.915473,0c-5.925543,0 -10.915473,1.69981 -10.915473,3.399621c0,2.039772 -10.915473,3.399621 -26.509006,3.399621c-15.593533,0 -26.509006,-1.359848 -26.509006,-3.399621c0,-1.69981 -2.806836,-3.399621 -5.925543,-3.399621c-3.430577,0 -7.173025,-1.69981 -8.420508,-3.739583c-0.935612,-2.039772 -6.861155,-6.119317 -12.786697,-8.839013c-5.925543,-2.719696 -11.539215,-7.819127 -12.474826,-11.218747c-0.935612,-3.739583 -2.806836,-5.779355 -4.36619,-4.759469c-1.559353,0.679924 -4.36619,-1.359848 -6.549283,-5.439393c-2.183095,-3.739583 -4.98993,-6.799241 -6.237413,-6.799241c-4.054318,0 -17.464757,-16.65814 -24.637782,-30.596584c-3.742448,-7.479165 -8.108638,-13.598481 -9.667991,-13.598481c-1.247483,0 -2.494965,-2.379734 -2.494965,-5.099431c0,-5.099431 -5.925543,-18.697912 -9.667991,-22.097533c-6.861155,-6.119317 -12.162956,-127.145803 -6.237413,-133.605082c1.871224,-2.039772 3.430577,-7.479165 3.430577,-11.898671c0,-4.419507 1.247483,-6.799241 3.118707,-5.779355c1.871224,1.019886 3.118707,-1.019886 3.118707,-4.759469c0,-3.739583 1.559353,-7.819127 3.118707,-8.839013c1.871224,-1.019886 3.118707,-4.419507 3.118707,-7.479165c0,-11.558709 51.77053,-72.751876 70.170899,-82.610776c14.03418,-7.819127 13.410438,-18.017988 -2.806836,-45.894875c-7.796766,-12.918557 -15.593533,-25.497153 -17.464757,-27.876887c-1.559353,-2.379734 -3.118707,-5.779355 -3.118707,-7.819127c0,-1.69981 -1.247483,-3.399621 -3.118707,-3.399621c-1.559353,0 -3.118707,-2.379734 -3.118707,-5.099431c0,-2.719696 -1.871224,-5.099431 -4.36619,-5.099431c-2.494965,0 -5.301801,-3.059659 -6.549283,-6.459279c-0.935612,-3.739583 -8.108638,-12.918557 -15.593533,-20.397723c-7.796766,-7.819127 -14.03418,-15.638254 -14.03418,-17.338064c0,-1.69981 -3.430577,-4.079545 -7.796766,-5.439393c-4.36619,-1.019886 -7.796766,-3.399621 -7.796766,-4.759469c0,-1.359848 -4.67806,-5.099431 -9.979861,-8.159089c-5.613672,-3.059659 -12.474826,-7.139203 -14.969791,-8.839013c-2.494965,-1.359848 -16.529145,-6.119317 -31.187066,-10.538823c-14.657921,-4.079545 -29.315842,-8.499051 -32.746419,-10.198861c-12.786697,-5.439393 -73.601476,-7.479165 -243.259117,-7.139203c-175.895053,0 -258.540779,2.379734 -251.367754,7.139203c3.430577,2.379734 -75.784571,12.918557 -124.436394,16.318178c-11.227344,1.019886 -21.830946,3.059659 -23.702171,4.759469c-1.871224,1.69981 -14.03418,4.759469 -26.509006,6.799241c-39.607574,6.119317 -43.350022,7.139203 -43.350022,10.198861c0,1.69981 -5.613672,3.059659 -12.162956,3.059659c-6.861155,0 -13.410438,1.69981 -14.346051,3.399621c-0.935612,2.039772 -8.108638,3.399621 -15.905404,3.399621c-7.484896,0 -13.722309,1.359848 -13.722309,3.059659c0,1.359848 -6.549283,4.079545 -14.657921,5.099431c-26.509006,4.419507 -48.963694,8.499051 -63.933486,11.558709c-8.420508,1.69981 -14.969791,2.379734 -14.969791,1.69981c0,-0.679924 -3.118707,1.019886 -6.861155,3.739583c-3.742448,3.059659 -9.979861,5.439393 -14.03418,5.439393c-8.420508,0 -22.766559,6.799241 -22.766559,10.878785c0,1.359848 -2.806836,2.719696 -6.237413,2.719696c-3.430577,0 -6.237413,1.69981 -6.237413,3.399621c0,2.039772 -2.806836,3.399621 -5.925543,3.399621c-3.430577,0 -7.173025,1.69981 -8.108638,3.399621c-0.935612,2.039772 -6.861155,3.399621 -13.098568,3.399621c-6.237413,0 -10.291732,1.019886 -9.35612,2.379734c2.494965,2.379734 -11.851085,11.218747 -18.400369,11.218747c-2.494965,0 -5.301801,2.379734 -6.237413,5.099431c-1.247483,2.719696 -3.118707,4.079545 -4.67806,3.059659c-1.559353,-1.019886 -2.806836,1.359848 -2.806836,4.759469c0,3.739583 2.494965,7.479165 5.613672,8.839013c8.420508,3.059659 15.905404,9.178975 32.746419,26.857001c15.281663,15.978216 36.488867,45.554913 36.488867,50.654344c0,1.359848 4.054318,12.578595 9.35612,24.817229c4.98993,12.238633 9.35612,24.477266 9.35612,26.857001c0,2.379734 2.183095,10.538823 4.98993,17.678026c4.36619,10.878785 4.98993,21.077647 3.430577,57.453585c-0.935612,26.517039 -3.118707,44.535027 -4.98993,45.214951c-1.871224,0.679924 -3.430577,6.459279 -3.430577,12.578595c0,6.459279 -1.247483,12.578595 -3.118707,13.598481c-1.559353,1.019886 -3.118707,4.759469 -3.118707,8.159089c0,13.598481 -20.271593,48.614572 -39.607574,68.33237c-10.915473,11.218747 -20.895334,20.397723 -22.454688,20.397723c-1.559353,0 -3.430577,1.019886 -4.054318,2.719696c-1.871224,4.759469 -41.790669,24.477266 -49.899306,24.477266c-4.36619,0 -8.732378,1.69981 -9.35612,3.399621c-0.623741,2.379734 -14.346051,4.079545 -33.682032,4.419507c-33.05829,0.339962 -45.533117,-2.379734 -37.112609,-8.159089c3.430577,-2.379734 3.118707,-3.059659 -0.935612,-3.059659c-8.420508,0 -14.969791,3.739583 -14.969791,8.839013c0,2.719696 -2.494965,4.759469 -5.925543,4.759469c-4.98993,0 -5.301801,1.69981 -3.118707,16.998102c2.494965,16.998102 9.35612,32.296394 13.098568,28.556811c0.935612,-1.019886 3.742448,1.019886 5.925543,5.099431c2.183095,4.079545 6.549283,7.139203 9.667991,7.139203c3.118707,0 4.98993,1.359848 4.054318,3.059659c-4.98993,8.499051 71.730252,14.95833 81.086372,6.799241c1.871224,-1.69981 13.722309,-4.079545 26.509006,-5.099431c17.152886,-1.69981 26.820877,-0.679924 38.04822,3.399621c8.108638,3.059659 15.281663,5.439393 15.905404,5.439393c0.935612,0 6.549283,-5.439393 12.474826,-11.898671c6.237413,-6.459279 13.410438,-11.898671 16.217274,-11.898671c2.494965,0 3.742448,-1.359848 2.806836,-3.399621c-0.935612,-1.69981 -0.31187,-3.399621 1.871224,-3.399621c1.871224,0 5.925543,-2.719696 8.732378,-6.459279c2.806836,-3.399621 9.667991,-8.839013 15.281663,-11.898671c5.301801,-3.059659 9.979861,-7.139203 9.979861,-8.839013c0,-2.039772 2.806836,-3.399621 6.237413,-3.399621c3.430577,0 6.237413,-1.359848 6.237413,-3.399621c0,-1.69981 1.871224,-3.399621 4.054318,-3.399621c5.613672,0 20.895334,-8.159089 20.895334,-10.878785c0,-1.69981 2.806836,-2.719696 6.237413,-2.719696c5.925543,0 18.400369,-6.119317 21.830946,-10.538823c2.806836,-3.739583 43.038152,-16.65814 51.458659,-16.65814c4.67806,0 11.227344,-2.039772 14.969791,-4.079545c3.742448,-2.379734 19.959722,-5.099431 35.553255,-6.119317c15.905404,-1.019886 30.563325,-3.739583 32.122678,-5.439393c2.494965,-2.719696 1.247483,-7.479165 -4.36619,-16.65814c-4.36619,-7.139203 -8.108638,-14.278406 -8.108638,-15.638254c0,-1.69981 -2.183095,-3.059659 -4.67806,-3.059659c-2.494965,0 -4.67806,-1.69981 -4.67806,-3.739583c0,-2.039772 -2.183095,-5.779355 -4.67806,-8.499051c-2.494965,-3.059659 -4.67806,-8.159089 -4.67806,-11.558709c0,-3.399621 -1.247483,-7.139203 -2.806836,-8.499051c-4.36619,-2.719696 -12.786697,-22.097533 -12.786697,-29.236735c0,-3.059659 -1.247483,-6.459279 -3.118707,-7.139203c-9.044249,-3.399621 -10.603603,-68.672332 -1.871224,-78.531231c2.183095,-2.379734 5.925543,-9.178975 8.420508,-14.95833c2.183095,-6.119317 5.301801,-11.218747 6.549283,-11.218747c1.559353,0 2.494965,-1.69981 2.494965,-3.739583c0,-3.739583 14.03418,-18.697912 33.682032,-36.375938c5.925543,-5.099431 14.346051,-12.918557 18.71224,-17.678026c4.67806,-4.759469 12.786697,-10.878785 17.776628,-13.598481c5.301801,-2.719696 12.162956,-7.819127 15.281663,-10.878785c3.430577,-3.399621 7.796766,-6.119317 9.979861,-6.119317c2.183095,0 4.36619,-1.359848 4.98993,-2.719696c1.247483,-3.739583 30.563325,-21.077647 35.553255,-21.077647c2.494965,0 4.36619,-1.359848 4.36619,-3.399621c0,-1.69981 4.054318,-3.399621 9.044249,-3.399621c5.301801,0 10.291732,-1.359848 11.227344,-3.399621c0.935612,-2.039772 6.861155,-3.399621 12.786697,-3.399621c5.925543,0 10.603603,-1.359848 10.603603,-3.399621c0,-1.69981 3.430577,-3.399621 7.796766,-3.399621c4.36619,0 7.796766,-1.359848 7.796766,-3.059659c0,-1.69981 3.118707,-3.739583 7.173025,-4.759469c3.742448,-1.019886 14.657921,-4.759469 24.014041,-8.499051c9.35612,-3.739583 27.444619,-8.499051 39.919445,-10.878785c12.162956,-2.039772 21.830946,-5.439393 20.583464,-7.139203c-1.871224,-3.739583 146.267341,-4.079545 149.697918,-0.339962c1.247483,1.359848 19.335981,4.759469 40.231315,7.819127c43.350022,6.459279 53.018013,10.198861 77.343924,30.596584c28.068359,23.117419 57.384201,54.733888 63.933486,68.672332c2.494965,5.099431 5.925543,9.178975 7.484896,9.178975c1.871224,0 3.118707,2.039772 3.118707,4.419507c0,2.039772 4.36619,9.518937 9.35612,15.978216c4.98993,6.459279 9.35612,13.938444 9.35612,16.318178c0,2.039772 1.247483,4.079545 2.494965,4.079545c2.494965,0 13.410438,26.517039 17.776628,43.515141c1.247483,4.079545 3.430577,6.799241 4.98993,5.779355c1.559353,-1.359848 2.806836,11.898671 2.806836,31.956432c0,20.397723 -1.247483,34.336166 -3.118707,34.336166c-1.559353,0 -4.98993,5.439393 -7.484896,11.898671c-5.613672,14.278406 -33.370161,45.894875 -40.543186,45.894875c-2.806836,0 -4.98993,2.379734 -4.98993,5.099431c0,2.719696 -2.183095,5.099431 -4.67806,5.099431c-2.494965,0 -4.67806,1.69981 -4.67806,3.399621c0,2.039772 -1.871224,3.399621 -4.36619,3.399621c-3.430577,0 -9.979861,9.178975 -7.173025,10.538823c0.31187,0 14.657921,1.69981 31.810807,3.399621c35.241385,3.399621 67.052192,8.499051 62.374133,9.858899c-3.118707,1.019886 16.217274,5.779355 36.488867,9.178975c6.549283,1.019886 13.098568,3.739583 15.281663,6.459279c1.871224,2.719696 5.925543,4.759469 9.044249,4.759469c7.484896,0 31.810807,15.298292 29.003972,18.017988c-0.935612,1.359848 0.935612,2.379734 4.67806,2.379734c3.742448,0 6.861155,1.69981 6.861155,3.399621c0,2.039772 1.559353,3.399621 3.430577,3.399621c1.871224,0 4.98993,2.039772 7.173025,4.419507c2.183095,2.039772 7.796766,7.139203 12.162956,10.878785c4.67806,3.739583 8.420508,8.499051 8.420508,10.878785c0,2.379734 1.559353,4.419507 3.430577,4.419507c3.742448,0 21.519076,20.397723 21.519076,24.477266c0,1.359848 1.871224,4.419507 4.054318,6.799241c2.183095,2.379734 8.108638,10.538823 13.098568,18.017988c5.301801,7.479165 10.291732,14.278406 11.227344,15.298292c0.935612,1.019886 3.742448,6.799241 6.237413,12.918557c2.494965,5.779355 5.301801,10.878785 6.549283,10.878785c1.559353,0 2.494965,2.039772 2.494965,4.419507c0,7.819127 9.667991,27.196963 18.400369,37.055862c9.044249,10.198861 14.657921,8.839013 23.390299,-5.779355l0.000003,0l0.000007,0.000002zm-613.449593,-64.252826c6.861155,-16.65814 5.613672,-19.037874 -10.915473,-19.037874c-8.420508,0 -15.905404,1.019886 -17.152886,2.039772c-2.806836,3.399621 1.247483,11.558709 5.925543,11.558709c2.494965,0 4.36619,1.69981 4.36619,3.399621c0,5.099431 7.173025,12.918557 10.915473,12.578595c1.559353,-0.339962 4.67806,-5.099431 6.861155,-10.538823l-0.000001,0l-0.000001,0zm77.343924,-93.829523c0.935612,-1.69981 4.98993,-3.399621 9.044249,-3.399621c3.742448,0 12.474826,-2.719696 19.335981,-6.459279c6.549283,-3.399621 17.776628,-8.499051 24.637782,-10.878785c6.861155,-2.719696 13.722309,-6.799241 14.969791,-8.839013c1.247483,-2.379734 4.054318,-4.419507 6.237413,-4.419507c2.183095,0 7.796766,-3.739583 12.786697,-8.499051c4.98993,-4.759469 10.291732,-8.499051 11.851085,-8.499051c1.247483,0 2.494965,-2.379734 2.494965,-5.099431c0,-2.719696 1.559353,-5.099431 3.118707,-5.099431c1.871224,0 3.118707,-2.379734 3.118707,-5.439393c0,-2.719696 1.247483,-4.419507 2.494965,-3.399621c1.559353,1.019886 4.67806,-2.039772 6.861155,-6.459279c2.183095,-4.759469 4.98993,-8.499051 6.237413,-8.499051c0.935612,0 9.979861,-8.499051 19.959722,-18.697912c9.667991,-10.198861 19.024111,-18.697912 20.271593,-18.697912c1.247483,0 7.484896,-5.439393 13.722309,-11.898671c6.237413,-6.459279 13.098568,-11.898671 14.657921,-11.898671c1.871224,0 3.118707,-2.379734 3.118707,-5.099431c0,-3.059659 -2.806836,-5.099431 -7.484896,-5.099431c-4.36619,0 -8.732378,-1.359848 -9.667991,-3.399621c-0.935612,-1.69981 -8.732378,-3.399621 -17.152886,-3.399621c-8.420508,0 -16.217274,-1.359848 -17.152886,-3.399621c-0.935612,-1.69981 -13.722309,-3.399621 -27.756489,-3.399621c-14.346051,0 -33.370161,-1.69981 -42.41441,-3.399621c-9.35612,-2.039772 -51.77053,-3.739583 -94.808681,-3.739583c-43.038152,-0.339962 -74.848959,-1.69981 -70.482769,-3.059659c6.549283,-2.379734 5.613672,-2.719696 -5.301801,-3.059659c-7.484896,-0.339962 -13.410438,1.359848 -13.410438,3.059659c0,2.039772 -15.281663,3.399621 -39.607574,3.399621c-42.41441,0 -103.852931,6.459279 -103.852931,10.878785c0,1.359848 -4.98993,2.719696 -10.915473,2.719696c-5.925543,0 -10.915473,1.69981 -10.915473,3.399621c0,2.039772 -2.494965,3.399621 -5.301801,3.399621c-3.118707,0 -9.044249,3.059659 -13.410438,6.799241c-4.36619,3.739583 -10.603603,6.799241 -14.03418,6.799241c-3.430577,0 -10.915473,4.419507 -16.841016,9.858899c-9.35612,8.159089 -9.979861,10.198861 -6.861155,16.65814c1.871224,4.079545 4.98993,7.479165 6.549283,7.479165c1.871224,0 3.118707,2.379734 3.118707,5.099431c0,2.719696 1.559353,5.099431 3.430577,5.099431c1.559353,0 2.494965,1.359848 1.559353,2.719696c-0.935612,1.69981 3.118707,8.499051 9.044249,15.298292c5.925543,7.139203 10.915473,13.938444 10.915473,15.298292c0,4.419507 9.35612,14.618368 21.207205,23.797342c15.905404,12.238633 50.834918,31.276508 57.072331,31.276508c3.430577,0 5.925543,1.69981 5.925543,3.399621c0,2.039772 5.301801,3.399621 11.851085,3.399621c6.237413,0 13.722309,1.69981 16.217274,3.399621c6.549283,4.419507 183.068079,4.419507 185.563044,0l0,0.000002l0.000002,0.000001zm-345.552694,-202.617376c-0.935612,-1.019886 -3.742448,-1.359848 -5.925543,-0.339962c-2.494965,1.019886 -1.559353,2.039772 1.871224,2.039772c3.430577,0.339962 5.301801,-0.679924 4.054318,-1.69981l0.000001,0zm10.291732,-8.159089c0,-1.69981 1.871224,-3.399621 4.36619,-3.399621c2.494965,0 9.667991,-2.719696 16.529145,-6.459279c16.217274,-8.499051 32.434549,-13.938444 42.41441,-13.938444c4.36619,0 9.35612,-2.039772 10.603603,-4.759469c2.806836,-5.099431 19.335981,-7.819127 67.987804,-10.878785c20.583464,-1.359848 29.003972,-3.059659 24.949653,-5.099431c-3.430577,-1.359848 34.617644,-2.719696 84.205079,-2.719696c49.899306,0 87.635656,1.359848 84.205079,2.719696c-3.742448,1.69981 11.227344,3.739583 37.42448,5.099431c35.865127,1.69981 106.347896,7.139203 110.090344,8.499051c0.623741,0.339962 0,2.039772 -0.935612,3.739583c-1.247483,2.039772 5.301801,3.399621 16.841016,3.399621c19.647851,0 24.325912,-4.419507 14.346051,-13.598481c-2.494965,-2.379734 -3.742448,-5.779355 -2.494965,-7.819127c0.935612,-2.039772 0.31187,-2.379734 -1.559353,-1.019886c-2.183095,1.359848 -5.301801,-1.019886 -7.484896,-6.119317c-1.871224,-4.759469 -4.67806,-8.839013 -5.925543,-8.839013c-1.247483,0 -5.301801,-5.439393 -9.044249,-11.898671c-3.742448,-6.459279 -7.796766,-11.898671 -9.35612,-11.898671c-1.247483,0 -6.861155,-4.419507 -12.474826,-10.198861c-5.613672,-5.439393 -12.786697,-10.198861 -15.905404,-10.198861c-3.118707,0 -7.484896,-3.059659 -9.667991,-6.799241c-2.183095,-3.739583 -7.173025,-6.799241 -10.915473,-6.799241c-4.054318,0 -7.173025,-1.359848 -7.173025,-3.399621c0,-2.039772 -9.35612,-3.399621 -22.142817,-3.399621c-11.851085,0 -21.207205,-1.359848 -20.271593,-3.059659c4.054318,-7.139203 -114.768404,-10.198861 -141.589281,-3.399621c-7.796766,2.039772 -18.71224,4.419507 -24.325912,5.439393c-5.613672,1.019886 -10.915473,3.059659 -11.851085,4.759469c-0.935612,1.69981 -5.613672,3.059659 -10.915473,3.059659c-4.98993,0 -9.044249,1.359848 -9.044249,2.719696c0,1.359848 -6.549283,4.419507 -14.657921,6.799241c-8.420508,2.719696 -17.464757,6.119317 -20.271593,7.819127c-3.118707,1.69981 -8.420508,3.059659 -11.539215,3.059659c-3.430577,0 -6.861155,1.359848 -7.796766,3.059659c-0.935612,1.69981 -8.732378,4.759469 -17.152886,7.139203c-8.732378,2.039772 -17.152886,6.119317 -19.335981,8.839013c-1.871224,2.719696 -6.237413,4.759469 -9.35612,4.759469c-5.925543,0 -25.885265,10.878785 -32.434549,18.017988c-1.871224,2.379734 -10.915473,9.518937 -19.647851,15.978216c-9.044249,6.459279 -16.217274,13.598481 -16.217274,15.978216c0,2.039772 -2.806836,5.099431 -6.237413,6.119317c-3.430577,1.019886 -6.237413,3.739583 -6.237413,5.439393c0,1.69981 -1.871224,3.059659 -4.054318,3.059659c-2.183095,0 -5.613672,3.059659 -7.796766,6.799241c-3.430577,6.119317 -3.118707,6.799241 4.054318,6.799241c4.36619,0 7.796766,-1.359848 7.796766,-3.399621l-0.000001,0l-0.000004,-0.000003z" id="svg_3" stroke-width="0" stroke="null"></path> <path d="m557.957919,6372.850587c0,-4.759469 0.623741,-6.459279 1.559353,-4.079545c0.623741,2.039772 0.623741,6.119317 0,8.499051c-0.935612,2.039772 -1.559353,0.339962 -1.559353,-4.419507l0,0.000001z" id="svg_4" stroke-width="0" stroke="null"></path> <path d="m547.978057,6237.205733c0,-1.69981 -0.935612,-5.439393 -1.871224,-8.499051c-1.247483,-3.739583 -0.31187,-5.439393 3.118707,-5.439393c3.118707,0 4.98993,3.059659 4.98993,8.499051c0,4.759469 -1.247483,8.499051 -3.118707,8.499051c-1.559353,0 -3.118707,-1.359848 -3.118707,-3.059659l0.000001,0.000001z" id="svg_5" stroke-width="0" stroke="null"></path> <path d="m522.092792,6197.090212c-1.247483,-1.019886 -2.183095,-6.459279 -2.183095,-11.898671c0,-13.598481 7.484896,-10.538823 8.732378,3.399621c0.935612,10.198861 -1.871224,13.938444 -6.549283,8.499051l0,-0.000001z" id="svg_6" stroke-width="0" stroke="null"></path> <path d="m497.45501,6146.095906c2.183095,-1.019886 4.98993,-0.679924 5.925543,0.339962c1.247483,1.019886 -0.623741,2.039772 -4.054318,1.69981c-3.430577,0 -4.36619,-1.019886 -1.871224,-2.039772l-0.000001,0z" id="svg_7" stroke-width="0" stroke="null"></path> <path d="m2238.628918,6132.837387c0,-3.739583 0.935612,-4.759469 1.871224,-2.039772c0.935612,2.379734 0.623741,5.439393 -0.31187,6.459279c-0.935612,1.359848 -1.871224,-0.679924 -1.559353,-4.419507l-0.000001,0z" id="svg_8" stroke-width="0" stroke="null"></path> <path d="m993.329363,5785.736144c2.183095,-1.019886 4.98993,-0.679924 5.925543,0.339962c1.247483,1.019886 -0.623741,2.039772 -4.054318,1.69981c-3.430577,0 -4.36619,-1.019886 -1.871224,-2.039772l-0.000001,0z" id="svg_9" stroke-width="0" stroke="null"></path> <path d="m376.449193,5685.787304c0,-1.69981 1.559353,-2.379734 3.118707,-1.359848c1.871224,1.019886 3.118707,2.719696 3.118707,3.739583c0,0.679924 -1.247483,1.359848 -3.118707,1.359848c-1.559353,0 -3.118707,-1.69981 -3.118707,-3.739583z" id="svg_10" stroke-width="0" stroke="null"></path> <path d="m111.982871,5924.100694c0,-4.759469 0.623741,-6.459279 1.559353,-4.079545c0.623741,2.039772 0.623741,6.119317 0,8.499051c-0.935612,2.039772 -1.559353,0.339962 -1.559353,-4.419507l0,0.000001z" id="svg_11" stroke-width="0" stroke="null"></path> </g> </g> </svg> <span class="text-xl font-bold sm:text-2xl">知道的越多，才知知道的越少</span> </a> <nav aria-label="Main menu" class="absolute -inset-x-4 top-14 hidden flex-col items-end gap-y-4 rounded-md bg-bgColor/[.85] py-4 text-accent shadow backdrop-blur group-[.menu-open]:z-50 group-[.menu-open]:flex sm:static sm:z-auto sm:-ms-4 sm:mt-1 sm:flex sm:flex-row sm:items-center sm:divide-x sm:divide-dashed sm:divide-accent sm:rounded-none sm:bg-transparent sm:py-0 sm:shadow-none sm:backdrop-blur-none" id="navigation-menu"> <a class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" data-astro-prefetch href="/astro-theme-cactus/"> Home </a><a class="px-4 py-4 underline-offset-2 sm:py-0 sm:hover:underline" data-astro-prefetch href="/astro-theme-cactus/posts/"> Blog </a> </nav> </div> <site-search class="ms-auto" id="search" data-astro-cid-otpdt6jm> <button class="flex h-9 w-9 items-center justify-center rounded-md ring-zinc-400 transition-all hover:ring-2" data-open-modal disabled data-astro-cid-otpdt6jm> <svg aria-label="search" class="h-7 w-7" fill="none" height="16" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" width="16" xmlns="http://www.w3.org/2000/svg" data-astro-cid-otpdt6jm> <path d="M0 0h24v24H0z" stroke="none" data-astro-cid-otpdt6jm></path> <path d="M3 10a7 7 0 1 0 14 0 7 7 0 1 0-14 0M21 21l-6-6" data-astro-cid-otpdt6jm></path> </svg> </button> <dialog aria-label="search" class="h-full max-h-full w-full max-w-full border border-zinc-400 bg-bgColor shadow backdrop:backdrop-blur sm:mx-auto sm:mb-auto sm:mt-16 sm:h-max sm:max-h-[calc(100%-8rem)] sm:min-h-[15rem] sm:w-5/6 sm:max-w-[48rem] sm:rounded-md" data-astro-cid-otpdt6jm> <div class="dialog-frame flex flex-col gap-4 p-6 pt-12 sm:pt-6" data-astro-cid-otpdt6jm> <button class="ms-auto cursor-pointer rounded-md bg-zinc-200 p-2 font-semibold dark:bg-zinc-700" data-close-modal data-astro-cid-otpdt6jm>Close</button> <div class="search-container" data-astro-cid-otpdt6jm> <div id="cactus__search" data-astro-cid-otpdt6jm></div> </div> </div> </dialog> </site-search>    <theme-toggle class="ms-2 sm:ms-4"> <button class="relative h-9 w-9 rounded-md p-2 ring-zinc-400 transition-all hover:ring-2" type="button"> <span class="sr-only">Dark Theme</span> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-100 opacity-100 transition-all dark:scale-0 dark:opacity-0" fill="none" focusable="false" id="sun-svg" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M12 18C15.3137 18 18 15.3137 18 12C18 8.68629 15.3137 6 12 6C8.68629 6 6 8.68629 6 12C6 15.3137 8.68629 18 12 18Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M22 12L23 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 2V1" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M12 23V22" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 20L19 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M20 4L19 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 20L5 19" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M4 4L5 5" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> <path d="M1 12L2 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-7 w-7 -translate-x-1/2 -translate-y-1/2 scale-0 opacity-0 transition-all dark:scale-100 dark:opacity-100" fill="none" focusable="false" id="moon-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z"></path> <path d="M17 4a2 2 0 0 0 2 2a2 2 0 0 0 -2 2a2 2 0 0 0 -2 -2a2 2 0 0 0 2 -2"></path> <path d="M19 11h2m-1 -1v2"></path> </svg> </button> </theme-toggle>  <mobile-button> <button aria-expanded="false" aria-haspopup="menu" aria-label="Open main menu" class="group relative ms-4 h-7 w-7 sm:invisible sm:hidden" id="toggle-navigation-menu" type="button"> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 transition-all group-aria-expanded:scale-0 group-aria-expanded:opacity-0" fill="none" focusable="false" id="line-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M3.75 9h16.5m-16.5 6.75h16.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> <svg aria-hidden="true" class="absolute start-1/2 top-1/2 h-full w-full -translate-x-1/2 -translate-y-1/2 scale-0 text-accent opacity-0 transition-all group-aria-expanded:scale-100 group-aria-expanded:opacity-100" class="text-accent" fill="none" focusable="false" id="cross-svg" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button> </mobile-button> </header>  <main id="main">  <div class="gap-x-10 lg:flex lg:items-start"> <aside class="sticky top-20 order-2 -me-32 hidden basis-64 lg:block"> <h2 class="font-semibold">Table of Contents</h2> <ul class="mt-4 text-xs"> <li class=""> <a aria-label="Scroll to section: 什么是Feign" class="block line-clamp-2 hover:text-accent mt-3" href="#什么是feign"><span class="me-0.5">#</span>什么是Feign</a>  </li><li class=""> <a aria-label="Scroll to section: 什么是openFeign" class="block line-clamp-2 hover:text-accent mt-3" href="#什么是openfeign"><span class="me-0.5">#</span>什么是openFeign</a>  </li><li class=""> <a aria-label="Scroll to section: Feign与OpenFeign的对比" class="block line-clamp-2 hover:text-accent mt-3" href="#feign与openfeign的对比"><span class="me-0.5">#</span>Feign与OpenFeign的对比</a>  </li><li class=""> <a aria-label="Scroll to section: openFeign使用" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign使用"><span class="me-0.5">#</span>openFeign使用</a>  </li><li class=""> <a aria-label="Scroll to section: OpenFeign超时处理" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign超时处理"><span class="me-0.5">#</span>OpenFeign超时处理</a>  </li><li class=""> <a aria-label="Scroll to section: OpenFeign日志增强" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign日志增强"><span class="me-0.5">#</span>OpenFeign日志增强</a>  </li><li class=""> <a aria-label="Scroll to section: OpenFeign 实现 RequestInterceptor" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign-实现-requestinterceptor"><span class="me-0.5">#</span>OpenFeign 实现 RequestInterceptor</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: RequestInterceptor 实现类" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#requestinterceptor-实现类"><span class="me-0.5">#</span>RequestInterceptor 实现类</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 使 RequestInterceptor 生效" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#使-requestinterceptor-生效"><span class="me-0.5">#</span>使 RequestInterceptor 生效</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 服务提供者增加拦截器(用于获取请求头中的数据)" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#服务提供者增加拦截器用于获取请求头中的数据"><span class="me-0.5">#</span>服务提供者增加拦截器(用于获取请求头中的数据)</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 结合 Hystrix 限流使用的坑" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#结合-hystrix-限流使用的坑"><span class="me-0.5">#</span>结合 Hystrix 限流使用的坑</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 原因分析" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#原因分析"><span class="me-0.5">#</span>原因分析</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 解决方案" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#解决方案"><span class="me-0.5">#</span>解决方案</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: hystrix 线程池和信号量隔离区别" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#hystrix-线程池和信号量隔离区别"><span class="me-0.5">#</span>hystrix 线程池和信号量隔离区别</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 线程和信号量隔离的使用场景" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#线程和信号量隔离的使用场景"><span class="me-0.5">#</span>线程和信号量隔离的使用场景</a>  </li> </ul> </li> </ul> </li><li class=""> <a aria-label="Scroll to section: openfeign 核心组件" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign-核心组件"><span class="me-0.5">#</span>openfeign 核心组件</a>  </li><li class=""> <a aria-label="Scroll to section: openfeign 如何扫描所有 FeignClient(基于低版本 SpringCloud 2020.0.x版本之前)" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign-如何扫描所有-feignclient基于低版本-springcloud-20200x版本之前"><span class="me-0.5">#</span>openfeign 如何扫描所有 FeignClient(基于低版本 SpringCloud 2020.0.x版本之前)</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: @FeignClient解析" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclient解析"><span class="me-0.5">#</span>@FeignClient解析</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: @FeignClient注解解释" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclient注解解释"><span class="me-0.5">#</span>@FeignClient注解解释</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: @FeignClient 注解作用" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclient-注解作用"><span class="me-0.5">#</span>@FeignClient 注解作用</a>  </li> </ul> </li><li class="ms-2"> <a aria-label="Scroll to section: @EnableFeignClients 解析" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#enablefeignclients-解析"><span class="me-0.5">#</span>@EnableFeignClients 解析</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: FeignClientsRegistrar 类" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclientsregistrar-类"><span class="me-0.5">#</span>FeignClientsRegistrar 类</a>  </li> </ul> </li><li class="ms-2"> <a aria-label="Scroll to section: FeignClient 的动态代理类" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclient-的动态代理类"><span class="me-0.5">#</span>FeignClient 的动态代理类</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: FeignClientFactoryBean 创建动态代理类的入口" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclientfactorybean-创建动态代理类的入口"><span class="me-0.5">#</span>FeignClientFactoryBean 创建动态代理类的入口</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: Feign.Builder的构建过程" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignbuilder的构建过程"><span class="me-0.5">#</span>Feign.Builder的构建过程</a>  </li> </ul> </li><li class="ms-2"> <a aria-label="Scroll to section: OpenFeign处理HTTP请求" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#openfeign处理http请求"><span class="me-0.5">#</span>OpenFeign处理HTTP请求</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: 动态代理处理请求的入口" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#动态代理处理请求的入口"><span class="me-0.5">#</span>动态代理处理请求的入口</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: SynchronousMethodHandler 处理请求机制" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#synchronousmethodhandler-处理请求机制"><span class="me-0.5">#</span>SynchronousMethodHandler 处理请求机制</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 总结" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#总结"><span class="me-0.5">#</span>总结</a>  </li> </ul> </li> </ul> </li><li class=""> <a aria-label="Scroll to section: OpenFeign新版本和旧版本之间的差异(高版本OpenFeign底层不使用Ribbon做负载均衡)" class="block line-clamp-2 hover:text-accent mt-3" href="#openfeign新版本和旧版本之间的差异高版本openfeign底层不使用ribbon做负载均衡"><span class="me-0.5">#</span>OpenFeign新版本和旧版本之间的差异(高版本OpenFeign底层不使用Ribbon做负载均衡)</a> <ul> <li class="ms-2"> <a aria-label="Scroll to section: @FeignClientsRegistrar开启对FeignClient的扫描" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#feignclientsregistrar开启对feignclient的扫描"><span class="me-0.5">#</span>@FeignClientsRegistrar开启对FeignClient的扫描</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: 为FeignClient生成动态代理类" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#为feignclient生成动态代理类"><span class="me-0.5">#</span>为FeignClient生成动态代理类</a>  </li><li class="ms-2"> <a aria-label="Scroll to section: Client处理负载均衡(核心区别)" class="block line-clamp-2 hover:text-accent mt-2 text-[0.6875rem]" href="#client处理负载均衡核心区别"><span class="me-0.5">#</span>Client处理负载均衡(核心区别)</a>  </li> </ul> </li> </ul> </aside> <article class="flex-grow break-words" data-pagefind-body> <div id="blog-hero"><h1 class="title mb-3 sm:mb-1"> Feign &amp; openFeign </h1> <div class="flex flex-wrap items-center gap-x-3 gap-y-2"> <p class="font-semibold"> <time datetime="2024-02-22T15:00:03.000Z"> February 22, 2024 </time> /  67 min read </p> <span class="rounded-lg bg-quote/10 p-1 text-quote">
Last Updated:
<time datetime="2024-05-16T14:00:40.000Z" class="ms-1"> May 16, 2024 </time> </span> </div> <div class="mt-3"> <svg aria-hidden="true" class="inline-block h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M0 0h24v24H0z" fill="none" stroke="none"></path> <path d="M7.859 6h-2.834a2.025 2.025 0 0 0 -2.025 2.025v2.834c0 .537 .213 1.052 .593 1.432l6.116 6.116a2.025 2.025 0 0 0 2.864 0l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-6.117 -6.116a2.025 2.025 0 0 0 -1.431 -.593z"></path> <path d="M17.573 18.407l2.834 -2.834a2.025 2.025 0 0 0 0 -2.864l-7.117 -7.116"></path> <path d="M6 9h-.01"></path> </svg>  <a aria-label="View more blogs with the tag java" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/astro-theme-cactus/tags/java/"> java </a> ,  <a aria-label="View more blogs with the tag feign" class="cactus-link inline-block before:content-['#']" data-pagefind-filter="tag" href="/astro-theme-cactus/tags/feign/"> feign </a>  </div></div> <div class="prose prose-sm prose-cactus mt-12 prose-headings:font-semibold prose-headings:text-accent-2 prose-headings:before:absolute prose-headings:before:-ms-4 prose-headings:before:text-accent prose-headings:before:content-['#'] prose-th:before:content-none">  <h2 id="什么是feign">什么是Feign</h2>
<p>Netflix Feign 是 Netflix 公司发布的一种实现负载均衡和服务调用的开源组件。Spring Cloud 将其与 Netflix 中的其他开源服务组件(例如 Eureka、Ribbon 以及 Hystrix 等)一起整合进 Spring Cloud Netflix 模块中,整合后全称为 Spring Cloud Netflix Feign Feign 对 <a href="http://c.biancheng.net/springcloud/ribbon.html" rel="nofollow, noopener, noreferrer" target="_blank">Ribbon</a>进行了集成,利用 Ribbon 维护了一份可用服务清单,并通过 Ribbon 实现了客户端的负载均衡。Feign 是一种声明式服务调用组件,它在 RestTemplate 的基础上做了进一步的封装。通过 Feign,我们只需要声明一个接口并通过注解进行简单的配置(类似于 Dao 接口上面的 Mapper 注解一样)即可实现对 HTTP 接口的绑定。通过 Feign,我们可以像调用本地方法一样来调用远程服务,而完全感觉不到这是在进行远程调用。Feign 支持多种注解,例如 Feign 自带的注解以及 JAX-RS 注解等,但遗憾的是 Feign 本身并不支持 Spring MVC 注解,这无疑会给广大 Spring 用户带来不便。</p>
<h2 id="什么是openfeign">什么是openFeign</h2>
<p>2019 年 Netflix 公司宣布 Feign 组件正式进入停更维护状态,于是 Spring 官方便推出了一个名为 OpenFeign 的组件作为 Feign 的替代方案。</p>
<p>OpenFeign 全称 Spring Cloud OpenFeign,它是 Spring 官方推出的一种声明式服务调用与负载均衡组件,它的出现就是为了替代进入停更维护状态的 Feign。OpenFeign 是 Spring Cloud 对 Feign 的二次封装,它具有 Feign 的所有功能,并在 Feign 的基础上增加了对 Spring MVC 注解的支持,例如 @RequestMapping、@GetMapping 和 @PostMapping 等。</p>
<p>常用注解</p>





























<table><thead><tr><th>注解</th><th>说明</th></tr></thead><tbody><tr><td>@FeignClient</td><td>该注解用于通知 OpenFeign 组件对 @RequestMapping 注解下的接口进行解析,并通过动态代理的方式产生实现类,实现负载均衡和服务调用。</td></tr><tr><td>EnableFeignClients</td><td>该注解用于开启 OpenFeign 功能,当 Spring Cloud 应用启动时,OpenFeign 会扫描标有 @FeignClient 注解的接口,生成代理并注册到 Spring 容器中。</td></tr><tr><td>@RequestMapping</td><td>Spring MVC 注解,在 Spring MVC 中使用该注解映射请求,通过它来指定控制器(Controller)可以处理哪些 URL 请求,相当于 Servlet 中 web.xml 的配置。</td></tr><tr><td>@GetMapping</td><td>Spring MVC 注解,用来映射 GET 请求,它是一个组合注解,相当于 @RequestMapping(method = RequestMethod.GET) 。</td></tr><tr><td>@PostMapping</td><td>Spring MVC 注解,用来映射 POST 请求,它是一个组合注解,相当于 @RequestMapping(method = RequestMethod.POST) 。</td></tr></tbody></table>
<h2 id="feign与openfeign的对比">Feign与OpenFeign的对比</h2>
<p>**相同点: **</p>
<ul>
<li>Feign 和 OpenFeign 都是 Spring Cloud 下的远程调用和负载均衡组件。</li>
<li>Feign 和 OpenFeign 作用一样,都可以实现服务的远程调用和负载均衡。</li>
<li>Feign 和 OpenFeign 都对 Ribbon 进行了集成,都利用 Ribbon 维护了可用服务清单,并通过 Ribbon 实现了客户端的负载均衡。</li>
<li>Feign 和 OpenFeign 都是在服务消费者(客户端)定义服务绑定接口并通过注解的方式进行配置,以实现远程服务的调用。</li>
</ul>
<p>**不同点: **</p>
<ul>
<li>Feign 和 OpenFeign 的依赖项不同,Feign 的依赖为 spring-cloud-starter-feign,而 OpenFeign 的依赖为 spring-cloud-starter-openfeign。</li>
<li>Feign 和 OpenFeign 支持的注解不同,Feign 支持 Feign 注解和 JAX-RS 注解,但不支持 Spring MVC 注解;OpenFeign 除了支持 Feign 注解和 JAX-RS 注解外,还支持 Spring MVC 注解。</li>
</ul>
<h2 id="openfeign使用">openFeign使用</h2>
<p>引入依赖</p>
<div class="expressive-code"><link rel="stylesheet" href="/astro-theme-cactus/_astro/ec.v6sg1.css"/><script type="module" src="/astro-theme-cactus/_astro/ec.3zb7u.js"></script><figure class="frame"><figcaption class="header"></figcaption><pre data-language="xml"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">&lt;!-- openfeign依赖 --&gt;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">dependency</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">groupId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;org.springframework.cloud&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">groupId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">artifactId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;spring-cloud-starter-openfeign&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">artifactId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">dependency</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">&lt;!-- openfeign优化请求连接池依赖 --&gt;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">dependency</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">     </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">groupId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;io.github.openfeign&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">groupId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">     </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">artifactId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;feign-httpclient&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">artifactId</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">dependency</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<!-- openfeign依赖 --><dependency>      <groupId>org.springframework.cloud</groupId>      <artifactId>spring-cloud-starter-openfeign</artifactId></dependency><!-- openfeign优化请求连接池依赖 --><dependency>     <groupId>io.github.openfeign</groupId>     <artifactId>feign-httpclient</artifactId></dependency>"><div></div></button></div></figure></div>
<p>定义远程调用接口</p>
<ul>
<li>在 @FeignClient 注解中,value 属性的取值为: 服务提供者的服务名,即服务提供者配置文件(application.yml)中 spring.application.name 的取值。</li>
<li>接口中定义的每个方法都与服务提供者中 Controller 定义的服务方法对应。</li>
<li>openfeign本身并不具备fallback降级属性,需要搭配降级框架如(hystrix或sentinel)。如果未引入降级框架,即使声明fallback降级服务类,在远程调用发生异常时,也不会触发。</li>
</ul>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Component</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">FeignClient</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">value</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">service5</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">interface</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">FeignService</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">     </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">GetMapping</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">/api/v1/service5</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">     </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">List</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">Integer</span><span style="--0:#F8F8F2;--1:#24292E">&gt; </span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Component@FeignClient(value = &#34;service5&#34;)public interface FeignService {     @GetMapping(&#34;/api/v1/service5&#34;)     List<Integer> get();}"><div></div></button></div></figure></div>
<p>启动类添加注解@EnableFeignClients</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">EnableFeignClients</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">EnableEurekaClient</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">SpringBootApplication</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Service3Application</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">     </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">main</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">args</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">SpringApplication.</span><span style="--0:#50FA7B;--1:#6F42C1">run</span><span style="--0:#F8F8F2;--1:#24292E">(Service3Application.class, args);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@EnableFeignClients@EnableEurekaClient@SpringBootApplicationpublic class Service3Application {     public static void main(String[] args) {        SpringApplication.run(Service3Application.class, args);    }}"><div></div></button></div></figure></div>
<h2 id="openfeign超时处理">OpenFeign超时处理</h2>
<p>openFeign 客户端的默认超时时间为 1 秒钟,如果服务端处理请求的时间超过 1 秒就会报错。为了避免这样的情况,我们需要对 OpenFeign 客户端的超时时间进行控制。</p>
<p>yml 添加如下进行配置</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">ribbon</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">ReadTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">6000</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972">#建立连接所用的时间,适用于网络状况正常的情况下,两端两端连接所用的时间</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">ConnectionTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">6000</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972">#建立连接后,服务器读取到可用资源的时间</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">feign</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">client</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">httpclient</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">enabled</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972"># 开启 HttpClient优化连接池</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">compression</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">request</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">enabled</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972"># 开启请求数据的压缩功能</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">mime-types</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">text/xml,application/xml, application/json</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972"># 压缩类型</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">min-request-size</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">1024</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972"># 最小压缩值标准,当数据大于 1024 才会进行压缩</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">response</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">enabled</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972"># 开启响应数据压缩功能</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="ribbon:  ReadTimeout: 6000 #建立连接所用的时间,适用于网络状况正常的情况下,两端两端连接所用的时间  ConnectionTimeout: 6000 #建立连接后,服务器读取到可用资源的时间feign:  client:    httpclient:      enabled: true # 开启 HttpClient优化连接池  compression:    request:      enabled: true # 开启请求数据的压缩功能      mime-types: text/xml,application/xml, application/json # 压缩类型      min-request-size: 1024 # 最小压缩值标准,当数据大于 1024 才会进行压缩    response:      enabled: true # 开启响应数据压缩功能"><div></div></button></div></figure></div>
<h2 id="openfeign日志增强">OpenFeign日志增强</h2>
<p>yml 添加日志级别声明</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">logging</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">level</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">com.ftc.service3.FeignService</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">debug</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#96A1C2;--1:#616972">#feign日志以什么样的级别监控该接口</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="logging:  level:    com.ftc.service3.FeignService: debug #feign日志以什么样的级别监控该接口"><div></div></button></div></figure></div>
<p>说明:</p>
<ul>
<li>com.ftc.service3.FeignService 是开启 @FeignClient 注解的接口(即服务绑定接口)的完整类名。也可以只配置部分路径,表示监控该路径下的所有服务绑定接口</li>
<li>debug: 表示监听该接口的日志级别。</li>
</ul>
<p>创建日志配置类</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">ConfigBean</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">  </span></span><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">    </span></span><span style="--0:#96A1C2;--1:#616972">* OpenFeign 日志增强</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">    </span></span><span style="--0:#96A1C2;--1:#616972">* 配置 OpenFeign 记录哪些内容</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">    </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Logger</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Level</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">feginLoggerLevel</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> Logger.Level.FULL;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configurationpublic class ConfigBean {  /**    * OpenFeign 日志增强    * 配置 OpenFeign 记录哪些内容    */  @Bean  Logger.Level feginLoggerLevel() {      return Logger.Level.FULL;  }}"><div></div></button></div></figure></div>
<p>该配置的作用是通过配置的 Logger.Level 对象告诉 OpenFeign 记录哪些日志内容。Logger.Level 的具体级别如下:</p>
<ul>
<li>NONE: 不记录任何信息。</li>
<li>BASIC: 仅记录请求方法、URL 以及响应状态码和执行时间。</li>
<li>HEADERS: 除了记录 BASIC 级别的信息外,还会记录请求和响应的头信息。</li>
<li>FULL: 记录所有请求与响应的明细,包括头信息、请求体、元数据等等。</li>
</ul>
<h2 id="openfeign-实现-requestinterceptor">OpenFeign 实现 RequestInterceptor</h2>
<p>在一些业务场景中,微服务间相互调用需要做鉴权,以保证我们服务的安全性。即: 服务 A 调用服务 B 的时候需要将服务 B 的一些鉴权信息传递给服务 B,从而保证服务 B 的调用也可以通过鉴权,进而保证整个服务调用链的安全。</p>
<p>通过 RequestInterceptor 拦截器拦截 openfeign 服务请求,将上游服务的请求头或者请求体中的数据封装到我们的 openfeign 调用的请求模版中,从而实现上游数据的传递。</p>
<h3 id="requestinterceptor-实现类">RequestInterceptor 实现类</h3>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Slf4j</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">MyFeignRequestInterceptor</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">implements</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">RequestInterceptor</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">  </span></span><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* 这里可以实现对请求的拦截,对请求添加一些额外信息之类的</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">requestTemplate</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">apply</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">RequestTemplate</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">requestTemplate</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 1. obtain request</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">ServletRequestAttributes</span><span style="--0:#F8F8F2"> attributes </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (ServletRequestAttributes) RequestContextHolder.</span><span style="--0:#50FA7B;--1:#6F42C1">getRequestAttributes</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 2. 兼容hystrix限流后,获取不到ServletRequestAttributes的问题(使拦截器直接失效)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (Objects.</span><span style="--0:#50FA7B;--1:#6F42C1">isNull</span><span style="--0:#F8F8F2;--1:#24292E">(attributes)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">log.</span><span style="--0:#50FA7B;--1:#6F42C1">error</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">MyFeignRequestInterceptor is invalid!</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">HttpServletRequest</span><span style="--0:#F8F8F2;--1:#24292E"> request </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">getRequest</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 2. obtain request headers,and put it into openFeign RequestTemplate</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Enumeration</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">&gt; headerNames </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> request.</span><span style="--0:#50FA7B;--1:#6F42C1">getHeaderNames</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (Objects.</span><span style="--0:#50FA7B;--1:#6F42C1">nonNull</span><span style="--0:#F8F8F2;--1:#24292E">(headerNames)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> (headerNames.</span><span style="--0:#50FA7B;--1:#6F42C1">hasMoreElements</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> headerNames.</span><span style="--0:#50FA7B;--1:#6F42C1">nextElement</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> request.</span><span style="--0:#50FA7B;--1:#6F42C1">getHeader</span><span style="--0:#F8F8F2;--1:#24292E">(name);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">requestTemplate.</span><span style="--0:#50FA7B;--1:#6F42C1">header</span><span style="--0:#F8F8F2;--1:#24292E">(name, value);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// todo 需要传递请求参数时放开</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--1:#005CC5">3.</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> obtain request body, and put it into openFeign </span><span style="--0:#8BE9FD;--0fs:italic">RequestTemplate</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Enumeration</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">&gt; bodyNames </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> request.</span><span style="--0:#50FA7B;--1:#6F42C1">getParameterNames</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">StringBuffer</span><span style="--0:#F8F8F2;--1:#24292E"> body </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">StringBuffer</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (bodyNames </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> (bodyNames.</span><span style="--0:#50FA7B;--1:#6F42C1">hasMoreElements</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> bodyNames.</span><span style="--0:#50FA7B;--1:#6F42C1">nextElement</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> request.</span><span style="--0:#50FA7B;--1:#6F42C1">getParameter</span><span style="--0:#F8F8F2;--1:#24292E">(name);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">body.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(name).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">=</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(value).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">&amp;</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (body.</span><span style="--0:#50FA7B;--1:#6F42C1">length</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">body.</span><span style="--0:#50FA7B;--1:#6F42C1">deleteCharAt</span><span style="--0:#F8F8F2;--1:#24292E">(body.</span><span style="--0:#50FA7B;--1:#6F42C1">length</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">1</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">requestTemplate.</span><span style="--0:#50FA7B;--1:#6F42C1">body</span><span style="--0:#F8F8F2;--1:#24292E">(body.</span><span style="--0:#50FA7B;--1:#6F42C1">toString</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">log.</span><span style="--0:#50FA7B;--1:#6F42C1">info</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">openfeign interceptor body:{}</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, body.</span><span style="--0:#50FA7B;--1:#6F42C1">toString</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Slf4jpublic class MyFeignRequestInterceptor implements RequestInterceptor {  /**   * 这里可以实现对请求的拦截,对请求添加一些额外信息之类的   *   * @param requestTemplate   */  @Override  public void apply(RequestTemplate requestTemplate) {    // 1. obtain request    final ServletRequestAttributes attributes = (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();    // 2. 兼容hystrix限流后,获取不到ServletRequestAttributes的问题(使拦截器直接失效)    if (Objects.isNull(attributes)) {      log.error(&#34;MyFeignRequestInterceptor is invalid!&#34;);      return;    }    HttpServletRequest request = attributes.getRequest();    // 2. obtain request headers,and put it into openFeign RequestTemplate    Enumeration<String> headerNames = request.getHeaderNames();    if (Objects.nonNull(headerNames)) {      while (headerNames.hasMoreElements()) {        String name = headerNames.nextElement();        String value = request.getHeader(name);        requestTemplate.header(name, value);      }    }    // todo 需要传递请求参数时放开    3. obtain request body, and put it into openFeign RequestTemplate    Enumeration<String> bodyNames = request.getParameterNames();    StringBuffer body = new StringBuffer();    if (bodyNames != null) {      while (bodyNames.hasMoreElements()) {        String name = bodyNames.nextElement();        String value = request.getParameter(name);        body.append(name).append(&#34;=&#34;).append(value).append(&#34;&#38;&#34;);      }    }    if (body.length() != 0) {      body.deleteCharAt(body.length() - 1);      requestTemplate.body(body.toString());      log.info(&#34;openfeign interceptor body:{}&#34;, body.toString());    }  }}"><div></div></button></div></figure></div>
<h3 id="使-requestinterceptor-生效">使 RequestInterceptor 生效</h3>
<ol>
<li>
<p>代码方式全局生效</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">MyConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">RequestInterceptor</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">requestInterceptor</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">MyFeignRequestInterceptor</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configurationpublic class MyConfiguration {    @Bean    public RequestInterceptor requestInterceptor() {        return new MyFeignRequestInterceptor();    }}"><div></div></button></div></figure></div>
</li>
<li>
<p>配置方式全局生效</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">feign</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">client</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">config</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">default</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">connectTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">5000</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">readTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">5000</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">loggerLevel</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">full</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972"># 拦截器配置(和@Bean的方式二选一)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">requestInterceptors</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">          </span></span><span style="--0:#FF79C6;--1:#24292E">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">com.chou401.feign.config.MyFeignRequestInterceptor</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="feign:  client:    config:      default:        connectTimeout: 5000        readTimeout: 5000        loggerLevel: full        # 拦截器配置(和@Bean的方式二选一)        requestInterceptors:          - com.chou401.feign.config.MyFeignRequestInterceptor"><div></div></button></div></figure></div>
</li>
<li>
<p>代码方式针对某个服务生效</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">FeignClient</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">value</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">service-a</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">configuration</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> MyFeignRequestInterceptor.class)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">interface</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">ServiceClient</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@FeignClient(value = &#34;service-a&#34;, configuration = MyFeignRequestInterceptor.class)public interface ServiceClient {}"><div></div></button></div></figure></div>
</li>
<li>
<p>配置方式针对某个服务生效</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">feign</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">client</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">config</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">SERVICE-A</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">connectTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">5000</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">readTimeout</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">5000</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">loggerLevel</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">full</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972"># 拦截器配置(和@Bean的方式二选一)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">requestInterceptors</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">          </span></span><span style="--0:#FF79C6;--1:#24292E">-</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#F1FA8C;--1:#032F62">com.chou401.feign.config.MyFeignRequestInterceptor</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="feign:  client:    config:      SERVICE-A:        connectTimeout: 5000        readTimeout: 5000        loggerLevel: full        # 拦截器配置(和@Bean的方式二选一)        requestInterceptors:          - com.chou401.feign.config.MyFeignRequestInterceptor"><div></div></button></div></figure></div>
</li>
</ol>
<h3 id="服务提供者增加拦截器用于获取请求头中的数据">服务提供者增加拦截器(用于获取请求头中的数据)</h3>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Slf4j</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">MvcInterceptor</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">implements</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">HandlerInterceptor</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">preHandle</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">HttpServletRequest</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">request</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">HttpServletResponse</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">response</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">handler</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> token </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> request.</span><span style="--0:#50FA7B;--1:#6F42C1">getHeader</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">token</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">log.</span><span style="--0:#50FA7B;--1:#6F42C1">info</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">obtain token is : {}</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, token);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Slf4jpublic class MvcInterceptor implements HandlerInterceptor {    @Override    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {        String token = request.getHeader(&#34;token&#34;);        log.info(&#34;obtain token is : {}&#34;, token);        return true;    }}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">MvcInterceptorConfig</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">implements</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">WebMvcConfigurer</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">addInterceptors</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">InterceptorRegistry</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">registry</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">registry.</span><span style="--0:#50FA7B;--1:#6F42C1">addInterceptor</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">MvcInterceptor</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">addPathPatterns</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">/**</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configurationpublic class MvcInterceptorConfig implements WebMvcConfigurer {    @Override    public void addInterceptors(InterceptorRegistry registry) {        registry.addInterceptor(new MvcInterceptor())                .addPathPatterns(&#34;/**&#34;);    }}"><div></div></button></div></figure></div>
<h3 id="结合-hystrix-限流使用的坑">结合 Hystrix 限流使用的坑</h3>
<p>application.yaml 配置文件开启限流</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yaml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">feign</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">hystrix</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">enabled</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">true</span></div></div><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">hystrix</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">command</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">default</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">execution</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">isolation</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#8BE9FD;--1:#1E7734">thread</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#8BE9FD;--1:#1E7734">timeoutInMilliseconds</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">30000</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="feign:  hystrix:    enabled: truehystrix:  command:    default:      execution:        isolation:          thread:            timeoutInMilliseconds: 30000"><div></div></button></div></figure></div>
<p>做完上述配置后,<strong>Feign 接口的熔断机制为: 线程模式</strong>。如果我们自定义了一个 <code>RequestInterceptor</code> 实现类,就会导致 hystrix 熔断机制失效,接口调用异常(404、null)。</p>
<h4 id="原因分析">原因分析</h4>
<ul>
<li>在 Feign 调用之前,会先走到 RequestInterceptor 拦截器,拦截器中使用了 <code>ServletRequestAttributes</code> 获取请求数据。</li>
<li>默认 Feign 使用的是线程池模式,当开始熔断的时候,负责熔断的线程和执行 Feign 接口的线程不是同一个线程,ServletRequestAttributes 取到的将会是空值。</li>
</ul>
<h4 id="解决方案">解决方案</h4>
<p>将 hystrix 熔断方式从线程模式改为信号量模式</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="yaml"><code><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">feign</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">hystrix</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">enabled</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">true</span></div></div><div class="ec-line"><div class="code"><span style="--0:#8BE9FD;--1:#1E7734">hystrix</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--1:#1E7734">command</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--1:#1E7734">default</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#8BE9FD;--1:#1E7734">execution</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--1:#1E7734">isolation</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#8BE9FD;--1:#1E7734">thread</span><span style="--0:#FF79C6;--1:#24292E">:</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#8BE9FD;--1:#1E7734">timeoutInMilliseconds</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#BD93F9;--1:#005CC5">30000</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#8BE9FD;--1:#1E7734">strategy</span><span style="--1:#24292E"><span style="--0:#FF79C6">:</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#F1FA8C;--1:#032F62">SEMAPHORE</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="feign:  hystrix:    enabled: truehystrix:  command:    default:      execution:        isolation:          thread:            timeoutInMilliseconds: 30000          strategy: SEMAPHORE"><div></div></button></div></figure></div>
<h4 id="hystrix-线程池和信号量隔离区别">hystrix 线程池和信号量隔离区别</h4>








































<table><thead><tr><th></th><th>线程池</th><th>信号量</th></tr></thead><tbody><tr><td>线程</td><td>请求线程和调用 provider 线程不是同一条线程</td><td>请求线程和调用 provider 线程是同一条线程</td></tr><tr><td>开销</td><td>排队、调用、上下文切换等</td><td>无线程切换,开销低</td></tr><tr><td>异步</td><td>支持</td><td>不支持</td></tr><tr><td>并发支持</td><td>支持: 最大线程池大小</td><td>支持: 最大信号量上限</td></tr><tr><td>传递 Header</td><td>不支持</td><td>支持</td></tr><tr><td>支持超时</td><td>支持</td><td>不支持</td></tr></tbody></table>
<h4 id="线程和信号量隔离的使用场景">线程和信号量隔离的使用场景</h4>
<blockquote>
<p><strong>线程池隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大,并且耗时长(一般是计算量大或者读数据库)</li>
<li>采用线程池隔离,可以保证大量的容器线程可用,不会由于其他服务原因,一直处于阻塞或者等待状态,快速失败返回</li>
</ul>
<blockquote>
<p><strong>信号量隔离</strong></p>
</blockquote>
<ul>
<li>请求并发量大,并且耗时短(一般是计算量小,或读缓存)</li>
<li>采用信号量隔离时的服务返回往往非常快,不会占用容器线程太长时间</li>
<li>其减少了线程切换的一些开销,提高了缓存服务的效率</li>
</ul>
<h2 id="openfeign-核心组件">openfeign 核心组件</h2>
<p>使用 Feign 最核心的是要构造一个 FeignClient,里面包含了一系列的组件:</p>
<ol>
<li>Encoder(SpringEncoder)
Encoder 编码器,当我们调用接口时,如果传递的参数是一个对象,Feign 需要对这个对象进行 encode 编码,做 JSON 序列化,即: encoder 负责将 Java 对象装换成 JSON 字符串。</li>
<li>Decoder(ResponseEntityDecoder)
Decoder 解码器,当接口收到一个 JSON 对象后,Feign 需要对这个对象进行 decode 解码,即: decoder 负责将 JSON 字符串转换成 JavaBean 对象。</li>
<li>Contract(SpringMvcContract)
一般来说 Feign 的@FeignClient 注解需要和 Spring Web MVC 支持的@PathVariable、@RequestMapping、@pRequestParam 等注解结合起来使用,但是 Feign 本身是不支持 Spring Web MVC 注解的,所以需要有一个契约组件(Contract),负责解释 Spring MVC 的注解,让 Feign 可以和 Spring MVC 注解结合起来使用。</li>
<li>Logger(Slf4jLogger)
Logger 为打印 Feign 接口请求调用日志的日志组件,默认为 Slf4jLogger。</li>
</ol>
<h2 id="openfeign-如何扫描所有-feignclient基于低版本-springcloud-20200x版本之前">openfeign 如何扫描所有 FeignClient(基于低版本 SpringCloud 2020.0.x版本之前)</h2>
<p>基于的 SpringCloud 版本</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="xml"><code><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E"> </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">properties</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">spring-boot.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;2.3.7.RELEASE&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">spring-boot.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">spring-cloud.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;Hoxton.SR9&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">spring-cloud.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#FF79C6;--1:#1E7734">spring-cloud-alibaba.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;2.2.6.RELEASE&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">spring-cloud-alibaba.version</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">&lt;/</span><span style="--0:#FF79C6;--1:#1E7734">properties</span><span style="--0:#F8F8F2;--1:#24292E">&gt;</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code=" <properties>    <spring-boot.version>2.3.7.RELEASE</spring-boot.version>    <spring-cloud.version>Hoxton.SR9</spring-cloud.version>    <spring-cloud-alibaba.version>2.2.6.RELEASE</spring-cloud-alibaba.version></properties>"><div></div></button></div></figure></div>
<p>我们知道 openfeign 有两个注解: @EnableFeignClients 和 @FeignClient,其中:</p>
<blockquote>
<p>@EnableFeignClients: 用来开启 openfeign</p>
<p>@FeignClient: 标记要用 openfeign 来拦截的请求接口</p>
</blockquote>
<p>为什么 Service-B 服务中定义了一个 ServiceAClient 接口(继承自 Service-A 的 api 接口),某 Controller 或 Service 中通过 @Autowired 注入一个 ServiceAClient 接口的实例,就可以通过 openfeign 做负载均衡去调用 Service-A服务?</p>
<h3 id="feignclient解析">@FeignClient解析</h3>
<h4 id="feignclient注解解释">@FeignClient注解解释</h4>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> @</span><span style="--0:#FF79C6;--1:#BF3441">interface</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">FeignClient</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 微服务名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">AliasFor</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">name</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">value</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 已经废弃,直接使用 name 即可</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/** @deprecated */</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Deprecated</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">serviceId</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 存在多个相同 FeignClient 时,可以使用 contextId 做唯一约束</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">contextId</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">AliasFor</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">value</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">name</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 对应 Spring 的 @Qualifier 注解,在定义 @FeignClient 时,指定 qualifier</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 在 @Autowired 注入 FeignClient 时,使用 @Qualifier 注解</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">/** @deprecated */</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Deprecated</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">qualifier</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">qualifiers</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 用于配置指定服务的地址 / IP,相当于直接请求这个服务,不经过 Ribbon 的负载均衡</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">url</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 当调用请求发生 404 错误时,如果 decode404 的值为 true,会执行 decode 解码用 404 代替抛出 FeignException 异常,否则直接抛出异常</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">decode404</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// OpenFeign 的配置类,在配置类中可以自定义 Feign 的 Encoder、Decoder、LogLevel、Contract 等</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">configuration</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 定义容错的处理类(回退逻辑),fallback 类必须实现 FeignClient 的接口</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">fallback</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> void.class;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 也是容错的处理,但是可以知道熔断的异常信息</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">fallbackFactory</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> void.class;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// path 定义当前 FeignClient 访问接口时的统一前缀,比如接口地址是 /user/get,如果定义了前缀是 user,那么具体方法上的路径就只需要写 /get 即可</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">path</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#E9F284;--1:#032F62">&quot;&quot;</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">primary</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public @interface FeignClient {    // 微服务名    @AliasFor(&#34;name&#34;)    String value() default &#34;&#34;;    // 已经废弃,直接使用 name 即可    /** @deprecated */    @Deprecated    String serviceId() default &#34;&#34;;    // 存在多个相同 FeignClient 时,可以使用 contextId 做唯一约束    String contextId() default &#34;&#34;;    @AliasFor(&#34;value&#34;)    String name() default &#34;&#34;;    // 对应 Spring 的 @Qualifier 注解,在定义 @FeignClient 时,指定 qualifier    // 在 @Autowired 注入 FeignClient 时,使用 @Qualifier 注解    /** @deprecated */    @Deprecated    String qualifier() default &#34;&#34;;    String[] qualifiers() default {};    // 用于配置指定服务的地址 / IP,相当于直接请求这个服务,不经过 Ribbon 的负载均衡    String url() default &#34;&#34;;    // 当调用请求发生 404 错误时,如果 decode404 的值为 true,会执行 decode 解码用 404 代替抛出 FeignException 异常,否则直接抛出异常    boolean decode404() default false;    // OpenFeign 的配置类,在配置类中可以自定义 Feign 的 Encoder、Decoder、LogLevel、Contract 等    Class<?>[] configuration() default {};    // 定义容错的处理类(回退逻辑),fallback 类必须实现 FeignClient 的接口    Class<?> fallback() default void.class;    // 也是容错的处理,但是可以知道熔断的异常信息    Class<?> fallbackFactory() default void.class;    // path 定义当前 FeignClient 访问接口时的统一前缀,比如接口地址是 /user/get,如果定义了前缀是 user,那么具体方法上的路径就只需要写 /get 即可    String path() default &#34;&#34;;    boolean primary() default true;}"><div></div></button></div></figure></div>
<h4 id="feignclient-注解作用">@FeignClient 注解作用</h4>
<p>用 @FeignClient 注解标注一个接口后,OpenFeign 会对这个接口创建一个对应的动态代理 —&gt; REST Client(发送 RESTful 请求的客户端),然后可以将这个 REST Client 注入其他的组件(比如 SerivceBController),如果弃用了 Ribbon,就会采用负载均衡的方式,来进行 http 请求的发送。</p>
<h5 id="使用-ribbonclient-自定义负载均衡策略">使用 @RibbonClient 自定义负载均衡策略</h5>
<p>可以用 @RibbonClient 标准一个配置类,在 @RibbonClient 注解的 configuration 属性中可以指定配置类,自定义自己的 Ribbon 的 ILoadBalancer,@RibbonClient 的名称要和 @FeignClient 的名称一样</p>
<p>**在 SpringBoot 扫描不到的目录下新建一个配置类: **</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">MyConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">IRule</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">getRule</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">MyRule</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">IPing</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">getPing</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">MyPing</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configurationpublic class MyConfiguration {    @Bean    public IRule getRule() {        return new MyRule();    }    @Bean    public IPing getPing() {        return new MyPing();    }}"><div></div></button></div></figure></div>
<p>**在 SpringBoot 可以扫描到的目录新建一个配置类(被 @RibbonClient 注解标注): **
由于 @FeignClient 中填的name()/value() 是 Service-A,所以 @RibbonClient 的 value() 也必须是 Service-A,表示针对调用服务 Service-A 时做负载均衡。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Cinfiguration</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">RibbonClient</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">name</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Service-A</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--1:#005CC5">configuration</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> MyConfiguration.class)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">ServiceAConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Cinfiguration@RibbonClient(name = &#34;Service-A&#34;, configuration = MyConfiguration.class)public class ServiceAConfiguration {}"><div></div></button></div></figure></div>
<h3 id="enablefeignclients-解析">@EnableFeignClients 解析</h3>
<p><code>@EnableFeignClients</code> 注解用于开启 openfeign,可以猜测,@EnableFeignClients 注解会触发 openfeign 的核心机制: 扫描所有包下面的 @FeignClient 注解的接口、生成 @FeignClient 标注接口的动态代理类。</p>
<p>基于这两个猜测解析 @EnableFeignClients。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Retention</span><span style="--0:#F8F8F2;--1:#24292E">(RetentionPolicy.RUNTIME)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Target</span><span style="--0:#F8F8F2;--1:#24292E">({ElementType.TYPE})</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Documented</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Import</span><span style="--0:#F8F8F2;--1:#24292E">({FeignClientsRegistrar.class})</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> @</span><span style="--0:#FF79C6;--1:#BF3441">interface</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">EnableFeignClients</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">value</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">basePackages</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">basePackageClasses</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">defaultConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E">[] </span><span style="--0:#50FA7B;--1:#6F42C1">clients</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">default</span><span style="--0:#F8F8F2;--1:#24292E"> {};</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Retention(RetentionPolicy.RUNTIME)@Target({ElementType.TYPE})@Documented@Import({FeignClientsRegistrar.class})public @interface EnableFeignClients {    String[] value() default {};    String[] basePackages() default {};    Class<?>[] basePackageClasses() default {};    Class<?>[] defaultConfiguration() default {};    Class<?>[] clients() default {};}"><div></div></button></div></figure></div>
<p><code>@EnableFeignClients</code> 注解中通过 <code>@Import</code> 导入了一个 <code>FeignClientsRegistrar</code> 类,FeignClientsRegistrar 负责 FeignClient 的注册(即: 扫描指定包下的 @FeignClient 注解标注的接口、生成 FeignClient 动态代理类、触发后面的其他流程)。</p>
<h4 id="feignclientsregistrar-类">FeignClientsRegistrar 类</h4>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202402291451526.png" alt="202402291451526"/>
<p>由于 <code>FeignClientsRegistrar</code> 实现自 <code>ImportBeanDefinitionRegistrar</code>,结合 <a href="spring-deifinition-integrated-impl.md">SpringBoot 的自动配置</a>,得知,在 SpringBoot 启动过程中会进入到 FeignClientsRegistrar#registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) 方法。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">registerBeanDefinitions</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">AnnotationMetadata</span><span style="--0:#F8F8F2"> metadata, </span><span style="--0:#8BE9FD;--0fs:italic">BeanDefinitionRegistry</span><span style="--0:#F8F8F2"> registry) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 注册默认配置</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">registerDefaultConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(metadata, registry);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 注册所有的 FeignClient</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">registerFeignClients</span><span style="--0:#F8F8F2;--1:#24292E">(metadata, registry);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void registerBeanDefinitions(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {    // 注册默认配置    this.registerDefaultConfiguration(metadata, registry);    // 注册所有的 FeignClient    this.registerFeignClients(metadata, registry);}"><div></div></button></div></figure></div>
<p><code>registerBeanDefinitions()</code> 方法是 Feign 的核心入口方法,其中会做两件事: 注册默认的配置、注册所有的 FeignClient。</p>
<h5 id="注册默认配置">注册默认配置</h5>
<p><code>registerDefaultConfiguration()</code> 方法负责注册 openfeign 的默认配置。具体代码执行流程如下:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">registerDefaultConfiguration</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">AnnotationMetadata</span><span style="--0:#F8F8F2"> metadata, </span><span style="--0:#8BE9FD;--0fs:italic">BeanDefinitionRegistry</span><span style="--0:#F8F8F2"> registry) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取 @EnableFeignClients 注解中的全部属性</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; defaultAttrs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getAnnotationAttributes</span><span style="--0:#F8F8F2;--1:#24292E">(EnableFeignClients.class.</span><span style="--0:#50FA7B;--1:#6F42C1">getName</span><span style="--0:#F8F8F2;--1:#24292E">(), </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (defaultAttrs </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> defaultAttrs.</span><span style="--0:#50FA7B;--1:#6F42C1">containsKey</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">defaultConfiguration</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> name;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">hasEnclosingClass</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">default.</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getEnclosingClassName</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 默认这里,name 为启动类全路径名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">default.</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getClassName</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 将以name 作为 beanName 的 BeanDefinition 注册到 BeanDefinitionRegistry 中</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">registerClientConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(registry, name, defaultAttrs.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">defaultConfiguration</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void registerDefaultConfiguration(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {    // 获取 @EnableFeignClients 注解中的全部属性    Map<String, Object> defaultAttrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName(), true);    if (defaultAttrs != null &#38;&#38; defaultAttrs.containsKey(&#34;defaultConfiguration&#34;)) {        String name;        if (metadata.hasEnclosingClass()) {            name = &#34;default.&#34; + metadata.getEnclosingClassName();        } else {            // 默认这里,name 为启动类全路径名            name = &#34;default.&#34; + metadata.getClassName();        }        // 将以name 作为 beanName 的 BeanDefinition 注册到 BeanDefinitionRegistry 中        this.registerClientConfiguration(registry, name, defaultAttrs.get(&#34;defaultConfiguration&#34;));    }}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">registerClientConfiguration</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">BeanDefinitionRegistry</span><span style="--0:#F8F8F2"> registry, </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> name, </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> configuration) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 构建 BeanDefinition</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">BeanDefinitionBuilder</span><span style="--0:#F8F8F2;--1:#24292E"> builder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> BeanDefinitionBuilder.</span><span style="--0:#50FA7B;--1:#6F42C1">genericBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">(FeignClientSpecification.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">builder.</span><span style="--0:#50FA7B;--1:#6F42C1">addConstructorArgValue</span><span style="--0:#F8F8F2;--1:#24292E">(name);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">builder.</span><span style="--0:#50FA7B;--1:#6F42C1">addConstructorArgValue</span><span style="--0:#F8F8F2;--1:#24292E">(configuration);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 注册 BeanDefinition</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">registry.</span><span style="--0:#50FA7B;--1:#6F42C1">registerBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">(name </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">.</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> FeignClientSpecification.class.</span><span style="--0:#50FA7B;--1:#6F42C1">getSimpleName</span><span style="--0:#F8F8F2;--1:#24292E">(), builder.</span><span style="--0:#50FA7B;--1:#6F42C1">getBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void registerClientConfiguration(BeanDefinitionRegistry registry, Object name, Object configuration) {    // 构建 BeanDefinition    BeanDefinitionBuilder builder = BeanDefinitionBuilder.genericBeanDefinition(FeignClientSpecification.class);    builder.addConstructorArgValue(name);    builder.addConstructorArgValue(configuration);    // 注册 BeanDefinition    registry.registerBeanDefinition(name + &#34;.&#34; + FeignClientSpecification.class.getSimpleName(), builder.getBeanDefinition());}"><div></div></button></div></figure></div>
<p>方法流程解析:</p>
<blockquote>
<p>1.首先获取 @EnableFeignClients 注解的全部属性</p>
<p>2.如果属性不为空,并且属性中包含 defaultConfiguration,则默认字符串 <code>default.</code> 和启动类全路径名拼接到一起</p>
<p>3.然后再拼接上 <code>.FeignClientSpecification</code>,作为 beanName,构建出一个 BeanDefinition,将其注册到 BeanDefinitionRegistry 中。</p>
</blockquote>
<h5 id="注册所有的-feignclient">注册所有的 FeignClient</h5>
<p>registerFeignClients()方法负责注册所有的FeignClient</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">registerFeignClients</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">AnnotationMetadata</span><span style="--0:#F8F8F2"> metadata, </span><span style="--0:#8BE9FD;--0fs:italic">BeanDefinitionRegistry</span><span style="--0:#F8F8F2"> registry) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取类扫描器</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ClassPathScanningCandidateComponentProvider</span><span style="--0:#F8F8F2;--1:#24292E"> scanner </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getScanner</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">scanner.</span><span style="--0:#50FA7B;--1:#6F42C1">setResourceLoader</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.resourceLoader);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取 @EnableFeignClients 注解中的全部属性</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; attrs </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getAnnotationAttributes</span><span style="--0:#F8F8F2;--1:#24292E">(EnableFeignClients.class.</span><span style="--0:#50FA7B;--1:#6F42C1">getName</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 给类扫描器添加 Filter,只扫描 @FeignClient 注解</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AnnotationTypeFilter</span><span style="--0:#F8F8F2;--1:#24292E"> annotationTypeFilter </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">AnnotationTypeFilter</span><span style="--0:#F8F8F2;--1:#24292E">(FeignClient.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取 @EnableFeignClients 注解中的 clients 属性值,默认为空</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] clients </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> attrs </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[])((</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[])attrs.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">clients</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Object</span><span style="--0:#F8F8F2;--1:#24292E"> basePackages;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (clients </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> clients.length </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Set</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">&gt; clientClasses </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">HashSet</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">HashSet</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[] var9 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> clients;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var10 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> clients.length;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var11 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">; var11 </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> var10; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">var11) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt; clazz </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var9[var11];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">((Set)basePackages).</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(ClassUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">getPackageName</span><span style="--0:#F8F8F2;--1:#24292E">(clazz));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">clientClasses.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(clazz.</span><span style="--0:#50FA7B;--1:#6F42C1">getCanonicalName</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AbstractClassTestingTypeFilter</span><span style="--0:#F8F8F2;--1:#24292E"> filter </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">AbstractClassTestingTypeFilter</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">match</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">ClassMetadata</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">metadata</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> cleaned </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getClassName</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">replaceAll</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#E9F284;--1:#032F62">&quot;</span><span style="--0:#FF79C6;--1:#005CC5">\\</span><span style="--1:#032F62"><span style="--0:#F1FA8C">$</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">.</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> clientClasses.</span><span style="--0:#50FA7B;--1:#6F42C1">contains</span><span style="--0:#F8F8F2;--1:#24292E">(cleaned);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">};</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">scanner.</span><span style="--0:#50FA7B;--1:#6F42C1">addIncludeFilter</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">AllTypeFilter</span><span style="--0:#F8F8F2;--1:#24292E">(Arrays.</span><span style="--0:#50FA7B;--1:#6F42C1">asList</span><span style="--0:#F8F8F2;--1:#24292E">(filter, annotationTypeFilter)));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">scanner.</span><span style="--0:#50FA7B;--1:#6F42C1">addIncludeFilter</span><span style="--0:#F8F8F2;--1:#24292E">(annotationTypeFilter);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getBasePackages</span><span style="--0:#F8F8F2;--1:#24292E">(metadata);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Iterator</span><span style="--0:#F8F8F2;--1:#24292E"> var17 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> ((Set)basePackages).</span><span style="--0:#50FA7B;--1:#6F42C1">iterator</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E">(var17.</span><span style="--0:#50FA7B;--1:#6F42C1">hasNext</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> basePackage </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (String)var17.</span><span style="--0:#50FA7B;--1:#6F42C1">next</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 遍历扫描到的所有包含 @FeignClient 注解的接口(BeanDefinition)</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Set</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">BeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">&gt; candidateComponents </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> scanner.</span><span style="--0:#50FA7B;--1:#6F42C1">findCandidateComponents</span><span style="--0:#F8F8F2;--1:#24292E">(basePackage);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Iterator</span><span style="--0:#F8F8F2;--1:#24292E"> var21 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> candidateComponents.</span><span style="--0:#50FA7B;--1:#6F42C1">iterator</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E">(var21.</span><span style="--0:#50FA7B;--1:#6F42C1">hasNext</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">BeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E"> candidateComponent </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (BeanDefinition)var21.</span><span style="--0:#50FA7B;--1:#6F42C1">next</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (candidateComponent </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> AnnotatedBeanDefinition) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AnnotatedBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E"> beanDefinition </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (AnnotatedBeanDefinition)candidateComponent;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AnnotationMetadata</span><span style="--0:#F8F8F2;--1:#24292E"> annotationMetadata </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> beanDefinition.</span><span style="--0:#50FA7B;--1:#6F42C1">getMetadata</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#96A1C2;--1:#616972">// 如果标注了 @FeignClient 注解的 Class 不是接口类型,则触发断言</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">Assert.</span><span style="--0:#50FA7B;--1:#6F42C1">isTrue</span><span style="--0:#F8F8F2;--1:#24292E">(annotationMetadata.</span><span style="--0:#50FA7B;--1:#6F42C1">isInterface</span><span style="--0:#F8F8F2;--1:#24292E">(), </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">@FeignClient can only be specified on an interface</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#96A1C2;--1:#616972">// 获取 @FeignClient 注解的全部属性</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; attributes </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> annotationMetadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getAnnotationAttributes</span><span style="--0:#F8F8F2;--1:#24292E">(FeignClient.class.</span><span style="--0:#50FA7B;--1:#6F42C1">getCanonicalName</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#96A1C2;--1:#616972">// 从 @FeignClient 注解中获取要调用的服务名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getClientName</span><span style="--0:#F8F8F2;--1:#24292E">(attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#96A1C2;--1:#616972">// 将要调用的服务名称 + @FeignClient 的配置属性,在 BeanDefinitionRegistry 中注册一下</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">registerClientConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(registry, name, attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">configuration</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#96A1C2;--1:#616972">// 注册 FeignClient</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">registerFeignClient</span><span style="--0:#F8F8F2;--1:#24292E">(registry, annotationMetadata, attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public void registerFeignClients(AnnotationMetadata metadata, BeanDefinitionRegistry registry) {    // 获取类扫描器    ClassPathScanningCandidateComponentProvider scanner = this.getScanner();    scanner.setResourceLoader(this.resourceLoader);    // 获取 @EnableFeignClients 注解中的全部属性    Map<String, Object> attrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName());    // 给类扫描器添加 Filter,只扫描 @FeignClient 注解    AnnotationTypeFilter annotationTypeFilter = new AnnotationTypeFilter(FeignClient.class);    // 获取 @EnableFeignClients 注解中的 clients 属性值,默认为空    Class<?>[] clients = attrs == null ? null : (Class[])((Class[])attrs.get(&#34;clients&#34;));    Object basePackages;    if (clients != null &#38;&#38; clients.length != 0) {        final Set<String> clientClasses = new HashSet();        basePackages = new HashSet();        Class[] var9 = clients;        int var10 = clients.length;        for(int var11 = 0; var11 < var10; ++var11) {            Class<?> clazz = var9[var11];            ((Set)basePackages).add(ClassUtils.getPackageName(clazz));            clientClasses.add(clazz.getCanonicalName());        }        AbstractClassTestingTypeFilter filter = new AbstractClassTestingTypeFilter() {            protected boolean match(ClassMetadata metadata) {                String cleaned = metadata.getClassName().replaceAll(&#34;\\$&#34;, &#34;.&#34;);                return clientClasses.contains(cleaned);            }        };        scanner.addIncludeFilter(new AllTypeFilter(Arrays.asList(filter, annotationTypeFilter)));    } else {        scanner.addIncludeFilter(annotationTypeFilter);        basePackages = this.getBasePackages(metadata);    }    Iterator var17 = ((Set)basePackages).iterator();    while(var17.hasNext()) {        String basePackage = (String)var17.next();        // 遍历扫描到的所有包含 @FeignClient 注解的接口(BeanDefinition)        Set<BeanDefinition> candidateComponents = scanner.findCandidateComponents(basePackage);        Iterator var21 = candidateComponents.iterator();        while(var21.hasNext()) {            BeanDefinition candidateComponent = (BeanDefinition)var21.next();            if (candidateComponent instanceof AnnotatedBeanDefinition) {                AnnotatedBeanDefinition beanDefinition = (AnnotatedBeanDefinition)candidateComponent;                AnnotationMetadata annotationMetadata = beanDefinition.getMetadata();                // 如果标注了 @FeignClient 注解的 Class 不是接口类型,则触发断言                Assert.isTrue(annotationMetadata.isInterface(), &#34;@FeignClient can only be specified on an interface&#34;);                // 获取 @FeignClient 注解的全部属性                Map<String, Object> attributes = annotationMetadata.getAnnotationAttributes(FeignClient.class.getCanonicalName());                // 从 @FeignClient 注解中获取要调用的服务名                String name = this.getClientName(attributes);                // 将要调用的服务名称 + @FeignClient 的配置属性,在 BeanDefinitionRegistry 中注册一下                this.registerClientConfiguration(registry, name, attributes.get(&#34;configuration&#34;));                // 注册 FeignClient                this.registerFeignClient(registry, annotationMetadata, attributes);            }        }    }}"><div></div></button></div></figure></div>
<p>**方法逻辑解析: **</p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解的所有属性,主要为了拿到扫描包路径(basePackages);</p>
<p>2.因为一般不会在@EnableFeignClients注解中配置clients属性,所以会进入到clients属性为空时的逻辑;</p>
<p>3.然后通过getScanner()方法获取扫描器: ClassPathScanningCandidateComponentProvider,并将上下文AnnotationConfigServletWebServerApplicationContext作为扫描器的ResourceLoader;</p>
<p>4.接着给扫描器ClassPathScanningCandidateComponentProvider添加一个注解过滤器(AnnotationTypeFilter),只过滤出包含@FeignClient注解的BeanDefinition;</p>
<p>5.再通过getBasePackages(metadata)方法获取@EnableFeingClients注解中的指定的包扫描路径 或 扫描类;如果没有获取到,则默认扫描启动类所在的包路径;</p>
<p>6.然后进入到核心逻辑: 通过scanner.findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口;</p>
<p>7.最后将FeignClientConfiguration 在BeanDefinitionRegistry中注册一下,再对FeignClient做真正的注册操作。</p>
</blockquote>
<h5 id="获取包扫描路径">获取包扫描路径</h5>
<p>FeignClientsRegistrar#getBasePackages(metadata)方法负责获取包路径:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Set</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">String</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">getBasePackages</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">AnnotationMetadata</span><span style="--0:#F8F8F2"> importingClassMetadata) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取 @EnableFeignClients 注解的全部属性</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; attributes </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> importingClassMetadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getAnnotationAttributes</span><span style="--0:#F8F8F2;--1:#24292E">(EnableFeignClients.class.</span><span style="--0:#50FA7B;--1:#6F42C1">getCanonicalName</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Set</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">&gt; basePackages </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">HashSet</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[] var4 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[])((</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[])attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">value</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var5 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var4.length;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var6;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> pkg;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(var6 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">; var6 </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> var5; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">var6) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">pkg </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var4[var6];</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (StringUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">hasText</span><span style="--0:#F8F8F2;--1:#24292E">(pkg)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(pkg);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 指定包路径</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">var4 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[])((</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[])attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">basePackages</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">var5 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var4.length;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(var6 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">; var6 </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> var5; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">var6) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">pkg </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var4[var6];</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (StringUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">hasText</span><span style="--0:#F8F8F2;--1:#24292E">(pkg)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(pkg);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 指定类名场景下,获取指定类所在的包</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[] var8 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[])((</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Class</span><span style="--0:#F8F8F2;--1:#24292E">[])attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">basePackageClasses</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">var5 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var8.length;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(var6 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">; var6 </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> var5; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">var6) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Class</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt; clazz </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var8[var6];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(ClassUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">getPackageName</span><span style="--0:#F8F8F2;--1:#24292E">(clazz));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (basePackages.</span><span style="--0:#50FA7B;--1:#6F42C1">isEmpty</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 如果没有 @EnableFeignClient 注解没有指定扫描的包路径或类,则返回启动类所在的包</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">basePackages.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(ClassUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">getPackageName</span><span style="--0:#F8F8F2;--1:#24292E">(importingClassMetadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getClassName</span><span style="--0:#F8F8F2;--1:#24292E">()));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> basePackages;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected Set<String> getBasePackages(AnnotationMetadata importingClassMetadata) {    // 获取 @EnableFeignClients 注解的全部属性    Map<String, Object> attributes = importingClassMetadata.getAnnotationAttributes(EnableFeignClients.class.getCanonicalName());    Set<String> basePackages = new HashSet();    String[] var4 = (String[])((String[])attributes.get(&#34;value&#34;));    int var5 = var4.length;    int var6;    String pkg;    for(var6 = 0; var6 < var5; ++var6) {        pkg = var4[var6];        if (StringUtils.hasText(pkg)) {            basePackages.add(pkg);        }    }    // 指定包路径    var4 = (String[])((String[])attributes.get(&#34;basePackages&#34;));    var5 = var4.length;    for(var6 = 0; var6 < var5; ++var6) {        pkg = var4[var6];        if (StringUtils.hasText(pkg)) {            basePackages.add(pkg);        }    }    // 指定类名场景下,获取指定类所在的包    Class[] var8 = (Class[])((Class[])attributes.get(&#34;basePackageClasses&#34;));    var5 = var8.length;    for(var6 = 0; var6 < var5; ++var6) {        Class<?> clazz = var8[var6];        basePackages.add(ClassUtils.getPackageName(clazz));    }    if (basePackages.isEmpty()) {        // 如果没有 @EnableFeignClient 注解没有指定扫描的包路径或类,则返回启动类所在的包        basePackages.add(ClassUtils.getPackageName(importingClassMetadata.getClassName()));    }    return basePackages;}"><div></div></button></div></figure></div>
<p>**方法执行逻辑解析: **</p>
<blockquote>
<p>1.首先获取@EnableFeignClients注解中的全部属性;</p>
<p>2.如果指定了basePackages,则采用basePackages指定的目录作为包扫描路径;</p>
<p>3.如果指定了一些basePackageClasses,则采用basePackageClasses指定的类们所在的目录 作为包扫描路径;</p>
<p>4.如果既没有指定basePackages,也没有指定basePackageClasses,则采用启动类所在的目录作为包扫描路径。默认是这种情况。</p>
</blockquote>
<h5 id="扫描所有的-feignclient">扫描所有的 FeignClient</h5>
<p>ClassPathScanningCandidateComponentProvider#findCandidateComponents(String basePackage)方法负责扫描出指定目录下的所有标注了@FeignClient注解的Class类(包括interface、正常的Class)。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Set</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">BeanDefinition</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">findCandidateComponents</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">String</span><span style="--0:#F8F8F2"> basePackage) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.componentsIndex </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">indexSupportsIncludeFilters</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">addCandidateComponentsFromIndex</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.componentsIndex, basePackage) </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">scanCandidateComponents</span><span style="--0:#F8F8F2;--1:#24292E">(basePackage);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Set<BeanDefinition> findCandidateComponents(String basePackage) {    return this.componentsIndex != null &#38;&#38; this.indexSupportsIncludeFilters() ? this.addCandidateComponentsFromIndex(this.componentsIndex, basePackage) : this.scanCandidateComponents(basePackage);}"><div></div></button></div></figure></div>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// basePackage: 启动类所在的目录</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Set</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">BeanDefinition</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">scanCandidateComponents</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">String</span><span style="--0:#F8F8F2"> basePackage) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Set</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">BeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">&gt; candidates </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">LinkedHashSet</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> packageSearchPath </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">classpath*:</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">resolveBasePackage</span><span style="--0:#F8F8F2;--1:#24292E">(basePackage) </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&#39;</span><span style="--0:#F1FA8C">/</span><span style="--0:#E9F284">&#39;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.resourcePattern;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 扫描出指定路径下的所有 Class 文件</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Resource</span><span style="--0:#F8F8F2;--1:#24292E">[] resources </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getResourcePatternResolver</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">getResources</span><span style="--0:#F8F8F2;--1:#24292E">(packageSearchPath);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> traceEnabled </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">isTraceEnabled</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> debugEnabled </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">isDebugEnabled</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Resource</span><span style="--0:#F8F8F2;--1:#24292E">[] var7 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> resources;</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var8 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> resources.length;</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 遍历每个 Class 文件</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> var9 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">; var9 </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E"> var8; </span><span style="--0:#FF79C6;--1:#BF3441">++</span><span style="--0:#F8F8F2;--1:#24292E">var9) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Resource</span><span style="--0:#F8F8F2;--1:#24292E"> resource </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> var7[var9];</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (traceEnabled) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">trace</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Scanning </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (resource.</span><span style="--0:#50FA7B;--1:#6F42C1">isReadable</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">MetadataReader</span><span style="--0:#F8F8F2;--1:#24292E"> metadataReader </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getMetadataReaderFactory</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">getMetadataReader</span><span style="--0:#F8F8F2;--1:#24292E">(resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#96A1C2;--1:#616972">// 根据 Scanner 中的 @FeignClient 过滤器,过滤出所有被 @FeignClient 注解标注的 Class</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">isCandidateComponent</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ScannedGenericBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E"> sbd </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ScannedGenericBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                        </span></span><span style="--0:#F8F8F2;--1:#24292E">sbd.</span><span style="--0:#50FA7B;--1:#6F42C1">setSource</span><span style="--0:#F8F8F2;--1:#24292E">(resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent">                        </span><span style="--0:#96A1C2;--1:#616972">// 这里默认都返回 true,获取 Scanner 时重写了这个方法</span></div></div><div class="ec-line"><div class="code"><span class="indent">                        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">isCandidateComponent</span><span style="--0:#F8F8F2;--1:#24292E">((AnnotatedBeanDefinition)sbd)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (debugEnabled) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                                </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">debug</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Identified candidate component class: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#96A1C2;--1:#616972">// 最终标注了 @FeignClient 注解的 Class 都会放到这里,并返回</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                            </span></span><span style="--0:#F8F8F2;--1:#24292E">candidates.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(sbd);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (debugEnabled) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">debug</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Ignored because not a concrete top-level class: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (traceEnabled) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                        </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">trace</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Ignored because not matching any filter: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Throwable</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">var13</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BeanDefinitionStoreException</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Failed to read candidate component class: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource, var13);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (traceEnabled) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger.</span><span style="--0:#50FA7B;--1:#6F42C1">trace</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Ignored because not readable: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> resource);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> candidates;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">IOException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">var14</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BeanDefinitionStoreException</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">I/O failure during classpath scanning</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, var14);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// basePackage: 启动类所在的目录private Set<BeanDefinition> scanCandidateComponents(String basePackage) {    Set<BeanDefinition> candidates = new LinkedHashSet();    try {        String packageSearchPath = &#34;classpath*:&#34; + this.resolveBasePackage(basePackage) + '/' + this.resourcePattern;        // 扫描出指定路径下的所有 Class 文件        Resource[] resources = this.getResourcePatternResolver().getResources(packageSearchPath);        boolean traceEnabled = this.logger.isTraceEnabled();        boolean debugEnabled = this.logger.isDebugEnabled();        Resource[] var7 = resources;        int var8 = resources.length;        // 遍历每个 Class 文件        for(int var9 = 0; var9 < var8; ++var9) {            Resource resource = var7[var9];            if (traceEnabled) {                this.logger.trace(&#34;Scanning &#34; + resource);            }            if (resource.isReadable()) {                try {                    MetadataReader metadataReader = this.getMetadataReaderFactory().getMetadataReader(resource);                    // 根据 Scanner 中的 @FeignClient 过滤器,过滤出所有被 @FeignClient 注解标注的 Class                    if (this.isCandidateComponent(metadataReader)) {                        ScannedGenericBeanDefinition sbd = new ScannedGenericBeanDefinition(metadataReader);                        sbd.setSource(resource);                        // 这里默认都返回 true,获取 Scanner 时重写了这个方法                        if (this.isCandidateComponent((AnnotatedBeanDefinition)sbd)) {                            if (debugEnabled) {                                this.logger.debug(&#34;Identified candidate component class: &#34; + resource);                            }                            // 最终标注了 @FeignClient 注解的 Class 都会放到这里,并返回                            candidates.add(sbd);                        } else if (debugEnabled) {                            this.logger.debug(&#34;Ignored because not a concrete top-level class: &#34; + resource);                        }                    } else if (traceEnabled) {                        this.logger.trace(&#34;Ignored because not matching any filter: &#34; + resource);                    }                } catch (Throwable var13) {                    throw new BeanDefinitionStoreException(&#34;Failed to read candidate component class: &#34; + resource, var13);                }            } else if (traceEnabled) {                this.logger.trace(&#34;Ignored because not readable: &#34; + resource);            }        }        return candidates;    } catch (IOException var14) {        throw new BeanDefinitionStoreException(&#34;I/O failure during classpath scanning&#34;, var14);    }}"><div></div></button></div></figure></div>
<p>**方法逻辑解析: **</p>
<blockquote>
<p>1.首先扫描出指定路径下的所有Class文件;</p>
<p>2.接着遍历每个Class文件,使用Scanner中的@FeignClient过滤器过滤出所有被@FeignClient注解标注的Class;</p>
<p>3.最后将过滤出的所有Class返回。</p>
</blockquote>
<p>细看一下 <code>isCandidateComponent(MetadataReader metadataReader)</code> 方法:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">isCandidateComponent</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">MetadataReader</span><span style="--0:#F8F8F2"> metadataReader) throws IOException {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Iterator</span><span style="--0:#F8F8F2;--1:#24292E"> var2 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.excludeFilters.</span><span style="--0:#50FA7B;--1:#6F42C1">iterator</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">TypeFilter</span><span style="--0:#F8F8F2;--1:#24292E"> tf;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">do</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">var2.</span><span style="--0:#50FA7B;--1:#6F42C1">hasNext</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// includeFilters 是在获取到 Scanner 之后添加的</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">var2 </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.includeFilters.</span><span style="--0:#50FA7B;--1:#6F42C1">iterator</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">do</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">var2.</span><span style="--0:#50FA7B;--1:#6F42C1">hasNext</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">                    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">tf </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (TypeFilter)var2.</span><span style="--0:#50FA7B;--1:#6F42C1">next</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 判断 Class 是否被 @FeignClient 注解标注</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">tf.</span><span style="--0:#50FA7B;--1:#6F42C1">match</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getMetadataReaderFactory</span><span style="--0:#F8F8F2;--1:#24292E">()));</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">//条件装配</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">isConditionMatch</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">tf </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (TypeFilter)var2.</span><span style="--0:#50FA7B;--1:#6F42C1">next</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">tf.</span><span style="--0:#50FA7B;--1:#6F42C1">match</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getMetadataReaderFactory</span><span style="--0:#F8F8F2;--1:#24292E">()));</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected boolean isCandidateComponent(MetadataReader metadataReader) throws IOException {    Iterator var2 = this.excludeFilters.iterator();    TypeFilter tf;    do {        if (!var2.hasNext()) {            // includeFilters 是在获取到 Scanner 之后添加的            var2 = this.includeFilters.iterator();            do {                if (!var2.hasNext()) {                    return false;                }                tf = (TypeFilter)var2.next();            // 判断 Class 是否被 @FeignClient 注解标注            } while(!tf.match(metadataReader, this.getMetadataReaderFactory()));            //条件装配            return this.isConditionMatch(metadataReader);        }        tf = (TypeFilter)var2.next();    } while(!tf.match(metadataReader, this.getMetadataReaderFactory()));    return false;}"><div></div></button></div></figure></div>
<p>AbstractTypeHierarchyTraversingFilter#match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory)</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">match</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">MetadataReader</span><span style="--0:#F8F8F2"> metadataReader, </span><span style="--0:#8BE9FD;--0fs:italic">MetadataReaderFactory</span><span style="--0:#F8F8F2"> metadataReaderFactory) throws IOException {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">matchSelf</span><span style="--0:#F8F8F2;--1:#24292E">(metadataReader)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">...</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">AnnotationTypeFilter#</span><span style="--0:#50FA7B;--1:#6F42C1">matchSelf</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">MetadataReader</span><span style="--0:#F8F8F2"> metadataReader)</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">```java</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">matchSelf</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">MetadataReader</span><span style="--0:#F8F8F2"> metadataReader) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AnnotationMetadata</span><span style="--0:#F8F8F2;--1:#24292E"> metadata </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadataReader.</span><span style="--0:#50FA7B;--1:#6F42C1">getAnnotationMetadata</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">hasAnnotation</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.annotationType.</span><span style="--0:#50FA7B;--1:#6F42C1">getName</span><span style="--0:#F8F8F2;--1:#24292E">()) </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.considerMetaAnnotations </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">hasMetaAnnotation</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.annotationType.</span><span style="--0:#50FA7B;--1:#6F42C1">getName</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public boolean match(MetadataReader metadataReader, MetadataReaderFactory metadataReaderFactory) throws IOException {  if (this.matchSelf(metadataReader)) {      return true;  }  ...}AnnotationTypeFilter#matchSelf(MetadataReader metadataReader)```javaprotected boolean matchSelf(MetadataReader metadataReader) {    AnnotationMetadata metadata = metadataReader.getAnnotationMetadata();    return metadata.hasAnnotation(this.annotationType.getName()) || this.considerMetaAnnotations &#38;&#38; metadata.hasMetaAnnotation(this.annotationType.getName());}"><div></div></button></div></figure></div>
<h5 id="注册feignclient">注册FeignClient</h5>
<p>扫描到所有的FeignClient之后,需要将其注入到Spring中,<code>FeignClientsRegistrar#registerFeignClient()</code> 方法负责这个操作;</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">registerFeignClient</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">BeanDefinitionRegistry</span><span style="--0:#F8F8F2"> registry, </span><span style="--0:#8BE9FD;--0fs:italic">AnnotationMetadata</span><span style="--0:#F8F8F2"> annotationMetadata, </span><span style="--0:#8BE9FD;--0fs:italic">Map</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">String, Object</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> attributes) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> className </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> annotationMetadata.</span><span style="--0:#50FA7B;--1:#6F42C1">getClassName</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 构建 FeignClient 对应的 BeanDefinition</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">BeanDefinitionBuilder</span><span style="--0:#F8F8F2;--1:#24292E"> definition </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> BeanDefinitionBuilder.</span><span style="--0:#50FA7B;--1:#6F42C1">genericBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">(FeignClientFactoryBean.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">validate</span><span style="--0:#F8F8F2;--1:#24292E">(attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">url</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getUrl</span><span style="--0:#F8F8F2;--1:#24292E">(attributes));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">path</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getPath</span><span style="--0:#F8F8F2;--1:#24292E">(attributes));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> name </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getName</span><span style="--0:#F8F8F2;--1:#24292E">(attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">name</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, name);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> contextId </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getContextId</span><span style="--0:#F8F8F2;--1:#24292E">(attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">contextId</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, contextId);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">type</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, className);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">decode404</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">decode404</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">fallback</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">fallback</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">addPropertyValue</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">fallbackFactory</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">fallbackFactory</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">definition.</span><span style="--0:#50FA7B;--1:#6F42C1">setAutowireMode</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">2</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> alias </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> contextId </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">FeignClient</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">AbstractBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E"> beanDefinition </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> definition.</span><span style="--0:#50FA7B;--1:#6F42C1">getBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">beanDefinition.</span><span style="--0:#50FA7B;--1:#6F42C1">setAttribute</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">factoryBeanObjectType</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, className);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">boolean</span><span style="--0:#F8F8F2;--1:#24292E"> primary </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Boolean)attributes.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">primary</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">beanDefinition.</span><span style="--0:#50FA7B;--1:#6F42C1">setPrimary</span><span style="--0:#F8F8F2;--1:#24292E">(primary);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 如果 FeignClient 配置了别名,则采用别名作为 beanName</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> qualifier </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getQualifier</span><span style="--0:#F8F8F2;--1:#24292E">(attributes);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (StringUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">hasText</span><span style="--0:#F8F8F2;--1:#24292E">(qualifier)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">alias </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> qualifier;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">BeanDefinitionHolder</span><span style="--0:#F8F8F2;--1:#24292E"> holder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BeanDefinitionHolder</span><span style="--0:#F8F8F2;--1:#24292E">(beanDefinition, className, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">[]{alias});</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将 FeignClient 注册到 Spring 的临时容器</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">BeanDefinitionReaderUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">registerBeanDefinition</span><span style="--0:#F8F8F2;--1:#24292E">(holder, registry);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private void registerFeignClient(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata, Map<String, Object> attributes) {    String className = annotationMetadata.getClassName();    // 构建 FeignClient 对应的 BeanDefinition    BeanDefinitionBuilder definition = BeanDefinitionBuilder.genericBeanDefinition(FeignClientFactoryBean.class);    this.validate(attributes);    definition.addPropertyValue(&#34;url&#34;, this.getUrl(attributes));    definition.addPropertyValue(&#34;path&#34;, this.getPath(attributes));    String name = this.getName(attributes);    definition.addPropertyValue(&#34;name&#34;, name);    String contextId = this.getContextId(attributes);    definition.addPropertyValue(&#34;contextId&#34;, contextId);    definition.addPropertyValue(&#34;type&#34;, className);    definition.addPropertyValue(&#34;decode404&#34;, attributes.get(&#34;decode404&#34;));    definition.addPropertyValue(&#34;fallback&#34;, attributes.get(&#34;fallback&#34;));    definition.addPropertyValue(&#34;fallbackFactory&#34;, attributes.get(&#34;fallbackFactory&#34;));    definition.setAutowireMode(2);    String alias = contextId + &#34;FeignClient&#34;;    AbstractBeanDefinition beanDefinition = definition.getBeanDefinition();    beanDefinition.setAttribute(&#34;factoryBeanObjectType&#34;, className);    boolean primary = (Boolean)attributes.get(&#34;primary&#34;);    beanDefinition.setPrimary(primary);    // 如果 FeignClient 配置了别名,则采用别名作为 beanName    String qualifier = this.getQualifier(attributes);    if (StringUtils.hasText(qualifier)) {        alias = qualifier;    }    BeanDefinitionHolder holder = new BeanDefinitionHolder(beanDefinition, className, new String[]{alias});    // 将 FeignClient 注册到 Spring 的临时容器    BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);}"><div></div></button></div></figure></div>
<p>注册FeignClient实际就是构建一个FeignClient对应的BeanDefinition,然后将FeignClient的一些属性配置设置为BeanDefinition的property,最后将BeanDefinition注册到Spring的临时容器。在处理FeignClient的属性配置时,如果@FeignClient中配置了qualifier,则使用qualifier作为beanName。</p>
<p>到这里已经完成了包的扫描、FeignClient的解析、FeignClient数据以BeanDefinition的形式存储到spring框架中的BeanDefinitionRegistry中。</p>
<h3 id="feignclient-的动态代理类">FeignClient 的动态代理类</h3>
<p>在<code>AbstractApplicationContext#refresh()</code>方法中最后调用的<code>finishBeanFactoryInitialization(beanFactory)</code>方法中会将所有类全部注入到Spring容器中;在将ServiceBController注入到Spring容器过程中,会将其成员ServiceAClient也注入到Spring容器中,<code>AbstractAutowireCapableBeanFactory#populateBean()</code>方法会处理ServiceAClient,进而调用到<code>AutowiredAnnotationBeanPostProcessor#postProcessProperties()</code>方法对ServiceAClient做一个注入操作。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011534065.png" alt="202403011534065"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011541600.png" alt="202403011541600"/>
<p>走到<code>AbstractBeanFactory#getBean(String)</code>方法获取ServiceBController依赖的成员类型ServiceAClient。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011542177.png" alt="202403011542177"/>
<p>由于我们在注册FeignClient到Spring容器时,构建的BeanDefinition的beanClas是FeignClientFactoryBean。</p>
<p>FeignClientFactoryBean是一个工厂,保存了@FeignClient注解的所有属性值,在Spring容器初始化的过程中,其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011547458.png" alt="202403011547458"/>
<p>从debug的堆栈信息我们可以看到是FeignClientFactoryBean#getObject()方法负责获取/创建动态代理类。</p>
<h4 id="feignclientfactorybean-创建动态代理类的入口">FeignClientFactoryBean 创建动态代理类的入口</h4>
<p>我们都知道要通过注册到 Spring 容器中的 FeignClient 的 BeanDefinition 的 beanClass 属性是 FeignClientFactoryBean,所以大概率和 FeignClientFactoryBean 是相关的,怎么找呐?连蒙带猜~</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> Feign.Builder </span><span style="--0:#50FA7B;--1:#6F42C1">feign</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">FeignContext</span><span style="--0:#F8F8F2"> context) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">FeignLoggerFactory</span><span style="--0:#F8F8F2;--1:#24292E"> loggerFactory </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (FeignLoggerFactory)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, FeignLoggerFactory.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Logger</span><span style="--0:#F8F8F2;--1:#24292E"> logger </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> loggerFactory.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.type);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Feign</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Builder</span><span style="--0:#F8F8F2;--1:#24292E"> builder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> ((Feign.Builder)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Feign.Builder.class)).</span><span style="--0:#50FA7B;--1:#6F42C1">logger</span><span style="--0:#F8F8F2;--1:#24292E">(logger).</span><span style="--0:#50FA7B;--1:#6F42C1">encoder</span><span style="--0:#F8F8F2;--1:#24292E">((Encoder)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Encoder.class)).</span><span style="--0:#50FA7B;--1:#6F42C1">decoder</span><span style="--0:#F8F8F2;--1:#24292E">((Decoder)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Decoder.class)).</span><span style="--0:#50FA7B;--1:#6F42C1">contract</span><span style="--0:#F8F8F2;--1:#24292E">((Contract)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Contract.class));</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 处理 Feign.Builder 的配置信息</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureFeign</span><span style="--0:#F8F8F2;--1:#24292E">(context, builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> builder;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected Feign.Builder feign(FeignContext context) {    FeignLoggerFactory loggerFactory = (FeignLoggerFactory)this.get(context, FeignLoggerFactory.class);    Logger logger = loggerFactory.create(this.type);    Feign.Builder builder = ((Feign.Builder)this.get(context, Feign.Builder.class)).logger(logger).encoder((Encoder)this.get(context, Encoder.class)).decoder((Decoder)this.get(context, Decoder.class)).contract((Contract)this.get(context, Contract.class));    // 处理 Feign.Builder 的配置信息    this.configureFeign(context, builder);    return builder;}"><div></div></button></div></figure></div>
<p>注意到 FeignClientFactoryBean 的 feign(FeignContext context) 方法,方法会构造一个 Feign.Builder,Builder,这不就是构造器模式嘛,基于 Feign.Builder 可以构造对应的 FeignClient。</p>
<p>再看哪里调用了 feign() 方法,找到 getTarget() 方法。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">T</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">T</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">getTarget</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">FeignContext</span><span style="--0:#F8F8F2;--1:#24292E"> context </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (FeignContext)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.applicationContext.</span><span style="--0:#50FA7B;--1:#6F42C1">getBean</span><span style="--0:#F8F8F2;--1:#24292E">(FeignContext.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Feign</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Builder</span><span style="--0:#F8F8F2;--1:#24292E"> builder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">feign</span><span style="--0:#F8F8F2;--1:#24292E">(context);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">StringUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">hasText</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name.</span><span style="--0:#50FA7B;--1:#6F42C1">startsWith</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">http</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">http://</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">cleanPath</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">loadBalance</span><span style="--0:#F8F8F2;--1:#24292E">(builder, context, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> Target.</span><span style="--0:#50FA7B;--1:#6F42C1">HardCodedTarget</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.type, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (StringUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">hasText</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url) </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url.</span><span style="--0:#50FA7B;--1:#6F42C1">startsWith</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">http</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">http://</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> url </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.url </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">cleanPath</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Client</span><span style="--0:#F8F8F2;--1:#24292E"> client </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Client)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getOptional</span><span style="--0:#F8F8F2;--1:#24292E">(context, Client.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (client </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (client </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> LoadBalancerFeignClient) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">client </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> ((LoadBalancerFeignClient)client).</span><span style="--0:#50FA7B;--1:#6F42C1">getDelegate</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (client </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> FeignBlockingLoadBalancerClient) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                </span></span><span style="--0:#F8F8F2;--1:#24292E">client </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> ((FeignBlockingLoadBalancerClient)client).</span><span style="--0:#50FA7B;--1:#6F42C1">getDelegate</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">builder.</span><span style="--0:#50FA7B;--1:#6F42C1">client</span><span style="--0:#F8F8F2;--1:#24292E">(client);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Targeter</span><span style="--0:#F8F8F2;--1:#24292E"> targeter </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Targeter)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Targeter.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> targeter.</span><span style="--0:#50FA7B;--1:#6F42C1">target</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, builder, context, </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> Target.</span><span style="--0:#50FA7B;--1:#6F42C1">HardCodedTarget</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.type, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name, url));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="<T> T getTarget() {    FeignContext context = (FeignContext)this.applicationContext.getBean(FeignContext.class);    Feign.Builder builder = this.feign(context);    if (!StringUtils.hasText(this.url)) {        if (!this.name.startsWith(&#34;http&#34;)) {            this.url = &#34;http://&#34; + this.name;        } else {            this.url = this.name;        }        this.url = this.url + this.cleanPath();        return this.loadBalance(builder, context, new Target.HardCodedTarget(this.type, this.name, this.url));    } else {        if (StringUtils.hasText(this.url) &#38;&#38; !this.url.startsWith(&#34;http&#34;)) {            this.url = &#34;http://&#34; + this.url;        }        String url = this.url + this.cleanPath();        Client client = (Client)this.getOptional(context, Client.class);        if (client != null) {            if (client instanceof LoadBalancerFeignClient) {                client = ((LoadBalancerFeignClient)client).getDelegate();            }            if (client instanceof FeignBlockingLoadBalancerClient) {                client = ((FeignBlockingLoadBalancerClient)client).getDelegate();            }            builder.client(client);        }        Targeter targeter = (Targeter)this.get(context, Targeter.class);        return targeter.target(this, builder, context, new Target.HardCodedTarget(this.type, this.name, url));    }}"><div></div></button></div></figure></div>
<p>对于有一定开发的经验而言,见到 Target 这一类东西,基本可以确定就是动态代理。</p>
<p>再往上追,看哪里调用了 getTarget() 方法?进入到 getObject() 方法。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">getObject</span><span style="--0:#F8F8F2;--1:#24292E">() throws Exception {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getTarget</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Object getObject() throws Exception {    return this.getTarget();}"><div></div></button></div></figure></div>
<p>而getObject()方法是FactoryBean接口中定义的方法。</p>
<p>到这里可以确定 FeignClientFactoryBean#getObject() 方法,在 Spring 容器初始化时,会被作为入口来调用,进而创建一个 ServiceAClient 的动态代理,返回给 Spring 容器并注册到 Spring 容器里去。</p>
<h4 id="feignbuilder的构建过程">Feign.Builder的构建过程</h4>
<p>上面我们得出结论: FeignClient 是通过 Feign.Builder 来构建的,生成 FeignClient 动态代理的入口是 FeignClientFactoryBean#getObject(),这里我们看一下 Feign.Builder 是如何构建的?</p>
<h5 id="feigncontext-上下文的获取">FeignContext 上下文的获取</h5>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011636380.png" alt="202403011636380"/>
<p>调用FeignClientFactoryBean#getObject()创建/获取FeignClient动态代理类时,首先要通过</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--1:#24292E"><span style="--0:#8BE9FD;--0fs:italic">FeignContext</span><span style="--0:#F8F8F2"> context </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> applicationContext.</span><span style="--0:#50FA7B;--1:#6F42C1">getBean</span><span style="--0:#F8F8F2;--1:#24292E">(FeignContext.class);</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="FeignContext context = applicationContext.getBean(FeignContext.class);"><div></div></button></div></figure></div>
<p>获取 feign 的上下文 FeignClient。
这里的 applicationContext 是 AnnotationConfigServletWebApplicationContext。</p>
<blockquote>
<p>ribbon里有一个SpringClientFactory,就是对每个服务的调用,都会有一个独立的ILoadBalancer,IoadBalancer里面的IRule、IPing都是独立的组件,也就是说ribbon要调用的每个服务都对应一个独立的spring容器;从那个独立的spring容器中,可以取出某个服务关联的属于自己的LoadBalancer、IRule、IPing等。</p>
</blockquote>
<p>FeignClient 也是类似的上下文:</p>
<blockquote>
<p>我们如果要调用一个服务的话,ServiceA,那么那个服务(ServiceA)就会关联一个独立的spring容器;关联着自己独立的一些组件,比如说独立的Logger组件,独立的Decoder组件,独立的Encoder组件;FeignContext则代表了一个独立的容器工厂,里面记录了每个服务对应的容器AnnotationConfigApplicationContext。</p>
<ul>
<li>因此,可以对不同的@FeignClient自定义不同的Configuration。</li>
</ul>
</blockquote>
<p><strong>FeignContext在哪里注入到Spring容器的?</strong>
FeignClient 位于 spring-cloud-openfeign-core 项目,我们在这个项目下结合 SpringBoot 自动装配的特性找 XxxAutoConfiguration 和 XxxConfiguration,最终找到 FeignAutoConfiguration。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011646192.png" alt="202403011646192"/>
<p>FeignAutoConfiguration中使用@Bean方法将FeignContext注入到Spring容器。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011649023.png" alt="202403011649023"/>
<p>FeignContext 继承自 NamedContextFactory,内部负责对每个服务都维护一个对应的spring容器(以map存储,一个服务对应一个spring容器),此处和 Ribbon 一样。</p>
<p>进入到 feign() 方法中,以获取 FeignLoggerFactory 为例:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011654599.png" alt="202403011654599"/>
<p>get(FeignContext context, Class type)方法要做的事情如下:</p>
<blockquote>
<ul>
<li>根据服务名称(ServiceA)去FeignContext里面去获取对应的FeignLoggerFactory;</li>
<li>其实就是根据ServiceA服务名称,先获取对应的spring容器,然后从那个spring容器中,获取自己独立的一个FeignLoggerFactory;</li>
</ul>
</blockquote>
<p>默认使用的 FeignLoggerFactory 是在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中加载的 DefaultFeignLoggerFactory,而 DefaultFeignLoggerFactory 中默认创建的是Slf4jLogger。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011704244.png" alt="202403011704244"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011705898.png" alt="202403011705898"/>
<h5 id="从-feignclient-中获取-feignbuilder">从 FeignClient 中获取 Feign.Builder</h5>
<p>这里和上面获取 FeignLoggerFactory 一样,在 spring-cloud-openfeign-core 项目的 FeignClientsConfiguration 类中会找到两个 Feign.Builder(一个和 Hystrix 相关,另外一个 Retryer 相关的(请求超时、失败重试))的注册逻辑:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011729059.png" alt="202403011729059"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011731270.png" alt="202403011731270"/>
<p>由于默认 feign.hystrix.enabled 属性为 false,所以默认注入的 Feign.Builder 是 Feign.builder().retryer(retryer)。</p>
<h5 id="处理配置信息">处理配置信息</h5>
<p>回到 feign() 方法,其中调用的 <code>configureFeign(context, builder)</code> 方法负责处理 Feign 的相关配置(即: 使用 application.yml 中配置的参数,来设置 Feign.Builder)。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403011745579.png" alt="202403011745579"/>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">void</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">configureFeign</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">FeignContext</span><span style="--0:#F8F8F2"> context, Feign.Builder builder) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">FeignClientProperties</span><span style="--0:#F8F8F2;--1:#24292E"> properties </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (FeignClientProperties)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.applicationContext.</span><span style="--0:#50FA7B;--1:#6F42C1">getBean</span><span style="--0:#F8F8F2;--1:#24292E">(FeignClientProperties.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">FeignClientConfigurer</span><span style="--0:#F8F8F2;--1:#24292E"> feignClientConfigurer </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (FeignClientConfigurer)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getOptional</span><span style="--0:#F8F8F2;--1:#24292E">(context, FeignClientConfigurer.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">setInheritParentContext</span><span style="--0:#F8F8F2;--1:#24292E">(feignClientConfigurer.</span><span style="--0:#50FA7B;--1:#6F42C1">inheritParentConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (properties </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.inheritParentContext) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (properties.</span><span style="--0:#50FA7B;--1:#6F42C1">isDefaultToProperties</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(context, builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 读取 application.yml 文件中针对所有服务 default 的配置</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingProperties</span><span style="--0:#F8F8F2;--1:#24292E">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getConfig</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getDefaultConfig</span><span style="--0:#F8F8F2;--1:#24292E">()), builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 读取 application.yml 文件中针对当前服务的配置</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingProperties</span><span style="--0:#F8F8F2;--1:#24292E">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getConfig</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.contextId), builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingProperties</span><span style="--0:#F8F8F2;--1:#24292E">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getConfig</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getDefaultConfig</span><span style="--0:#F8F8F2;--1:#24292E">()), builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingProperties</span><span style="--0:#F8F8F2;--1:#24292E">((FeignClientProperties.FeignClientConfiguration)properties.</span><span style="--0:#50FA7B;--1:#6F42C1">getConfig</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.contextId), builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(context, builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">configureUsingConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">(context, builder);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected void configureFeign(FeignContext context, Feign.Builder builder) {    FeignClientProperties properties = (FeignClientProperties)this.applicationContext.getBean(FeignClientProperties.class);    FeignClientConfigurer feignClientConfigurer = (FeignClientConfigurer)this.getOptional(context, FeignClientConfigurer.class);    this.setInheritParentContext(feignClientConfigurer.inheritParentConfiguration());    if (properties != null &#38;&#38; this.inheritParentContext) {        if (properties.isDefaultToProperties()) {            this.configureUsingConfiguration(context, builder);            // 读取 application.yml 文件中针对所有服务 default 的配置            this.configureUsingProperties((FeignClientProperties.FeignClientConfiguration)properties.getConfig().get(properties.getDefaultConfig()), builder);            // 读取 application.yml 文件中针对当前服务的配置            this.configureUsingProperties((FeignClientProperties.FeignClientConfiguration)properties.getConfig().get(this.contextId), builder);        } else {            this.configureUsingProperties((FeignClientProperties.FeignClientConfiguration)properties.getConfig().get(properties.getDefaultConfig()), builder);            this.configureUsingProperties((FeignClientProperties.FeignClientConfiguration)properties.getConfig().get(this.contextId), builder);            this.configureUsingConfiguration(context, builder);        }    } else {        this.configureUsingConfiguration(context, builder);    }}"><div></div></button></div></figure></div>
<p>**逻辑解析: **</p>
<blockquote>
<ol>
<li>FeignClientProperties是针对FeignClient的配置;</li>
<li>先读取application.yml中的feign.client打头的一些参数,包括了connectionTimeout、readTimeout之类的参数;如果application.yml中没有配置feign.client相关参数,则使用默认配置(Retryer retryer、ErrorDecoder、Request.Options等);</li>
<li>然后读取application.yml中针对当前要调用服务的配置。</li>
</ol>
<p>所以如果在 application.yml 文件中同时配置了针对全部服务和单个服务的配置,则针对单个服务的配置优先级更高,因为在代码解析中它是放在后面解析的,会覆盖前面解析的内容。</p>
</blockquote>
<h5 id="使用-feignbuilder-构建出一个-feignclient">使用 Feign.Builder 构建出一个 FeignClient</h5>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041111641.png" alt="202403041111641"/>
<p>如果在 @FeignClient 上,没有配置 url 属性,也就是没有指定服务的 url 地址,那么 Feign 就会自动跟 Ribbon 关联起来,采用 Ribbon 来进行负载均衡,直接拿出 @FeignClient 中配置的 name() 为 Ribbon 准备对应的 url 地址: <code>http://ServiceA</code>。</p>
<p>此外如果在 @FeignClient 注解中配置了 <code>path 属性</code>,就表示要访问的是这个 ServiceA 服务的莫一类接口,比如: @FeignClient(value=“ServiceA”, path=“/user”),在拼接请求 URL 地址的时候,就会拼接成: <code>http://ServiceA/user</code>。</p>
<p><code>FeignClientFactoryBean#loadBalance()</code> 方法是一个基于 Ribbon 进行负载均衡的 FeignClient 动态代理生成方法:</p>
<blockquote>
<p>入参:</p>
<ol>
<li>Feign.Builder builder —&gt; FeignClient构造器</li>
<li>FeignContext context —&gt; Feign上下文</li>
<li>HardCodedTarget&lt;T&gt; target,target是一个HardCodedTarget,硬编码的Target,里面包含了接口类型(com.zhss.service.ServiceAClient)、服务名称(ServiceA)、url地址(<a href="http://ServiceA" rel="nofollow, noopener, noreferrer" target="_blank">http://ServiceA</a>)</li>
</ol>
</blockquote>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">T</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">T</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">loadBalance</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(Feign.Builder builder, </span><span style="--0:#8BE9FD;--0fs:italic">FeignContext</span><span style="--0:#F8F8F2"> context, Target.HardCodedTarget</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">T</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> target) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Client</span><span style="--0:#F8F8F2;--1:#24292E"> client </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Client)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getOptional</span><span style="--0:#F8F8F2;--1:#24292E">(context, Client.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (client </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">builder.</span><span style="--0:#50FA7B;--1:#6F42C1">client</span><span style="--0:#F8F8F2;--1:#24292E">(client);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">        </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Targeter</span><span style="--0:#F8F8F2;--1:#24292E"> targeter </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Targeter)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(context, Targeter.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> targeter.</span><span style="--0:#50FA7B;--1:#6F42C1">target</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">, builder, context, target);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">IllegalStateException</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="protected <T> T loadBalance(Feign.Builder builder, FeignContext context, Target.HardCodedTarget<T> target) {    Client client = (Client)this.getOptional(context, Client.class);    if (client != null) {        builder.client(client);        Targeter targeter = (Targeter)this.get(context, Targeter.class);        return targeter.target(this, builder, context, target);    } else {        throw new IllegalStateException(&#34;No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-netflix-ribbon?&#34;);    }}"><div></div></button></div></figure></div>
<p><code>loadBalance()</code> 方法中首先会获取 Client 和 Targeter:</p>
<ul>
<li>通过 <code>Client client = getOptional(context, Client.class)</code> 方法获取 Client,返回的是 <code>LoadBalancerFeignClient</code>,(高版本是 FeignBlockingLoadBalancerClient)</li>
<li>通过 <code>Targeter targeter = get(context, Targeter.class)</code> 方法获取 Targeter: ,返回的是 <code>HystrixTargeter</code></li>
</ul>
<h6 id="loadbalancerfeignclient-在哪里注入到-spring-容器">LoadBalancerFeignClient 在哪里注入到 Spring 容器</h6>
<p>进入到 LoadBalancerFeignClient 类中看哪里调用了它唯一一个构造函数</p>
<p>找到 LoadBalancerFeignClient 有三个地方调用了它的构造函数,new 了一个实例:</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置,只有 DefaultFeignLoadBalancedConfiguration 中的 Client 符合条件装配</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span><span style="--0:#F8F8F2;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--1:#005CC5">proxyBeanMethods</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">DefaultFeignLoadBalancedConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultFeignLoadBalancedConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnMissingBean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Client</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">feignClient</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">CachingSpringLoadBalancerFactory</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">cachingFactory</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">SpringClientFactory</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">clientFactory</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">LoadBalancerFeignClient</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> Client.</span><span style="--0:#50FA7B;--1:#6F42C1">Default</span><span style="--0:#F8F8F2;--1:#24292E">((SSLSocketFactory)</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, (HostnameVerifier)</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">), cachingFactory, clientFactory);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configuration(    proxyBeanMethods = false)class DefaultFeignLoadBalancedConfiguration {    DefaultFeignLoadBalancedConfiguration() {    }    @Bean    @ConditionalOnMissingBean    public Client feignClient(CachingSpringLoadBalancerFactory cachingFactory, SpringClientFactory clientFactory) {        return new LoadBalancerFeignClient(new Client.Default((SSLSocketFactory)null, (HostnameVerifier)null), cachingFactory, clientFactory);    }}"><div></div></button></div></figure></div>
<p>可以通过引入 Apache HttpClient 的 Maven 依赖使用 HttpClientFeignLoadBalancedConfiguration,或引入 OkHttpClient 的 Maven 依赖并在 application.yml 文件中指定 feign.okhttp.enabled 属性为 true 使用 OkHttpFeignLoadBalancedConfiguration。</p>
<h6 id="hystrixtargeter-在哪里注入到-spring-容器">HystrixTargeter 在哪里注入到 Spring 容器</h6>
<p>在 <code>FeignAutoConfiguration</code> 类中可以找到 Targeter 注入到 Spring 容器的逻辑</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span><span style="--0:#F8F8F2;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--1:#005CC5">proxyBeanMethods</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnMissingClass</span><span style="--0:#F8F8F2;--1:#24292E">({</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">feign.hystrix.HystrixFeign</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">})</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">DefaultFeignTargeterConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultFeignTargeterConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnMissingBean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Targeter</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">feignTargeter</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultTargeter</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Configuration</span><span style="--0:#F8F8F2;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--1:#005CC5">proxyBeanMethods</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">false</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnClass</span><span style="--0:#F8F8F2;--1:#24292E">(</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#BD93F9;--1:#005CC5">name</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> {</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">feign.hystrix.HystrixFeign</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">static</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">HystrixFeignTargeterConfiguration</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">protected</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">HystrixFeignTargeterConfiguration</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnMissingBean</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Targeter</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">feignTargeter</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">HystrixTargeter</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Configuration(    proxyBeanMethods = false)@ConditionalOnMissingClass({&#34;feign.hystrix.HystrixFeign&#34;})protected static class DefaultFeignTargeterConfiguration {    protected DefaultFeignTargeterConfiguration() {    }    @Bean    @ConditionalOnMissingBean    public Targeter feignTargeter() {        return new DefaultTargeter();    }}@Configuration(    proxyBeanMethods = false)@ConditionalOnClass(    name = {&#34;feign.hystrix.HystrixFeign&#34;})protected static class HystrixFeignTargeterConfiguration {    protected HystrixFeignTargeterConfiguration() {    }    @Bean    @ConditionalOnMissingBean    public Targeter feignTargeter() {        return new HystrixTargeter();    }}"><div></div></button></div></figure></div>
<blockquote>
<p>默认是创建 HystrixTargeter:</p>
<ol>
<li>如果有 feign.hystrix.HystrixFeign 这个类的话,那么就会构造一个 HystrixTargeter 出来</li>
<li>如果没有 feign.hystrix.HystrixFeign 这个类的话,那么就会构造一个 DefaultTargeter 出来</li>
</ol>
</blockquote>
<p>HystrixTargeter 是用来让 Feign 和 Hystrix 整合使用的,在发送请求的时候可以基于 Hystrix 实现熔断、限流、降级。</p>
<ul>
<li>生产环境如果启用 <code>feign.hystrix.HystrixFeign</code>,则 Feign.Builder 也会变成 HystrixFeign.Builder,默认还是 Feign 自己的 Feign.Builder。</li>
</ul>
<h6 id="hystrixtargetertarget方法">HystrixTargeter#target()方法</h6>
<p>继续往下走,进入到 <code>HystrixTargeter#target()</code> 方法,具体代码执行流程如下:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041658903.png" alt="202403041658903"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041659749.png" alt="202403041659749"/>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Feign</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">build</span><span style="--0:#F8F8F2;--1:#24292E">() {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Client</span><span style="--0:#F8F8F2;--1:#24292E"> client </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Client)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.client, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Retryer</span><span style="--0:#F8F8F2;--1:#24292E"> retryer </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Retryer)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.retryer, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取所有的 RequestInterceptor</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">List</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">RequestInterceptor</span><span style="--0:#F8F8F2;--1:#24292E">&gt; requestInterceptors </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (List)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.requestInterceptors.</span><span style="--0:#50FA7B;--1:#6F42C1">stream</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">map</span><span style="--0:#F8F8F2;--1:#24292E">((ri) </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">-&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> (RequestInterceptor)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(ri, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}).</span><span style="--0:#50FA7B;--1:#6F42C1">collect</span><span style="--0:#F8F8F2;--1:#24292E">(Collectors.</span><span style="--0:#50FA7B;--1:#6F42C1">toList</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Logger</span><span style="--0:#F8F8F2;--1:#24292E"> logger </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Logger)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logger, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Contract</span><span style="--0:#F8F8F2;--1:#24292E"> contract </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Contract)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.contract, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Request</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Options</span><span style="--0:#F8F8F2;--1:#24292E"> options </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Request.Options)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.options, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Encoder</span><span style="--0:#F8F8F2;--1:#24292E"> encoder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Encoder)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.encoder, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Decoder</span><span style="--0:#F8F8F2;--1:#24292E"> decoder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (Decoder)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.decoder, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">InvocationHandlerFactory</span><span style="--0:#F8F8F2;--1:#24292E"> invocationHandlerFactory </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (InvocationHandlerFactory)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.invocationHandlerFactory, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">QueryMapEncoder</span><span style="--0:#F8F8F2;--1:#24292E"> queryMapEncoder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (QueryMapEncoder)Capability.</span><span style="--0:#50FA7B;--1:#6F42C1">enrich</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.queryMapEncoder, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.capabilities);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将 FeignClient 的一些信息放到 Handler 中</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">SynchronousMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Factory</span><span style="--0:#F8F8F2;--1:#24292E"> synchronousMethodHandlerFactory </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> SynchronousMethodHandler.</span><span style="--0:#50FA7B;--1:#6F42C1">Factory</span><span style="--0:#F8F8F2;--1:#24292E">(client, retryer, requestInterceptors, logger, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.logLevel, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.decode404, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.closeAfterDecode, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.propagationPolicy, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.forceDecoding);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ReflectiveFeign</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ParseHandlersByName</span><span style="--0:#F8F8F2;--1:#24292E"> handlersByName </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> ReflectiveFeign.</span><span style="--0:#50FA7B;--1:#6F42C1">ParseHandlersByName</span><span style="--0:#F8F8F2;--1:#24292E">(contract, options, encoder, decoder, queryMapEncoder, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.errorDecoder, synchronousMethodHandlerFactory);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// ReflectiveFeign 负责生成动态代理类</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ReflectiveFeign</span><span style="--0:#F8F8F2;--1:#24292E">(handlersByName, invocationHandlerFactory, queryMapEncoder);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Feign build() {    Client client = (Client)Capability.enrich(this.client, this.capabilities);    Retryer retryer = (Retryer)Capability.enrich(this.retryer, this.capabilities);    // 获取所有的 RequestInterceptor    List<RequestInterceptor> requestInterceptors = (List)this.requestInterceptors.stream().map((ri) -> {        return (RequestInterceptor)Capability.enrich(ri, this.capabilities);    }).collect(Collectors.toList());    Logger logger = (Logger)Capability.enrich(this.logger, this.capabilities);    Contract contract = (Contract)Capability.enrich(this.contract, this.capabilities);    Request.Options options = (Request.Options)Capability.enrich(this.options, this.capabilities);    Encoder encoder = (Encoder)Capability.enrich(this.encoder, this.capabilities);    Decoder decoder = (Decoder)Capability.enrich(this.decoder, this.capabilities);    InvocationHandlerFactory invocationHandlerFactory = (InvocationHandlerFactory)Capability.enrich(this.invocationHandlerFactory, this.capabilities);    QueryMapEncoder queryMapEncoder = (QueryMapEncoder)Capability.enrich(this.queryMapEncoder, this.capabilities);    // 将 FeignClient 的一些信息放到 Handler 中    SynchronousMethodHandler.Factory synchronousMethodHandlerFactory = new SynchronousMethodHandler.Factory(client, retryer, requestInterceptors, logger, this.logLevel, this.decode404, this.closeAfterDecode, this.propagationPolicy, this.forceDecoding);    ReflectiveFeign.ParseHandlersByName handlersByName = new ReflectiveFeign.ParseHandlersByName(contract, options, encoder, decoder, queryMapEncoder, this.errorDecoder, synchronousMethodHandlerFactory);    // ReflectiveFeign 负责生成动态代理类    return new ReflectiveFeign(handlersByName, invocationHandlerFactory, queryMapEncoder);}"><div></div></button></div></figure></div>
<p><code>Feign#target()</code> 方法中主要做两件事:</p>
<ol>
<li>build() 方法将Feign.Builder 中所有东西集成在一起,构建成一个 ReflectiveFeign</li>
<li>ReflectiveFeign#newInstance() 方法负责生成动态代理</li>
</ol>
<h6 id="reflectivefeignnewinstance生成动态代理类">ReflectiveFeign#newInstance()生成动态代理类</h6>
<p>ReflectiveFeign#newInstance() 源码如下</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">T</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">T</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">newInstance</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Target</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">T</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> target) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 基于我们配置的Contract、Encoder等一堆组件,加上Target对象(知道是ServiceAClient接口),去进行接口的所有spring mvc注解的解析,以及接口中各个方法的一些解析,获取了这个接口中有哪些方法</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">MethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt; nameToHandler </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> targetToHandlersByName.</span><span style="--0:#50FA7B;--1:#6F42C1">apply</span><span style="--0:#F8F8F2;--1:#24292E">(target);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">Method</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">MethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt; methodToHandler </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">LinkedHashMap</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">Method</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">MethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt;();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">List</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">DefaultMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt; defaultMethodHandlers </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">LinkedList</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">DefaultMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt;();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 遍历ServiceAClient接口中的每个方法</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Method</span><span style="--0:#F8F8F2"> method </span></span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> target.</span><span style="--0:#50FA7B;--1:#6F42C1">type</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">getMethods</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (method.</span><span style="--0:#50FA7B;--1:#6F42C1">getDeclaringClass</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> Object.class) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">continue</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (Util.</span><span style="--0:#50FA7B;--1:#6F42C1">isDefault</span><span style="--0:#F8F8F2;--1:#24292E">(method)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">DefaultMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E"> handler </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">(method);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">defaultMethodHandlers.</span><span style="--0:#50FA7B;--1:#6F42C1">add</span><span style="--0:#F8F8F2;--1:#24292E">(handler);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">methodToHandler.</span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--0:#F8F8F2;--1:#24292E">(method, handler);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 将ServiceAClient接口中的每个方法,加上对应的nameToHandler中存放的对应的SynchronousMethodHandler(异步化的方法代理处理组件),放到一个map中去</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">methodToHandler.</span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--0:#F8F8F2;--1:#24292E">(method, nameToHandler.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(Feign.</span><span style="--0:#50FA7B;--1:#6F42C1">configKey</span><span style="--0:#F8F8F2;--1:#24292E">(target.</span><span style="--0:#50FA7B;--1:#6F42C1">type</span><span style="--0:#F8F8F2;--1:#24292E">(), method)));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// JDK动态代理)基于一个factory工厂,创建了一个InvocationHandler</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">InvocationHandler</span><span style="--0:#F8F8F2;--1:#24292E"> handler </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> factory.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(target, methodToHandler);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 基于JDK的动态代理,创建出来了一个动态代理类: Proxy,其实现ServiceAClient接口</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// new Class&lt;?&gt;[]{target.type()},这个就是ServiceAClient接口</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// InvocationHandler: 对上面proxy动态代理类所有方法的调用,都会走这个InvocationHandler的拦截方法,由这个InvocationHandler中的一个方法来提供所有方法的一个实现的逻辑</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">T</span><span style="--0:#F8F8F2;--1:#24292E"> proxy </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> (T) Proxy.</span><span style="--0:#50FA7B;--1:#6F42C1">newProxyInstance</span><span style="--0:#F8F8F2;--1:#24292E">(target.</span><span style="--0:#50FA7B;--1:#6F42C1">type</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">getClassLoader</span><span style="--0:#F8F8F2;--1:#24292E">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Class</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E">&gt;[] {target.</span><span style="--0:#50FA7B;--1:#6F42C1">type</span><span style="--0:#F8F8F2;--1:#24292E">()}, handler);</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 上述代码段中,就是 JDK 动态代理的体现,动态生成一个没有名字的匿名类,这个类实现了 ServiceAClient(FeignClient)接口,基于这个匿名类创建一个对象(T proxy),这就是所谓的动态代理,后续所有对这个 T proxy 对象所有接口方法的调用,都会交给 InvocationHandler 处理,此处的 InvocationHandler 是 ReflectiveFeign 的内部类 FeignInvocationHandler</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">DefaultMethodHandler</span><span style="--0:#F8F8F2"> defaultMethodHandler </span></span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> defaultMethodHandlers) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">defaultMethodHandler.</span><span style="--0:#50FA7B;--1:#6F42C1">bindTo</span><span style="--0:#F8F8F2;--1:#24292E">(proxy);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> proxy;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public <T> T newInstance(Target<T> target) {    // 基于我们配置的Contract、Encoder等一堆组件,加上Target对象(知道是ServiceAClient接口),去进行接口的所有spring mvc注解的解析,以及接口中各个方法的一些解析,获取了这个接口中有哪些方法    Map<String, MethodHandler> nameToHandler = targetToHandlersByName.apply(target);    Map<Method, MethodHandler> methodToHandler = new LinkedHashMap<Method, MethodHandler>();    List<DefaultMethodHandler> defaultMethodHandlers = new LinkedList<DefaultMethodHandler>();    // 遍历ServiceAClient接口中的每个方法    for (Method method : target.type().getMethods()) {        if (method.getDeclaringClass() == Object.class) {            continue;        } else if (Util.isDefault(method)) {            DefaultMethodHandler handler = new DefaultMethodHandler(method);            defaultMethodHandlers.add(handler);            methodToHandler.put(method, handler);        } else {            // 将ServiceAClient接口中的每个方法,加上对应的nameToHandler中存放的对应的SynchronousMethodHandler(异步化的方法代理处理组件),放到一个map中去            methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));        }    }    // JDK动态代理)基于一个factory工厂,创建了一个InvocationHandler    InvocationHandler handler = factory.create(target, methodToHandler);    // 基于JDK的动态代理,创建出来了一个动态代理类: Proxy,其实现ServiceAClient接口    // new Class<?>[]{target.type()},这个就是ServiceAClient接口    // InvocationHandler: 对上面proxy动态代理类所有方法的调用,都会走这个InvocationHandler的拦截方法,由这个InvocationHandler中的一个方法来提供所有方法的一个实现的逻辑    T proxy = (T) Proxy.newProxyInstance(target.type().getClassLoader(),        new Class<?>[] {target.type()}, handler);    // 上述代码段中,就是 JDK 动态代理的体现,动态生成一个没有名字的匿名类,这个类实现了 ServiceAClient(FeignClient)接口,基于这个匿名类创建一个对象(T proxy),这就是所谓的动态代理,后续所有对这个 T proxy 对象所有接口方法的调用,都会交给 InvocationHandler 处理,此处的 InvocationHandler 是 ReflectiveFeign 的内部类 FeignInvocationHandler    for (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) {        defaultMethodHandler.bindTo(proxy);    }    return proxy;}"><div></div></button></div></figure></div>
<p>方法中有两个Map类型的局部变量: nameToHandler、methodToHandler:</p>
<blockquote>
<ol>
<li>nameToHandler 释义: 接口中的每个方法的名称,对应一个处理这个方法的SynchronousMethodHandler;由ReflectiveFeign的内部类ParseHandlersByName的apply(target)方法获取。</li>
<li>methodToHandler 释义: 接口中的每个方法(Method对象),对应一个处理这个方法的SynchronousMethodHandler;</li>
</ol>
</blockquote>
<h6 id="parsehandlersbynameapply解析feignclient中的方法">ParseHandlersByName#apply()解析FeignClient中的方法</h6>
<p><code>ParseHandlersByName#apply()</code> 方法会对我们定义的 ServiceAClient 接口进行解析,解析里面有哪些方法,然后为每个方法创建一个 SynchronousMethodHandler 出来,也就是说某个 SynchronousMethodHandler 专门用来处理那个方法的请求调用。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Map</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">String, MethodHandler</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">apply</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Target</span><span style="--0:#F8F8F2"> target) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">List</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">MethodMetadata</span><span style="--0:#F8F8F2;--1:#24292E">&gt; metadata </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> contract.</span><span style="--0:#50FA7B;--1:#6F42C1">parseAndValidateMetadata</span><span style="--0:#F8F8F2;--1:#24292E">(target.</span><span style="--0:#50FA7B;--1:#6F42C1">type</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">MethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt; result </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">LinkedHashMap</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">MethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">&gt;();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">MethodMetadata</span><span style="--0:#F8F8F2"> md </span></span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> metadata) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">BuildTemplateByResolvingArgs</span><span style="--0:#F8F8F2;--1:#24292E"> buildTemplate;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">md.</span><span style="--0:#50FA7B;--1:#6F42C1">formParams</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">isEmpty</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> md.</span><span style="--0:#50FA7B;--1:#6F42C1">template</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">bodyTemplate</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">buildTemplate </span><span style="--0:#FF79C6;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BuildFormEncodedTemplateFromArgs</span><span style="--0:#F8F8F2;--1:#24292E">(md, encoder, queryMapEncoder, target);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (md.</span><span style="--0:#50FA7B;--1:#6F42C1">bodyIndex</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">buildTemplate </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BuildEncodedTemplateFromArgs</span><span style="--0:#F8F8F2;--1:#24292E">(md, encoder, queryMapEncoder, target);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">buildTemplate </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">BuildTemplateByResolvingArgs</span><span style="--0:#F8F8F2;--1:#24292E">(md, queryMapEncoder, target);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (md.</span><span style="--0:#50FA7B;--1:#6F42C1">isIgnored</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">result.</span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--0:#F8F8F2;--1:#24292E">(md.</span><span style="--0:#50FA7B;--1:#6F42C1">configKey</span><span style="--0:#F8F8F2;--1:#24292E">(), args </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">-&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">IllegalStateException</span><span style="--0:#F8F8F2;--1:#24292E">(md.</span><span style="--0:#50FA7B;--1:#6F42C1">configKey</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C"> is not a method handled by feign</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">});</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">result.</span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--0:#F8F8F2;--1:#24292E">(md.</span><span style="--0:#50FA7B;--1:#6F42C1">configKey</span><span style="--0:#F8F8F2;--1:#24292E">(),</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#96A1C2;--1:#616972">// 为每个方法创建对应的 MethodHandler</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">            </span></span><span style="--0:#F8F8F2;--1:#24292E">factory.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(target, md, buildTemplate, options, decoder, errorDecoder));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> result;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Map<String, MethodHandler> apply(Target target) {    List<MethodMetadata> metadata = contract.parseAndValidateMetadata(target.type());    Map<String, MethodHandler> result = new LinkedHashMap<String, MethodHandler>();    for (MethodMetadata md : metadata) {    BuildTemplateByResolvingArgs buildTemplate;    if (!md.formParams().isEmpty() &#38;&#38; md.template().bodyTemplate() == null) {        buildTemplate =            new BuildFormEncodedTemplateFromArgs(md, encoder, queryMapEncoder, target);    } else if (md.bodyIndex() != null) {        buildTemplate = new BuildEncodedTemplateFromArgs(md, encoder, queryMapEncoder, target);    } else {        buildTemplate = new BuildTemplateByResolvingArgs(md, queryMapEncoder, target);    }    if (md.isIgnored()) {        result.put(md.configKey(), args -> {        throw new IllegalStateException(md.configKey() + &#34; is not a method handled by feign&#34;);        });    } else {        result.put(md.configKey(),            // 为每个方法创建对应的 MethodHandler            factory.create(target, md, buildTemplate, options, decoder, errorDecoder));    }    }    return result;}"><div></div></button></div></figure></div>
<p>其中 <code>factory.create</code> 会为所有标注了 SpringMvc 注解的方法都生成一个对应的 SynchronousMethodHandler。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">MethodHandler</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Target</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;?&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> target,</span></div></div><div class="ec-line"><div class="code"><span class="indent">                            </span><span style="--0:#96A1C2;--1:#616972">// 解析这个方法,针对这个方法生成一个 SynchronousMethodHandler</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">MethodMetadata</span><span style="--0:#F8F8F2;--1:#24292E"> md,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">                            </span></span><span style="--0:#F8F8F2;--1:#24292E">RequestTemplate.Factory buildTemplateFromArgs,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Options</span><span style="--0:#F8F8F2;--1:#24292E"> options,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Decoder</span><span style="--0:#F8F8F2;--1:#24292E"> decoder,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">                            </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ErrorDecoder</span><span style="--0:#F8F8F2;--1:#24292E"> errorDecoder) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">SynchronousMethodHandler</span><span style="--0:#F8F8F2;--1:#24292E">(target, client, retryer, requestInterceptors, logger,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">logLevel, md, buildTemplateFromArgs, options, decoder,</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">errorDecoder, decode404, closeAfterDecode, propagationPolicy, forceDecoding);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public MethodHandler create(Target<?> target,                            // 解析这个方法,针对这个方法生成一个 SynchronousMethodHandler                            MethodMetadata md,                            RequestTemplate.Factory buildTemplateFromArgs,                            Options options,                            Decoder decoder,                            ErrorDecoder errorDecoder) {    return new SynchronousMethodHandler(target, client, retryer, requestInterceptors, logger,        logLevel, md, buildTemplateFromArgs, options, decoder,        errorDecoder, decode404, closeAfterDecode, propagationPolicy, forceDecoding);}"><div></div></button></div></figure></div>
<p><code>SpringMvcContract.parseAndValidateMetadata()</code> 方法负责解析 FeignClient 接口中每个标注了 SpringMvc 注解的方法,即: Feign 依靠 Contract 组件(SpringMvcContract)来解析接口上的 SpringMvc 注解。</p>
<blockquote>
<p>针对 FeignClient 接口中的每个标注了 springMVC 注解的方法都会被 springMvcContract 组件解析,针对每个方法最后都生成一个 MethodMetadata,代表方法的一些元数据,包括:</p>
<ol>
<li>方法的定义: 比如: <code>ServiceAClient#deleteUser(Long)</code></li>
<li>方法的返回类型: 比如: <code>class java.lang.String</code></li>
<li>发送 HTTP 请求的模版: 比如: <code>DELETE /user/{id} HTTP/1.1</code></li>
</ol>
</blockquote>
<h6 id="springmvccontract组件的工作原理">SpringMvcContract组件的工作原理</h6>
<p>看一下 <code>SpringMvcContract.parseAndValidateMetadata()</code> 如何解析 FeignClient 中的每个方法</p>
<p>以如下方法为例:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403041746106.png" alt="202403041746106"/>
<p>解析逻辑如下:</p>
<blockquote>
<ol>
<li>解析@RequestMapping注解,看看里面的method属性是什么?是GET/UPDATE/DELETE,然后在HTTP template里就加上GET/UPDATE/DELETE;(示例为DELETE)</li>
<li>找到接口上定义的@RequestMapping注解,解析里面的value值,拿到请求路径(/user),此时HTTP template变成: DELETE /user</li>
<li>再次解析deleteUser()方法上的@RequestMapping注解,找到里面的value,获取到 <code>/{id}</code>,拼接到HTTP template里去: <code>DELETE /user/{id}</code></li>
<li>接着硬编码拼死一个HTTP协议,http 1.1,HTTP template: <code>DELETE /user/{id} HTTP/1.1</code></li>
<li>indexToName: 解析@PathVariable注解,第一个占位符(index是0)要替换成方法入参里的id这个参数的值</li>
<li>假如后面来调用这个deleteUser()方法,传递进来的id = 1.那么此时就会拿出之前解析好的HTTP template: <code>DELETE /user/{id} HTTP/1.1</code>。然后用传递进来的id = 1替换掉第一个占位符的值,DELETE /user/1 HTTP/1.1</li>
</ol>
</blockquote>
<h3 id="openfeign处理http请求">OpenFeign处理HTTP请求</h3>
<h4 id="动态代理处理请求的入口">动态代理处理请求的入口</h4>
<p>我们知道所有对动态代理对象(T Proxy)的所有接口方法的调用,都会交给 <code>InvocationHandler</code> 来处理,此处的 <code>InvocationHandler</code> 是 <code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code>。针对 FeignClient 的每个方法都会对应一个 <code>SynchronousMethodHandler</code>。</p>
<p>以 <code>http://localhost:9090/ServiceB/user/sayHello/1?name=zhangsan&amp;age=18</code> 请求调用为例:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051440325.png" alt="202403051440325"/>
<p>请求调用 ServiceBController 的 greeting() 方法后,要调用 ServiceAClient#sayHello() 方法时,请求会进到 ServiceAClient 的动态代理类,进而请求交给 ReflectiveFeign 的内部类 FeignInvocationHandler 来处理,在结合 JDK 动态代理的特性,方法会交给 invoke() 方法执行,所以动态代理处理请求的入口为: <code>ReflectiveFeign</code> 的内部类 <code>FeignInvocationHandler</code> 的 invoke() 方法:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051446826.png" alt="202403051446826"/>
<p>方法逻辑:</p>
<blockquote>
<ol>
<li>针对父类 Object 的 equals、hashCode、toString 方法直接处理</li>
<li>其他方法则从 dispatch 中获取 Method 对应的 MethodHandler,然后将方法的执行交给 MethodHandler 来处理</li>
<li>dispatch 是一个以 Method 为 key,MethodHandler 为 value 的 Map 类型(Map&lt;Method, MethodHandler&gt;),其是在构建 FeignInvocationHandler 时,记录了每个 FeignClient 对应的所有方法 MethodHandler 的映射</li>
</ol>
</blockquote>
<p>invoke() 方法中通过方法名找到 Method 对应的 MethodHandler,这里的 MethodHandler 为 SynchronousMethodHandler,然后将 args 参数交给它来处理请求</p>
<h4 id="synchronousmethodhandler-处理请求机制">SynchronousMethodHandler 处理请求机制</h4>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">invoke</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">[] argv) throws Throwable {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 创建一个请求模版</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">RequestTemplate</span><span style="--0:#F8F8F2;--1:#24292E"> template </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> buildTemplateFromArgs.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(argv);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Options</span><span style="--0:#F8F8F2;--1:#24292E"> options </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">findOptions</span><span style="--0:#F8F8F2;--1:#24292E">(argv);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Retryer</span><span style="--0:#F8F8F2;--1:#24292E"> retryer </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.retryer.</span><span style="--0:#50FA7B;--1:#6F42C1">clone</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">while</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#BD93F9;--1:#005CC5">true</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#96A1C2;--1:#616972">// 执行请求并返回 decode 后的结果</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">executeAndDecode</span><span style="--0:#F8F8F2;--1:#24292E">(template, options);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">RetryableException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">e</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">retryer.</span><span style="--0:#50FA7B;--1:#6F42C1">continueOrPropagate</span><span style="--0:#F8F8F2;--1:#24292E">(e);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">RetryableException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">th</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">          </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Throwable</span><span style="--0:#F8F8F2;--1:#24292E"> cause </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> th.</span><span style="--0:#50FA7B;--1:#6F42C1">getCause</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">          </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (propagationPolicy </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> UNWRAP </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> cause </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> cause;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">            </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> th;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (logLevel </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> Logger.Level.NONE) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">          </span></span><span style="--0:#F8F8F2;--1:#24292E">logger.</span><span style="--0:#50FA7B;--1:#6F42C1">logRetry</span><span style="--0:#F8F8F2;--1:#24292E">(metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">configKey</span><span style="--0:#F8F8F2;--1:#24292E">(), logLevel);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">continue</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Override  public Object invoke(Object[] argv) throws Throwable {    // 创建一个请求模版    RequestTemplate template = buildTemplateFromArgs.create(argv);    Options options = findOptions(argv);    Retryer retryer = this.retryer.clone();    while (true) {      try {        // 执行请求并返回 decode 后的结果        return executeAndDecode(template, options);      } catch (RetryableException e) {        try {          retryer.continueOrPropagate(e);        } catch (RetryableException th) {          Throwable cause = th.getCause();          if (propagationPolicy == UNWRAP &#38;&#38; cause != null) {            throw cause;          } else {            throw th;          }        }        if (logLevel != Logger.Level.NONE) {          logger.logRetry(metadata.configKey(), logLevel);        }        continue;      }    }  }"><div></div></button></div></figure></div>
<p><code>SynchronousMethodHandler#invoke()</code> 方法中主要包括两大块: 创建请求模版、执行请求并返回 decode 后的结果。</p>
<p>这里的重试机制,其实就是依靠 Retryer#continueOrPropagate() 方法中对重试次数的判断,超过最大重试次数抛异常结束流程。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051634061.png" alt="202403051634061"/>
<h5 id="创建请求模版springmvccontract-解析方法参数">创建请求模版(SpringMvcContract 解析方法参数)</h5>
<p>在上文中我们聊到会用 SpringMvcContract 解析Spring mvc 的注解,最终拿到方法的对应的请求(RequestTemplate)是 <code>GET /user/sayHello/{id} HTTP/1.1</code>,但是要生成一个可以访问的请求地址,需要再基于 SpringMvcContract 去解析 @RequestParam 注解,将方法的入参,绑定到 HTTP 请求参数里去,最终将请求处理为 <code>GET /user/sayHello/1?name=zhangsan&amp;age=18 HTTP/1.1</code></p>
<p>而 <code>RequestTemplate template = buildTemplateFromArgs.create(argv)</code> 负责做这个操作,ReflectiveFeign#create(Object[] argv):</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">RequestTemplate</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">[] argv) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 获取 REST 请求模版</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">RequestTemplate</span><span style="--0:#F8F8F2;--1:#24292E"> mutable </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> RequestTemplate.</span><span style="--0:#50FA7B;--1:#6F42C1">from</span><span style="--0:#F8F8F2;--1:#24292E">(metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">template</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">mutable.</span><span style="--0:#50FA7B;--1:#6F42C1">feignTarget</span><span style="--0:#F8F8F2;--1:#24292E">(target);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">urlIndex</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> urlIndex </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">urlIndex</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#50FA7B;--1:#6F42C1">checkArgument</span><span style="--0:#F8F8F2;--1:#24292E">(argv[urlIndex] </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">URI parameter %s was null</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">, urlIndex);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">mutable.</span><span style="--0:#50FA7B;--1:#6F42C1">target</span><span style="--0:#F8F8F2;--1:#24292E">(String.</span><span style="--0:#50FA7B;--1:#6F42C1">valueOf</span><span style="--0:#F8F8F2;--1:#24292E">(argv[urlIndex]));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; varBuilder </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">LinkedHashMap</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt;();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 遍历 REST 请求要调用方法标记了 springmvc 注解的参数</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">Entry</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">Integer</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">Collection</span><span style="--0:#F8F8F2">&lt;</span></span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">&gt;&gt; entry </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">indexToName</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">entrySet</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> i </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> entry.</span><span style="--0:#50FA7B;--1:#6F42C1">getKey</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Object</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> argv[entry.</span><span style="--0:#50FA7B;--1:#6F42C1">getKey</span><span style="--0:#F8F8F2;--1:#24292E">()];</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (value </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) { </span><span style="--0:#96A1C2;--1:#616972">// Null values are skipped.</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 使用 SpringMvcContract 解析出方法参数对应的 value 值</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (indexToExpander.</span><span style="--0:#50FA7B;--1:#6F42C1">containsKey</span><span style="--0:#F8F8F2;--1:#24292E">(i)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">value </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">expandElements</span><span style="--0:#F8F8F2;--1:#24292E">(indexToExpander.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(i), value);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">for</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">String</span><span style="--0:#F8F8F2"> name </span></span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> entry.</span><span style="--0:#50FA7B;--1:#6F42C1">getValue</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">        </span></span><span style="--0:#F8F8F2;--1:#24292E">varBuilder.</span><span style="--0:#50FA7B;--1:#6F42C1">put</span><span style="--0:#F8F8F2;--1:#24292E">(name, value);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 构建出完整的 REST 请求</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">RequestTemplate</span><span style="--0:#F8F8F2;--1:#24292E"> template </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">resolve</span><span style="--0:#F8F8F2;--1:#24292E">(argv, mutable, varBuilder);</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 处理表单内容</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">queryMapIndex</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// add query map parameters after initial resolve so that they take</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// precedence over any predefined values</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Object</span><span style="--0:#F8F8F2;--1:#24292E"> value </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> argv[metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">queryMapIndex</span><span style="--0:#F8F8F2;--1:#24292E">()];</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Map</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">String</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--0:#F8F8F2;--1:#BF3441">Object</span><span style="--0:#F8F8F2;--1:#24292E">&gt; queryMap </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">toQueryMap</span><span style="--0:#F8F8F2;--1:#24292E">(value);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">template </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">addQueryMapQueryParameters</span><span style="--0:#F8F8F2;--1:#24292E">(queryMap, template);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 处理请求头内容</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">headerMapIndex</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">template </span><span style="--0:#FF79C6;--1:#BF3441">=</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#50FA7B;--1:#6F42C1">addHeaderMapHeaders</span><span style="--1:#24292E"><span style="--0:#F8F8F2">((</span><span style="--0:#8BE9FD;--0fs:italic">Map</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">String, Object</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--0:#F8F8F2;--1:#24292E">) argv[metadata.</span><span style="--0:#50FA7B;--1:#6F42C1">headerMapIndex</span><span style="--0:#F8F8F2;--1:#24292E">()], template);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> template;</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Overridepublic RequestTemplate create(Object[] argv) {  // 获取 REST 请求模版  RequestTemplate mutable = RequestTemplate.from(metadata.template());  mutable.feignTarget(target);  if (metadata.urlIndex() != null) {    int urlIndex = metadata.urlIndex();    checkArgument(argv[urlIndex] != null, &#34;URI parameter %s was null&#34;, urlIndex);    mutable.target(String.valueOf(argv[urlIndex]));  }  Map<String, Object> varBuilder = new LinkedHashMap<String, Object>();  // 遍历 REST 请求要调用方法标记了 springmvc 注解的参数  for (Entry<Integer, Collection<String>> entry : metadata.indexToName().entrySet()) {    int i = entry.getKey();    Object value = argv[entry.getKey()];    if (value != null) { // Null values are skipped.      // 使用 SpringMvcContract 解析出方法参数对应的 value 值      if (indexToExpander.containsKey(i)) {        value = expandElements(indexToExpander.get(i), value);      }      for (String name : entry.getValue()) {        varBuilder.put(name, value);      }    }  }  // 构建出完整的 REST 请求  RequestTemplate template = resolve(argv, mutable, varBuilder);  // 处理表单内容  if (metadata.queryMapIndex() != null) {    // add query map parameters after initial resolve so that they take    // precedence over any predefined values    Object value = argv[metadata.queryMapIndex()];    Map<String, Object> queryMap = toQueryMap(value);    template = addQueryMapQueryParameters(queryMap, template);  }  // 处理请求头内容  if (metadata.headerMapIndex() != null) {    template =        addHeaderMapHeaders((Map<String, Object>) argv[metadata.headerMapIndex()], template);  }  return template;}"><div></div></button></div></figure></div>
<p>以解析 <code>@PathVariable(&quot;id&quot;) Long id</code> 为例,SpringMvcContract 解析逻辑如下:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051717607.png" alt="202403051717607"/>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">private</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">expandElements</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Expander</span><span style="--0:#F8F8F2"> expander, </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> value) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (value </span><span style="--0:#FF79C6;--1:#BF3441">instanceof</span><span style="--0:#F8F8F2;--1:#24292E"> Iterable) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">expandIterable</span><span style="--0:#F8F8F2;--1:#24292E">(expander, (Iterable) value);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> expander.</span><span style="--0:#50FA7B;--1:#6F42C1">expand</span><span style="--0:#F8F8F2;--1:#24292E">(value);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="private Object expandElements(Expander expander, Object value) {  if (value instanceof Iterable) {    return expandIterable(expander, (Iterable) value);  }  return expander.expand(value);}"><div></div></button></div></figure></div>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051723717.png" alt="202403051723717"/>
<p>最后解析出 <code>@PathVariable(&quot;id&quot;) Long id</code> 对应的值为 1,然后将所有的标注了 SpringMVC 注解的参数都解析完之后,将参数名和对应的 value 值放到一个命名为 <code>varBuilder</code> 的 Map 中:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051728793.png" alt="202403051728793"/>
<p>接着需要根据 varBuilder 的内容构建出一个完整的 REST 请求(即: 将 SpringMVC 注解标注的参数全部用 value 值替换、添加到请求中)</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051736823.png" alt="202403051736823"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051744919.png" alt="202403051744919"/>
<p><code>RequestTemplate resolve(Map&lt;String, ?&gt; variables)</code> 中负责解析并构建完整的 RequestTemplate,进到方法中的 urlTemplate 为 <code>/user/sayHello/{id}</code>,variables 为上面的 varBuilder: <code>{&quot;id&quot;:1,&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:18}</code>。</p>
<p>方法中首先将 <code>&quot;id&quot;:1</code> 替换 <code>urlTemplate(/user/sayHello/{id})</code> 中的 <code>{id}</code>,得出 expanded 为 <code>/user/sayHello/1</code>,然后再将查询参数 <code>&quot;name&quot;:&quot;zhangsan&quot;,&quot;age&quot;:18</code> 拼接到请求中,得到最终的 URL 为: <code>/user/sayHello/1?name=zhangsan&amp;age=18</code>,返回的 RequestTemplate 内容为:</p>
<p><code>buildTemplateFromArgs.create(argv)</code> 方法执行完成之后,得到一个完整的 RequestTemplate,下面需要基于这个 RequestTemplate 来执行请求。</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051758648.png" alt="202403051758648"/>
<h5 id="执行请求并解码返回值">执行请求并解码返回值</h5>
<p><code>SynchronousMethodHandler#executeAndDecode(RequestTemplate, Options)</code> 方法负责执行请求并解码返回值,具体执行逻辑如下:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051804120.png" alt="202403051804120"/>
<p>方法中主要做三件事: 应用所有的 RequestInterceptor(即执行 RequestInterceptor#apply()方法)、通过 LoadBalancerFeignClient 做负载均衡执行请求,使用 Decoder 对请求返回结果解码或处理返回结果。</p>
<p>下面分开来看</p>
<h6 id="应用所有的-requestinterceptor">应用所有的 RequestInterceptor</h6>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403051813337.png" alt="202403051813337"/>
<p>遍历所有的请求拦截器 <code>RequestInterceptor</code>,将每个请求拦截器都应用到 RequestTemplate 请求模版上面去,也就是让每个请求拦截器都对请求进行处理(调用拦截器的 apply(RequestTemplate)方法)。</p>
<blockquote>
<ul>
<li>其实这里本质上就是基于 RequestTemplate,创建一个Request</li>
<li>Request 是基于之前的 HardCodedTarget(包含了目标请求服务信息的一个 Target,服务名也在其中),处理 RequestTemplate,生成一个 Request</li>
</ul>
</blockquote>
<p>应用完所有的 RequestInterceptor 之后,如果 Feign 日志的隔离级别不等于 <code>Logger.Level.NONE</code>,则打印即将要发送的 Request 请求日志;
打印完请求日志之后,会通过 <code>SynchronousMethodHandler</code> 中的成员 Client 来执行请求,对于 OpenFeign 旧版而言,Client 是 <code>LoadBalancerFeignClient</code>。</p>
<h6 id="loadbalancerfeignclient-负载均衡执行请求详述">LoadBalancerFeignClient 负载均衡执行请求详述</h6>
<p>基于 LoadBalancerFeignClient 完成了请求的处理和发送,这里肯定是将 HTTP 请求发送到对应 server 的某个实例上去,同时获取到 Response 响应。</p>
<p><code>LoadBalancerFeignClient#execute()</code> 方法处理逻辑:</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Response</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">execute</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Request</span><span style="--0:#F8F8F2"> request, Request.Options options) throws IOException {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将请求的 url 封装成 URI</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">URI</span><span style="--0:#F8F8F2;--1:#24292E"> asUri </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> URI.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(request.</span><span style="--0:#50FA7B;--1:#6F42C1">url</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 获取要请求的服务名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> clientName </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> asUri.</span><span style="--0:#50FA7B;--1:#6F42C1">getHost</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 从 URI 中剔除服务名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">URI</span><span style="--0:#F8F8F2;--1:#24292E"> uriWithoutHost </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">cleanUrl</span><span style="--0:#F8F8F2;--1:#24292E">(request.</span><span style="--0:#50FA7B;--1:#6F42C1">url</span><span style="--0:#F8F8F2;--1:#24292E">(), clientName);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将请求封装为 RibbonRequest</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">FeignLoadBalancer</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">RibbonRequest</span><span style="--0:#F8F8F2;--1:#24292E"> ribbonRequest </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> FeignLoadBalancer.</span><span style="--0:#50FA7B;--1:#6F42C1">RibbonRequest</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.delegate, request, uriWithoutHost);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 将 options 封装为请求配置传给 Ribbon</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">IClientConfig</span><span style="--0:#F8F8F2;--1:#24292E"> requestConfig </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getClientConfig</span><span style="--0:#F8F8F2;--1:#24292E">(options, clientName);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 通过集成的 Ribbon 执行请求</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> ((FeignLoadBalancer.RibbonResponse)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">lbClient</span><span style="--0:#F8F8F2;--1:#24292E">(clientName).</span><span style="--0:#50FA7B;--1:#6F42C1">executeWithLoadBalancer</span><span style="--0:#F8F8F2;--1:#24292E">(ribbonRequest, requestConfig)).</span><span style="--0:#50FA7B;--1:#6F42C1">toResponse</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">ClientException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">var8</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">IOException</span><span style="--0:#F8F8F2;--1:#24292E"> io </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">findIOException</span><span style="--0:#F8F8F2;--1:#24292E">(var8);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (io </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> io;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">RuntimeException</span><span style="--0:#F8F8F2;--1:#24292E">(var8);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Response execute(Request request, Request.Options options) throws IOException {  try {    // 将请求的 url 封装成 URI    URI asUri = URI.create(request.url());    // 获取要请求的服务名    String clientName = asUri.getHost();    // 从 URI 中剔除服务名    URI uriWithoutHost = cleanUrl(request.url(), clientName);    // 将请求封装为 RibbonRequest    FeignLoadBalancer.RibbonRequest ribbonRequest = new FeignLoadBalancer.RibbonRequest(this.delegate, request, uriWithoutHost);    // 将 options 封装为请求配置传给 Ribbon    IClientConfig requestConfig = this.getClientConfig(options, clientName);    // 通过集成的 Ribbon 执行请求    return ((FeignLoadBalancer.RibbonResponse)this.lbClient(clientName).executeWithLoadBalancer(ribbonRequest, requestConfig)).toResponse();  } catch (ClientException var8) {    IOException io = this.findIOException(var8);    if (io != null) {      throw io;    } else {      throw new RuntimeException(var8);    }  }}"><div></div></button></div></figure></div>
<p>方法逻辑解析:</p>
<blockquote>
<ol>
<li>首先将请求的url封装成一个URI,然后从请求URL地址中,获取到要访问的服务名称clientName(示例为ServiceA)</li>
<li>然后将请求URI中的服务名称剔除,比如这里的 &lt;<a href="http://Service-A/user/sayHello/" rel="nofollow, noopener, noreferrer" target="_blank">http://Service-A/user/sayHello/</a>&gt; 变为 http:///user/sayHello/</li>
<li>接着基于去除了服务名称的uri地址,创建了一个适用于Ribbon的请求(FeignLoadBalancer.RibbonRequest)</li>
<li>根据服务名从SpringClientFactory(Feign上下文)中获取Ribbon相关的配置IClientConfig,比如(连接超时时间、读取数据超时时间),如果获取不到,则创建一个FeignOptionsClientConfig</li>
<li>最后根据服务名从CachingSpringLoadBalancerFactory获取对应的FeignLoadBalancer;在FeignLoadBalancer里封装了ribbon的ILoadBalancer</li>
</ol>
</blockquote>
<p>既然Feign中集成了Ribbon,那它们是怎么整合到一起的?FeignLoadBalancer中用了Ribbon的那个ILoadBalancer?Feign如何使用Ribbon进行负载均衡?最终发送出去的请求URI是什么样的?</p>
<p><strong>1&gt; Feign 是如何和 Ribbon、eureka 整合在一起的?FeignLoadBalancer 中用了 Ribbon 的那个 ILoadBalancer?</strong></p>
<ol>
<li>
<p>FeignLoadBalancer中用了Ribbon的那个ILoadBalancer?</p>
<p>FeignLoadBalancer的类继承结构如下:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061818220.png" alt="202403061818220"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061819814.png" alt="202403061819814"/>
<p>FeignLoadBalancer间接继承自LoadBalancerContext,LoadBalancerContext中有一个ILoadBalancer类型的成员,其就是FeignLoadBalancer中集成的Ribbon的ILoadBalancer。从代码执行流程来看,集成的ILoadBalancer为Ribbon默认的ZoneAwareLoadBalancer:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403061830279.png" alt="202403061830279"/>
<p>到这里,可以看到根据服务名获取到的FeignLoadBalancer中组合了Ribbon的ZoneAwareLoadBalancer负载均衡器。</p>
</li>
<li>
<p>Ribbon和Eureka的集成?
RibbonClientConfiguration#ribbonLoadBalancer</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Bean</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">ConditionalOnMissingBean</span></div></div><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// serverList: 服务实例列表信息</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">ILoadBalancer</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">ribbonLoadBalancer</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">IClientConfig</span><span style="--0:#F8F8F2"> config, </span><span style="--0:#8BE9FD;--0fs:italic">ServerList</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">Server</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> serverList, </span><span style="--0:#8BE9FD;--0fs:italic">ServerListFilter</span></span><span style="--0:#FF79C6;--1:#BF3441">&lt;</span><span style="--0:#F8F8F2;--1:#24292E">Server</span><span style="--0:#FF79C6;--1:#BF3441">&gt;</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> serverListFilter, </span><span style="--0:#8BE9FD;--0fs:italic">IRule</span><span style="--0:#F8F8F2"> rule, </span><span style="--0:#8BE9FD;--0fs:italic">IPing</span><span style="--0:#F8F8F2"> ping, </span><span style="--0:#8BE9FD;--0fs:italic">ServerListUpdater</span><span style="--0:#F8F8F2"> serverListUpdater) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> (ILoadBalancer)(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.propertiesFactory.</span><span style="--0:#50FA7B;--1:#6F42C1">isSet</span><span style="--0:#F8F8F2;--1:#24292E">(ILoadBalancer.class, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">?</span><span style="--0:#F8F8F2;--1:#24292E"> (ILoadBalancer)</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.propertiesFactory.</span><span style="--0:#50FA7B;--1:#6F42C1">get</span><span style="--0:#F8F8F2;--1:#24292E">(ILoadBalancer.class, config, </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.name)</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">:</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">ZoneAwareLoadBalancer</span><span style="--0:#F8F8F2;--1:#24292E">(config, rule, ping, serverList, serverListFilter, serverListUpdater));</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="@Bean@ConditionalOnMissingBean// serverList: 服务实例列表信息public ILoadBalancer ribbonLoadBalancer(IClientConfig config, ServerList<Server> serverList, ServerListFilter<Server> serverListFilter, IRule rule, IPing ping, ServerListUpdater serverListUpdater) {    return (ILoadBalancer)(this.propertiesFactory.isSet(ILoadBalancer.class, this.name)    ? (ILoadBalancer)this.propertiesFactory.get(ILoadBalancer.class, config, this.name)    : new ZoneAwareLoadBalancer(config, rule, ping, serverList, serverListFilter, serverListUpdater));}"><div></div></button></div></figure></div>
<p>Ribbon自己和Eureka集成的流程: Ribbon的配置类RibbonClientConfiguration,会初始化ZoneAwareLoadBalancer并将其注入到Spring容器;ZoneAwareLoadBalancer内部持有跟eureka进行整合的DomainExtractingServerList(Eureka和Ribbon集成的配置类EurekaRibbonClientConfiguration(spring-cloud-netflix-eureka-client项目下)中负责将其注入到Spring容器),nacos 和 ribbon 集成的配置类 NacosRibbonClientConfiguration。</p>
<p>小结:
在spring boot启动,要去获取一个ribbon的ILoadBalancer的时候,会去从那个服务对应的一个独立的spring容器(Ribbon子上下文)中获取;获取到一个服务对应的ZoneAwareLoadBalancer,其中组合了DomainExtractingServerList,DomainExtractingServerList自己会去eureka的注册表里去拉取服务对应的注册表(即: 服务的实例列表)。</p>
</li>
</ol>
<p><strong>2&gt; Feign如何使用Ribbon进行负载均衡?</strong>
feign是基于ribbon的ZoneAwareLoadBalancer来进行负载均衡的,从一个server list中选择出来一个server。</p>
<p>接着上面的内容,进入到FeignLoadBalancer的executeWithLoadBalancer()方法;</p>
<p>由于AbstractLoadBalancerAwareClient是FeignLoadBalancer的父类,FeignLoadBalancer类中没有重写executeWithLoadBalancer()方法,进入到AbstractLoadBalancerAwareClient#executeWithLoadBalancer()方法:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071635683.png" alt="202403071635683"/>
<p>方法逻辑解析:</p>
<blockquote>
<ol>
<li>
<p>首先构建一个LoadBalancerCommand,LoadBalancerCommand刚创建的时候里面的server是null,也就是还没确定要对哪个server发起请求;</p>
</li>
<li>
<p>command.submit()方法的代码块,本质上是重写了LoadBalancerCommand#submit(ServerOperation&lt;T&gt;)方法入参ServerOperation的call()方法。</p>
<ul>
<li>call()方法内部根据选择出的Server构造出具体的http请求地址,然后基于底层的http通信组件,发送出去这个请求。</li>
<li>call()方法是被内嵌到LoadBalancerCommand#submit()方法中的,也就是在执行LoadBalancerCommand的时候会调用call()方法;</li>
</ul>
</li>
<li>
<p>最后通过command.toBlocking().single()方法,进行阻塞式的同步执行,获取到响应结果。</p>
</li>
</ol>
</blockquote>
<p>从整体来看,ServerOperation中封装了负载均衡选择出来的server,然后直接基于这个server替换掉请求URL中的服务名,拼接出最终的请求URL地址,然后基于底层的http组件发送请求。</p>
<p>LoadBalancerCommand肯定是在某个地方使用Ribbon的ZoneAwareLoadBalancer负载均衡选择出来了一个server,然后将这个server,交给ServerOpretion中的call()方法去处理。</p>
<p>结合方法的命名找到LoadBalancerCommand#selectServer():</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071639910.png" alt="202403071639910"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071640043.png" alt="202403071640043"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071642161.png" alt="202403071642161"/>
<p>selectServer()方法逻辑解析:</p>
<blockquote>
<p>在这个方法中,就是直接基于Feign集成的Ribbon的<code>ZoneAwareLoadBalancer</code>的 chooseServer() 方法,通过负载均衡机制选择了一个server出来。</p>
<ul>
<li>先通过LoadBalancerContext#getServerFromLoadBalancer()方法获取到ILoadBalancer;</li>
<li>在利用ILoadBalancer#chooseServer()方法选择出一个Server。</li>
</ul>
</blockquote>
<p>选择出一个Server之后,再去调用ServerOperation.call()方法,由call()方法拼接出最终的请求URI,发送http请求;</p>
<p><strong>3&gt; 最终发送出去的请求URI是什么样的?</strong>
ServerOperation#call()方法里负责发送请求,在executeWithLoadBalancer()方法中重写了LoadBalancerCommand#command()方法中入参ServerOperation的call()方法;</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071648955.png" alt="202403071648955"/>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">URI</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">reconstructURIWithServer</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Server</span><span style="--0:#F8F8F2"> server, </span><span style="--0:#8BE9FD;--0fs:italic">URI</span><span style="--0:#F8F8F2"> original) {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 获取服务 ip</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> host </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> server.</span><span style="--0:#50FA7B;--1:#6F42C1">getHost</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 获取服务的 port</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">int</span><span style="--0:#F8F8F2;--1:#24292E"> port </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> server.</span><span style="--0:#50FA7B;--1:#6F42C1">getPort</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 获取请求协议,这里为 http</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> scheme </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> server.</span><span style="--0:#50FA7B;--1:#6F42C1">getScheme</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (host.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getHost</span><span style="--0:#F8F8F2;--1:#24292E">())</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> port </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> original.</span><span style="--0:#50FA7B;--1:#6F42C1">getPort</span><span style="--0:#F8F8F2;--1:#24292E">()</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">&amp;&amp;</span><span style="--0:#F8F8F2;--1:#24292E"> scheme </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> original.</span><span style="--0:#50FA7B;--1:#6F42C1">getScheme</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> original;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (scheme </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">scheme </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> original.</span><span style="--0:#50FA7B;--1:#6F42C1">getScheme</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (scheme </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">scheme </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">deriveSchemeAndPortFromPartialUri</span><span style="--0:#F8F8F2;--1:#24292E">(original).</span><span style="--0:#50FA7B;--1:#6F42C1">first</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">StringBuilder</span><span style="--0:#F8F8F2;--1:#24292E"> sb </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">StringBuilder</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 拼接请求协议,此时请求为 http://</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(scheme).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">://</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">Strings.</span><span style="--0:#50FA7B;--1:#6F42C1">isNullOrEmpty</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawUserInfo</span><span style="--0:#F8F8F2;--1:#24292E">())) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawUserInfo</span><span style="--0:#F8F8F2;--1:#24292E">()).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">@</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 拼接请求 ip,此时请求为 http://192.168.1.3</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(host);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (port </span><span style="--0:#FF79C6;--1:#BF3441">&gt;=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">0</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#96A1C2;--1:#616972">// 拼接请求 post,此时请求为 http://192.168.1.3:8082</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">:</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(port);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 拼接请求路径,此时请求为 http://192.168.1.3:8082/user/sayHello/1</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawPath</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 拼接请求查询参数,此时请求为 http:///user/sayHello/1?name=zhangsan&amp;age=18</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">Strings.</span><span style="--0:#50FA7B;--1:#6F42C1">isNullOrEmpty</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawQuery</span><span style="--0:#F8F8F2;--1:#24292E">())) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">?</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawQuery</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">!</span><span style="--0:#F8F8F2;--1:#24292E">Strings.</span><span style="--0:#50FA7B;--1:#6F42C1">isNullOrEmpty</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawFragment</span><span style="--0:#F8F8F2;--1:#24292E">())) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">sb.</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">#</span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E">).</span><span style="--0:#50FA7B;--1:#6F42C1">append</span><span style="--0:#F8F8F2;--1:#24292E">(original.</span><span style="--0:#50FA7B;--1:#6F42C1">getRawFragment</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">URI</span><span style="--0:#F8F8F2;--1:#24292E"> newURI </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">URI</span><span style="--0:#F8F8F2;--1:#24292E">(sb.</span><span style="--0:#50FA7B;--1:#6F42C1">toString</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> newURI;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> (</span><span style="--0:#8BE9FD;--0fs:italic">URISyntaxException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">e</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">RuntimeException</span><span style="--0:#F8F8F2;--1:#24292E">(e);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public URI reconstructURIWithServer(Server server, URI original) {  // 获取服务 ip  String host = server.getHost();  // 获取服务的 port  int port = server.getPort();  // 获取请求协议,这里为 http  String scheme = server.getScheme();  if (host.equals(original.getHost())        &#38;&#38; port == original.getPort()        &#38;&#38; scheme == original.getScheme()) {    return original;  }  if (scheme == null) {    scheme = original.getScheme();  }  if (scheme == null) {    scheme = deriveSchemeAndPortFromPartialUri(original).first();  }  try {    StringBuilder sb = new StringBuilder();    // 拼接请求协议,此时请求为 http://    sb.append(scheme).append(&#34;://&#34;);    if (!Strings.isNullOrEmpty(original.getRawUserInfo())) {      sb.append(original.getRawUserInfo()).append(&#34;@&#34;);    }    // 拼接请求 ip,此时请求为 http://192.168.1.3    sb.append(host);    if (port >= 0) {      // 拼接请求 post,此时请求为 http://192.168.1.3:8082      sb.append(&#34;:&#34;).append(port);    }    // 拼接请求路径,此时请求为 http://192.168.1.3:8082/user/sayHello/1    sb.append(original.getRawPath());    // 拼接请求查询参数,此时请求为 http:///user/sayHello/1?name=zhangsan&#38;age=18    if (!Strings.isNullOrEmpty(original.getRawQuery())) {      sb.append(&#34;?&#34;).append(original.getRawQuery());    }    if (!Strings.isNullOrEmpty(original.getRawFragment())) {      sb.append(&#34;#&#34;).append(original.getRawFragment());    }    URI newURI = new URI(sb.toString());    return newURI;  } catch (URISyntaxException e) {    throw new RuntimeException(e);  }}"><div></div></button></div></figure></div>
<p>方法逻辑解析:</p>
<blockquote>
<p>根据之前处理好的请求URI和Server的地址拼接出真实的地址; 依次拼接http://,服务的IP、服务的Port、请求路径、查询参数,最终体现为:</p>
<ul>
<li>原request的uri: GET http:///user/sayHello/1?name=saint&amp;age=18 HTTP/1.1</li>
<li>server地址: 192.168.1.3:8082</li>
<li>拼接后的地址: &lt;<a href="http://192.168.1.3:8082/user/sayHello/1?name=saint&age=18" rel="nofollow, noopener, noreferrer" target="_blank">http://192.168.1.3:8082/user/sayHello/1?name=saint&amp;age=18</a>&gt;</li>
</ul>
</blockquote>
<p>接着使用拼接后的地址替换掉request.uri,再调用FeignLoadBalacner#execute()方法发送一个http请求;其中发送请求的超时时间默认为1000ms,即1s;最后返回结果封装到FeignLoadBalancer.RibbonResponse。</p>
<h6 id="指定decoder时对请求返回结果解码">指定Decoder时对请求返回结果解码</h6>
<p>如果配置了decoder,则使用Decoder#decode()方法对结果进行解码;</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">interface</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Decoder</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">  </span></span><span style="--0:#96A1C2;--1:#616972">/**</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* Decodes an http response into an object corresponding to its</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* {</span><span style="--0:#FF79C6;--1:#BF3441">@link</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">java.lang.reflect.Method</span><span style="--0:#96A1C2;--1:#616972">#</span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">getGenericReturnType()</span><span style="--0:#96A1C2;--1:#616972"> generic return type}. If you need to</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* wrap exceptions, please do so via {@link DecodeException}.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">*</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">response</span><span style="--0:#96A1C2;--1:#616972"> the response to decode</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@param</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">type</span><span style="--0:#96A1C2;--1:#616972"> {</span><span style="--0:#FF79C6;--1:#BF3441">@link</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">java.lang.reflect.Method</span><span style="--0:#96A1C2;--1:#616972">#</span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">getGenericReturnType()</span><span style="--0:#96A1C2;--1:#616972"> generic return type} of the</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">*        method corresponding to this {@code response}.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@return</span><span style="--0:#96A1C2;--1:#616972"> instance of {@code type}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@throws</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">IOException</span><span style="--0:#96A1C2;--1:#616972"> will be propagated safely to the caller.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@throws</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">DecodeException</span><span style="--0:#96A1C2;--1:#616972"> when decoding failed due to a checked exception besides IOException.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">* </span><span style="--0:#FF79C6;--1:#BF3441">@throws</span><span style="--0:#96A1C2;--1:#616972"> </span><span style="--0:#8BE9FD;--1:#6F42C1">FeignException</span><span style="--0:#96A1C2;--1:#616972"> when decoding succeeds, but conveys the operation failed.</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">   </span></span><span style="--0:#96A1C2;--1:#616972">*/</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Object</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Response</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">response</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">Type</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">type</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">throws</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">IOException</span><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">DecodeException</span><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">FeignException</span><span style="--0:#F8F8F2">;</span></span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#96A1C2;--1:#616972">  </span></span><span style="--0:#96A1C2;--1:#616972">/** Default implementation of {@code Decoder}. */</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">class</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--1:#6F42C1">Default</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">extends</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#8BE9FD;--0fs:italic;--1:#6F42C1">StringDecoder</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">@</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">Override</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Response</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">response</span><span style="--1:#24292E"><span style="--0:#F8F8F2">, </span><span style="--0:#8BE9FD;--0fs:italic">Type</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">type</span><span style="--0:#F8F8F2;--1:#24292E">) </span><span style="--0:#FF79C6;--1:#BF3441">throws</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">IOException</span><span style="--0:#F8F8F2"> {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (response.</span><span style="--0:#50FA7B;--1:#6F42C1">status</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">404</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">||</span><span style="--0:#F8F8F2;--1:#24292E"> response.</span><span style="--0:#50FA7B;--1:#6F42C1">status</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">204</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> Util.</span><span style="--0:#50FA7B;--1:#6F42C1">emptyValueOf</span><span style="--0:#F8F8F2;--1:#24292E">(type);</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (response.</span><span style="--0:#50FA7B;--1:#6F42C1">body</span><span style="--0:#F8F8F2;--1:#24292E">() </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">)</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">;</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">byte</span><span style="--0:#F8F8F2;--1:#24292E">[].class.</span><span style="--0:#50FA7B;--1:#6F42C1">equals</span><span style="--0:#F8F8F2;--1:#24292E">(type)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">        </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> Util.</span><span style="--0:#50FA7B;--1:#6F42C1">toByteArray</span><span style="--0:#F8F8F2;--1:#24292E">(response.</span><span style="--0:#50FA7B;--1:#6F42C1">body</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">asInputStream</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent">      </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">super</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--0:#F8F8F2;--1:#24292E">(response, type);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public interface Decoder {  /**   * Decodes an http response into an object corresponding to its   * {@link java.lang.reflect.Method#getGenericReturnType() generic return type}. If you need to   * wrap exceptions, please do so via {@link DecodeException}.   *   * @param response the response to decode   * @param type {@link java.lang.reflect.Method#getGenericReturnType() generic return type} of the   *        method corresponding to this {@code response}.   * @return instance of {@code type}   * @throws IOException will be propagated safely to the caller.   * @throws DecodeException when decoding failed due to a checked exception besides IOException.   * @throws FeignException when decoding succeeds, but conveys the operation failed.   */  Object decode(Response response, Type type) throws IOException, DecodeException, FeignException;  /** Default implementation of {@code Decoder}. */  public class Default extends StringDecoder {    @Override    public Object decode(Response response, Type type) throws IOException {      if (response.status() == 404 || response.status() == 204)        return Util.emptyValueOf(type);      if (response.body() == null)        return null;      if (byte[].class.equals(type)) {        return Util.toByteArray(response.body().asInputStream());      }      return super.decode(response, type);    }  }}"><div></div></button></div></figure></div>
<h6 id="默认情况下feign接收到服务返回的结果后如何处理">默认情况下,Feign接收到服务返回的结果后,如何处理?</h6>
<p>即: 未指定decoder时,会直接使用AsyncResponseHandler#handleResponse()方法处理接收到的服务返回结果:</p>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071718925.png" alt="202403071718925"/>
<img src="https://cdn.jsdelivr.net/gh/chou401/pic-md@main//img/202403071723997.png" alt="202403071723997"/>
<p>如果响应结果的returnType为Response时,则将return信息的body()解析成byte数组,放到resultFuture的RESULT中;然后SynchronousMethodHandler#executeAndDecode()方法中通过resultFuture.join()方法拿到RESULT(即: 请求的真正的响应结果)。</p>
<p>一般而言,会走到如下else if 分支</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#96A1C2;--1:#616972">// 请求成功后,返回结果类型为 void,则处理的返回结果赋值 null</span></div></div><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#50FA7B;--1:#6F42C1">isVoidType</span><span style="--0:#F8F8F2;--1:#24292E">(returnType)) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">resultFuture.</span><span style="--0:#50FA7B;--1:#6F42C1">complete</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 解析请求的返回结果</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> result </span></span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--0:#F8F8F2;--1:#24292E">(response, returnType);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">shouldClose </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> closeAfterDecode;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">resultFuture.</span><span style="--0:#50FA7B;--1:#6F42C1">complete</span><span style="--0:#F8F8F2;--1:#24292E">(result);</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="// 请求成功后,返回结果类型为 void,则处理的返回结果赋值 nullif (isVoidType(returnType)) {  resultFuture.complete(null);} else {  // 解析请求的返回结果  final Object result = decode(response, returnType);  shouldClose = closeAfterDecode;  resultFuture.complete(result);}"><div></div></button></div></figure></div>
<p>decode()方法中将response处理为我们要的returnType,比如调用的服务方返回给我们一个JSON字符串,decode()方法中会将其转换为我们需要的JavaBean(即: returnType,当前方法的返回值)。</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--1:#24292E"><span style="--0:#8BE9FD;--0fs:italic">Object</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Response</span><span style="--0:#F8F8F2"> response, </span><span style="--0:#8BE9FD;--0fs:italic">Type</span><span style="--0:#F8F8F2"> type) throws IOException {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">try</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> decoder.</span><span style="--0:#50FA7B;--1:#6F42C1">decode</span><span style="--0:#F8F8F2;--1:#24292E">(response, type);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">FeignException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">e</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> e;</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">catch</span><span style="--0:#F8F8F2;--1:#24292E"> (</span><span style="--0:#FF79C6;--1:#BF3441">final</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">RuntimeException</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#FFB86C;--0fs:italic;--1:#AE4B07">e</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">throw</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DecodeException</span><span style="--0:#F8F8F2;--1:#24292E">(response.</span><span style="--0:#50FA7B;--1:#6F42C1">status</span><span style="--0:#F8F8F2;--1:#24292E">(), e.</span><span style="--0:#50FA7B;--1:#6F42C1">getMessage</span><span style="--0:#F8F8F2;--1:#24292E">(), response.</span><span style="--0:#50FA7B;--1:#6F42C1">request</span><span style="--0:#F8F8F2;--1:#24292E">(), e);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="Object decode(Response response, Type type) throws IOException {  try {    return decoder.decode(response, type);  } catch (final FeignException e) {    throw e;  } catch (final RuntimeException e) {    throw new DecodeException(response.status(), e.getMessage(), response.request(), e);  }}"><div></div></button></div></figure></div>
<p>deocode()方法中会用到一个Decoder,decoder默认是OptionalDecoder,针对JavaBean返回类型,OptionalDecoder将decode委托给ResponseEntityDecoder处理。</p>
<h4 id="总结">总结</h4>
<blockquote>
<ol>
<li>请求达到FeignClient时,会进入到JDK动态代理类,由ReflectiveFeign#FeignInvocationHandler分发处理请求;找到接口方法对应的SynchronousMethodHandler;</li>
<li>SynchronousMethodHandler中首先使用SpringMvcContract解析标注了SpringMvc注解的参数;然后使用encoder对请求进行编码;</li>
<li>RequestInterceptor对Request进行拦截处理;</li>
<li>LoadBalancerFeignClient通过集成的Ribbon的负载均衡器(<code>ZoneAwareLoadBalancer</code>)实现负载均衡找到一个可用的Server,交给RibbonRequest组合的Client去做HTTP请求,这里的Client可以是HttpUrlConnection、HttpClient、OKHttp。</li>
<li>最后Decoder对Response响应进行解码。</li>
</ol>
</blockquote>
<h2 id="openfeign新版本和旧版本之间的差异高版本openfeign底层不使用ribbon做负载均衡">OpenFeign新版本和旧版本之间的差异(高版本OpenFeign底层不使用Ribbon做负载均衡)</h2>
<h3 id="feignclientsregistrar开启对feignclient的扫描">@FeignClientsRegistrar开启对FeignClient的扫描</h3>
<p><strong>此处主流程上无区别:</strong>
在SpringBoot启动流程中 @FeignClientsRegistrar 注解开启OpenFeign的入口、OpenFeign扫描所有的FeignClient的流程,高版本和低版本基本一样。</p>
<p>主要流程如下:</p>
<blockquote>
<p>1&gt; 开启扫描FeignClient的入口:</p>
<ol>
<li>启动类上添加的@EnableFeignClients注解会通过@Import注解在SpringBoot启动流程中将ImportBeanDefinitionRegistrar接口的实现类FeignClientsRegistrar注入到启动类的ConfigurationClass的属性中,在注册启动类的BeanDefinition时,会遍历调用其@Import的所有ImportBeanDefinitionRegistrar接口的 registerBeanDefinitions()方法。</li>
</ol>
<p>2&gt; 扫描FeignClient:</p>
<ol>
<li>拿到@EnableFeignClients注解中配置的扫描包路径相关的属性,得到要扫描的包路径;</li>
<li>获取到扫描器ClassPathScanningCandidateComponentProvider,然后给其添加一个注解过滤器(AnnotationTypeFilter),只过滤出包含@FeignClient注解的BeanDefinition;</li>
<li>扫描器的findCandidateComponents(basePackage)方法从包路径下扫描出所有标注了@FeignClient注解并符合条件装配的接口;然后将其在BeanDefinitionRegistry中注册一下;</li>
</ol>
</blockquote>
<h3 id="为feignclient生成动态代理类">为FeignClient生成动态代理类</h3>
<p><strong>区别主要体现在这里:</strong>
在注册FeignClient到Spring容器时,构建的BeanDefinition的beanClas是FeignClientFactoryBean;FeignClientFactoryBean是一个工厂,保存了@FeignClient注解的所有属性值,在Spring容器初始化的过程中,其会根据之前扫描出的FeignClient信息构建FeignClient的动态代理类。</p>
<p><strong>底层通信Client的区别?</strong>
在使用Feign.Builder构建FeignClient的时候,获取到的Client是FeignBlockingLoadBalancerClient(这其中的逻辑后面聊,在OpenFeign低版本是LoadBalancerFeignClient);用于生成FeignClient的Targeter是DefaultTargeter(在OpenFeign低版本是HystrixTargeter,高版本移除了Hystrix,采用Spring Cloud Circuit Breaker 做限流熔断);</p>
<p>具体体现在FeignClientFactoryBean#loadBalance()方法,其是一个进行负载均衡的FeignClient动态代理生成方法;</p>
<p><strong>1&gt; FeignBlockingLoadBalancerClient何时注入到Spring容器?</strong></p>
<p>FeignBlockingLoadBalancerClient注入到Spring容器的方式和OpenFeign低版本的LoadBalancerFeignClient是一样的;</p>
<p>进入到FeignBlockingLoadBalancerClient类中,看哪里调用了它唯一一个构造函数;</p>
<p>找到FeignBlockingLoadBalancerClient发现有三个地方调用了它的构造函数,new了一个实例;</p>
<ul>
<li>DefaultFeignLoadBalancedConfiguration</li>
<li>HttpClientFeignLoadBalancedConfiguration</li>
<li>OkHttpFeignLoadBalancedConfiguration</li>
</ul>
<p>再结合默认的配置,只有DefaultFeignLoadBalancedConfiguration中的Client符合条件装配;</p>
<p>可以通过引入Apache HttpClient的maven依赖使用HttpClientFeignLoadBalancedConfiguration,或引入OkHttpClient的maven依赖并在application.yml文件中指定feign.okhttp.enabled属性为true使用OkHttpFeignLoadBalancedConfiguration。</p>
<p><strong>2&gt; DefaultTargeter在哪里注入到Spring容器?</strong></p>
<p>DefaultTargeter注入到Spring容器的方式和OpenFeign低版本的HystrixTargeter是一样的;</p>
<p>在FeignAutoConfiguration类中可以找到Targeter注入到Spring容器的逻辑;</p>
<p><strong>3&gt; 后续生成动态代理类的逻辑和旧版本一样</strong>
都体现在ReflectiveFeign#newInstance()方法中:</p>
<h3 id="client处理负载均衡核心区别">Client处理负载均衡(核心区别)</h3>
<p>上面提到OpenFeign高版本获取到的Client是<code>FeignBlockingLoadBalancerClient</code>,而低版本的是<code>LoadBalancerFeignClient</code>,LoadBalancerFeignClient基于Ribbon实现负载均衡,FeignBlockingLoadBalancerClient就靠OpenFeign(通过loadBalancerClient)实现负载均衡;</p>
<p><strong>FeignBlockingLoadBalancerClient是如何做负载均衡的:</strong>
1&gt; FeignBlockingLoadBalancerClient选择一个服务实例</p>
<div class="expressive-code"><figure class="frame"><figcaption class="header"></figcaption><pre data-language="java"><code><div class="ec-line"><div class="code"><span style="--0:#FF79C6;--1:#BF3441">public</span><span style="--1:#24292E"><span style="--0:#F8F8F2"> </span><span style="--0:#8BE9FD;--0fs:italic">Response</span><span style="--0:#F8F8F2"> </span></span><span style="--0:#50FA7B;--1:#6F42C1">execute</span><span style="--1:#24292E"><span style="--0:#F8F8F2">(</span><span style="--0:#8BE9FD;--0fs:italic">Request</span><span style="--0:#F8F8F2"> request, Request.Options options) throws IOException {</span></span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 将请求的 url 封装成 uri</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">URI</span><span style="--0:#F8F8F2;--1:#24292E"> originalUri </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> URI.</span><span style="--0:#50FA7B;--1:#6F42C1">create</span><span style="--0:#F8F8F2;--1:#24292E">(request.</span><span style="--0:#50FA7B;--1:#6F42C1">url</span><span style="--0:#F8F8F2;--1:#24292E">());</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 获取要请求的服务名</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> serviceId </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> originalUri.</span><span style="--0:#50FA7B;--1:#6F42C1">getHost</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">Assert.</span><span style="--0:#50FA7B;--1:#6F42C1">state</span><span style="--0:#F8F8F2;--1:#24292E">(serviceId </span><span style="--0:#FF79C6;--1:#BF3441">!=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">, </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Request URI does not contain a valid hostname: </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> originalUri);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> hint </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">getHint</span><span style="--0:#F8F8F2;--1:#24292E">(serviceId);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">DefaultRequest</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">RequestDataContext</span><span style="--0:#F8F8F2;--1:#24292E">&gt; lbRequest </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultRequest</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">RequestDataContext</span><span style="--0:#F8F8F2;--1:#24292E">(LoadBalancerUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">buildRequestData</span><span style="--0:#F8F8F2;--1:#24292E">(request), hint));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Set</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">LoadBalancerLifecycle</span><span style="--0:#F8F8F2;--1:#24292E">&gt; supportedLifecycleProcessors </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> LoadBalancerLifecycleValidator.</span><span style="--0:#50FA7B;--1:#6F42C1">getSupportedLifecycleProcessors</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.loadBalancerClientFactory.</span><span style="--0:#50FA7B;--1:#6F42C1">getInstances</span><span style="--0:#F8F8F2;--1:#24292E">(serviceId, LoadBalancerLifecycle.class), RequestDataContext.class, ResponseData.class, ServiceInstance.class);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">supportedLifecycleProcessors.</span><span style="--0:#50FA7B;--1:#6F42C1">forEach</span><span style="--0:#F8F8F2;--1:#24292E">((lifecycle) </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">-&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">lifecycle.</span><span style="--0:#50FA7B;--1:#6F42C1">onStart</span><span style="--0:#F8F8F2;--1:#24292E">(lbRequest);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">});</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#96A1C2;--1:#616972">// 选择一个服务实例</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">ServiceInstance</span><span style="--0:#F8F8F2;--1:#24292E"> instance </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.loadBalancerClient.</span><span style="--0:#50FA7B;--1:#6F42C1">choose</span><span style="--0:#F8F8F2;--1:#24292E">(serviceId, lbRequest);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">org</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">springframework</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">cloud</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">client</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">loadbalancer</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Response</span><span style="--0:#F8F8F2;--1:#24292E">&lt;</span><span style="--0:#F8F8F2;--1:#BF3441">ServiceInstance</span><span style="--0:#F8F8F2;--1:#24292E">&gt; lbResponse </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">DefaultResponse</span><span style="--0:#F8F8F2;--1:#24292E">(instance);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">  </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">String</span><span style="--0:#F8F8F2;--1:#24292E"> message;</span></div></div><div class="ec-line"><div class="code"><span class="indent">  </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (instance </span><span style="--0:#FF79C6;--1:#BF3441">==</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--1:#005CC5">null</span><span style="--0:#F8F8F2;--1:#24292E">) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">message </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--1:#032F62"><span style="--0:#E9F284">&quot;</span><span style="--0:#F1FA8C">Load balancer does not contain an instance for the service </span><span style="--0:#E9F284">&quot;</span></span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#FF79C6;--1:#BF3441">+</span><span style="--0:#F8F8F2;--1:#24292E"> serviceId;</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">if</span><span style="--0:#F8F8F2;--1:#24292E"> (LOG.</span><span style="--0:#50FA7B;--1:#6F42C1">isWarnEnabled</span><span style="--0:#F8F8F2;--1:#24292E">()) {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">LOG.</span><span style="--0:#50FA7B;--1:#6F42C1">warn</span><span style="--0:#F8F8F2;--1:#24292E">(message);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code">
</div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">supportedLifecycleProcessors.</span><span style="--0:#50FA7B;--1:#6F42C1">forEach</span><span style="--0:#F8F8F2;--1:#24292E">((lifecycle) </span><span style="--0:#8BE9FD;--0fs:italic;--1:#BF3441">-&gt;</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">      </span></span><span style="--0:#F8F8F2;--1:#24292E">lifecycle.</span><span style="--0:#50FA7B;--1:#6F42C1">onComplete</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#FF79C6;--0fw:bold;--1:#BF3441">new</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#50FA7B;--1:#6F42C1">CompletionContext</span><span style="--0:#F8F8F2;--1:#24292E">(Status.DISCARD, lbRequest, lbResponse));</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">});</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> Response.</span><span style="--0:#50FA7B;--1:#6F42C1">builder</span><span style="--0:#F8F8F2;--1:#24292E">().</span><span style="--0:#50FA7B;--1:#6F42C1">request</span><span style="--0:#F8F8F2;--1:#24292E">(request).</span><span style="--0:#50FA7B;--1:#6F42C1">status</span><span style="--0:#F8F8F2;--1:#24292E">(HttpStatus.SERVICE_UNAVAILABLE.</span><span style="--0:#50FA7B;--1:#6F42C1">value</span><span style="--0:#F8F8F2;--1:#24292E">()).</span><span style="--0:#50FA7B;--1:#6F42C1">body</span><span style="--0:#F8F8F2;--1:#24292E">(message, StandardCharsets.UTF_8).</span><span style="--0:#50FA7B;--1:#6F42C1">build</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">} </span><span style="--0:#FF79C6;--1:#BF3441">else</span><span style="--0:#F8F8F2;--1:#24292E"> {</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#96A1C2;--1:#616972">// 构建完整的请求 url</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">    </span></span><span style="--0:#F8F8F2;--1:#24292E">message </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.loadBalancerClient.</span><span style="--0:#50FA7B;--1:#6F42C1">reconstructURI</span><span style="--0:#F8F8F2;--1:#24292E">(instance, originalUri).</span><span style="--0:#50FA7B;--1:#6F42C1">toString</span><span style="--0:#F8F8F2;--1:#24292E">();</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--1:#24292E">    </span></span><span style="--0:#8BE9FD;--0fs:italic;--1:#24292E">Request</span><span style="--0:#F8F8F2;--1:#24292E"> newRequest </span><span style="--0:#FF79C6;--1:#BF3441">=</span><span style="--0:#F8F8F2;--1:#24292E"> </span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.</span><span style="--0:#50FA7B;--1:#6F42C1">buildRequest</span><span style="--0:#F8F8F2;--1:#24292E">(request, message, instance);</span></div></div><div class="ec-line"><div class="code"><span class="indent">    </span><span style="--0:#FF79C6;--1:#BF3441">return</span><span style="--0:#F8F8F2;--1:#24292E"> LoadBalancerUtils.</span><span style="--0:#50FA7B;--1:#6F42C1">executeWithLoadBalancerLifecycleProcessing</span><span style="--0:#F8F8F2;--1:#24292E">(</span><span style="--0:#BD93F9;--0fs:italic;--1:#005CC5">this</span><span style="--0:#F8F8F2;--1:#24292E">.delegate, options, newRequest, lbRequest, lbResponse, supportedLifecycleProcessors);</span></div></div><div class="ec-line"><div class="code"><span class="indent"><span style="--0:#F8F8F2;--1:#24292E">  </span></span><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div><div class="ec-line"><div class="code"><span style="--0:#F8F8F2;--1:#24292E">}</span></div></div></code></pre><div class="copy"><button title="Copy to clipboard" data-copied="Copied!" data-code="public Response execute(Request request, Request.Options options) throws IOException {  // 将请求的 url 封装成 uri  URI originalUri = URI.create(request.url());  // 获取要请求的服务名  String serviceId = originalUri.getHost();  Assert.state(serviceId != null, &#34;Request URI does not contain a valid hostname: &#34; + originalUri);  String hint = this.getHint(serviceId);  DefaultRequest<RequestDataContext> lbRequest = new DefaultRequest(new RequestDataContext(LoadBalancerUtils.buildRequestData(request), hint));  Set<LoadBalancerLifecycle> supportedLifecycleProcessors = LoadBalancerLifecycleValidator.getSupportedLifecycleProcessors(this.loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle.class), RequestDataContext.class, ResponseData.class, ServiceInstance.class);  supportedLifecycleProcessors.forEach((lifecycle) -> {    lifecycle.onStart(lbRequest);  });  // 选择一个服务实例  ServiceInstance instance = this.loadBalancerClient.choose(serviceId, lbRequest);  org.springframework.cloud.client.loadbalancer.Response<ServiceInstance> lbResponse = new DefaultResponse(instance);  String message;  if (instance == null) {    message = &#34;Load balancer does not contain an instance for the service &#34; + serviceId;    if (LOG.isWarnEnabled()) {      LOG.warn(message);    }    supportedLifecycleProcessors.forEach((lifecycle) -> {      lifecycle.onComplete(new CompletionContext(Status.DISCARD, lbRequest, lbResponse));    });    return Response.builder().request(request).status(HttpStatus.SERVICE_UNAVAILABLE.value()).body(message, StandardCharsets.UTF_8).build();  } else {    // 构建完整的请求 url    message = this.loadBalancerClient.reconstructURI(instance, originalUri).toString();    Request newRequest = this.buildRequest(request, message, instance);    return LoadBalancerUtils.executeWithLoadBalancerLifecycleProcessing(this.delegate, options, newRequest, lbRequest, lbResponse, supportedLifecycleProcessors);  }}"><div></div></button></div></figure></div>   </div> </article> </div> <button aria-label="Back to Top" class="z-90 fixed bottom-8 end-4 flex h-10 w-10 translate-y-28 items-center justify-center rounded-full border-2 border-transparent bg-zinc-200 text-3xl opacity-0 transition-all duration-300 hover:border-zinc-400 data-[show=true]:translate-y-0 data-[show=true]:opacity-100 dark:bg-zinc-700 sm:end-8 sm:h-12 sm:w-12" data-show="false" id="to-top-btn"><svg aria-hidden="true" class="h-6 w-6" fill="none" focusable="false" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"> <path d="M4.5 15.75l7.5-7.5 7.5 7.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </button>  </main> <footer class="mt-auto flex w-full flex-col items-center justify-center gap-y-2 pb-4 pt-20 text-center align-top font-semibold text-gray-600 dark:text-gray-400 sm:flex-row sm:justify-between sm:text-xs"> <div class="me-0 sm:me-4">
&copy; chou401 2024.<span class="inline-block">&nbsp;🚀&nbsp;花易谢、雾易失、梦易逝、云易散</span> </div> <nav aria-label="More on this site" class="flex gap-x-2 sm:gap-x-0 sm:divide-x sm:divide-gray-500"> <a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/astro-theme-cactus/"> Home </a><a class="px-4 py-2 sm:py-0 sm:hover:text-textColor sm:hover:underline" href="/astro-theme-cactus/posts/"> Blog </a> </nav> </footer> </body></html> 